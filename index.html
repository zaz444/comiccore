<!DOCTYPE html>
<html>
<head>

    <script>
  // If the link has ?id=... it will jump straight to the reader
  const urlParams = new URLSearchParams(window.location.search);
  const comicId = urlParams.get('id');
  if (comicId) {
    window.location.href = `https://zaz444.github.io/comiccore/reader.html?id=${comicId}`;
  }
</script> 
    <link rel="stylesheet" href="theme.css">

    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore - Home</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        /* colors now in theme.css */

        body { 
            margin: 0; 
            padding: 20px; 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .home-header { 
            width: 100%; 
            max-width: 400px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin: 40px 0 30px 0; 
        }

        .welcome-container { flex: 1; }
        h1 { margin: 0; font-size: 24px; }
        
        .corner-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            cursor: pointer;
            object-fit: cover;
            background: var(--card);
            transition: transform 0.2s;
        }
        .corner-avatar:hover { transform: scale(1.1); }

        .user-meta-row { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        #user-display { color: var(--accent); font-size: 18px; font-weight: 700; }
        #id-badge { background: #202327; color: var(--accent); font-size: 11px; padding: 2px 8px; border-radius: 6px; font-weight: 800; border: 1px solid var(--border); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        
        .card { 
            background: var(--accent); 
            border-radius: 20px; 
            padding: 30px 15px; 
            text-align: center; 
            color: white; 
            font-weight: 700; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
            transition: transform 0.2s, background 0.3s; 
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card:active { transform: scale(0.95); }
        .card:hover { filter: brightness(1.1); }
        
        .card.large { 
            grid-column: span 2; 
            padding: 20px; 
            text-align: left; 
            padding-left: 25px; 
            justify-content: flex-start;
        }

        /* Notification States */
        .card.has-message { background: var(--notify-msg) !important; color: #000; }
        .card.has-request { background: var(--notify-req) !important; color: #000; }

        .logout-btn { 
            margin-top: 40px; 
            background: none; 
            border: 1px solid var(--border); 
            color: var(--secondary); 
            padding: 12px 30px; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 600; 
        }

        /* ‚îÄ‚îÄ Ratio Picker Modal ‚îÄ‚îÄ */
        #ratio-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.96);
            z-index: 9999; display: none; flex-direction: column;
            align-items: center; justify-content: center; gap: 18px;
            backdrop-filter: blur(12px); padding: 20px;
        }
        #ratio-modal h2 { margin: 0; color: var(--accent); font-size: 20px; letter-spacing: 1px; text-align: center; }
        #ratio-modal p  { margin: 0; color: #666; font-size: 12px; text-align: center; }
        .ratio-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            max-width: 380px; width: 100%;
        }
        .ratio-btn {
            background: #1a1a1a; border: 1.5px solid #333; color: #fff;
            border-radius: 12px; padding: 12px 6px; cursor: pointer; font-weight: 800;
            font-size: 12px; text-align: center; transition: 0.2s; display: flex;
            flex-direction: column; align-items: center; justify-content: center; gap: 7px;
            min-height: 70px;
        }
        .ratio-btn:hover, .ratio-btn:active { border-color: var(--accent); color: var(--accent); background: #111; }
        .ratio-preview { background: #444; border: 1.5px solid #666; border-radius: 2px; }
        .ratio-cancel {
            background: none; border: 1px solid #333; color: #666;
            padding: 10px 28px; border-radius: 50px; cursor: pointer;
            font-size: 13px; font-weight: 600; margin-top: 4px;
        }
    </style>
</head>
<body>

    <div class="home-header">
        <div class="welcome-container">
            <h1>Welcome,</h1>
            <div class="user-meta-row">
                <span id="user-display">Loading...</span>
                <span id="id-badge" style="display:none;">#ID</span>
            </div>
        </div>
        <img id="nav-pfp" src="https://via.placeholder.com/50" class="corner-avatar" onclick="goToMyProfile()" title="View Public Profile">
    </div>

    <div class="grid">
        <button class="card" onclick="location.href='discover.html'">Discover</button>
        <button class="card" onclick="location.href='my-comics.html'">My Comics</button>
        
        <button class="card" onclick="goToMyProfile()">View Profile</button>
        <button class="card" onclick="location.href='favorites.html'">Favorites</button>
        
        <button class="card large" onclick="openRatioModal()">Create Comic</button>
        <button class="card large" onclick="location.href='settings.html'">Settings</button>
        
        <button id="teams-btn" class="card large" onclick="location.href='teams.html'">Teams</button>
        <button id="conn-btn" class="card large" onclick="location.href='connections.html'">Connections</button>
        <button class="card large" onclick="location.href='sprite-editor.html'" style="border-color: var(--teal); color: var(--teal);">üé® Sprite Editor</button>
    </div>

    <button class="logout-btn" onclick="logout()">Sign Out</button>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://mmycqeejhguzhtzkyjaj.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (user) {
                const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
                document.getElementById('user-display').innerText = myProfile.name || "New Creator";
                if (myProfile.pic) document.getElementById('nav-pfp').src = myProfile.pic;

                if (myProfile.permanent_id) {
                    const badge = document.getElementById('id-badge');
                    badge.innerText = "#" + myProfile.permanent_id;
                    badge.style.display = "inline-block";
                }

                // Hide buttons for disabled features
                if (localStorage.getItem('cc-privacy-team') === 'false')
                    document.getElementById('teams-btn').style.display = 'none';
                if (localStorage.getItem('cc-privacy-friends') === 'false')
                    document.getElementById('conn-btn').style.display = 'none';

                // Run all notification checks
                checkNotifications(user.id);
                checkTeamNotifications(user.id);
            } else {
                window.location.href = "login.html";
            }
        }

        async function checkNotifications(userId) {
            const connBtn = document.getElementById('conn-btn');

            const { count: reqCount } = await supabaseClient
                .from('friend_requests')
                .select('*', { count: 'exact', head: true })
                .eq('receiver_id', userId)
                .eq('status', 'pending');

            if (reqCount > 0) {
                connBtn.classList.add('has-request');
                connBtn.innerText = "Connections (New Request!)";
                return;
            }

            const { count: msgCount } = await supabaseClient
                .from('messages')
                .select('*', { count: 'exact', head: true })
                .eq('receiver_id', userId)
                .eq('is_read', false);

            if (msgCount > 0) {
                connBtn.classList.add('has-message');
                connBtn.innerText = "Connections (New Message!)";
            }
        }

        async function checkTeamNotifications(userId) {
            const teamsBtn = document.getElementById('teams-btn');

            const { data: myTickets } = await supabaseClient
                .from('team_tickets')
                .select('id')
                .eq('owner_id', userId);
            
            if (myTickets && myTickets.length > 0) {
                const ticketIds = myTickets.map(t => t.id);
                const { count: incomingCount } = await supabaseClient
                    .from('team_requests')
                    .select('*', { count: 'exact', head: true })
                    .in('ticket_id', ticketIds)
                    .eq('status', 'pending');

                if (incomingCount > 0) {
                    teamsBtn.classList.add('has-request');
                    teamsBtn.innerText = "Teams (Join Request!)";
                    return;
                }
            }

            const { count: acceptedCount } = await supabaseClient
                .from('team_requests')
                .select('*', { count: 'exact', head: true })
                .eq('sender_id', userId)
                .eq('status', 'accepted');

            if (acceptedCount > 0) {
                teamsBtn.classList.add('has-message');
                teamsBtn.innerText = "Teams (Request Accepted!)";
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'o') {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    location.href = 'connections.html';
                }
            }
        });

        function goToMyProfile() {
            const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
            location.href = myProfile.handle ? `profile.html?u=${myProfile.handle}` : 'profile.html';
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = "login.html";
        }

        function openRatioModal() {
            document.getElementById('ratio-modal').style.display = 'flex';
        }

        function pickRatio(w, h) {
            localStorage.setItem('cc-new-comic-ratio', JSON.stringify({ w, h }));
            localStorage.removeItem('active_draft_id');
            // Hide ratio modal, show mode picker
            document.getElementById('ratio-modal').style.display = 'none';
            document.getElementById('mode-modal').style.display = 'flex';
        }

        function goToMode(mode) {
            if (mode === 'comic') {
                window.location.href = 'create.html';
            } else {
                window.location.href = 'story.html';
            }
        }
        checkUser();
    </script>

    <!-- ‚îÄ‚îÄ Canvas Ratio Picker ‚îÄ‚îÄ -->
    <div id="ratio-modal">
        <h2>CHOOSE CANVAS FORMAT</h2>
        <p>Pick the frame shape for your comic. Set by creator ‚Äî can't change later.</p>
        <div class="ratio-grid">
            <button class="ratio-btn" onclick="pickRatio(1,1)">
                <div class="ratio-preview" style="width:36px;height:36px;"></div>1:1
            </button>
            <button class="ratio-btn" onclick="pickRatio(16,9)">
                <div class="ratio-preview" style="width:44px;height:25px;"></div>16:9
            </button>
            <button class="ratio-btn" onclick="pickRatio(9,16)">
                <div class="ratio-preview" style="width:25px;height:44px;"></div>9:16
            </button>
            <button class="ratio-btn" onclick="pickRatio(5,4)">
                <div class="ratio-preview" style="width:38px;height:30px;"></div>5:4
            </button>
            <button class="ratio-btn" onclick="pickRatio(4,5)">
                <div class="ratio-preview" style="width:30px;height:38px;"></div>4:5
            </button>
            <button class="ratio-btn" onclick="pickRatio(7,5)">
                <div class="ratio-preview" style="width:40px;height:29px;"></div>7:5
            </button>
            <button class="ratio-btn" onclick="pickRatio(5,7)">
                <div class="ratio-preview" style="width:29px;height:40px;"></div>5:7
            </button>
            <button class="ratio-btn" onclick="pickRatio(4,3)">
                <div class="ratio-preview" style="width:38px;height:29px;"></div>4:3
            </button>
            <button class="ratio-btn" onclick="pickRatio(3,4)">
                <div class="ratio-preview" style="width:29px;height:38px;"></div>3:4
            </button>
            <button class="ratio-btn" onclick="pickRatio(5,3)">
                <div class="ratio-preview" style="width:40px;height:24px;"></div>5:3
            </button>
            <button class="ratio-btn" onclick="pickRatio(3,5)">
                <div class="ratio-preview" style="width:24px;height:40px;"></div>3:5
            </button>
            <button class="ratio-btn" onclick="pickRatio(3,2)">
                <div class="ratio-preview" style="width:40px;height:27px;"></div>3:2
            </button>
            <button class="ratio-btn" onclick="pickRatio(2,3)" style="grid-column:span 1;">
                <div class="ratio-preview" style="width:27px;height:40px;"></div>2:3
            </button>
        </div>
        <button class="ratio-cancel" onclick="document.getElementById('ratio-modal').style.display='none'">Cancel</button>
    </div>

    <!-- ‚îÄ‚îÄ Comic or Story Mode Picker ‚îÄ‚îÄ -->
    <div id="mode-modal" style="
        position:fixed; inset:0; background:rgba(0,0,0,0.96);
        z-index:10000; display:none; flex-direction:column;
        align-items:center; justify-content:center; gap:24px;
        backdrop-filter:blur(12px); padding:30px;
        font-family:'Inter',sans-serif;
    ">
        <div style="text-align:center;">
            <h2 style="margin:0; color:var(--accent); font-size:22px; letter-spacing:1px;">WHAT ARE YOU MAKING?</h2>
            <p style="margin:8px 0 0; color:#555; font-size:13px;">Choose your creation type</p>
        </div>
        <div style="display:flex; gap:16px; width:100%; max-width:360px;">
            <button onclick="goToMode('comic')" style="
                flex:1; background:#1a1a1a; border:2px solid #333; color:#fff;
                border-radius:20px; padding:28px 16px; cursor:pointer;
                display:flex; flex-direction:column; align-items:center; gap:12px;
                transition:0.2s; font-family:'Inter',sans-serif;
            " onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='#333'">
                <span style="font-size:40px;">üé®</span>
                <span style="font-weight:900; font-size:16px; color:var(--accent);">COMIC</span>
                <span style="font-size:11px; color:#666; line-height:1.5; text-align:center;">Frames, sprites, speech bubbles. Visual storytelling.</span>
            </button>
            <button onclick="goToMode('story')" style="
                flex:1; background:#1a1a1a; border:2px solid #333; color:#fff;
                border-radius:20px; padding:28px 16px; cursor:pointer;
                display:flex; flex-direction:column; align-items:center; gap:12px;
                transition:0.2s; font-family:'Inter',sans-serif;
            " onmouseover="this.style.borderColor='var(--teal)'" onmouseout="this.style.borderColor='#333'">
                <span style="font-size:40px;">üìñ</span>
                <span style="font-weight:900; font-size:16px; color:var(--teal);">STORY</span>
                <span style="font-size:11px; color:#666; line-height:1.5; text-align:center;">Write a novel or short story. Text-based, like a book.</span>
            </button>
        </div>
        <button onclick="document.getElementById('mode-modal').style.display='none'; document.getElementById('ratio-modal').style.display='flex';" style="
            background:none; border:1px solid #333; color:#555;
            padding:10px 28px; border-radius:50px; cursor:pointer;
            font-size:13px; font-weight:600; font-family:'Inter',sans-serif;
        ">‚Üê Back to Ratio</button>
    </div>
</body>

</html>
