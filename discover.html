<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ComicCore â€” Discover</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap">
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: 'Inter', sans-serif; background: #0f0f11; color: #f5f5f7; min-height: 100dvh; padding-bottom: 80px; }

/* â”€â”€ Header â”€â”€ */
.header {
position: sticky; top: 0; z-index: 200;
background: linear-gradient(to bottom, rgba(0,0,0,.98) 70%, transparent);
padding: 16px 16px 12px; backdrop-filter: blur(20px);
}
.header-row { display: flex; align-items: center; gap: 10px; }
.logo { font-size: 20px; font-weight: 900; color: #ff7a00; letter-spacing: 1px; flex: 1; }
.search-box {
flex: 1; background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.1);
color: #f5f5f7; padding: 8px 14px; border-radius: 24px;
font-family: inherit; font-size: 13px; outline: none; transition: .2s;
}
.search-box:focus { border-color: #ff7a00; background: rgba(255,255,255,.1); }
.search-box::placeholder { color: #444; }

/* â”€â”€ Nav tabs â”€â”€ */
.nav-tabs { display: flex; gap: 4px; margin-top: 10px; overflow-x: auto; padding-bottom: 2px; }
.nav-tabs::-webkit-scrollbar { display: none; }
.nav-tab {
flex-shrink: 0; padding: 6px 16px; border-radius: 20px;
font-size: 12px; font-weight: 700; cursor: pointer;
border: 1.5px solid #222; background: none; color: #555;
transition: .15s; white-space: nowrap;
}
.nav-tab.active { background: white; color: #000; border-color: white; }

/* â”€â”€ Sort/filter row â”€â”€ */
.filter-row { display: flex; gap: 6px; padding: 10px 16px 0; overflow-x: auto; }
.filter-row::-webkit-scrollbar { display: none; }
.filter-chip {
flex-shrink: 0; padding: 5px 14px; border-radius: 20px;
font-size: 11px; font-weight: 800; cursor: pointer;
border: 1.5px solid #1e1e1e; background: #111; color: #444;
transition: .15s; letter-spacing: .3px; white-space: nowrap;
}
.filter-chip.on { border-color: #ff7a00; color: #ff7a00; background: rgba(255,122,0,.08); }

/* â”€â”€ Creator search results â”€â”€ */
#creatorResultsSection { display: none; padding: 12px 16px 0; }
.creators-label { font-size: 10px; font-weight: 900; color: #333; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
.creators-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; }
.creators-row::-webkit-scrollbar { display: none; }
.creator-card { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: .15s; }
.creator-card:hover { opacity: .8; }
.creator-card img { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #ff7a00; object-fit: cover; background: #111; }
.creator-card div { font-size: 10px; font-weight: 700; color: #777; }

/* â”€â”€ Section labels â”€â”€ */
.section-label { font-size: 14px; font-weight: 900; color: #f5f5f7; padding: 16px 16px 8px; letter-spacing: .3px; }

/* â”€â”€ Comics grid â”€â”€ */
.comics-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 4px; padding: 0 4px;
}
@media (min-width: 480px) { .comics-grid { grid-template-columns: repeat(4, 1fr); } }
@media (min-width: 680px) { .comics-grid { grid-template-columns: repeat(5, 1fr); } }

.comic-tile {
position: relative; cursor: pointer; border-radius: 6px; overflow: hidden;
background: #111; aspect-ratio: .67;
transition: transform .2s, box-shadow .2s;
}
.comic-tile:active { transform: scale(.96); }
.comic-tile img.cover-img { width: 100%; height: 100%; object-fit: cover; display: block; background: #0a0a0a; }
.comic-tile .no-cover {
width: 100%; height: 100%; display: flex; align-items: center;
justify-content: center; font-size: 28px; background: linear-gradient(135deg,#0f0f11,#1a1a1e);
}
.tile-progress { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,.1); }
.tile-progress-fill { height: 100%; background: #ff7a00; transition: width .3s; }
.tile-stars {
position: absolute; top: 5px; right: 5px;
background: rgba(0,0,0,.75); color: #ffd700;
font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 10px;
backdrop-filter: blur(4px);
}
.tile-mine {
position: absolute; top: 5px; left: 5px;
background: rgba(255,122,0,.85); color: #000;
font-size: 8px; font-weight: 900; padding: 2px 6px; border-radius: 10px;
}
.tile-new {
position: absolute; top: 5px; left: 5px;
background: rgba(50,215,75,.85); color: #000;
font-size: 8px; font-weight: 900; padding: 2px 6px; border-radius: 10px;
}

/* â”€â”€ Creator avatar on tile (bottom left) â”€â”€ */
.tile-creator-avatar {
position: absolute; bottom: 26px; left: 6px;
width: 28px; height: 28px; border-radius: 50%;
border: 2px solid rgba(255,255,255,.25);
object-fit: cover; background: #222;
cursor: pointer; z-index: 10;
transition: border-color .2s, transform .15s;
}
.tile-creator-avatar:hover { border-color: #ff7a00; transform: scale(1.1); }
.tile-creator-info {
position: absolute; bottom: 26px; left: 40px;
display: flex; align-items: center; gap: 5px; z-index: 10;
opacity: 0; transition: opacity .2s; pointer-events: none;
}
.comic-tile:hover .tile-creator-info { opacity: 1; pointer-events: auto; }
.tile-creator-handle {
font-size: 9px; font-weight: 900; color: white;
background: rgba(0,0,0,.7); padding: 2px 6px; border-radius: 8px;
backdrop-filter: blur(4px); white-space: nowrap;
}
.tile-follow-btn {
font-size: 8px; font-weight: 900; color: #000;
background: #ff7a00; border: none; padding: 2px 7px;
border-radius: 8px; cursor: pointer; white-space: nowrap;
transition: .15s;
}
.tile-follow-btn.following { background: rgba(255,255,255,.15); color: white; }
.tile-follow-btn:hover { opacity: .85; }

/* â”€â”€ Popup overlay â”€â”€ */
.popup-overlay {
position: fixed; inset: 0; z-index: 1000;
background: rgba(0,0,0,.85); backdrop-filter: blur(8px);
display: none; align-items: flex-end; justify-content: center;
}
.popup-overlay.open { display: flex; }
.popup-sheet {
background: #141416; border-radius: 20px 20px 0 0;
border-top: 1px solid #222; width: 100%; max-width: 560px;
max-height: 88dvh; overflow-y: auto; position: relative;
animation: slideUp .3s cubic-bezier(.4,0,.2,1);
}
.popup-sheet::-webkit-scrollbar { display: none; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.popup-cover { width: 100%; aspect-ratio: 1.6; object-fit: cover; display: block; background: #0a0a0a; border-radius: 20px 20px 0 0; }
.popup-cover-placeholder {
width: 100%; aspect-ratio: 1.6; background: linear-gradient(135deg,#111,#1a1a2e);
display: flex; align-items: center; justify-content: center; font-size: 52px;
border-radius: 20px 20px 0 0;
}
.popup-close {
position: absolute; top: 12px; right: 12px;
background: rgba(0,0,0,.7); border: none; color: white;
width: 32px; height: 32px; border-radius: 50%;
font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
backdrop-filter: blur(8px); z-index: 2;
}
.popup-body { padding: 16px 18px 28px; }
.popup-title { font-size: 20px; font-weight: 900; margin: 0 0 4px; letter-spacing: -.3px; }
.popup-creator { font-size: 12px; color: #555; margin-bottom: 12px; font-weight: 700; }
.popup-creator a { color: #ff7a00; text-decoration: none; }
.popup-meta-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
.popup-meta-chip { background: #1e1e20; border-radius: 8px; padding: 4px 10px; font-size: 11px; font-weight: 700; color: #888; }
.popup-desc { font-size: 13px; line-height: 1.6; color: #aaa; margin-bottom: 14px; }
.popup-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 18px; }
.popup-tag { background: #1a1a1c; border: 1px solid #2a2a2c; border-radius: 20px; padding: 3px 10px; font-size: 11px; color: #666; font-weight: 700; }
.popup-btns { display: flex; gap: 8px; flex-wrap: wrap; }
.read-btn {
flex: 1; background: white; color: #000; border: none;
padding: 13px; border-radius: 10px; font-size: 14px; font-weight: 900;
cursor: pointer; transition: .15s; letter-spacing: .3px; min-width: 120px;
}
.read-btn:hover { background: #e8e8e8; }
.popup-icon-btn {
background: #1e1e20; border: 1.5px solid #2a2a2c; color: #888;
padding: 13px 16px; border-radius: 10px; font-size: 16px; cursor: pointer;
transition: .15s; min-width: 50px; text-align: center;
}
.popup-icon-btn:hover { background: #2a2a2c; }
.popup-icon-btn.starred { background: rgba(255,215,0,.12); border-color: #ffd700; color: #ffd700; }
.popup-edit-btn {
background: #1e1e20; border: 1.5px solid #00d2ff; color: #00d2ff;
padding: 13px 16px; border-radius: 10px; font-size: 12px; font-weight: 900;
cursor: pointer; white-space: nowrap;
}
.popup-delete-btn {
background: #1e1e20; border: 1.5px solid #ff3b30; color: #ff3b30;
padding: 13px 16px; border-radius: 10px; font-size: 12px; font-weight: 900;
cursor: pointer; white-space: nowrap;
}
.popup-progress-wrap { margin: 12px 0 0; }
.popup-progress-bar { height: 3px; background: #1e1e1e; border-radius: 2px; overflow: hidden; }
.popup-progress-fill { height: 100%; background: #ff7a00; transition: width .3s; }
.popup-progress-label { font-size: 10px; color: #444; font-weight: 700; margin-top: 4px; }

/* â”€â”€ Comments overlay â”€â”€ */
.comment-overlay {
position: fixed; inset: 0; z-index: 2000;
background: rgba(0,0,0,.88); backdrop-filter: blur(8px);
display: none; align-items: flex-end; justify-content: center;
}
.comment-overlay.open { display: flex; }
.comment-sheet {
background: #1c1c1e; width: 100%; max-width: 500px;
border-radius: 20px 20px 0 0; padding: 20px 18px 0;
max-height: 75vh; display: flex; flex-direction: column;
border: 1px solid #2c2c2e; animation: slideUp .3s cubic-bezier(.4,0,.2,1);
}
.comment-sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.comment-sheet-header span { font-weight: 900; font-size: 15px; }
.comment-sheet-header button { background: none; border: none; color: #f5f5f7; font-size: 22px; cursor: pointer; }
.comment-list { flex: 1; overflow-y: auto; }
.comment-item { padding: 10px 0; border-bottom: 1px solid #2c2c2e; display: flex; gap: 10px; align-items: flex-start; }
.comment-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; border: 1px solid #2a2a2c; cursor: pointer; }
.comment-content { flex: 1; }
.comment-user { font-size: 11px; font-weight: 800; color: #ff7a00; margin-bottom: 3px; cursor: pointer; }
.comment-user:hover { text-decoration: underline; }
.comment-text-body { font-size: 13px; color: #f5f5f7; }
.comment-reaction-img { max-width: 120px; max-height: 120px; border-radius: 8px; margin-top: 6px; display: block; object-fit: contain; }
.comment-empty { text-align: center; padding: 24px; color: #444; font-size: 12px; font-weight: 700; }

/* Comment input area */
.comment-input-area { border-top: 1px solid #2c2c2e; margin-top: auto; }
.comment-input-row { display: flex; gap: 8px; padding: 10px 0 calc(14px + env(safe-area-inset-bottom)); }
.comment-input-row input {
flex: 1; background: #1c1c1e; border: 1px solid #2c2c2e; color: #f5f5f7;
padding: 10px 14px; border-radius: 12px; font-family: inherit; font-size: 13px; outline: none;
}
.comment-input-row input:focus { border-color: #ff7a00; }
.post-btn { background: #ff7a00; border: none; color: #000; padding: 10px 16px; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 13px; }
.reaction-toggle-btn {
background: #1e1e20; border: 1px solid #2a2a2c; color: #aaa;
padding: 10px 12px; border-radius: 12px; font-size: 16px; cursor: pointer;
transition: .15s; flex-shrink: 0;
}
.reaction-toggle-btn.active { border-color: #ff7a00; color: #ff7a00; background: rgba(255,122,0,.1); }

/* Reaction image tray */
.reaction-tray {
display: none; padding: 10px 0 4px;
border-top: 1px solid #2c2c2e;
}
.reaction-tray.open { display: block; }
.reaction-tray-header {
display: flex; align-items: center; justify-content: space-between;
margin-bottom: 8px; padding: 0 2px;
}
.reaction-tray-title { font-size: 10px; font-weight: 900; color: #555; text-transform: uppercase; letter-spacing: 1px; }
.reaction-tray-manage { font-size: 10px; font-weight: 800; color: #ff7a00; cursor: pointer; text-decoration: none; }
.reaction-grid {
display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;
max-height: 180px; overflow-y: auto;
}
.reaction-grid::-webkit-scrollbar { width: 3px; }
.reaction-grid::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
.reaction-img-btn {
aspect-ratio: 1; background: #111; border-radius: 8px; overflow: hidden;
border: 1.5px solid transparent; cursor: pointer; transition: .15s; padding: 0;
}
.reaction-img-btn:hover { border-color: #ff7a00; transform: scale(1.05); }
.reaction-img-btn img { width: 100%; height: 100%; object-fit: cover; display: block; }
.reaction-tray-empty { color: #444; font-size: 11px; font-weight: 700; text-align: center; padding: 16px; grid-column: 1/-1; }

/* â”€â”€ Share sheet â”€â”€ */
.share-overlay {
position: fixed; inset: 0; background: rgba(0,0,0,.88); z-index: 2000;
display: none; flex-direction: column; align-items: center; justify-content: flex-end;
}
.share-overlay.open { display: flex; }
.share-sheet-inner {
background: #1c1c1e; width: 100%; max-width: 500px;
border-radius: 20px 20px 0 0; padding: 20px;
max-height: 70vh; display: flex; flex-direction: column; border: 1px solid #2c2c2e;
animation: slideUp .3s cubic-bezier(.4,0,.2,1);
}
.friend-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #2c2c2e; }
.friend-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #222; }
.friend-name { font-size: 13px; font-weight: 700; }
.friend-handle { font-size: 11px; color: #555; }
.send-btn { background: #ff7a00; border: none; color: #000; padding: 7px 16px; border-radius: 20px; font-weight: 900; cursor: pointer; font-size: 12px; }

/* â”€â”€ Stories â”€â”€ */
.story-card { display: flex; gap: 14px; padding: 14px 16px; border-bottom: 1px solid #2c2c2e; cursor: pointer; transition: .15s; }
.story-card:hover { background: rgba(255,255,255,.03); }
.story-cover { width: 70px; height: 90px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
.story-cover-placeholder { width: 70px; height: 90px; background: #111; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
.story-title { font-weight: 900; font-size: 14px; margin-bottom: 3px; }
.story-author { font-size: 11px; color: #ff7a00; text-decoration: none; }
.story-desc { font-size: 12px; color: #666; margin-top: 4px; line-height: 1.4; }
.story-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 11px; color: #444; font-weight: 700; }
.empty-feed { padding: 48px 20px; text-align: center; color: #2a2a2a; font-size: 13px; line-height: 1.8; }

/* â”€â”€ Toast â”€â”€ */
.toast {
position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
background: #1c1c1e; border: 1px solid #3a3a3c; color: #fff;
padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 700;
opacity: 0; transition: .25s; z-index: 9999; white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€ Bottom nav â”€â”€ */
.bottom-nav {
position: fixed; bottom: 0; left: 0; right: 0;
background: rgba(0,0,0,.95); border-top: 1px solid #2c2c2e;
display: flex; justify-content: space-around; padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
z-index: 500; backdrop-filter: blur(12px);
}
.nav-item { font-size: 22px; cursor: pointer; opacity: .4; text-decoration: none; color: #f5f5f7; transition: .15s; }
.nav-item.active { opacity: 1; color: #ff7a00; }
</style>

</head>
<body>

<!-- Header -->

<div class="header">
  <div class="header-row">
    <span class="logo">COMICCORE</span>
    <input class="search-box" id="tagSearch" placeholder="Search comics, creatorsâ€¦" oninput="filterSearch()">
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" id="tab-all"      onclick="switchTab('all')">Comics</button>
    <button class="nav-tab"        id="tab-stories"  onclick="switchTab('stories')">Stories</button>
    <button class="nav-tab"        id="tab-projects" onclick="switchTab('projects')">Teams</button>
  </div>
</div>

<!-- Creator search results -->

<div id="creatorResultsSection">
  <div class="creators-label">Creators</div>
  <div class="creators-row" id="creatorResults"></div>
</div>

<!-- Main sections -->

<div id="section-recents">
  <div class="filter-row">
    <button class="filter-chip on" id="chip-recent"  onclick="setSort('recent')">ğŸ• Most Recent</button>
    <button class="filter-chip"   id="chip-popular" onclick="setSort('popular')">ğŸ”¥ Most Popular</button>
    <button class="filter-chip"   id="chip-oldest"  onclick="setSort('oldest')">ğŸ“… Oldest First</button>
  </div>
  <div class="section-label" id="comics-label">Latest Comics</div>
  <div class="comics-grid" id="recentFeed"></div>
</div>

<div id="section-stories" style="display:none;">
  <div id="storiesFeed"></div>
</div>
<div id="section-projects" style="display:none;">
  <div class="section-label">Team Projects</div>
  <div class="comics-grid" id="projectsFeed"></div>
</div>

<!-- â”€â”€ Comic Detail Popup â”€â”€ -->

<div class="popup-overlay" id="popup-overlay" onclick="if(event.target===this)closePopup()">
  <div class="popup-sheet" id="popup-sheet">
    <button class="popup-close" onclick="closePopup()">âœ•</button>
    <div id="popup-cover-wrap"></div>
    <div class="popup-body">
      <div class="popup-title"   id="popup-title"></div>
      <div class="popup-creator" id="popup-creator"></div>
      <div class="popup-meta-row" id="popup-meta"></div>
      <div class="popup-desc"   id="popup-desc"></div>
      <div class="popup-tags"   id="popup-tags"></div>
      <div id="popup-progress-wrap" class="popup-progress-wrap" style="display:none;">
        <div class="popup-progress-bar"><div class="popup-progress-fill" id="popup-progress-fill"></div></div>
        <div class="popup-progress-label" id="popup-progress-label"></div>
      </div>
      <div class="popup-btns" id="popup-btns"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ Comments overlay â”€â”€ -->

<div class="comment-overlay" id="comment-overlay" onclick="if(event.target===this)closeCommentSheet()">
  <div class="comment-sheet" onclick="event.stopPropagation()">
    <div class="comment-sheet-header">
      <span>Comments</span>
      <button onclick="closeCommentSheet()">âœ•</button>
    </div>
    <div class="comment-list" id="commentList">
      <div class="comment-empty">Loadingâ€¦</div>
    </div>
    <div class="comment-input-area">
      <!-- Reaction image tray -->
      <div class="reaction-tray" id="reaction-tray">
        <div class="reaction-tray-header">
          <span class="reaction-tray-title">ğŸ­ Reaction Images</span>
          <a href="commentimagessource.html" class="reaction-tray-manage">+ Manage</a>
        </div>
        <div class="reaction-grid" id="reaction-grid">
          <div class="reaction-tray-empty">No images yet.<br><a href="commentimagessource.html" style="color:#ff7a00;font-size:10px;">Add some â†’</a></div>
        </div>
      </div>
      <div class="comment-input-row">
        <button class="reaction-toggle-btn" id="reaction-toggle-btn" onclick="toggleReactionTray()" title="Reaction images">ğŸ­</button>
        <input id="commentInput" placeholder="Add a commentâ€¦" onkeydown="if(event.key==='Enter')postComment()">
        <button class="post-btn" onclick="postComment()">Post</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Share overlay â”€â”€ -->

<div class="share-overlay" id="shareOverlay" onclick="if(event.target===this)closeShareSheet()">
  <div class="share-sheet-inner" onclick="event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <span style="font-weight:900; font-size:15px;">Share: <span id="share-comic-title" style="color:#ff7a00;"></span></span>
      <button onclick="closeShareSheet()" style="background:none;border:none;color:#f5f5f7;font-size:22px;cursor:pointer;">âœ•</button>
    </div>
    <div id="share-friends-list" style="overflow-y:auto; flex:1;"></div>
  </div>
</div>

<!-- Toast -->

<div class="toast" id="toast"></div>

<!-- Bottom nav -->

<div class="bottom-nav">
  <a href="index.html"    class="nav-item">ğŸ </a>
  <a href="discover.html" class="nav-item active">ğŸ”</a>
  <a href="teams.html"    class="nav-item">âš¡</a>
  <a href="messages.html" class="nav-item">ğŸ’¬</a>
  <a href="profile.html"  class="nav-item">ğŸ‘¤</a>
</div>

<script>
const _sb = supabase.createClient(
  'https://mmycqeejhguzhtzkyjaj.supabase.co',
  'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE'
);
const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{"handle":"guest"}');

let allComics       = [];
let activeComicId   = null;
let globalStars     = [];
let activePopupComic   = null;
let activePopupStarred = false;
let currentSort     = 'recent';
let storiesLoaded   = false;
let shareComicId    = null;
let shareComicTitle = null;
let toastTimer      = null;

// â”€â”€ Profile cache (to avoid re-fetching same profiles) â”€â”€â”€â”€
const profileCache = {};
async function getCachedProfile(handle) {
  if (profileCache[handle]) return profileCache[handle];
  const { data } = await _sb.from('profiles').select('pic, name').eq('handle', handle).maybeSingle();
  profileCache[handle] = data || { pic: '', name: handle };
  return profileCache[handle];
}

// â”€â”€ Connection/follow cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const connectionCache = {};
async function getConnectionStatus(targetHandle) {
  if (!myProfile.handle || myProfile.handle === 'guest') return 'guest';
  if (targetHandle === myProfile.handle) return 'self';
  const key = targetHandle;
  if (connectionCache[key] !== undefined) return connectionCache[key];
  const { data } = await _sb.from('connections')
    .select('status')
    .or(`and(sender_handle.eq.${myProfile.handle},receiver_handle.eq.${targetHandle}),and(sender_handle.eq.${targetHandle},receiver_handle.eq.${myProfile.handle})`)
    .maybeSingle();
  const status = data?.status || 'none';
  connectionCache[key] = status;
  return status;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s || '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

function timeAgo(d) {
  if (!d) return '';
  const sec = Math.floor((Date.now() - new Date(d)) / 1000);
  if (sec < 60) return 'Just now';
  const min = Math.floor(sec/60); if (min < 60) return min+'m ago';
  const hr  = Math.floor(min/60); if (hr  < 24) return hr +'h ago';
  const day = Math.floor(hr /24); if (day <  7) return day+'d ago';
  const wk  = Math.floor(day/7);  if (wk  <  4) return wk +'w ago';
  const mo  = Math.floor(day/30); if (mo  < 12) return mo +'mo ago';
  return Math.floor(day/365)+'y ago';
}

function exactDate(d) {
  if (!d) return 'Unknown';
  return new Date(d).toLocaleString('en-US',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
}

function isNewComic(d) {
  if (!d) return false;
  return (Date.now() - new Date(d)) < 1000 * 60 * 60 * 48;
}

function getProgress(comicId, totalFrames) {
  try {
    const s = localStorage.getItem('cc-progress-' + comicId);
    if (s === null || !totalFrames) return null;
    const f = parseInt(s);
    if (f <= 0 || f >= totalFrames - 1) return null;
    return { frame: f + 1, total: totalFrames, pct: Math.round(((f + 1) / totalFrames) * 100) };
  } catch(e) { return null; }
}

// â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSort(s) {
  currentSort = s;
  ['recent','popular','oldest'].forEach(k =>
    document.getElementById('chip-'+k).classList.toggle('on', k === s)
  );
  const labels = { recent:'Latest Comics', popular:'Most Popular', oldest:'Oldest First' };
  document.getElementById('comics-label').innerText = labels[s];
  renderComics(allComics, globalStars);
}

function sortedComics(comics, stars) {
  const c = [...comics];
  if (currentSort === 'popular') {
    return c.sort((a,b) =>
      stars.filter(s => s.receiver_hand === b.id).length -
      stars.filter(s => s.receiver_hand === a.id).length
    );
  } else if (currentSort === 'oldest') {
    return c.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
  }
  return c.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
}

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadFeeds();
  setupRealtime();
}

function setupRealtime() {
  _sb.channel('discover_realtime')
    .on('postgres_changes', { event:'*', schema:'public', table:'messages' }, () => {
      loadFeeds();
      if (activeComicId) fetchComments();
    })
    .subscribe();
}

async function loadFeeds() {
  const [{ data: comics }, { data: stars }, { data: teams }] = await Promise.all([
    _sb.from('comics').select('*').order('created_at', { ascending: false }),
    _sb.from('messages').select('receiver_hand, sender_handle').eq('reaction','â­'),
    _sb.from('team_tickets').select('*'),
  ]);

  allComics   = (comics || []).filter(c => c.title && (c.data?.length > 0 || c.cover));
  globalStars = stars || [];

  renderComics(allComics, globalStars);
  renderTeams(teams || []);
}

// â”€â”€ Render comics grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderComics(comics, stars) {
  const sorted    = sortedComics(comics, stars);
  const container = document.getElementById('recentFeed');
  if (!sorted.length) {
    container.innerHTML = '<div class="empty-feed" style="grid-column:1/-1;">No comics yet.<br>Be the first to publish!</div>';
    return;
  }
  container.innerHTML = sorted.map(c => {
    const starCount  = stars.filter(s => s.receiver_hand === c.id).length;
    const isMine     = c.owner_handle === myProfile.handle;
    const isNew      = isNewComic(c.created_at) && !isMine;
    const prog       = getProgress(c.id, (c.data||[]).length);
    const coverHtml  = c.cover
      ? `<img class="cover-img" src="${esc(c.cover)}" loading="lazy" onerror="this.parentNode.innerHTML='<div class=no-cover>ğŸ“–</div>'">`
      : `<div class="no-cover">ğŸ“–</div>`;
    const progressHtml = prog
      ? `<div class="tile-progress"><div class="tile-progress-fill" style="width:${prog.pct}%"></div></div>` : '';
    const badgeHtml  = isMine
      ? `<div class="tile-mine">MINE</div>`
      : (isNew ? `<div class="tile-new">NEW</div>` : '');
    const starsHtml  = starCount > 0 ? `<div class="tile-stars">â­ ${starCount}</div>` : '';

    // Creator avatar â€” use data-handle, will be hydrated async
    const ownerHandle = esc(c.owner_handle || 'unknown');
    const avatarHtml = `
      <img class="tile-creator-avatar" data-handle="${ownerHandle}"
        src="" alt="@${ownerHandle}"
        onclick="event.stopPropagation(); location.href='profile.html?u=${ownerHandle}'"
        onerror="this.style.display='none'">
      <div class="tile-creator-info">
        <span class="tile-creator-handle">@${ownerHandle}</span>
        ${!isMine && myProfile.handle !== 'guest' ? `<button class="tile-follow-btn" data-follow-handle="${ownerHandle}" onclick="event.stopPropagation(); tileFollow(this, '${ownerHandle}')">Follow</button>` : ''}
      </div>`;

    return `<div class="comic-tile" data-id="${esc(c.id)}">${coverHtml}${badgeHtml}${starsHtml}${progressHtml}${avatarHtml}</div>`;
  }).join('');

  // Attach click handlers
  container.querySelectorAll('.comic-tile').forEach(tile => {
    tile.addEventListener('click', () => openPopup(tile.dataset.id));
  });

  // Async-hydrate avatars
  hydrateAvatars(container);
  hydrateFollowButtons(container);
}

async function hydrateAvatars(container) {
  const avatars = container.querySelectorAll('.tile-creator-avatar[data-handle]');
  // Batch by unique handles
  const handles = [...new Set([...avatars].map(a => a.dataset.handle))];
  await Promise.all(handles.map(async handle => {
    const p = await getCachedProfile(handle);
    container.querySelectorAll(`.tile-creator-avatar[data-handle="${handle}"]`).forEach(img => {
      if (p?.pic) { img.src = p.pic; }
      else img.style.display = 'none';
    });
  }));
}

async function hydrateFollowButtons(container) {
  if (!myProfile.handle || myProfile.handle === 'guest') return;
  const btns = container.querySelectorAll('.tile-follow-btn[data-follow-handle]');
  const handles = [...new Set([...btns].map(b => b.dataset.followHandle))];
  await Promise.all(handles.map(async handle => {
    const status = await getConnectionStatus(handle);
    container.querySelectorAll(`.tile-follow-btn[data-follow-handle="${handle}"]`).forEach(btn => {
      if (status === 'accepted') { btn.textContent = 'Friends'; btn.classList.add('following'); btn.disabled = true; }
      else if (status === 'pending') { btn.textContent = 'Pending'; btn.classList.add('following'); }
      else { btn.textContent = 'Follow'; }
    });
  }));
}

async function tileFollow(btn, handle) {
  if (!myProfile.handle || myProfile.handle === 'guest') { showToast('Log in to follow!'); return; }
  btn.disabled = true;
  const status = connectionCache[handle];
  if (status === 'pending' || status === 'accepted') { showToast('Already connected!'); return; }

  const { error } = await _sb.from('connections').insert([{
    sender_handle: myProfile.handle,
    receiver_handle: handle,
    status: 'pending'
  }]);
  if (error) { showToast('Error sending request'); btn.disabled = false; return; }
  connectionCache[handle] = 'pending';
  btn.textContent = 'Pending';
  btn.classList.add('following');
  showToast(`ğŸ‘‹ Follow request sent to @${handle}`);
}

// â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openPopup(id) {
  const c = allComics.find(c => c.id === id);
  if (!c) return;
  activePopupComic = c;

  // Cover
  const coverWrap = document.getElementById('popup-cover-wrap');
  coverWrap.innerHTML = c.cover
    ? `<img class="popup-cover" src="${esc(c.cover)}" onerror="this.parentNode.innerHTML='<div class=popup-cover-placeholder>ğŸ“–</div>'">`
    : `<div class="popup-cover-placeholder">ğŸ“–</div>`;

  // Title & creator
  document.getElementById('popup-title').innerText   = c.title || 'Untitled';
  const ownerHandle = c.owner_handle || 'unknown';
  document.getElementById('popup-creator').innerHTML =
    `by <a href="profile.html?u=${esc(ownerHandle)}" onclick="event.stopPropagation()">@${esc(ownerHandle)}</a> Â· ${timeAgo(c.created_at)}`;

  // Meta
  const frameCount = (c.data||[]).length;
  const starCount  = globalStars.filter(s => s.receiver_hand === c.id).length;
  document.getElementById('popup-meta').innerHTML = `
    <span class="popup-meta-chip">ğŸ ${frameCount} page${frameCount!==1?'s':''}</span>
    <span class="popup-meta-chip">â­ ${starCount}</span>
    ${c.swipe_dir ? `<span class="popup-meta-chip">${c.swipe_dir==='vertical'?'â†• Vertical':'â†” Horizontal'}</span>` : ''}
    <span class="popup-meta-chip">ğŸ“… ${exactDate(c.created_at).split(',')[0]}</span>`;

  // Description
  const descEl = document.getElementById('popup-desc');
  descEl.innerText = c.description || '';
  descEl.style.display = c.description ? 'block' : 'none';

  // Tags
  const tags = c.tags || [];
  document.getElementById('popup-tags').innerHTML =
    tags.map(t => `<span class="popup-tag">#${esc(t)}</span>`).join('');

  // Progress
  const prog = getProgress(c.id, frameCount);
  const progWrap = document.getElementById('popup-progress-wrap');
  if (prog) {
    progWrap.style.display = 'block';
    document.getElementById('popup-progress-fill').style.width  = prog.pct + '%';
    document.getElementById('popup-progress-label').innerText   =
      `Reading progress: page ${prog.frame} of ${prog.total} (${prog.pct}%)`;
  } else {
    progWrap.style.display = 'none';
  }

  // Star state
  const isMine = c.owner_handle === myProfile.handle;
  activePopupStarred = false;
  if (myProfile.handle !== 'guest' && !isMine) {
    const { data: msg } = await _sb
      .from('messages').select('id')
      .eq('sender_handle', myProfile.handle)
      .eq('receiver_hand', c.id)
      .eq('reaction','â­')
      .maybeSingle();
    activePopupStarred = !!msg;
  }

  // Build buttons
  const btns = document.getElementById('popup-btns');
  btns.innerHTML = '';

  const readBtn = document.createElement('button');
  readBtn.className = 'read-btn';
  readBtn.innerHTML = prog ? 'â–¶ Continue' : 'â–¶ Read Now';
  readBtn.onclick = () => {
    closePopup();
    location.href = 'reader.html?id=' + encodeURIComponent(c.id);
  };
  btns.appendChild(readBtn);

  if (!isMine && myProfile.handle !== 'guest') {
    const starBtn = document.createElement('button');
    starBtn.className = 'popup-icon-btn' + (activePopupStarred ? ' starred' : '');
    starBtn.id        = 'popup-star-btn';
    starBtn.innerHTML = activePopupStarred ? 'â­' : 'â˜†';
    starBtn.title     = activePopupStarred ? 'Remove star' : 'Star this comic';
    starBtn.onclick   = () => popupToggleStar(c.id);
    btns.appendChild(starBtn);
  }

  const commentBtn = document.createElement('button');
  commentBtn.className = 'popup-icon-btn';
  commentBtn.innerHTML = 'ğŸ’¬';
  commentBtn.title     = 'Comments';
  commentBtn.onclick   = () => openCommentSheet(c.id);
  btns.appendChild(commentBtn);

  const shareBtn = document.createElement('button');
  shareBtn.className = 'popup-icon-btn';
  shareBtn.innerHTML = 'â†—';
  shareBtn.title     = 'Share';
  shareBtn.onclick   = () => openShareSheet(c.id, c.title);
  btns.appendChild(shareBtn);

  if (isMine) {
    const editBtn = document.createElement('button');
    editBtn.className = 'popup-edit-btn';
    editBtn.innerHTML = 'âœï¸ Edit';
    editBtn.onclick   = () => {
      closePopup();
      localStorage.setItem('edit_comic_id', c.id);
      location.href = 'create.html';
    };
    btns.appendChild(editBtn);

    const delBtn = document.createElement('button');
    delBtn.className = 'popup-delete-btn';
    delBtn.innerHTML = 'ğŸ—‘';
    delBtn.title     = 'Delete comic';
    delBtn.onclick   = () => deleteComic(c.id, c.title);
    btns.appendChild(delBtn);
  }

  document.getElementById('popup-overlay').classList.add('open');
}

function closePopup() {
  document.getElementById('popup-overlay').classList.remove('open');
  activePopupComic = null;
}

async function popupToggleStar(comicId) {
  if (myProfile.handle === 'guest') { showToast('Log in to star!'); return; }
  const btn = document.getElementById('popup-star-btn');
  if (activePopupStarred) {
    await _sb.from('messages').delete()
      .eq('sender_handle', myProfile.handle)
      .eq('receiver_hand', comicId)
      .eq('reaction','â­');
    activePopupStarred = false;
    if (btn) { btn.classList.remove('starred'); btn.innerHTML = 'â˜†'; }
    showToast('Star removed');
  } else {
    await _sb.from('messages').insert([{
      sender_handle: myProfile.handle,
      receiver_hand: comicId,
      content: 'â­', reaction: 'â­'
    }]);
    activePopupStarred = true;
    if (btn) { btn.classList.add('starred'); btn.innerHTML = 'â­'; }
    showToast('â­ Starred!');
  }
  loadFeeds();
}

async function deleteComic(id, title) {
  if (!confirm(`Delete "${title}"? This removes it from Discover permanently.`)) return;
  closePopup();
  await _sb.from('comics').delete().eq('id', id);
  allComics = allComics.filter(c => c.id !== id);
  renderComics(allComics, globalStars);
}

// â”€â”€ Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingReactionImg = null; // {name, src} to insert

function openCommentSheet(id) {
  activeComicId = id;
  pendingReactionImg = null;
  document.getElementById('comment-overlay').classList.add('open');
  // Close reaction tray on open
  document.getElementById('reaction-tray').classList.remove('open');
  document.getElementById('reaction-toggle-btn').classList.remove('active');
  fetchComments();
  loadReactionTray();
}

function closeCommentSheet() {
  document.getElementById('comment-overlay').classList.remove('open');
  activeComicId = null;
  pendingReactionImg = null;
}

function toggleReactionTray() {
  const tray = document.getElementById('reaction-tray');
  const btn  = document.getElementById('reaction-toggle-btn');
  const isOpen = tray.classList.toggle('open');
  btn.classList.toggle('active', isOpen);
}

function loadReactionTray() {
  const grid = document.getElementById('reaction-grid');
  const images = JSON.parse(localStorage.getItem('cc-reaction-images') || '[]');
  if (!images.length) {
    grid.innerHTML = `<div class="reaction-tray-empty">No images yet.<br><a href="commentimagessource.html" style="color:#ff7a00;font-size:10px;">Add some â†’</a></div>`;
    return;
  }
  grid.innerHTML = images.map((img, i) => `
    <button class="reaction-img-btn" title="${esc(img.name)}" onclick="selectReactionImage(${i})">
      <img src="${esc(img.src)}" alt="${esc(img.name)}" loading="lazy">
    </button>
  `).join('');
}

function selectReactionImage(index) {
  const images = JSON.parse(localStorage.getItem('cc-reaction-images') || '[]');
  const img = images[index];
  if (!img) return;
  pendingReactionImg = img;
  // Show preview in input
  document.getElementById('commentInput').placeholder = `ğŸ“ "${img.name}" selected â€” add text or post!`;
  document.getElementById('commentInput').value = '';
  // Close tray
  document.getElementById('reaction-tray').classList.remove('open');
  document.getElementById('reaction-toggle-btn').classList.remove('active');
  showToast(`ğŸ­ "${img.name}" selected`);
}

async function fetchComments() {
  const listEl = document.getElementById('commentList');
  listEl.innerHTML = '<div class="comment-empty">Loadingâ€¦</div>';

  const { data: comments, error } = await _sb
    .from('messages')
    .select('*')
    .eq('receiver_hand', activeComicId)
    .is('reaction', null)
    .order('created_at', { ascending: false });

  if (error) {
    listEl.innerHTML = '<div class="comment-empty">Could not load comments.</div>';
    return;
  }
  if (!comments || !comments.length) {
    listEl.innerHTML = '<div class="comment-empty">No comments yet. Be first!</div>';
    return;
  }

  listEl.innerHTML = '';
  for (const m of comments) {
    const p = await getCachedProfile(m.sender_handle);
    const isImgReaction = m.content && m.content.startsWith('[IMG_REACTION]:');
    let bodyHtml = '';
    if (isImgReaction) {
      const src = m.content.replace('[IMG_REACTION]:', '').trim();
      bodyHtml = `<img src="${esc(src)}" class="comment-reaction-img" loading="lazy">`;
      if (m.comment_text) bodyHtml += `<div style="margin-top:4px;">${esc(m.comment_text)}</div>`;
    } else {
      bodyHtml = `<div>${esc(m.content)}</div>`;
    }

    const item = document.createElement('div');
    item.className = 'comment-item';
    item.innerHTML = `
      <img src="${esc(p?.pic || '')}" class="comment-avatar" onclick="location.href='profile.html?u=${esc(m.sender_handle)}'" onerror="this.src=''">
      <div class="comment-content">
        <div class="comment-user" onclick="location.href='profile.html?u=${esc(m.sender_handle)}'">@${esc(m.sender_handle)}</div>
        ${bodyHtml}
      </div>`;
    listEl.appendChild(item);
  }
}

async function postComment() {
  const input = document.getElementById('commentInput');
  const text  = input.value.trim();
  if (!text && !pendingReactionImg) return;
  if (!myProfile.handle || myProfile.handle === 'guest') {
    showToast('Log in to comment!'); return;
  }

  let content = text;
  let extraFields = {};

  if (pendingReactionImg) {
    // Store the image src as a special comment type
    content = `[IMG_REACTION]:${pendingReactionImg.src}`;
    if (text) extraFields.comment_text = text;
  }

  const { error } = await _sb.from('messages').insert([{
    sender_handle: myProfile.handle,
    receiver_hand: activeComicId,
    content,
    ...extraFields
  }]);

  if (error) { showToast('Error posting comment'); return; }
  input.value = '';
  input.placeholder = 'Add a commentâ€¦';
  pendingReactionImg = null;
  fetchComments();
}

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function filterSearch() {
  const q = document.getElementById('tagSearch').value.toLowerCase().trim();
  const creatorSection = document.getElementById('creatorResultsSection');
  if (!q) {
    creatorSection.style.display = 'none';
    renderComics(allComics, globalStars);
    return;
  }
  const filtered = allComics.filter(c =>
    c.title?.toLowerCase().includes(q) ||
    (c.tags && c.tags.some(t => t.toLowerCase().includes(q))) ||
    c.owner_handle?.toLowerCase().includes(q)
  );
  renderComics(filtered, globalStars);

  const { data: profiles } = await _sb
    .from('profiles').select('*')
    .or(`handle.ilike.%${q}%,name.ilike.%${q}%`)
    .limit(8);
  if (profiles?.length) {
    creatorSection.style.display = 'block';
    document.getElementById('creatorResults').innerHTML = profiles.map(p => `
      <div class="creator-card" onclick="location.href='profile.html?u=${esc(p.handle)}'">
        <img src="${esc(p.pic||'')}" onerror="this.src=''">
        <div>@${esc(p.handle)}</div>
      </div>`).join('');
  } else {
    creatorSection.style.display = 'none';
  }
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(type) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+type).classList.add('active');
  document.getElementById('section-recents').style.display  = type === 'all'      ? 'block' : 'none';
  document.getElementById('section-stories').style.display  = type === 'stories'  ? 'block' : 'none';
  document.getElementById('section-projects').style.display = type === 'projects' ? 'block' : 'none';
  if (type === 'stories' && !storiesLoaded) loadStories();
}

async function loadStories() {
  const feed = document.getElementById('storiesFeed');
  feed.innerHTML = '<div class="empty-feed">Loading storiesâ€¦</div>';
  const { data: stories, error } = await _sb.from('stories').select('*').order('created_at', { ascending: false });
  if (error || !stories?.length) {
    feed.innerHTML = '<div class="empty-feed">No stories yet. Be the first!</div>'; return;
  }
  storiesLoaded = true;
  feed.innerHTML = stories.map(s => `
    <div class="story-card" onclick="location.href='story-reader.html?id=${esc(s.id)}'">
      ${s.cover ? `<img src="${esc(s.cover)}" class="story-cover">` : `<div class="story-cover-placeholder">ğŸ“–</div>`}
      <div>
        <div class="story-title">${esc(s.title)}</div>
        <a href="profile.html?u=${esc(s.owner_handle)}" class="story-author" onclick="event.stopPropagation()">@${esc(s.owner_handle)}</a>
        ${s.description ? `<div class="story-desc">${esc(s.description)}</div>` : ''}
        <div class="story-meta"><span>ğŸ“„ ${s.page_count||1} pages</span><span>${timeAgo(s.created_at)}</span></div>
      </div>
    </div>`).join('');
}

function renderTeams(teams) {
  document.getElementById('projectsFeed').innerHTML = teams.length
    ? teams.map(t => `<div class="comic-tile" onclick="location.href='teams.html'" style="cursor:pointer;">
        <img src="${esc(t.pfp||'')}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentNode.innerHTML='<div class=no-cover>âš¡</div>'">
        <div style="position:absolute;bottom:6px;left:0;right:0;text-align:center;font-size:10px;font-weight:900;color:white;background:rgba(0,0,0,.7);padding:3px;">${esc(t.team_name)}</div>
      </div>`).join('')
    : '<div class="empty-feed" style="grid-column:1/-1;">No team projects yet.</div>';
}

// â”€â”€ Share (friend DM) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShareSheet(comicId, comicTitle) {
  shareComicId    = comicId;
  shareComicTitle = comicTitle;
  document.getElementById('share-comic-title').innerText = comicTitle;
  document.getElementById('shareOverlay').classList.add('open');
  loadShareFriends();
}

function closeShareSheet() {
  document.getElementById('shareOverlay').classList.remove('open');
  shareComicId = null; shareComicTitle = null;
}

async function loadShareFriends() {
  const list = document.getElementById('share-friends-list');
  list.innerHTML = '<div style="padding:20px;text-align:center;color:#555;">Loadingâ€¦</div>';
  if (!myProfile.handle || myProfile.handle === 'guest') {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">Log in to share.</div>'; return;
  }
  const { data: conns } = await _sb
    .from('connections').select('*')
    .or(`sender_handle.eq.${myProfile.handle},receiver_handle.eq.${myProfile.handle}`)
    .eq('status','accepted');
  if (!conns?.length) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">No connections yet.</div>'; return;
  }
  list.innerHTML = '';
  for (const conn of conns) {
    const friendHandle = conn.sender_handle === myProfile.handle ? conn.receiver_handle : conn.sender_handle;
    const p = await getCachedProfile(friendHandle);
    const row = document.createElement('div');
    row.className = 'friend-row';
    row.id = 'friend-row-' + friendHandle;
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="${esc(p?.pic||'')}" class="friend-pic" onerror="this.style.display='none'">
        <div>
          <div class="friend-name">${esc(p?.name||friendHandle)}</div>
          <div class="friend-handle">@${esc(friendHandle)}</div>
        </div>
      </div>
      <button class="send-btn" onclick="sendShare('${esc(friendHandle)}')">Send</button>`;
    list.appendChild(row);
  }
}

async function sendShare(toHandle) {
  const btn = document.querySelector(`#friend-row-${toHandle} .send-btn`);
  if (btn) { btn.disabled = true; btn.innerText = 'â€¦'; }
  const readerUrl = `reader.html?id=${encodeURIComponent(shareComicId)}`;
  await _sb.from('messages').insert([{
    sender_handle: myProfile.handle,
    receiver_handle: toHandle,
    content: `[SHARE]: ${shareComicTitle}! (Link: ${readerUrl})`
  }]);
  if (btn) { btn.innerText = 'Sent âœ“'; btn.style.background = '#32d74b'; btn.style.color = '#000'; }
  showToast('Shared!');
}

window.onload = init;
</script>

</body>
</html>
