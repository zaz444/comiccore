<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore | Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        /* colors now in theme.css */
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); display: flex; align-items: center; gap: 15px; z-index: 10; }
        .back-btn { cursor: pointer; font-size: 20px; }
        #chatPic { width: 38px; height: 38px; border-radius: 50%; background: #222; background-size: cover; border: 1px solid var(--border); }

        #chatContainer { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        /* --- MESSAGE ROWS --- */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); position: relative; }
        .mine { justify-content: flex-end; }
        .theirs { justify-content: flex-start; }
        .msg-row.slid { transform: translateX(-45px); }

        .pfp-mini { width: 28px; height: 28px; border-radius: 50%; background: #222; background-size: cover; flex-shrink: 0; border: 1px solid var(--border); }
        .mine .pfp-mini { display: none; }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .mine .bubble { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .theirs .bubble { background: #222; color: #fff; border-bottom-left-radius: 4px; }
        
        /* --- SHARED COMIC CARD UI --- */
        .share-card { background: #1a1a1a !important; border: 1px solid var(--border); padding: 0 !important; overflow: hidden; cursor: pointer; border-radius: 12px !important; }
        .share-header { background: var(--accent); color: #000; padding: 4px 10px; font-size: 10px; font-weight: 800; display: flex; justify-content: space-between; }
        .share-body { padding: 12px; }
        .share-title { font-weight: 800; font-size: 13px; color: #fff; display: block; }
        .share-sub { font-size: 11px; color: #777; margin-top: 2px; }

        .edited-tag { font-size: 9px; opacity: 0.5; margin-top: 2px; font-weight: 800; }
        .fwd-tag { font-size: 9px; opacity: 0.5; margin-bottom: 4px; font-weight: 800; }

        .msg-actions { position: absolute; right: -35px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #555; opacity: 0; transition: 0.2s; }
        .slid .msg-actions { opacity: 1; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .menu-card { background: #111; border: 1px solid var(--border); border-radius: 24px; width: 280px; overflow: hidden; }
        
        .reaction-badge { position: absolute; bottom: -8px; right: 8px; background: #1a1a1a; border: 1px solid var(--border); border-radius: 10px; padding: 2px 6px; font-size: 11px; z-index: 2; }

        .input-area { padding: 15px 20px 30px; background: #000; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .input-area input { flex: 1; background: #111; border: 1px solid var(--border); border-radius: 25px; padding: 12px 18px; color: white; outline: none; }
        .btn-round { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; background: #222; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    </style>
</head>
<body>

    <div id="menuOverlay" class="overlay" onclick="closeOverlays()">
        <div class="menu-card" id="menuCard" onclick="event.stopPropagation()"></div>
    </div>

    <div class="header">
        <span class="back-btn" onclick="location.href='connections.html'">‚¨ÖÔ∏è</span>
        <div id="chatPic"></div>
        <h3 id="headerTitle" style="margin:0; font-size:15px;">...</h3>
    </div>

    <div id="chatContainer"></div>

    <div class="input-area">
        <button class="btn-round" onclick="document.getElementById('imageInput').click()">üì∑</button>
        <input type="text" id="msgInput" placeholder="Message..." autocomplete="off">
        <button class="btn-round" style="background:var(--accent); color:#000;" onclick="sendMessage()">üöÄ</button>
        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImage(this)">
    </div>

    <script>
        const supabaseUrl = 'https://mmycqeejhguzhtzkyjaj.supabase.co';
        const supabaseKey = 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
        const myHandle = myProfile.handle;
        const urlParams = new URLSearchParams(window.location.search);
        const activeChatPartner = urlParams.get('to');
        
        let partnerPFP = "";
        let activeMsg = null;

        async function init() {
            // Privacy gate ‚Äî if user disabled DMs in settings, block access
            if (localStorage.getItem('cc-privacy-dm') === 'false') {
                document.body.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#000;color:#fff;text-align:center;gap:16px;">
                        <div style="font-size:48px">üîí</div>
                        <h2 style="margin:0">Direct Messages is Disabled</h2>
                        <p style="color:#666;margin:0">You've turned this off in Settings.</p>
                        <a href="settings.html" style="background:#FF7A00;color:#000;padding:12px 24px;border-radius:24px;font-weight:700;text-decoration:none;margin-top:8px">Go to Settings</a>
                        <a href="index.html" style="color:#666;font-size:13px">‚Üê Back Home</a>
                    </div>`;
                return;
            }
            if (!activeChatPartner || !myHandle) return;
            const { data: p } = await _supabase.from('profiles').select('name, pic').eq('handle', activeChatPartner).single();
            if (p) {
                document.getElementById('headerTitle').innerText = p.name;
                partnerPFP = p.pic || "";
                if (p.pic) document.getElementById('chatPic').style.backgroundImage = `url(${p.pic})`;
            }
            await loadMessages();
            setupRealtime();
        }

        function setupRealtime() {
            // Use a unique channel name per conversation to avoid conflicts
            const channelName = `dm_${[myHandle, activeChatPartner].sort().join('_')}`;
            _supabase.channel(channelName).on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
                if (payload.eventType === 'INSERT') {
                    const m = payload.new;
                    if ((m.sender_handle === myHandle && m.receiver_handle === activeChatPartner) || 
                        (m.sender_handle === activeChatPartner && m.receiver_handle === myHandle)) {
                        appendMessage(m);
                        // Mark incoming messages as read immediately
                        if (m.sender_handle === activeChatPartner && !m.is_read) {
                            _supabase.from('messages').update({ is_read: true }).eq('id', m.id);
                        }
                    }
                } else if (payload.eventType === 'UPDATE') {
                    updateMsgUI(payload.new);
                }
            }).subscribe();
        }

        async function markAllRead() {
            if (!activeChatPartner || !myHandle) return;
            await _supabase.from('messages')
                .update({ is_read: true })
                .eq('sender_handle', activeChatPartner)
                .eq('receiver_handle', myHandle)
                .eq('is_read', false);
        }

        function isImageContent(text) {
            if (text.startsWith('data:image')) return true;
            return text.match(/\.(jpeg|jpg|gif|png|webp|svg)/i) && text.startsWith('http');
        }

        function buildMessageHTML(m) {
            let text = m.content;
            let html = "";

            if (text.startsWith('[FWD]: ')) {
                html += `<div class="fwd-tag">‚û• FORWARDED</div>`;
                text = text.substring(7);
            }

            // --- SHARED COMIC LOGIC ---
            if (text.startsWith('[SHARE]: ')) {
                let shareData = text.substring(9);
                let comicTitle = shareData.split('! (Link:')[0] || "Shared Comic";
                let comicLink = shareData.includes('link=') ? shareData.split('link=')[1] : "discover.html";

                html += `
                <div class="bubble share-card" onclick="location.href='${comicLink}'">
                    <div class="share-header"><span>COMICCORE</span> <span>OPEN üìñ</span></div>
                    <div class="share-body">
                        <span class="share-title">${comicTitle}</span>
                        <span class="share-sub">Tap to read this comic on ComicCore</span>
                    </div>
                </div>`;
            } 
            else if (isImageContent(text)) {
                html += `<div class="bubble" style="padding:4px;"><img src="${text}" style="width:100%; border-radius:14px; display:block;"></div>`;
            } 
            else {
                html += `<div class="bubble"><span>${text}</span></div>`;
            }

            if (m.reaction) html += `<div class="reaction-badge">${m.reaction}</div>`;
            if (m.is_edited) html += `<div class="edited-tag">EDITED</div>`;
            return html;
        }

        async function loadMessages() {
            const { data } = await _supabase.from('messages').select('*')
                .or(`and(sender_handle.eq.${myHandle},receiver_handle.eq.${activeChatPartner}),and(sender_handle.eq.${activeChatPartner},receiver_handle.eq.${myHandle})`)
                .order('created_at', { ascending: true });
            document.getElementById('chatContainer').innerHTML = "";
            data?.forEach(appendMessage);
            // Mark all received messages as read
            markAllRead();
        }

        function appendMessage(m) {
            if (document.getElementById(`row-${m.id}`)) return;
            const isMine = m.sender_handle === myHandle;
            const row = document.createElement('div');
            row.className = `msg-row ${isMine ? 'mine' : 'theirs'}`;
            row.id = `row-${m.id}`;
            row.ondblclick = () => {
                document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('slid'));
                row.classList.add('slid');
            };

            const pfp = document.createElement('div');
            pfp.className = 'pfp-mini';
            if (partnerPFP) pfp.style.backgroundImage = `url(${partnerPFP})`;

            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            wrapper.innerHTML = buildMessageHTML(m);
            
            const actions = document.createElement('div');
            actions.className = 'msg-actions';
            actions.innerHTML = '‚ãÆ';
            actions.onclick = (e) => { e.stopPropagation(); openMenu(m, isMine); };

            row.appendChild(pfp);
            row.appendChild(wrapper);
            row.appendChild(actions);
            
            const container = document.getElementById('chatContainer');
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        function openMenu(m, isMine) {
            activeMsg = m;
            const menu = document.getElementById('menuCard');
            menu.innerHTML = `
                <div style="display:flex; justify-content:center; gap:10px; padding:15px; border-bottom:1px solid var(--border);">
                    <span onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="react('üòÇ')">üòÇ</span>
                    <span onclick="react('üî•')">üî•</span><span onclick="react('üòÆ')">üòÆ</span>
                </div>
                <div class="menu-item" style="padding:15px; cursor:pointer;" onclick="deleteMsg(${m.id})">üóëÔ∏è Delete</div>
            `;
            document.getElementById('menuOverlay').style.display = 'flex';
        }

        async function react(emoji) {
            const toggle = activeMsg.reaction === emoji ? null : emoji;
            await _supabase.from('messages').update({ reaction: toggle }).eq('id', activeMsg.id);
            closeOverlays();
        }

        async function deleteMsg(id) {
            await _supabase.from('messages').delete().eq('id', id);
            document.getElementById(`row-${id}`)?.remove();
            closeOverlays();
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const val = input.value.trim();
            if (!val) return;
            input.value = "";
            await _supabase.from('messages').insert([{ sender_handle: myHandle, receiver_handle: activeChatPartner, content: val }]);
        }

        async function handleImage(input) {
            const file = input.files[0];
            if (!file) return;
            // Convert to base64 and send as data URL in message content
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                await _supabase.from('messages').insert([{
                    sender_handle: myHandle,
                    receiver_handle: activeChatPartner,
                    content: dataUrl
                }]);
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function closeOverlays() {
            document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
            document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('slid'));
        }

        function updateMsgUI(m) {
            const row = document.getElementById(`row-${m.id}`);
            if (row) row.querySelector('.msg-wrapper').innerHTML = buildMessageHTML(m);
        }

        window.onload = init;
        document.getElementById('msgInput').onkeypress = e => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
=======
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore | Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        /* colors now in theme.css */
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); display: flex; align-items: center; gap: 15px; z-index: 10; }
        .back-btn { cursor: pointer; font-size: 20px; }
        #chatPic { width: 38px; height: 38px; border-radius: 50%; background: #222; background-size: cover; border: 1px solid var(--border); }

        #chatContainer { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        /* --- MESSAGE ROWS --- */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); position: relative; }
        .mine { justify-content: flex-end; }
        .theirs { justify-content: flex-start; }
        .msg-row.slid { transform: translateX(-45px); }

        .pfp-mini { width: 28px; height: 28px; border-radius: 50%; background: #222; background-size: cover; flex-shrink: 0; border: 1px solid var(--border); }
        .mine .pfp-mini { display: none; }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .mine .bubble { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .theirs .bubble { background: #222; color: #fff; border-bottom-left-radius: 4px; }
        
        /* --- SHARED COMIC CARD UI --- */
        .share-card { background: #1a1a1a !important; border: 1px solid var(--border); padding: 0 !important; overflow: hidden; cursor: pointer; border-radius: 12px !important; }
        .share-header { background: var(--accent); color: #000; padding: 4px 10px; font-size: 10px; font-weight: 800; display: flex; justify-content: space-between; }
        .share-body { padding: 12px; }
        .share-title { font-weight: 800; font-size: 13px; color: #fff; display: block; }
        .share-sub { font-size: 11px; color: #777; margin-top: 2px; }

        .edited-tag { font-size: 9px; opacity: 0.5; margin-top: 2px; font-weight: 800; }
        .fwd-tag { font-size: 9px; opacity: 0.5; margin-bottom: 4px; font-weight: 800; }

        .msg-actions { position: absolute; right: -35px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #555; opacity: 0; transition: 0.2s; }
        .slid .msg-actions { opacity: 1; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .menu-card { background: #111; border: 1px solid var(--border); border-radius: 24px; width: 280px; overflow: hidden; }
        
        .reaction-badge { position: absolute; bottom: -8px; right: 8px; background: #1a1a1a; border: 1px solid var(--border); border-radius: 10px; padding: 2px 6px; font-size: 11px; z-index: 2; }

        .input-area { padding: 15px 20px 30px; background: #000; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .input-area input { flex: 1; background: #111; border: 1px solid var(--border); border-radius: 25px; padding: 12px 18px; color: white; outline: none; }
        .btn-round { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; background: #222; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    </style>
</head>
<body>

    <div id="menuOverlay" class="overlay" onclick="closeOverlays()">
        <div class="menu-card" id="menuCard" onclick="event.stopPropagation()"></div>
    </div>

    <div class="header">
        <span class="back-btn" onclick="location.href='connections.html'">‚¨ÖÔ∏è</span>
        <div id="chatPic"></div>
        <h3 id="headerTitle" style="margin:0; font-size:15px;">...</h3>
    </div>

    <div id="chatContainer"></div>

    <div class="input-area">
        <button class="btn-round" onclick="document.getElementById('imageInput').click()">üì∑</button>
        <input type="text" id="msgInput" placeholder="Message..." autocomplete="off">
        <button class="btn-round" style="background:var(--accent); color:#000;" onclick="sendMessage()">üöÄ</button>
        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImage(this)">
    </div>

    <script>
        const supabaseUrl = 'https://mmycqeejhguzhtzkyjaj.supabase.co';
        const supabaseKey = 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
        const myHandle = myProfile.handle;
        const urlParams = new URLSearchParams(window.location.search);
        const activeChatPartner = urlParams.get('to');
        
        let partnerPFP = "";
        let activeMsg = null;

        async function init() {
            // Privacy gate ‚Äî if user disabled DMs in settings, block access
            if (localStorage.getItem('cc-privacy-dm') === 'false') {
                document.body.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#000;color:#fff;text-align:center;gap:16px;">
                        <div style="font-size:48px">üîí</div>
                        <h2 style="margin:0">Direct Messages is Disabled</h2>
                        <p style="color:#666;margin:0">You've turned this off in Settings.</p>
                        <a href="settings.html" style="background:#FF7A00;color:#000;padding:12px 24px;border-radius:24px;font-weight:700;text-decoration:none;margin-top:8px">Go to Settings</a>
                        <a href="index.html" style="color:#666;font-size:13px">‚Üê Back Home</a>
                    </div>`;
                return;
            }
            if (!activeChatPartner || !myHandle) return;
            const { data: p } = await _supabase.from('profiles').select('name, pic').eq('handle', activeChatPartner).single();
            if (p) {
                document.getElementById('headerTitle').innerText = p.name;
                partnerPFP = p.pic || "";
                if (p.pic) document.getElementById('chatPic').style.backgroundImage = `url(${p.pic})`;
            }
            await loadMessages();
            setupRealtime();
        }

        function setupRealtime() {
            // Use a unique channel name per conversation to avoid conflicts
            const channelName = `dm_${[myHandle, activeChatPartner].sort().join('_')}`;
            _supabase.channel(channelName).on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
                if (payload.eventType === 'INSERT') {
                    const m = payload.new;
                    if ((m.sender_handle === myHandle && m.receiver_handle === activeChatPartner) || 
                        (m.sender_handle === activeChatPartner && m.receiver_handle === myHandle)) {
                        appendMessage(m);
                        // Mark incoming messages as read immediately
                        if (m.sender_handle === activeChatPartner && !m.is_read) {
                            _supabase.from('messages').update({ is_read: true }).eq('id', m.id);
                        }
                    }
                } else if (payload.eventType === 'UPDATE') {
                    updateMsgUI(payload.new);
                }
            }).subscribe();
        }

        async function markAllRead() {
            if (!activeChatPartner || !myHandle) return;
            await _supabase.from('messages')
                .update({ is_read: true })
                .eq('sender_handle', activeChatPartner)
                .eq('receiver_handle', myHandle)
                .eq('is_read', false);
        }

        function isImageContent(text) {
            if (text.startsWith('data:image')) return true;
            return text.match(/\.(jpeg|jpg|gif|png|webp|svg)/i) && text.startsWith('http');
        }

        function buildMessageHTML(m) {
            let text = m.content;
            let html = "";

            if (text.startsWith('[FWD]: ')) {
                html += `<div class="fwd-tag">‚û• FORWARDED</div>`;
                text = text.substring(7);
            }

            // --- SHARED COMIC LOGIC ---
            if (text.startsWith('[SHARE]: ')) {
                let shareData = text.substring(9);
                let comicTitle = shareData.split('! (Link:')[0] || "Shared Comic";
                let comicLink = shareData.includes('link=') ? shareData.split('link=')[1] : "discover.html";

                html += `
                <div class="bubble share-card" onclick="location.href='${comicLink}'">
                    <div class="share-header"><span>COMICCORE</span> <span>OPEN üìñ</span></div>
                    <div class="share-body">
                        <span class="share-title">${comicTitle}</span>
                        <span class="share-sub">Tap to read this comic on ComicCore</span>
                    </div>
                </div>`;
            } 
            else if (isImageContent(text)) {
                html += `<div class="bubble" style="padding:4px;"><img src="${text}" style="width:100%; border-radius:14px; display:block;"></div>`;
            } 
            else {
                html += `<div class="bubble"><span>${text}</span></div>`;
            }

            if (m.reaction) html += `<div class="reaction-badge">${m.reaction}</div>`;
            if (m.is_edited) html += `<div class="edited-tag">EDITED</div>`;
            return html;
        }

        async function loadMessages() {
            const { data } = await _supabase.from('messages').select('*')
                .or(`and(sender_handle.eq.${myHandle},receiver_handle.eq.${activeChatPartner}),and(sender_handle.eq.${activeChatPartner},receiver_handle.eq.${myHandle})`)
                .order('created_at', { ascending: true });
            document.getElementById('chatContainer').innerHTML = "";
            data?.forEach(appendMessage);
            // Mark all received messages as read
            markAllRead();
        }

        function appendMessage(m) {
            if (document.getElementById(`row-${m.id}`)) return;
            const isMine = m.sender_handle === myHandle;
            const row = document.createElement('div');
            row.className = `msg-row ${isMine ? 'mine' : 'theirs'}`;
            row.id = `row-${m.id}`;
            row.ondblclick = () => {
                document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('slid'));
                row.classList.add('slid');
            };

            const pfp = document.createElement('div');
            pfp.className = 'pfp-mini';
            if (partnerPFP) pfp.style.backgroundImage = `url(${partnerPFP})`;

            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            wrapper.innerHTML = buildMessageHTML(m);
            
            const actions = document.createElement('div');
            actions.className = 'msg-actions';
            actions.innerHTML = '‚ãÆ';
            actions.onclick = (e) => { e.stopPropagation(); openMenu(m, isMine); };

            row.appendChild(pfp);
            row.appendChild(wrapper);
            row.appendChild(actions);
            
            const container = document.getElementById('chatContainer');
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        function openMenu(m, isMine) {
            activeMsg = m;
            const menu = document.getElementById('menuCard');
            menu.innerHTML = `
                <div style="display:flex; justify-content:center; gap:10px; padding:15px; border-bottom:1px solid var(--border);">
                    <span onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="react('üòÇ')">üòÇ</span>
                    <span onclick="react('üî•')">üî•</span><span onclick="react('üòÆ')">üòÆ</span>
                </div>
                <div class="menu-item" style="padding:15px; cursor:pointer;" onclick="deleteMsg(${m.id})">üóëÔ∏è Delete</div>
            `;
            document.getElementById('menuOverlay').style.display = 'flex';
        }

        async function react(emoji) {
            const toggle = activeMsg.reaction === emoji ? null : emoji;
            await _supabase.from('messages').update({ reaction: toggle }).eq('id', activeMsg.id);
            closeOverlays();
        }

        async function deleteMsg(id) {
            await _supabase.from('messages').delete().eq('id', id);
            document.getElementById(`row-${id}`)?.remove();
            closeOverlays();
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const val = input.value.trim();
            if (!val) return;
            input.value = "";
            await _supabase.from('messages').insert([{ sender_handle: myHandle, receiver_handle: activeChatPartner, content: val }]);
        }

        async function handleImage(input) {
            const file = input.files[0];
            if (!file) return;
            // Convert to base64 and send as data URL in message content
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                await _supabase.from('messages').insert([{
                    sender_handle: myHandle,
                    receiver_handle: activeChatPartner,
                    content: dataUrl
                }]);
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function closeOverlays() {
            document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
            document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('slid'));
        }

        function updateMsgUI(m) {
            const row = document.getElementById(`row-${m.id}`);
            if (row) row.querySelector('.msg-wrapper').innerHTML = buildMessageHTML(m);
        }

        window.onload = init;
        document.getElementById('msgInput').onkeypress = e => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
>>>>>>> ba49e38988dbbfe6054c14b4b3cd75b00beef1af
</html>