<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore - Background Source</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

        body { margin:0; font-family:'Inter',sans-serif; background:var(--bg,#0f0f11); color:var(--text,#f5f5f7); display:flex; flex-direction:column; height:100vh; overflow:hidden; }

        .toolbar { display:flex; justify-content:space-between; align-items:center; background:var(--card,#1c1c1e); padding:12px 16px; border-bottom:1px solid var(--border,#2c2c2e); flex-shrink:0; }
        .nav-btn { background:#2c2c2e; border:1px solid var(--border,#2c2c2e); color:white; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; transition:0.2s; }
        .nav-btn:hover { background:#3a3a3c; }

        .tab-row { display:flex; background:var(--card,#1c1c1e); border-bottom:1px solid var(--border,#2c2c2e); padding:0 16px; flex-shrink:0; overflow-x:auto; }
        .tab-row::-webkit-scrollbar { display:none; }
        .tab { padding:12px 20px; font-weight:800; font-size:13px; cursor:pointer; color:#555; position:relative; border:none; background:none; transition:0.2s; white-space:nowrap; flex-shrink:0; }
        .tab.active { color:#ff7a00; }
        .tab.active::after { content:''; position:absolute; bottom:0; left:0; width:100%; height:3px; background:#ff7a00; border-radius:2px 2px 0 0; }

        .tab-content { flex:1; overflow-y:auto; padding:20px; display:none; }
        .tab-content.active { display:block; }
        .section-label { font-size:10px; font-weight:900; color:#555; letter-spacing:2px; text-transform:uppercase; margin:20px 0 10px; }
        .section-label:first-child { margin-top:0; }

        .color-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(54px,1fr)); gap:10px; margin-bottom:20px; }
        .color-swatch { aspect-ratio:1; border-radius:10px; cursor:pointer; border:2px solid transparent; transition:0.15s; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
        .color-swatch:hover { transform:scale(1.1); border-color:#fff; }
        .custom-color-row { display:flex; gap:10px; align-items:center; margin-bottom:20px; }
        .custom-color-row input[type="color"] { width:52px; height:52px; border:none; border-radius:10px; cursor:pointer; padding:2px; background:#222; }
        .custom-color-row button { flex:1; padding:14px; background:#ff7a00; color:#000; border:none; border-radius:10px; font-weight:900; cursor:pointer; font-size:13px; }

        .gradient-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:12px; margin-bottom:20px; }
        .grad-card { aspect-ratio:1; border-radius:12px; cursor:pointer; border:2px solid transparent; transition:0.15s; box-shadow:0 2px 12px rgba(0,0,0,0.4); position:relative; overflow:hidden; }
        .grad-card:hover { transform:scale(1.04); border-color:#ff7a00; }
        .grad-label { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.5); padding:5px 8px; font-size:10px; font-weight:800; color:#fff; }
        .grad-builder { background:var(--card,#1c1c1e); border:1px solid var(--border,#2c2c2e); border-radius:16px; padding:16px; margin-bottom:20px; }
        .grad-preview { width:100%; height:80px; border-radius:10px; margin-bottom:12px; }
        .grad-controls { display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }
        .grad-controls label { font-size:10px; font-weight:800; color:#555; display:block; margin-bottom:4px; letter-spacing:1px; }
        .grad-controls input[type="color"] { width:44px; height:44px; border:none; border-radius:8px; cursor:pointer; padding:2px; background:#222; display:block; }
        .grad-controls select { background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:8px; padding:8px 10px; font-size:12px; outline:none; }
        .grad-apply-btn { flex:1; min-width:100px; padding:11px; background:#00d2ff; color:#000; border:none; border-radius:10px; font-weight:900; cursor:pointer; font-size:13px; }

        .bg-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; }
        .bg-card { background:var(--card,#1c1c1e); border-radius:12px; overflow:hidden; border:2px solid transparent; transition:0.2s; cursor:pointer; }
        .bg-card:hover { border-color:#ff7a00; transform:translateY(-3px); }
        .bg-card.ratio-mismatch { opacity:0.45; }
        .bg-card.ratio-mismatch:hover { opacity:1; border-color:#ff453a; }
        .bg-card img { width:100%; aspect-ratio:1; object-fit:cover; display:block; }
        .bg-info { padding:7px 10px 9px; }
        .bg-name { font-size:11px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:4px; }
        .bg-meta { display:flex; align-items:center; justify-content:space-between; gap:4px; }
        .bg-delete { color:#ff453a; cursor:pointer; font-size:14px; padding:0 3px; flex-shrink:0; line-height:1; }
        .ratio-badge { display:inline-block; background:#222; color:#666; font-size:9px; font-weight:900; padding:2px 5px; border-radius:4px; border:1px solid #333; }
        .ratio-badge.match { background:rgba(0,255,102,0.1); color:#ff7a00; border-color:#ff7a00; }
        .ratio-badge.mismatch { background:rgba(255,60,60,0.08); color:#ff453a; border-color:#ff453a; }

        .verified-badge { display:inline-flex; align-items:center; gap:3px; background:rgba(0,180,255,0.15); color:#00b4ff; border:1px solid rgba(0,180,255,0.4); font-size:9px; font-weight:900; padding:2px 7px; border-radius:20px; white-space:nowrap; }

        .official-banner { display:flex; align-items:center; gap:10px; background:linear-gradient(135deg,rgba(0,180,255,0.08),rgba(0,180,255,0.03)); border:1px solid rgba(0,180,255,0.2); border-radius:12px; padding:10px 14px; margin-bottom:16px; }
        .official-banner-title { font-size:12px; font-weight:900; color:#00b4ff; }
        .official-banner-sub { font-size:10px; color:#555; font-weight:700; margin-top:2px; }

        .upload-zone { border:2px dashed #333; border-radius:14px; padding:28px; text-align:center; cursor:pointer; transition:0.2s; margin-bottom:16px; }
        .upload-zone:hover { border-color:#ff7a00; background:rgba(255,122,0,0.03); }

        .ratio-filter-bar { display:flex; align-items:center; gap:8px; margin-bottom:14px; padding:10px 14px; background:#111; border-radius:10px; border:1px solid #2c2c2e; font-size:12px; }

        .lib-subtab-row { display:flex; gap:8px; margin-bottom:16px; }
        .lib-subtab { flex:1; padding:9px; background:#111; border:1.5px solid #222; color:#555; font-size:12px; font-weight:800; border-radius:10px; cursor:pointer; transition:0.15s; text-align:center; }
        .lib-subtab.active { border-color:#ff7a00; color:#ff7a00; background:rgba(255,122,0,0.04); }

        .empty-state { text-align:center; padding:40px 20px; color:#444; }
        .empty-state .empty-icon { font-size:36px; margin-bottom:8px; }
        .empty-state p { font-size:13px; font-weight:700; margin:0; }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.94); z-index:2000; display:none; align-items:flex-start; justify-content:center; padding:16px; backdrop-filter:blur(6px); overflow-y:auto; }
        .modal { background:#1c1c1e; padding:22px; border-radius:20px; width:100%; max-width:400px; border:1px solid #2c2c2e; margin:auto; }
        .modal h3 { margin:0 0 14px; font-size:16px; font-weight:900; letter-spacing:0.5px; }
        .modal input[type="text"] { width:100%; padding:11px 14px; background:#111; border:1px solid #333; color:white; border-radius:10px; margin:8px 0; box-sizing:border-box; font-family:inherit; font-size:14px; outline:none; }
        .modal input:focus { border-color:#ff7a00; }
        .modal-note { background:rgba(0,180,255,0.07); border:1px solid rgba(0,180,255,0.2); border-radius:8px; padding:9px 12px; font-size:11px; color:#00b4ff; font-weight:700; margin-bottom:12px; }

        /* ‚îÄ‚îÄ Pan Preview ‚îÄ‚îÄ */
        .preview-label { font-size:10px; font-weight:900; color:#555; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:6px; }
        .pan-wrap { width:100%; aspect-ratio:1; background:#0a0a0a; border-radius:12px; overflow:hidden; position:relative; border:1.5px solid rgba(0,180,255,0.2); margin-bottom:10px; cursor:grab; touch-action:none; user-select:none; }
        .pan-wrap.dragging { cursor:grabbing; }
        .pan-img { position:absolute; pointer-events:none; transform-origin:top left; }
        .pan-hint { position:absolute; bottom:8px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.75); color:#00b4ff; font-size:10px; font-weight:900; padding:4px 12px; border-radius:20px; pointer-events:none; white-space:nowrap; transition:opacity 0.4s; }
        .scale-row { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
        .scale-row .slabel { font-size:10px; font-weight:900; color:#555; text-transform:uppercase; letter-spacing:1px; width:44px; flex-shrink:0; }
        .scale-row input[type=range] { flex:1; accent-color:#ff7a00; }
        .scale-row .sval { font-size:11px; color:#00d2ff; font-weight:800; min-width:38px; text-align:right; }
        .reset-pan-btn { width:100%; padding:7px; background:transparent; border:1px solid #2a2a2a; color:#555; border-radius:8px; font-size:11px; font-weight:800; cursor:pointer; margin-bottom:12px; transition:0.15s; }
        .reset-pan-btn:hover { color:#aaa; border-color:#555; }
        /* Crop section */
        .crop-section { margin-bottom:10px; }
        .crop-wrap { width:100%; background:#000; border-radius:10px; overflow:hidden; margin-bottom:8px; }
        .crop-wrap img { max-width:100%; display:block; }
        .crop-note { font-size:11px; color:#555; font-weight:700; margin:0 0 8px; }
    </style>
</head>
<body>

<div class="toolbar">
    <div>
        <div style="font-size:18px;font-weight:900;color:#ff7a00;letter-spacing:1px;">BACKGROUNDS</div>
        <div style="font-size:10px;color:#555;font-weight:800;margin-top:2px;" id="ratio-display">All ratios</div>
    </div>
    <button class="nav-btn" onclick="goBack()">‚Üê BACK</button>
</div>

<div class="tab-row">
    <button class="tab active" onclick="switchTab(event,'colors')">üé® Colors</button>
    <button class="tab"        onclick="switchTab(event,'gradients')">üåà Gradients</button>
    <button class="tab"        onclick="switchTab(event,'library')">üñº Library</button>
</div>

<!-- COLORS -->
<div id="tab-colors" class="tab-content active">
    <div class="section-label">Preset Colors</div>
    <div class="color-grid" id="preset-colors"></div>
    <div class="section-label">Custom Color</div>
    <div class="custom-color-row">
        <input type="color" id="custom-color-input" value="#ffffff">
        <button onclick="applyCustomColor()">USE THIS COLOR</button>
    </div>
</div>

<!-- GRADIENTS -->
<div id="tab-gradients" class="tab-content">
    <div class="section-label">Preset Gradients</div>
    <div class="gradient-grid" id="preset-gradients"></div>
    <div class="section-label">Custom Gradient</div>
    <div class="grad-builder">
        <div class="grad-preview" id="grad-preview"></div>
        <div class="grad-controls">
            <div><label>FROM</label><input type="color" id="grad-color1" value="#ff7a00" oninput="updateGradPreview()"></div>
            <div><label>TO</label><input type="color" id="grad-color2" value="#ff0080" oninput="updateGradPreview()"></div>
            <div>
                <label>DIRECTION</label>
                <select id="grad-dir" onchange="updateGradPreview()">
                    <option value="to right">‚Üí Horizontal</option>
                    <option value="to bottom">‚Üì Vertical</option>
                    <option value="to bottom right">‚Üò Diagonal</option>
                    <option value="to bottom left">‚Üô Diagonal</option>
                    <option value="135deg">‚Üó Slanted</option>
                    <option value="circle">‚óé Radial</option>
                </select>
            </div>
            <button class="grad-apply-btn" onclick="applyCustomGradient()">APPLY</button>
        </div>
    </div>
</div>

<!-- LIBRARY -->
<div id="tab-library" class="tab-content">
    <div class="lib-subtab-row">
        <div class="lib-subtab active" id="subtab-mine"     onclick="switchLibTab('mine')">My Backgrounds</div>
        <div class="lib-subtab"         id="subtab-official" onclick="switchLibTab('official')">‚úì Official</div>
    </div>

    <div id="lib-mine">
        <div class="upload-zone" onclick="document.getElementById('upload-input').click()">
            <div style="font-size:30px;margin-bottom:6px;">üì§</div>
            <p style="margin:0;color:#555;font-size:13px;font-weight:600;">Tap to upload a background</p>
            <p style="margin:6px 0 0;color:#444;font-size:11px;">PNG ¬∑ JPG ¬∑ GIF ¬∑ WebP</p>
        </div>
        <div class="ratio-filter-bar" id="ratio-filter-bar" style="display:none;">
            <span style="color:#888;font-weight:600;">Canvas ratio:</span>
            <b style="color:#ff7a00;" id="ratio-filter-label">‚Äî</b>
            <span style="margin-left:auto;cursor:pointer;color:#ff7a00;font-weight:700;" onclick="clearRatioFilter()">Show all</span>
        </div>
        <div class="section-label">YOUR BACKGROUNDS</div>
        <div id="bg-container" class="bg-grid"></div>
    </div>

    <div id="lib-official" style="display:none;">
        <div class="official-banner">
            <div style="font-size:22px;">üõ°Ô∏è</div>
            <div>
                <div class="official-banner-title">Official Backgrounds</div>
                <div class="official-banner-sub">Hand-picked by ComicCore. Works on any canvas.</div>
            </div>
        </div>
        <div id="admin-upload-zone" style="display:none;margin-bottom:16px;">
            <div class="upload-zone" onclick="document.getElementById('admin-upload-input').click()" style="border-color:rgba(0,180,255,0.35);">
                <div style="font-size:24px;margin-bottom:6px;">üîí</div>
                <p style="margin:0;color:#00b4ff;font-size:12px;font-weight:800;">Upload Official Background</p>
                <p style="margin:4px 0 0;color:#444;font-size:11px;">Admin only ¬∑ visible to all users</p>
            </div>
        </div>
        <div id="official-container" class="bg-grid"></div>
    </div>
</div>

<!-- USER UPLOAD MODAL -->
<div id="upload-modal" class="overlay">
    <div class="modal">
        <h3 style="color:#ff7a00;">Upload Background</h3>
        <div class="preview-label">Preview ‚Äî drag to pan, slider to scale</div>
        <div class="pan-wrap" id="pan-wrap-user">
            <img class="pan-img" id="pan-img-user" src="" alt="">
            <div class="pan-hint" id="pan-hint-user">‚úã Drag to pan</div>
        </div>
        <div class="scale-row">
            <span class="slabel">Scale</span>
            <input type="range" id="scale-user" min="50" max="300" value="100" oninput="onScale('user')">
            <span class="sval" id="scale-val-user">100%</span>
        </div>
        <button class="reset-pan-btn" onclick="resetPan('user')">‚Ü∫ Reset position &amp; scale</button>
        <div class="crop-section" id="crop-section-user" style="display:none;">
            <div class="preview-label">Crop (optional)</div>
            <div class="crop-wrap"><img id="crop-img-user" style="max-width:100%;display:block;"></div>
            <p class="crop-note">Free crop ‚Äî no ratio lock. Hint: <span id="ratio-hint-text" style="color:#ff7a00;"></span></p>
        </div>
        <input type="text" id="bg-name" placeholder="Name (e.g. City Street)">
        <div style="display:flex;gap:8px;margin-top:4px;">
            <button class="nav-btn" onclick="closeUserModal()" style="flex:1;">CANCEL</button>
            <button class="nav-btn" id="save-btn" onclick="saveBackground()" style="flex:2;background:#ff7a00;color:#000;border:none;">SAVE</button>
        </div>
    </div>
</div>

<!-- ADMIN UPLOAD MODAL -->
<div id="admin-upload-modal" class="overlay">
    <div class="modal">
        <h3 style="color:#00b4ff;">Upload Official Background</h3>
        <div class="modal-note">üõ°Ô∏è Visible to ALL users. Your username will NOT be shown.</div>
        <div class="preview-label">Preview ‚Äî drag to pan, slider to scale</div>
        <div class="pan-wrap" id="pan-wrap-admin">
            <img class="pan-img" id="pan-img-admin" src="" alt="">
            <div class="pan-hint" id="pan-hint-admin">‚úã Drag to pan</div>
        </div>
        <div class="scale-row">
            <span class="slabel">Scale</span>
            <input type="range" id="scale-admin" min="50" max="300" value="100" oninput="onScale('admin')">
            <span class="sval" id="scale-val-admin">100%</span>
        </div>
        <button class="reset-pan-btn" onclick="resetPan('admin')">‚Ü∫ Reset</button>
        <div class="crop-section" id="crop-section-admin" style="display:none;">
            <div class="preview-label">Crop (optional)</div>
            <div class="crop-wrap"><img id="crop-img-admin" style="max-width:100%;display:block;"></div>
        </div>
        <input type="text" id="admin-bg-name" placeholder="Background name (e.g. Rooftop Sunset)">
        <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="nav-btn" onclick="closeAdminModal()" style="flex:1;">CANCEL</button>
            <button class="nav-btn" id="admin-save-btn" onclick="saveOfficialBackground()" style="flex:2;background:#00b4ff;color:#000;border:none;">PUBLISH</button>
        </div>
    </div>
</div>

<input type="file" id="upload-input"       hidden accept="image/*">
<input type="file" id="admin-upload-input" hidden accept="image/*">

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
// ‚îÄ‚îÄ Supabase ‚îÄ‚îÄ
const _supabase = supabase.createClient(
    'https://mmycqeejhguzhtzkyjaj.supabase.co',
    'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE'
);

// ‚îÄ‚îÄ Auth ‚Äî uses same key as profile.html & create.html ‚îÄ‚îÄ
const OWNER_HANDLE = 'jeffyplays';
function getCurrentHandle() {
    try { const p = localStorage.getItem('user_profile'); if (p) return JSON.parse(p).handle || ''; } catch(e) {}
    return '';
}
function isOwner() { return getCurrentHandle().toLowerCase() === OWNER_HANDLE.toLowerCase(); }

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let croppers = { user: null, admin: null };
let panStates = {
    user:  { x: 0, y: 0, scale: 100 },
    admin: { x: 0, y: 0, scale: 100 }
};
let rawDataUrls   = { user: null, admin: null };
let isAnimated    = { user: false, admin: false };
let currentRatioFilter = null;
let showAllLibrary = false;
let currentLibTab  = 'mine';

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
window.onload = function() {
    const stored = localStorage.getItem('cc-bg-ratio-filter');
    if (stored) {
        try { currentRatioFilter = JSON.parse(stored); } catch(e) {}
        if (currentRatioFilter) {
            const label = currentRatioFilter.w + ':' + currentRatioFilter.h;
            document.getElementById('ratio-display').innerText      = 'Canvas: ' + label;
            document.getElementById('ratio-filter-bar').style.display = 'flex';
            document.getElementById('ratio-filter-label').innerText  = label;
            document.getElementById('ratio-hint-text').innerText     = label + ' (free crop)';
        }
    }
    if (isOwner()) document.getElementById('admin-upload-zone').style.display = 'block';
    renderPresetColors();
    renderPresetGradients();
    updateGradPreview();
    setupPan('user');
    setupPan('admin');
    loadMyBackgrounds();
};

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function switchTab(evt, name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    evt.currentTarget.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    if (name === 'library') {
        if (currentLibTab === 'official') loadOfficialBackgrounds();
        else loadMyBackgrounds();
    }
}
function switchLibTab(tab) {
    currentLibTab = tab;
    document.getElementById('subtab-mine').classList.toggle('active', tab === 'mine');
    document.getElementById('subtab-official').classList.toggle('active', tab === 'official');
    document.getElementById('lib-mine').style.display     = tab === 'mine'     ? 'block' : 'none';
    document.getElementById('lib-official').style.display = tab === 'official' ? 'block' : 'none';
    if (tab === 'official') loadOfficialBackgrounds(); else loadMyBackgrounds();
}

// ‚îÄ‚îÄ Apply & return ‚îÄ‚îÄ
function applyBg(css, bgId) {
    if (bgId !== undefined) {
        localStorage.setItem('pending_bg_id', String(bgId));
        localStorage.removeItem('pending_background');
    } else {
        localStorage.setItem('pending_background', css);
        localStorage.removeItem('pending_bg_id');
    }
    goBack();
}
function goBack() {
    localStorage.removeItem('cc-bg-ratio-filter');
    const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent) || window.innerWidth <= 768;
    location.href = isMobile ? 'create-mobile.html' : 'create.html';
}
function clearRatioFilter() {
    showAllLibrary = true;
    document.getElementById('ratio-filter-bar').style.display = 'none';
    loadMyBackgrounds();
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function gcd(a,b){ return b===0?a:gcd(b,a%b); }
function simplifyRatio(w,h){ const g=gcd(w,h); return {w:w/g,h:h/g}; }
function isAnimatedSrc(src) {
    if (!src) return false;
    if (src.startsWith('data:image/gif'))  return true;
    if (src.startsWith('data:image/webp')) return true;
    if (src.startsWith('data:image/apng')) return true;
    return src.toLowerCase().includes('.gif');
}
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function verifiedBadgeHtml(){ return '<span class="verified-badge">‚úì Official</span>'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAN PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupPan(which) {
    const wrap = document.getElementById('pan-wrap-' + which);
    if (!wrap) return;
    let dragging = false, sx = 0, sy = 0, spx = 0, spy = 0;

    function start(cx, cy) {
        dragging = true; sx = cx; sy = cy;
        spx = panStates[which].x; spy = panStates[which].y;
        wrap.classList.add('dragging');
        const hint = document.getElementById('pan-hint-' + which);
        if (hint) hint.style.opacity = '0';
    }
    function move(cx, cy) {
        if (!dragging) return;
        panStates[which].x = spx + (cx - sx);
        panStates[which].y = spy + (cy - sy);
        refreshPan(which);
    }
    function end() { dragging = false; wrap.classList.remove('dragging'); }

    wrap.addEventListener('mousedown',  e => { start(e.clientX, e.clientY); e.preventDefault(); });
    wrap.addEventListener('touchstart', e => { start(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }, { passive: false });
    document.addEventListener('mousemove',  e => move(e.clientX, e.clientY));
    document.addEventListener('touchmove',  e => { if (dragging) { move(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }}, { passive: false });
    document.addEventListener('mouseup',  end);
    document.addEventListener('touchend', end);
}

function refreshPan(which) {
    const img  = document.getElementById('pan-img-' + which);
    const wrap = document.getElementById('pan-wrap-' + which);
    if (!img || !wrap || !img.naturalWidth) return;
    const st = panStates[which];
    const ww = wrap.offsetWidth  || 300;
    const wh = wrap.offsetHeight || 300;
    const iw = img.naturalWidth;
    const ih = img.naturalHeight;
    const s  = st.scale / 100;
    // cover-fit base then apply scale
    const base = Math.max(ww / iw, wh / ih);
    const dw = iw * base * s;
    const dh = ih * base * s;
    // clamp pan
    const maxX = Math.max(0, (dw - ww) / 2);
    const maxY = Math.max(0, (dh - wh) / 2);
    st.x = Math.max(-maxX, Math.min(maxX, st.x));
    st.y = Math.max(-maxY, Math.min(maxY, st.y));
    const left = (ww - dw) / 2 + st.x;
    const top  = (wh - dh) / 2 + st.y;
    img.style.width  = dw + 'px';
    img.style.height = dh + 'px';
    img.style.left   = left + 'px';
    img.style.top    = top  + 'px';
    img.style.transform = '';
}

function loadPanImage(which, dataUrl) {
    resetPan(which);
    const img = document.getElementById('pan-img-' + which);
    img.src = dataUrl;
    const hint = document.getElementById('pan-hint-' + which);
    if (hint) hint.style.opacity = '1';
    img.onload = () => refreshPan(which);
    if (img.complete && img.naturalWidth) refreshPan(which);
}

function onScale(which) {
    const v = parseInt(document.getElementById('scale-' + which).value);
    document.getElementById('scale-val-' + which).innerText = v + '%';
    panStates[which].scale = v;
    refreshPan(which);
}

function resetPan(which) {
    panStates[which] = { x: 0, y: 0, scale: 100 };
    document.getElementById('scale-' + which).value = 100;
    document.getElementById('scale-val-' + which).innerText = '100%';
    const hint = document.getElementById('pan-hint-' + which);
    if (hint) hint.style.opacity = '1';
    refreshPan(which);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE INPUT HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('upload-input').onchange = e => {
    const file = e.target.files[0]; if (!file) return;
    isAnimated.user = file.type === 'image/gif' || file.type === 'image/webp' || file.type === 'image/apng';
    const reader = new FileReader();
    reader.onload = ev => {
        rawDataUrls.user = ev.target.result;
        document.getElementById('upload-modal').style.display = 'flex';
        loadPanImage('user', rawDataUrls.user);
        // Crop section ‚Äî only for static images
        const cs = document.getElementById('crop-section-user');
        if (isAnimated.user) {
            cs.style.display = 'none';
            if (croppers.user) { croppers.user.destroy(); croppers.user = null; }
        } else {
            cs.style.display = 'block';
            const ci = document.getElementById('crop-img-user');
            ci.src = rawDataUrls.user;
            if (croppers.user) { croppers.user.destroy(); croppers.user = null; }
            ci.onload = () => { croppers.user = new Cropper(ci, { aspectRatio: NaN, viewMode: 1 }); };
        }
    };
    reader.readAsDataURL(file);
    e.target.value = '';
};

document.getElementById('admin-upload-input').onchange = e => {
    const file = e.target.files[0]; if (!file) return;
    isAnimated.admin = file.type === 'image/gif' || file.type === 'image/webp' || file.type === 'image/apng';
    const reader = new FileReader();
    reader.onload = ev => {
        rawDataUrls.admin = ev.target.result;
        document.getElementById('admin-upload-modal').style.display = 'flex';
        loadPanImage('admin', rawDataUrls.admin);
        const cs = document.getElementById('crop-section-admin');
        if (isAnimated.admin) {
            cs.style.display = 'none';
            if (croppers.admin) { croppers.admin.destroy(); croppers.admin = null; }
        } else {
            cs.style.display = 'block';
            const ci = document.getElementById('crop-img-admin');
            ci.src = rawDataUrls.admin;
            if (croppers.admin) { croppers.admin.destroy(); croppers.admin = null; }
            ci.onload = () => { croppers.admin = new Cropper(ci, { aspectRatio: NaN, viewMode: 1 }); };
        }
    };
    reader.readAsDataURL(file);
    e.target.value = '';
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE (user)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveBackground() {
    const name = (document.getElementById('bg-name').value || 'Untitled').trim();
    const btn  = document.getElementById('save-btn');
    btn.innerText = 'Saving‚Ä¶'; btn.disabled = true;

    let b64, naturalRatio = null;
    if (isAnimated.user) {
        b64 = rawDataUrls.user;
    } else if (croppers.user) {
        const cd = croppers.user.getCropBoxData();
        if (cd.width && cd.height) naturalRatio = simplifyRatio(Math.round(cd.width), Math.round(cd.height));
        b64 = croppers.user.getCroppedCanvas({ maxWidth: 1400, maxHeight: 1400 }).toDataURL('image/jpeg', 0.88);
    } else if (rawDataUrls.user) {
        b64 = rawDataUrls.user;
    } else {
        btn.innerText = 'SAVE'; btn.disabled = false; alert('No image loaded.'); return;
    }

    const handle = getCurrentHandle() || 'guest';
    // Try full payload first; silently fall back if new columns don't exist yet
    let error = await tryInsert({ name, image_data: b64, ratio: naturalRatio, uploaded_by: handle, is_official: false });

    btn.innerText = 'SAVE'; btn.disabled = false;
    if (error) { alert(error.message); return; }
    closeUserModal();
    // Switch to library/mine tab to show the new bg
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab')[2].classList.add('active');
    document.getElementById('tab-library').classList.add('active');
    switchLibTab('mine');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE (admin / official)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveOfficialBackground() {
    if (!isOwner()) { alert('Not authorized.'); return; }
    const name = (document.getElementById('admin-bg-name').value || 'Official BG').trim();
    const btn  = document.getElementById('admin-save-btn');
    btn.innerText = 'Publishing‚Ä¶'; btn.disabled = true;

    let b64;
    if (isAnimated.admin) {
        b64 = rawDataUrls.admin;
    } else if (croppers.admin) {
        b64 = croppers.admin.getCroppedCanvas({ maxWidth: 1920, maxHeight: 1920 }).toDataURL('image/jpeg', 0.92);
    } else if (rawDataUrls.admin) {
        b64 = rawDataUrls.admin;
    } else {
        btn.innerText = 'PUBLISH'; btn.disabled = false; alert('No image loaded.'); return;
    }

    let error = await tryInsert({ name, image_data: b64, ratio: null, is_official: true, uploaded_by: null });

    btn.innerText = 'PUBLISH'; btn.disabled = false;
    if (error) { alert(error.message); return; }
    closeAdminModal();
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab')[2].classList.add('active');
    document.getElementById('tab-library').classList.add('active');
    switchLibTab('official');
}

// Auto-fallback insert: tries full payload, falls back to base columns if schema error
async function tryInsert(payload) {
    const { error } = await _supabase.from('backgrounds_library').insert([payload]);
    if (error && error.message && (error.message.includes('is_official') || error.message.includes('uploaded_by') || error.message.includes('schema cache'))) {
        // New columns not in DB yet ‚Äî strip them and retry with just base columns
        const base = { name: payload.name, image_data: payload.image_data, ratio: payload.ratio || null };
        const r2 = await _supabase.from('backgrounds_library').insert([base]);
        return r2.error || null;
    }
    return error || null;
}

// ‚îÄ‚îÄ Close modals ‚îÄ‚îÄ
function closeUserModal() {
    document.getElementById('upload-modal').style.display = 'none';
    document.getElementById('bg-name').value = '';
    document.getElementById('pan-img-user').src = '';
    if (croppers.user) { croppers.user.destroy(); croppers.user = null; }
    rawDataUrls.user = null; isAnimated.user = false;
    resetPan('user');
}
function closeAdminModal() {
    document.getElementById('admin-upload-modal').style.display = 'none';
    document.getElementById('admin-bg-name').value = '';
    document.getElementById('pan-img-admin').src = '';
    if (croppers.admin) { croppers.admin.destroy(); croppers.admin = null; }
    rawDataUrls.admin = null; isAnimated.admin = false;
    resetPan('admin');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD BACKGROUNDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadMyBackgrounds() {
    const container = document.getElementById('bg-container');
    container.innerHTML = '<p style="color:#555;font-size:13px;padding:10px 0;">Loading‚Ä¶</p>';
    const handle = getCurrentHandle();
    if (!handle) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üîí</div><p>Log in to see your backgrounds.</p></div>`;
        return;
    }
    // Try with uploaded_by filter; fall back if column doesn't exist
    let { data, error } = await _supabase.from('backgrounds_library').select('*').eq('uploaded_by', handle).order('id', { ascending: false });
    if (error && error.message && (error.message.includes('uploaded_by') || error.message.includes('schema cache'))) {
        // Column missing ‚Äî load everything as fallback
        const r2 = await _supabase.from('backgrounds_library').select('*').order('id', { ascending: false });
        data = r2.data; error = r2.error;
    }
    if (error) { container.innerHTML = '<p style="color:#ff453a;">Error loading.</p>'; return; }
    if (!data || !data.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üñº</div><p>No backgrounds yet.<br>Upload one above!</p></div>`;
        return;
    }
    const filterKey = currentRatioFilter && !showAllLibrary ? currentRatioFilter.w + ':' + currentRatioFilter.h : null;
    container.innerHTML = '';
    data.forEach(bg => renderCard(bg, container, filterKey, false));
}

async function loadOfficialBackgrounds() {
    const container = document.getElementById('official-container');
    container.innerHTML = '<p style="color:#555;font-size:13px;padding:10px 0;">Loading‚Ä¶</p>';
    let { data, error } = await _supabase.from('backgrounds_library').select('*').eq('is_official', true).order('id', { ascending: false });
    if (error && error.message && (error.message.includes('is_official') || error.message.includes('schema cache'))) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üõ°Ô∏è</div><p>No official backgrounds yet.</p></div>`;
        return;
    }
    if (error) { container.innerHTML = '<p style="color:#ff453a;">Error loading.</p>'; return; }
    if (!data || !data.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üõ°Ô∏è</div><p>No official backgrounds yet.</p></div>`;
        return;
    }
    container.innerHTML = '';
    data.forEach(bg => renderCard(bg, container, null, true));
}

function renderCard(bg, container, filterKey, isOfficial) {
    const bgRatio    = bg.ratio || null;
    const bgKey      = bgRatio ? bgRatio.w + ':' + bgRatio.h : null;
    const isMatch    = !filterKey || !bgKey || bgKey === filterKey;
    const badgeClass = !bgKey ? '' : (isMatch ? 'match' : 'mismatch');
    const badgeText  = bgKey  || 'any';
    const displayName = escHtml((bg.name || 'Untitled').toUpperCase());

    const card = document.createElement('div');
    card.className = 'bg-card' + (!isMatch ? ' ratio-mismatch' : '');
    card.innerHTML = `
        <img src="${bg.image_data}" alt="${displayName}" loading="lazy">
        <div class="bg-info">
            <div class="bg-name">${displayName}</div>
            <div class="bg-meta">
                ${isOfficial
                    ? verifiedBadgeHtml()
                    : `<span class="ratio-badge ${badgeClass}">${escHtml(badgeText)}</span>`}
                ${(isOfficial && isOwner()) || !isOfficial
                    ? `<span class="bg-delete" title="Delete">‚úï</span>`
                    : ''}
            </div>
        </div>`;

    card.querySelector('img').addEventListener('click', () => applyBg(bg.image_data, bg.id));
    const del = card.querySelector('.bg-delete');
    if (del) del.addEventListener('click', e => {
        e.stopPropagation();
        const msg = isOfficial ? 'Delete official background for everyone?' : 'Delete this background?';
        if (!confirm(msg)) return;
        _supabase.from('backgrounds_library').delete().eq('id', bg.id).then(() => {
            isOfficial ? loadOfficialBackgrounds() : loadMyBackgrounds();
        });
    });

    container.appendChild(card);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRESET_COLORS = [
    '#ffffff','#f5f5f0','#cccccc','#888888','#444444','#111111','#000000',
    '#1a1a2e','#16213e','#0f3460','#533483','#e94560',
    '#ff6b6b','#ff9f43','#feca57','#48dbfb','#0abde3',
    '#1dd1a1','#10ac84','#2ecc71','#3498db','#9b59b6',
    '#e67e22','#e74c3c','#34495e','#f8c291','#778ca3',
];
function renderPresetColors() {
    document.getElementById('preset-colors').innerHTML = PRESET_COLORS.map(c =>
        `<div class="color-swatch" style="background:${c};" onclick="applyBg('${c}')" title="${c}"></div>`
    ).join('');
}
function applyCustomColor() { applyBg(document.getElementById('custom-color-input').value); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRADIENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRESET_GRADIENTS = [
    { name:'Sunset',      css:'linear-gradient(to bottom right, #f8771f, #eb3349)' },
    { name:'Ocean',       css:'linear-gradient(to bottom, #2193b0, #6dd5ed)' },
    { name:'Forest',      css:'linear-gradient(to bottom right, #134e5e, #71b280)' },
    { name:'Purple Haze', css:'linear-gradient(135deg, #360033, #0b8793)' },
    { name:'Peach',       css:'linear-gradient(to right, #ed4264, #ffedbc)' },
    { name:'Midnight',    css:'linear-gradient(to bottom, #0f0c29, #302b63, #24243e)' },
    { name:'Candy',       css:'linear-gradient(to right, #d53369, #cbad6d)' },
    { name:'Aurora',      css:'linear-gradient(135deg, #00c6ff, #0072ff)' },
    { name:'Fire',        css:'linear-gradient(to top, #f12711, #f5af19)' },
    { name:'Mint',        css:'linear-gradient(to right, #00b09b, #96c93d)' },
    { name:'Rose Gold',   css:'linear-gradient(135deg, #f093fb, #f5576c)' },
    { name:'Night Sky',   css:'linear-gradient(to bottom, #0a0a0a, #1a1a4e, #2d2d8f)' },
    { name:'Lemon',       css:'linear-gradient(to bottom right, #f7ff00, #db36a4)' },
    { name:'Steel',       css:'linear-gradient(to right, #485563, #29323c)' },
    { name:'Violet',      css:'linear-gradient(135deg, #7f00ff, #e100ff)' },
    { name:'Spring',      css:'linear-gradient(to bottom right, #a8ff78, #78ffd6)' },
    { name:'Crimson',     css:'linear-gradient(to bottom, #642b73, #c6426e)' },
    { name:'Cosmic',      css:'radial-gradient(circle, #1a1a2e 0%, #16213e 50%, #0f3460 100%)' },
    { name:'Neon',        css:'linear-gradient(135deg, #08f1ff, #ff00c1)' },
    { name:'Sand',        css:'linear-gradient(to bottom right, #decba4, #3e5151)' },
    { name:'Lava',        css:'radial-gradient(circle at 50% 120%, #ff4500, #1a0000)' },
    { name:'Fog',         css:'linear-gradient(to bottom, #d7d2cc, #304352)' },
    { name:'Mango',       css:'linear-gradient(to right, #ffe259, #ffa751)' },
    { name:'Blueberry',   css:'linear-gradient(135deg, #1e3c72, #2a5298)' },
];
function renderPresetGradients() {
    document.getElementById('preset-gradients').innerHTML = PRESET_GRADIENTS.map(g =>
        `<div class="grad-card" style="background:${g.css.replace(/'/g,'&apos;')};" onclick="applyBg('${g.css.replace(/'/g,"\\'")}')"><div class="grad-label">${escHtml(g.name)}</div></div>`
    ).join('');
}
function updateGradPreview() {
    const c1 = document.getElementById('grad-color1').value;
    const c2 = document.getElementById('grad-color2').value;
    const dir = document.getElementById('grad-dir').value;
    const css = dir === 'circle' ? `radial-gradient(circle,${c1},${c2})` : `linear-gradient(${dir},${c1},${c2})`;
    document.getElementById('grad-preview').style.background = css;
}
function applyCustomGradient() {
    const c1 = document.getElementById('grad-color1').value;
    const c2 = document.getElementById('grad-color2').value;
    const dir = document.getElementById('grad-dir').value;
    const css = dir === 'circle' ? `radial-gradient(circle,${c1},${c2})` : `linear-gradient(${dir},${c1},${c2})`;
    applyBg(css);
}
</script>
</body>
</html>