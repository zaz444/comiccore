<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ComicCore â€” Sprite Editor</title>
<link rel="stylesheet" href="theme.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
:root{--bg:#0d0d0f;--card:#1c1c1e;--text:#f5f5f7;--accent:#ff7a00;--border:#2c2c2e;--teal:#00d2ff;--danger:#ff3b30;--green:#32d74b;--purple:#bf5af2;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100dvh;overflow:hidden;user-select:none;}

/* â”€â”€ Top bar â”€â”€ */
.topbar{height:50px;background:#111;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0;gap:6px;}
.nb{background:#1e1e1e;border:1px solid #2a2a2a;color:#ccc;padding:6px 10px;border-radius:7px;cursor:pointer;font-size:11px;font-weight:700;transition:.15s;white-space:nowrap;}
.nb:hover{background:#2a2a2a;color:white;}
.nb.teal{border-color:var(--teal);color:var(--teal);}
.nb.accent{border-color:var(--accent);color:var(--accent);}
.nb.purple{border-color:var(--purple);color:var(--purple);}
.nb.green{border-color:var(--green);color:var(--green);}

/* â”€â”€ Workspace â”€â”€ */
.workspace{display:flex;flex:1;overflow:hidden;}

/* â”€â”€ Left toolbar â”€â”€ */
.lbar{width:50px;background:#0a0a0a;border-right:1px solid #1a1a1a;display:flex;flex-direction:column;align-items:center;padding:7px 0;gap:3px;flex-shrink:0;overflow-y:auto;}
.lbar::-webkit-scrollbar{width:2px;}
.tb{width:36px;height:36px;background:#141414;border:1.5px solid #202020;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:.1s;position:relative;flex-shrink:0;}
.tb:hover{border-color:#444;background:#1e1e1e;}
.tb.active{background:var(--accent);border-color:var(--accent);color:#000;}
.tb.on{background:rgba(0,210,255,.12);border-color:var(--teal);}
.tb.on-green{background:rgba(50,215,75,.12);border-color:var(--green);}
.ttip{position:absolute;left:42px;top:50%;transform:translateY(-50%);background:#000;color:#ddd;padding:3px 8px;border-radius:5px;font-size:9px;font-weight:700;white-space:nowrap;pointer-events:none;opacity:0;transition:.1s;z-index:400;border:1px solid #2a2a2a;}
.tb:hover .ttip{opacity:1;}
.tsep{width:26px;height:1px;background:#1a1a1a;margin:2px 0;flex-shrink:0;}

/* â”€â”€ Canvas â”€â”€ */
.cwrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#050505;position:relative;overflow:hidden;}
.cstack{position:relative;outline:1px solid #1a1a1a;}
.cstack canvas{position:absolute;top:0;left:0;image-rendering:pixelated;image-rendering:crisp-edges;}
.cbottom{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:4px;background:rgba(0,0,0,.85);padding:6px 10px;border-radius:11px;border:1px solid #1e1e1e;align-items:center;backdrop-filter:blur(8px);flex-wrap:wrap;max-width:96vw;justify-content:center;}
.cbb{background:#1a1a1a;border:1px solid #282828;color:#aaa;padding:5px 9px;border-radius:6px;cursor:pointer;font-size:10px;font-weight:700;}
.cbb:hover{background:#252525;color:white;}
.cbb.danger{color:var(--danger);}
.zdsp{color:#444;font-size:10px;font-weight:700;min-width:28px;text-align:center;}
select.cbb{appearance:none;}
/* playback */
.play-btn{background:var(--green);color:#000;border:none;padding:5px 10px;border-radius:6px;font-weight:900;font-size:11px;cursor:pointer;}
.play-btn.playing{background:var(--danger);}
.fps-input{width:38px;background:#1a1a1a;border:1px solid #2a2a2a;color:#aaa;border-radius:5px;font-size:10px;font-weight:700;padding:4px 5px;text-align:center;}
/* axis dot */
#axis-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:rgba(255,0,0,0.8);border:1.5px solid white;cursor:move;z-index:20;transform:translate(-50%,-50%);display:none;}
#axis-cross-h{position:absolute;height:1px;background:rgba(255,0,0,0.4);pointer-events:none;z-index:19;display:none;}
#axis-cross-v{position:absolute;width:1px;background:rgba(255,0,0,0.4);pointer-events:none;z-index:19;display:none;}

/* â”€â”€ Right panel â”€â”€ */
.rbar{width:220px;background:#0a0a0a;border-left:1px solid #1a1a1a;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.rtabs{display:flex;border-bottom:1px solid #1a1a1a;flex-shrink:0;overflow-x:auto;}
.rtabs::-webkit-scrollbar{height:2px;}
.rtab{flex-shrink:0;padding:8px 7px;text-align:center;font-size:8px;font-weight:900;color:#333;cursor:pointer;border:none;background:none;transition:.1s;text-transform:uppercase;letter-spacing:.3px;}
.rtab.active{color:var(--teal);border-bottom:2px solid var(--teal);}
.rbody{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px;}
.rbody::-webkit-scrollbar{width:2px;}
.slabel{font-size:8px;font-weight:900;color:#2e2e2e;text-transform:uppercase;letter-spacing:1px;}

/* layer row */
.lrow{display:flex;align-items:center;gap:4px;background:#111;border:1.5px solid #1e1e1e;border-radius:7px;padding:4px 5px;cursor:pointer;transition:.1s;}
.lrow:hover{border-color:#333;}
.lrow.alay{border-color:var(--accent);}
.lrow canvas{border-radius:3px;border:1px solid #222;flex-shrink:0;image-rendering:pixelated;}
.lname{flex:1;font-size:9px;font-weight:700;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;}

/* frame strip */
.fstrip{display:flex;gap:4px;overflow-x:auto;padding:6px 8px;border-top:1px solid #1a1a1a;flex-shrink:0;align-items:center;min-height:58px;}
.fstrip::-webkit-scrollbar{height:2px;}
.fthumb{flex-shrink:0;border:2px solid #1e1e1e;border-radius:5px;cursor:pointer;overflow:hidden;transition:.1s;text-align:center;}
.fthumb:hover{border-color:#444;}
.fthumb.af{border-color:var(--accent);}
.fthumb canvas{display:block;image-rendering:pixelated;}
.fadd{flex-shrink:0;width:38px;height:44px;border:2px dashed #1e1e1e;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:16px;color:#222;cursor:pointer;transition:.1s;}
.fadd:hover{border-color:#444;color:#555;}

/* action/sprite cards */
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.acard{background:#0f0f0f;border:1.5px solid #181818;border-radius:7px;overflow:hidden;cursor:pointer;transition:.1s;position:relative;}
.acard:hover{border-color:#333;}
.acard canvas{display:block;width:100%;image-rendering:pixelated;}
.acname{padding:2px 5px 5px;font-size:8px;font-weight:800;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.adel{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.9);border:none;color:var(--danger);font-size:8px;border-radius:3px;padding:1px 4px;cursor:pointer;opacity:0;transition:.1s;}
.acard:hover .adel{opacity:1;}
.scard{background:#080812;border:1.5px solid #14142a;border-radius:8px;overflow:hidden;cursor:pointer;transition:.1s;position:relative;}
.scard:hover{border-color:var(--teal);}
.scard img{width:100%;aspect-ratio:1;object-fit:contain;padding:4px;display:block;image-rendering:pixelated;}
.slbl{padding:2px 6px 5px;font-size:8px;font-weight:800;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ubadge{position:absolute;inset:0 0 auto 0;background:rgba(0,210,255,.9);color:#000;font-size:8px;font-weight:900;text-align:center;padding:3px;opacity:0;transition:.1s;}
.scard:hover .ubadge{opacity:1;}

/* â”€â”€ REMAP (FFS-style) â”€â”€ */
.remap-slot{display:flex;align-items:center;gap:5px;padding:4px 0;border-bottom:1px solid #141414;}
.remap-from,.remap-to{width:24px;height:24px;border-radius:5px;border:1.5px solid #2a2a2a;cursor:pointer;flex-shrink:0;transition:.1s;}
.remap-from:hover,.remap-to:hover{border-color:#666;transform:scale(1.1);}
.remap-arrow{color:#333;font-size:11px;font-weight:900;}
.remap-empty{color:#252525;font-size:9px;font-weight:700;}
.remap-btn-row{display:flex;gap:4px;flex-wrap:wrap;}
.remap-btn-row .nb{flex:1;padding:6px 4px;font-size:9px;text-align:center;}

/* â”€â”€ Palette editor â”€â”€ */
.pal-editor-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;}
.pal-dot{aspect-ratio:1;border-radius:3px;cursor:pointer;border:1.5px solid transparent;transition:.1s;position:relative;}
.pal-dot:hover{transform:scale(1.2);z-index:2;}
.pal-dot.sel{border-color:white;}
.pal-dot.empty{background:repeating-linear-gradient(45deg,#1a1a1a,#1a1a1a 3px,#111 3px,#111 6px);border-color:#222;}

/* â”€â”€ Color panel â”€â”€ */
.chistrow{display:flex;gap:3px;flex-wrap:wrap;}
.cdot{width:18px;height:18px;border-radius:3px;border:1.5px solid #222;cursor:pointer;}
.cdot:hover{transform:scale(1.2);}
.hsl-trk{width:100%;height:12px;border-radius:4px;cursor:pointer;outline:none;padding:0;border:none;appearance:none;-webkit-appearance:none;}
.hsl-trk::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:white;border:2px solid #000;cursor:pointer;}
.pgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:2px;}
.pc{aspect-ratio:1;border-radius:3px;cursor:pointer;border:1.5px solid transparent;transition:.1s;}
.pc:hover{transform:scale(1.15);}
.pc.sel{border-color:white;}
.srow{display:flex;align-items:center;gap:5px;}
.srow input[type=range]{flex:1;accent-color:var(--accent);}
.sval{font-size:9px;font-weight:700;color:#555;min-width:26px;text-align:right;}

/* â”€â”€ Modals â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9000;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(10px);}
.modal{background:#111;padding:20px;border-radius:16px;width:100%;max-width:340px;border:1px solid #222;}
.modal h3{margin:0 0 12px;font-size:13px;font-weight:900;letter-spacing:1px;}
.modal input{width:100%;padding:9px 11px;background:#0a0a0a;border:1px solid #2a2a2a;color:white;border-radius:7px;margin-bottom:10px;font-family:inherit;font-size:13px;outline:none;box-sizing:border-box;}
.modal input:focus{border-color:var(--accent);}
.mrow{display:flex;gap:7px;}
.mrow .nb{flex:1;text-align:center;padding:9px;}

/* selection marching ants */
@keyframes march{to{stroke-dashoffset:-8;}}
#sel-rect{fill:none;stroke:white;stroke-width:1;stroke-dasharray:4 4;animation:march .5s linear infinite;pointer-events:none;}
#lasso-path{fill:rgba(255,255,255,.08);stroke:white;stroke-width:1;stroke-dasharray:3 3;animation:march .5s linear infinite;pointer-events:none;}

/* tolerance row */
.tol-row{display:flex;align-items:center;gap:5px;padding:2px 0;}
.tol-row input{flex:1;accent-color:var(--teal);}
.tol-val{font-size:9px;font-weight:700;color:#555;min-width:26px;text-align:right;}
</style>
</head>
<body>

<!-- Modals -->
<div id="pub-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--accent)">ğŸ“¤ Publish Sprite</h3>
    <input id="pub-name" placeholder="Character Name"><input id="pub-tags" placeholder="Tags: hero, female, robot...">
    <div class="mrow"><button class="nb" onclick="closePub()">Cancel</button><button class="nb accent" id="pub-btn" onclick="publishSprite()">PUBLISH</button></div>
  </div>
</div>
<div id="save-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--teal)">ğŸ’¾ Save to Your Sprites</h3>
    <input id="save-name" placeholder="Name this sprite...">
    <div class="mrow"><button class="nb" onclick="closeSave()">Cancel</button><button class="nb teal" onclick="savePersonal()">SAVE</button></div>
  </div>
</div>
<div id="act-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--green)">â• Name This Pose</h3>
    <input id="act-iname" placeholder="e.g. Attack, Idle, Running...">
    <div class="mrow"><button class="nb" onclick="closeAct()">Cancel</button><button class="nb green" onclick="confirmAct()">ADD</button></div>
  </div>
</div>
<div id="pal-preset-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--purple)">ğŸ’¾ Save Palette Preset</h3>
    <input id="preset-name" placeholder="e.g. Red Alt, Evil Version...">
    <div class="mrow"><button class="nb" onclick="document.getElementById('pal-preset-modal').style.display='none'">Cancel</button><button class="nb purple" onclick="savePalettePreset()">SAVE</button></div>
  </div>
</div>

<!-- top bar -->
<div class="topbar">
  <div style="display:flex;gap:5px;align-items:center;">
    <button class="nb" onclick="location.href='index.html'">ğŸ </button>
    <span style="font-size:11px;font-weight:900;color:var(--accent);letter-spacing:1px;">SPRITE EDITOR</span>
  </div>
  <div style="display:flex;gap:4px;flex-wrap:wrap;">
    <button class="nb" onclick="newSprite()">ğŸ†•</button>
    <button class="nb" onclick="document.getElementById('imp-inp').click()">ğŸ“ Import</button>
    <button class="nb" onclick="exportPNG()">â¬‡ PNG</button>
    <button class="nb" onclick="exportGIF()">ğŸ GIF</button>
    <button class="nb teal" onclick="openSave()">ğŸ’¾ Save</button>
    <button class="nb accent" onclick="openPub()">ğŸ“¤ Publish</button>
    <input type="file" id="imp-inp" hidden accept="image/*" onchange="importImg(this)">
  </div>
</div>

<div class="workspace">
  <!-- Left toolbar -->
  <div class="lbar" id="lbar">
    <!-- Draw tools -->
    <div class="tb active" id="tl-pencil"  onclick="setTool('pencil')" ><span>âœï¸</span><div class="ttip">Pencil (P)</div></div>
    <div class="tb" id="tl-pixperf" onclick="togglePP()"><span style="font-size:10px;font-weight:900;letter-spacing:-1px;">PP</span><div class="ttip">Pixel Perfect</div></div>
    <div class="tb" id="tl-line"    onclick="setTool('line')"   ><span style="font-size:12px;font-weight:900;">â•±</span><div class="ttip">Line (L)</div></div>
    <div class="tb" id="tl-rect"    onclick="setTool('rect')"   ><span>â¬œ</span><div class="ttip">Rectangle</div></div>
    <div class="tb" id="tl-ellipse" onclick="setTool('ellipse')"><span>â­•</span><div class="ttip">Ellipse (O)</div></div>
    <div class="tb" id="tl-fill"    onclick="setTool('fill')"   ><span>ğŸª£</span><div class="ttip">Fill (F) â€” right-click=global</div></div>
    <div class="tb" id="tl-gradient" onclick="setTool('gradient')"><span style="font-size:11px">ğŸŒˆ</span><div class="ttip">Gradient Fill</div></div>
    <div class="tb" id="tl-shade"   onclick="setTool('shade')"  ><span>ğŸŒ‘</span><div class="ttip">Shade/Tint</div></div>
    <div class="tb" id="tl-dither"  onclick="setTool('dither')" ><span style="font-size:11px">â–“</span><div class="ttip">Dither Brush</div></div>
    <div class="tb" id="tl-eraser"  onclick="setTool('eraser')" ><span>ğŸ©¹</span><div class="ttip">Eraser (E)</div></div>
    <div class="tb" id="tl-eyedrop" onclick="setTool('eyedrop')"><span>ğŸ’‰</span><div class="ttip">Eyedropper (I)</div></div>
    <div class="tsep"></div>
    <!-- Selection tools -->
    <div class="tb" id="tl-select"  onclick="setTool('select')" ><span style="font-size:12px">â¬š</span><div class="ttip">Rect Select (S)</div></div>
    <div class="tb" id="tl-lasso"   onclick="setTool('lasso')"  ><span style="font-size:12px">ğŸ”®</span><div class="ttip">Lasso Select</div></div>
    <div class="tb" id="tl-wand"    onclick="setTool('wand')"   ><span style="font-size:12px">ğŸª„</span><div class="ttip">Magic Wand</div></div>
    <div class="tsep"></div>
    <!-- Toggles -->
    <div class="tb" id="tl-mh"    onclick="toggleMirror('h')"><span style="font-size:11px">â†”</span><div class="ttip">Mirror H</div></div>
    <div class="tb" id="tl-mv"    onclick="toggleMirror('v')"><span style="font-size:11px">â†•</span><div class="ttip">Mirror V</div></div>
    <div class="tb" id="tl-grid"  onclick="toggleGrid()"     ><span style="font-size:11px">#</span><div class="ttip">Grid (G)</div></div>
    <div class="tb" id="tl-onion" onclick="toggleOnion()"    ><span style="font-size:12px">ğŸ§…</span><div class="ttip">Onion Skin</div></div>
    <div class="tb" id="tl-axis"  onclick="toggleAxisMode()" ><span style="font-size:11px">âœ›</span><div class="ttip">Show Axis/Origin</div></div>
    <div class="tsep"></div>
    <!-- Colors -->
    <div style="position:relative;width:36px;height:36px;flex-shrink:0;cursor:pointer;">
      <div id="sec-sw" style="position:absolute;right:0;bottom:0;width:20px;height:20px;border-radius:4px;border:2px solid #0a0a0a;background:#000;cursor:pointer;z-index:1;" onclick="document.getElementById('sec-pk').click()"></div>
      <div id="pri-sw" style="position:absolute;left:0;top:0;width:20px;height:20px;border-radius:4px;border:2px solid #444;background:#fff;z-index:2;cursor:pointer;" onclick="document.getElementById('pri-pk').click()"></div>
    </div>
    <input type="color" id="pri-pk" hidden value="#ffffff" oninput="setPri(this.value)">
    <input type="color" id="sec-pk" hidden value="#000000" oninput="setSec(this.value)">
    <div style="font-size:7px;color:#1e1e1e;font-weight:900;text-align:center;">PÂ·S</div>
  </div>

  <!-- Canvas area -->
  <div class="cwrap" id="cwrap">
    <div class="cstack" id="cstack" style="width:256px;height:256px;">
      <canvas id="cv-checker" width="64" height="64" style="width:256px;height:256px;z-index:0;"></canvas>
      <canvas id="cv-onion"   width="64" height="64" style="width:256px;height:256px;z-index:2;pointer-events:none;opacity:.3;display:none;"></canvas>
      <!-- layer canvases at z-index:3+ injected by JS -->
      <canvas id="cv-grid"    width="64" height="64" style="width:256px;height:256px;z-index:10;pointer-events:none;"></canvas>
      <canvas id="cv-overlay" width="64" height="64" style="width:256px;height:256px;z-index:11;pointer-events:none;"></canvas>
      <canvas id="cv-sel"     width="64" height="64" style="width:256px;height:256px;z-index:12;pointer-events:none;"></canvas>
      <svg id="sel-svg" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:13;pointer-events:none;overflow:visible;">
        <rect id="sel-rect" x="0" y="0" width="0" height="0"/>
        <path id="lasso-path" d=""/>
      </svg>
      <canvas id="cv-hit"     width="64" height="64" style="width:256px;height:256px;z-index:14;cursor:crosshair;background:transparent;"></canvas>
      <!-- Axis marker -->
      <div id="axis-cross-h" style="top:50%;left:0;right:0;"></div>
      <div id="axis-cross-v" style="left:50%;top:0;bottom:0;"></div>
      <div id="axis-dot" title="Drag to move axis"></div>
    </div>

    <div class="cbottom">
      <button class="cbb" onclick="undo()">â†©</button>
      <button class="cbb" onclick="redo()">â†ª</button>
      <span class="zdsp" id="zlbl">4Ã—</span>
      <button class="cbb" onclick="chZoom(-1)">âˆ’</button>
      <button class="cbb" onclick="chZoom(1)">+</button>
      <select class="cbb" id="sz-sel" onchange="resizeCv(+this.value)">
        <option value="16">16</option><option value="32">32</option>
        <option value="64" selected>64</option><option value="128">128</option>
        <option value="256">256</option><option value="512">512</option>
      </select>
      <button class="play-btn" id="play-btn" onclick="togglePlay()">â–¶ Play</button>
      <input class="fps-input" id="fps-inp" type="number" min="1" max="60" value="8" title="FPS">
      <button class="cbb" id="desel-btn" style="display:none;color:var(--teal);" onclick="clearSel()">âœ•Sel</button>
      <button class="cbb danger" onclick="clearCv()">Clear</button>
    </div>
  </div>

  <!-- Right panel -->
  <div class="rbar">
    <div class="rtabs" id="rtabs">
      <button class="rtab active" id="rtab-layers"  onclick="switchTab('layers')">Layers</button>
      <button class="rtab"        id="rtab-actions" onclick="switchTab('actions')">Actions</button>
      <button class="rtab"        id="rtab-remap"   onclick="switchTab('remap')" style="color:var(--purple)">Recolor</button>
      <button class="rtab"        id="rtab-palette" onclick="switchTab('palette')">Palette</button>
      <button class="rtab"        id="rtab-lib"     onclick="switchTab('lib')">Sprites</button>
      <button class="rtab"        id="rtab-color"   onclick="switchTab('color')">Color</button>
    </div>
    <div class="rbody" id="rbody"></div>

    <!-- Always-visible controls -->
    <div style="border-top:1px solid #141414;padding:7px;flex-shrink:0;">
      <div class="slabel" style="margin-bottom:3px;">Brush Size</div>
      <div class="srow"><input type="range" id="bsize" min="1" max="32" value="2" oninput="updBrush()"><span class="sval" id="bval">2px</span></div>
      <!-- Wand tolerance (shows when wand/lasso active) -->
      <div id="tol-group" style="display:none;">
        <div class="slabel" style="margin:4px 0 3px;">Wand Tolerance</div>
        <div class="tol-row"><input type="range" id="tol-sl" min="0" max="128" value="32" oninput="document.getElementById('tol-val-lbl').innerText=this.value"><span class="tol-val" id="tol-val-lbl">32</span></div>
        <label style="font-size:9px;color:#444;cursor:pointer;display:flex;align-items:center;gap:4px;margin-top:2px;"><input type="checkbox" id="contiguous-chk" checked style="accent-color:var(--teal);">Contiguous</label>
      </div>
      <div class="slabel" style="margin:5px 0 3px;">Layer Opacity</div>
      <div class="srow"><input type="range" id="lopac" min="0" max="100" value="100" oninput="setLayerOpac(+this.value)"><span class="sval" id="lopval">100%</span></div>
    </div>
    <!-- Frame strip -->
    <div class="fstrip" id="fstrip"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ComicCore Sprite Editor â€” FFS-inspired full edition
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _S = supabase.createClient('https://mmycqeejhguzhtzkyjaj.supabase.co','sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE');

// â”€â”€ Global state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let W=64,H=64,zoom=4;
let tool='pencil',priCol='#ffffff',secCol='#000000',bsize=2;
let pixPerf=false,mirH=false,mirV=false,showGrid=false,showOnion=false,showAxis=false;
let drawing=false,lx=null,ly=null,shStart=null;
let selOn=false,sx=0,sy=0,sw=0,sh=0,selData=null;
let lassoPoints=[],lassoActive=false;
let wandMask=null; // ImageData mask for wand selection
let axisX=0,axisY=0,axisDragging=false;
let playTimer=null;
let layers=[],aLidx=0;
let frames=[],aFidx=0,actions=[],mySprites=[];
let uStack=[],rStack=[],cTab='layers',myHandle=null,colHist=[];
let remapSlots=[]; // [{from, to}] â€” FFS remap table
let palPresets={}; // named palette presets
let extractedPalette=[]; // from "extract colors"
let blendMode='source-over';

const PALETTE=['#000','#fff','#ff0000','#ff7a00','#ffd700','#00e64d','#00d2ff','#3366ff',
  '#cc00ff','#7c3aed','#10b981','#f59e0b','#6b7280','#1f2937','#111','#ef4444',
  '#fde68a','#bbf7d0','#bfdbfe','#fce7f3','#713f12','#14532d','#1e3a8a','#581c87','#9d174d'];

// DOM refs
const hitCv=document.getElementById('cv-hit'),gridCv=document.getElementById('cv-grid'),
  ovCv=document.getElementById('cv-overlay'),onionCv=document.getElementById('cv-onion'),
  checkCv=document.getElementById('cv-checker'),selCv=document.getElementById('cv-sel'),
  cstack=document.getElementById('cstack'),axisDot=document.getElementById('axis-dot'),
  axisH=document.getElementById('axis-cross-h'),axisV=document.getElementById('axis-cross-v');
const gridCtx=gridCv.getContext('2d'),ovCtx=ovCv.getContext('2d'),onionCtx=onionCv.getContext('2d'),selCtx=selCv.getContext('2d');

// Init
window.onload=()=>{
  myHandle=JSON.parse(localStorage.getItem('user_profile')||'{}').handle||null;
  mkLayers(); initRemapSlots(12); initFrame();
  drawChecker(); applyZoom(); renderFstrip(); switchTab('layers');
  fetchLib(); buildStaticPal(); updSwatches();
  axisX=W/2; axisY=H;

  hitCv.addEventListener('pointerdown',onDn);
  hitCv.addEventListener('pointermove',onMv);
  hitCv.addEventListener('pointerup',  onUp);
  hitCv.addEventListener('pointerleave',()=>{ovCtx.clearRect(0,0,W,H);drawing=false;});
  hitCv.addEventListener('contextmenu',e=>{e.preventDefault();swapC();});
  axisDot.addEventListener('pointerdown',startAxisDrag);
  window.addEventListener('keydown',onKey);
};

// â”€â”€ Layers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkLayer(name='Layer'){
  const cv=document.createElement('canvas');cv.width=W;cv.height=H;
  cv.style.cssText=`position:absolute;top:0;left:0;width:${W*zoom}px;height:${H*zoom}px;image-rendering:pixelated;image-rendering:crisp-edges;z-index:3;pointer-events:none;`;
  return{id:Date.now()+Math.random(),name,vis:true,opacity:100,blend:'source-over',cv,ctx:cv.getContext('2d')};
}
function mkLayers(){layers=[mkLayer('Lineart'),mkLayer('Color')];aLidx=0;layers.forEach(l=>cstack.insertBefore(l.cv,gridCv));}
function aL(){return layers[aLidx];}
function addLayer(){saveSt();const l=mkLayer('Layer '+(layers.length+1));layers.splice(aLidx+1,0,l);aLidx++;cstack.insertBefore(layers[aLidx].cv,gridCv);renderR();}
function delLayer(){if(layers.length<=1)return alert('Need at least 1 layer.');saveSt();cstack.removeChild(layers[aLidx].cv);layers.splice(aLidx,1);aLidx=Math.max(0,aLidx-1);renderR();}
function mvLU(){if(aLidx<=0)return;saveSt();[layers[aLidx],layers[aLidx-1]]=[layers[aLidx-1],layers[aLidx]];aLidx--;reorderDOM();renderR();}
function mvLD(){if(aLidx>=layers.length-1)return;saveSt();[layers[aLidx],layers[aLidx+1]]=[layers[aLidx+1],layers[aLidx]];aLidx++;reorderDOM();renderR();}
function reorderDOM(){layers.forEach(l=>{if(l.cv.parentNode)cstack.removeChild(l.cv);});layers.forEach(l=>cstack.insertBefore(l.cv,gridCv));}
function mergeDn(){if(aLidx>=layers.length-1)return;saveSt();const a=layers[aLidx],b=layers[aLidx+1];b.ctx.globalAlpha=a.opacity/100;b.ctx.globalCompositeOperation=a.blend;b.ctx.drawImage(a.cv,0,0);b.ctx.globalAlpha=1;b.ctx.globalCompositeOperation='source-over';cstack.removeChild(a.cv);layers.splice(aLidx,1);aLidx=Math.min(aLidx,layers.length-1);renderR();}
function mergeAll(){saveSt();const m=mkLayer('Merged');layers.forEach(l=>{if(!l.vis)return;m.ctx.globalAlpha=l.opacity/100;m.ctx.globalCompositeOperation=l.blend;m.ctx.drawImage(l.cv,0,0);});m.ctx.globalAlpha=1;m.ctx.globalCompositeOperation='source-over';layers.forEach(l=>{if(l.cv.parentNode)cstack.removeChild(l.cv);});layers=[m];aLidx=0;cstack.insertBefore(layers[0].cv,gridCv);renderR();}
function setLayerOpac(v){aL().opacity=v;aL().cv.style.opacity=v/100;document.getElementById('lopval').innerText=v+'%';}

// â”€â”€ Frames â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function capFrame(){const s={};layers.forEach(l=>{s[l.id]=l.ctx.getImageData(0,0,W,H);});return s;}
function initFrame(){frames=[capFrame()];aFidx=0;}
function saveFrame(){frames[aFidx]=capFrame();}
function loadFrame(i){const s=frames[i];layers.forEach(l=>{l.ctx.clearRect(0,0,W,H);if(s&&s[l.id])l.ctx.putImageData(s[l.id],0,0);});}
function addFrame(){saveFrame();frames.push({}); // blank frame
  aFidx=frames.length-1;renderFstrip();}
function dupFrame(){saveFrame();frames.splice(aFidx+1,0,capFrame());aFidx++;loadFrame(aFidx);renderFstrip();}
function switchFrame(i){saveFrame();aFidx=i;loadFrame(i);renderFstrip();if(showOnion)drawOnion();}
function delFrame(i){if(frames.length<=1)return;frames.splice(i,1);aFidx=Math.max(0,Math.min(aFidx,frames.length-1));loadFrame(aFidx);renderFstrip();}
function drawFrameOn(f,cv){const c=cv.getContext('2d');c.clearRect(0,0,cv.width,cv.height);layers.forEach(l=>{if(!l.vis)return;const d=f[l.id];if(d)c.putImageData(d,0,0);});}

// â”€â”€ Animation playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePlay(){
  if(playTimer){clearInterval(playTimer);playTimer=null;document.getElementById('play-btn').textContent='â–¶ Play';document.getElementById('play-btn').classList.remove('playing');return;}
  saveFrame();
  const fps=Math.max(1,Math.min(60,+document.getElementById('fps-inp').value||8));
  document.getElementById('play-btn').textContent='â¹ Stop';document.getElementById('play-btn').classList.add('playing');
  playTimer=setInterval(()=>{
    let next=(aFidx+1)%frames.length;
    loadFrame(next);aFidx=next;renderFstrip();
  },1000/fps);
}

// â”€â”€ Frame strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFstrip(){
  if(playTimer)return; // don't re-render while playing
  const s=document.getElementById('fstrip');s.innerHTML='';
  const ts=38;
  frames.forEach((f,i)=>{
    const w=document.createElement('div');w.className='fthumb'+(i===aFidx?' af':'');w.style.width=ts+'px';
    const cv=document.createElement('canvas');cv.width=W;cv.height=H;cv.style.cssText=`width:${ts}px;height:${ts}px;display:block;`;
    drawFrameOn(f,cv);
    const n=document.createElement('div');n.style.cssText=`font-size:7px;font-weight:900;color:${i===aFidx?'var(--accent)':'#2a2a2a'};text-align:center;padding:1px 0 2px;`;n.innerText=i+1;
    w.append(cv,n);
    w.onclick=()=>switchFrame(i);
    w.oncontextmenu=e=>{e.preventDefault();
      const m=document.createElement('div');m.style.cssText='position:fixed;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px;z-index:500;display:flex;flex-direction:column;gap:3px;';
      m.style.left=e.clientX+'px';m.style.top=e.clientY+'px';
      [['Duplicate',()=>{switchFrame(i);dupFrame();}],['Delete',()=>{if(frames.length>1&&confirm('Delete frame '+(i+1)+'?'))delFrame(i);}]].forEach(([lbl,fn])=>{const b=document.createElement('button');b.className='nb';b.style.cssText='padding:5px 10px;font-size:10px;';b.innerText=lbl;b.onclick=()=>{m.remove();fn();};m.appendChild(b);});
      document.body.appendChild(m);setTimeout(()=>document.addEventListener('click',()=>m.remove(),{once:true}),50);
    };
    s.appendChild(w);
  });
  const add=document.createElement('div');add.className='fadd';add.innerText='+';add.onclick=addFrame;s.appendChild(add);
}

function drawOnion(){onionCtx.clearRect(0,0,W,H);if(!showOnion||aFidx===0)return;const p=frames[aFidx-1];layers.forEach(l=>{if(p&&p[l.id]){onionCtx.globalAlpha=1;onionCtx.putImageData(p[l.id],0,0);}});}

// â”€â”€ Axis / origin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAxisMode(){showAxis=!showAxis;document.getElementById('tl-axis').classList.toggle('on',showAxis);updateAxisDisplay();}
function updateAxisDisplay(){
  const d=showAxis;axisDot.style.display=d?'block':'none';axisH.style.display=d?'block':'none';axisV.style.display=d?'block':'none';
  if(!d)return;
  const px=zoom;axisDot.style.left=(axisX*px)+'px';axisDot.style.top=(axisY*px)+'px';
  axisH.style.top=(axisY*px)+'px';axisH.style.left='0';axisH.style.right='0';axisH.style.height='1px';axisH.style.position='absolute';
  axisV.style.left=(axisX*px)+'px';axisV.style.top='0';axisV.style.bottom='0';axisV.style.width='1px';axisV.style.position='absolute';
}
function startAxisDrag(e){e.preventDefault();e.stopPropagation();axisDragging=true;const up=()=>{axisDragging=false;window.removeEventListener('pointermove',doDrag);window.removeEventListener('pointerup',up);};const doDrag=(ev)=>{const r=cstack.getBoundingClientRect();axisX=Math.max(0,Math.min(W,Math.round((ev.clientX-r.left)/zoom)));axisY=Math.max(0,Math.min(H,Math.round((ev.clientY-r.top)/zoom)));updateAxisDisplay();};window.addEventListener('pointermove',doDrag);window.addEventListener('pointerup',up);}

// â”€â”€ Zoom / Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyZoom(){
  const pw=W*zoom,ph=H*zoom;
  cstack.style.width=pw+'px';cstack.style.height=ph+'px';
  [checkCv,gridCv,ovCv,onionCv,hitCv,selCv,...layers.map(l=>l.cv)].forEach(cv=>{cv.style.width=pw+'px';cv.style.height=ph+'px';});
  document.getElementById('zlbl').innerText=zoom+'Ã—';
  drawChecker();if(showGrid)drawGrid();updateAxisDisplay();
}
function chZoom(d){const st=[1,2,3,4,6,8,12,16];const i=st.indexOf(zoom);zoom=st[Math.max(0,Math.min(st.length-1,i+d))];applyZoom();}
function resizeCv(ns){
  if(!confirm(`Resize to ${ns}Ã—${ns}?`)){document.getElementById('sz-sel').value=W;return;}
  saveSt();W=ns;H=ns;
  [checkCv,gridCv,ovCv,onionCv,hitCv,selCv].forEach(cv=>{cv.width=ns;cv.height=ns;});
  layers.forEach(l=>{const t=document.createElement('canvas');t.width=ns;t.height=ns;t.getContext('2d').drawImage(l.cv,0,0,ns,ns);l.cv.width=ns;l.cv.height=ns;l.ctx.drawImage(t,0,0);});
  frames=frames.map(()=>capFrame());drawChecker();applyZoom();
}
function drawChecker(){const c=checkCv.getContext('2d'),s=4;for(let y=0;y<H;y+=s)for(let x=0;x<W;x+=s){c.fillStyle=((x/s+y/s)%2===0)?'#222':'#161616';c.fillRect(x,y,s,s);}}
function drawGrid(){gridCtx.clearRect(0,0,W,H);if(!showGrid)return;gridCtx.strokeStyle='rgba(255,255,255,.08)';gridCtx.lineWidth=.5;const st=W>=64?8:4;for(let x=0;x<=W;x+=st){gridCtx.beginPath();gridCtx.moveTo(x,0);gridCtx.lineTo(x,H);gridCtx.stroke();}for(let y=0;y<=H;y+=st){gridCtx.beginPath();gridCtx.moveTo(0,y);gridCtx.lineTo(W,y);gridCtx.stroke();}}
function toggleGrid(){showGrid=!showGrid;document.getElementById('tl-grid').classList.toggle('on',showGrid);drawGrid();}
function toggleOnion(){showOnion=!showOnion;onionCv.style.display=showOnion?'block':'none';document.getElementById('tl-onion').classList.toggle('on',showOnion);drawOnion();}

// â”€â”€ Tool switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTool(t){
  tool=t;
  document.querySelectorAll('#lbar .tb[id^="tl-"]').forEach(b=>b.classList.remove('active'));
  document.getElementById('tl-'+t)?.classList.add('active');
  hitCv.style.cursor=t==='select'||t==='lasso'||t==='wand'?'default':'crosshair';
  document.getElementById('tol-group').style.display=(t==='wand'||t==='lasso')?'block':'none';
  if(t!=='select'&&t!=='lasso'&&t!=='wand')clearSel();
}
function togglePP(){pixPerf=!pixPerf;document.getElementById('tl-pixperf').classList.toggle('on',pixPerf);}
function toggleMirror(a){if(a==='h'){mirH=!mirH;document.getElementById('tl-mh').classList.toggle('on',mirH);}else{mirV=!mirV;document.getElementById('tl-mv').classList.toggle('on',mirV);}}

// â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPri(h){priCol=h;document.getElementById('pri-sw').style.background=h;document.getElementById('pri-pk').value=h;addHist(h);if(cTab==='color')renderR();}
function setSec(h){secCol=h;document.getElementById('sec-sw').style.background=h;document.getElementById('sec-pk').value=h;}
function swapC(){[priCol,secCol]=[secCol,priCol];updSwatches();}
function updSwatches(){document.getElementById('pri-sw').style.background=priCol;document.getElementById('sec-sw').style.background=secCol;document.getElementById('pri-pk').value=priCol;document.getElementById('sec-pk').value=secCol;}
function addHist(h){colHist=[h,...colHist.filter(c=>c!==h)].slice(0,20);}
function updBrush(){bsize=+document.getElementById('bsize').value;document.getElementById('bval').innerText=bsize+'px';}
function buildStaticPal(){} // built dynamically in renderR

// â”€â”€ Pointer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gPos(e){const r=hitCv.getBoundingClientRect();return{x:Math.max(0,Math.min(W-1,Math.floor((e.clientX-r.left)/zoom))),y:Math.max(0,Math.min(H-1,Math.floor((e.clientY-r.top)/zoom)))};}
function onDn(e){e.preventDefault();if(axisDragging)return;const p=gPos(e),col=e.button===2?secCol:priCol;saveSt();drawing=true;lx=p.x;ly=p.y;
  if(tool==='select'){selOn=false;sx=p.x;sy=p.y;sw=0;sh=0;updSelRect();return;}
  if(tool==='lasso'){lassoPoints=[[p.x,p.y]];lassoActive=true;updateLassoPath();return;}
  if(tool==='wand'){applyWand(p.x,p.y,col);return;}
  if(tool==='fill'){flood(p.x,p.y,col,e.button===2);return;}
  if(tool==='gradient'){shStart=p;return;}
  if(tool==='eyedrop'){pickCol(p.x,p.y);return;}
  if(['line','rect','ellipse'].includes(tool)){shStart=p;return;}
  paint(p.x,p.y,col);
}
function onMv(e){if(!drawing)return;e.preventDefault();const p=gPos(e),col=e.buttons===2?secCol:priCol;
  if(tool==='select'){sw=p.x-sx;sh=p.y-sy;updSelRect();return;}
  if(tool==='lasso'){lassoPoints.push([p.x,p.y]);updateLassoPath();return;}
  if(tool==='line'){ovCtx.clearRect(0,0,W,H);ovCtx.strokeStyle=col;ovCtx.lineWidth=Math.max(1,bsize);ovCtx.beginPath();ovCtx.moveTo(shStart.x+.5,shStart.y+.5);ovCtx.lineTo(p.x+.5,p.y+.5);ovCtx.stroke();return;}
  if(tool==='rect'){ovCtx.clearRect(0,0,W,H);ovCtx.strokeStyle=col;ovCtx.lineWidth=Math.max(1,bsize);ovCtx.strokeRect(shStart.x+.5,shStart.y+.5,p.x-shStart.x,p.y-shStart.y);return;}
  if(tool==='ellipse'){ovCtx.clearRect(0,0,W,H);const cx=(shStart.x+p.x)/2+.5,cy=(shStart.y+p.y)/2+.5,rx=Math.abs(p.x-shStart.x)/2,ry=Math.abs(p.y-shStart.y)/2;ovCtx.strokeStyle=col;ovCtx.lineWidth=Math.max(1,bsize);ovCtx.beginPath();ovCtx.ellipse(cx,cy,Math.max(1,rx),Math.max(1,ry),0,0,Math.PI*2);ovCtx.stroke();return;}
  if(tool==='gradient'){ovCtx.clearRect(0,0,W,H);const grd=ovCtx.createLinearGradient(shStart.x,shStart.y,p.x,p.y);grd.addColorStop(0,priCol);grd.addColorStop(1,secCol);ovCtx.fillStyle=grd;ovCtx.fillRect(0,0,W,H);return;}
  if(['pencil','eraser','shade','dither'].includes(tool))plotLine(lx,ly,p.x,p.y,col);
  lx=p.x;ly=p.y;
}
function onUp(e){if(!drawing)return;drawing=false;const p=gPos(e),col=e.button===2?secCol:priCol;
  ovCtx.clearRect(0,0,W,H);
  if(tool==='select'){finalSel(p);return;}
  if(tool==='lasso'){finaliseLasso();return;}
  const l=aL();
  if(tool==='line'){l.ctx.strokeStyle=col;l.ctx.lineWidth=bsize;l.ctx.beginPath();l.ctx.moveTo(shStart.x+.5,shStart.y+.5);l.ctx.lineTo(p.x+.5,p.y+.5);l.ctx.stroke();if(mirH){l.ctx.beginPath();l.ctx.moveTo(W-1-shStart.x+.5,shStart.y+.5);l.ctx.lineTo(W-1-p.x+.5,p.y+.5);l.ctx.stroke();}}
  if(tool==='rect'){l.ctx.strokeStyle=col;l.ctx.lineWidth=bsize;l.ctx.strokeRect(shStart.x+.5,shStart.y+.5,p.x-shStart.x,p.y-shStart.y);}
  if(tool==='ellipse'){const cx=(shStart.x+p.x)/2+.5,cy=(shStart.y+p.y)/2+.5,rx=Math.abs(p.x-shStart.x)/2,ry=Math.abs(p.y-shStart.y)/2;l.ctx.strokeStyle=col;l.ctx.lineWidth=bsize;l.ctx.beginPath();l.ctx.ellipse(cx,cy,Math.max(1,rx),Math.max(1,ry),0,0,Math.PI*2);l.ctx.stroke();}
  if(tool==='gradient'){const grd=l.ctx.createLinearGradient(shStart.x,shStart.y,p.x,p.y);grd.addColorStop(0,priCol);grd.addColorStop(1,secCol);l.ctx.fillStyle=grd;l.ctx.fillRect(0,0,W,H);}
}

// â”€â”€ Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function paint(x,y,col){const l=aL();if(!l.vis)return;const h=Math.floor(bsize/2);
  if(tool==='eraser'){l.ctx.clearRect(x-h,y-h,bsize,bsize);if(mirH)l.ctx.clearRect(W-1-x-h,y-h,bsize,bsize);if(mirV)l.ctx.clearRect(x-h,H-1-y-h,bsize,bsize);return;}
  if(tool==='shade'){const id=l.ctx.getImageData(x,y,1,1).data;if(id[3]===0)return;const f=col===secCol?1.15:.85;l.ctx.fillStyle=`rgb(${Math.min(255,id[0]*f)|0},${Math.min(255,id[1]*f)|0},${Math.min(255,id[2]*f)|0})`;l.ctx.fillRect(x-h,y-h,bsize,bsize);return;}
  if(tool==='dither'){if((x+y)%2===0){l.ctx.fillStyle=col;l.ctx.fillRect(x-h,y-h,bsize,bsize);}return;}
  if(pixPerf&&lx!==null){const dx=Math.abs(x-lx),dy=Math.abs(y-ly);if(dx===1&&dy===1){l.ctx.fillStyle=col;l.ctx.fillRect(x,y,1,1);return;}}
  l.ctx.fillStyle=col;l.ctx.fillRect(x-h,y-h,bsize,bsize);
  if(mirH)l.ctx.fillRect(W-1-x-h,y-h,bsize,bsize);
  if(mirV)l.ctx.fillRect(x-h,H-1-y-h,bsize,bsize);
}
function plotLine(x0,y0,x1,y1,col){let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx=x0<x1?1:-1,sy=y0<y1?1:-1,err=dx-dy;for(;;){paint(x0,y0,col);if(x0===x1&&y0===y1)break;const e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}}

// â”€â”€ Fill (with global option) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flood(sx2,sy2,fc,global=false){
  const l=aL();const id=l.ctx.getImageData(0,0,W,H),d=id.data;
  const idx=(sx2+sy2*W)*4,tg=[d[idx],d[idx+1],d[idx+2],d[idx+3]],fl=hx2rgb(fc);
  if(tg.every((v,j)=>v===fl[j]))return;
  if(global){
    // Replace ALL matching pixels regardless of connectivity (FFS non-contiguous fill)
    for(let i=0;i<d.length;i+=4){if(mC(d,i,tg)){d[i]=fl[0];d[i+1]=fl[1];d[i+2]=fl[2];d[i+3]=fl[3];}}
    l.ctx.putImageData(id,0,0);return;
  }
  const stk=[[sx2,sy2]],vis=new Uint8Array(W*H);
  while(stk.length){const[x,y]=stk.pop();if(x<0||x>=W||y<0||y>=H||vis[x+y*W])continue;const i4=(x+y*W)*4;if(!mC(d,i4,tg))continue;vis[x+y*W]=1;d[i4]=fl[0];d[i4+1]=fl[1];d[i4+2]=fl[2];d[i4+3]=fl[3];stk.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);}
  l.ctx.putImageData(id,0,0);
}
function mC(d,i,t){return d[i]===t[0]&&d[i+1]===t[1]&&d[i+2]===t[2]&&d[i+3]===t[3];}
function hx2rgb(h){if(!h||h.length<7)return[0,0,0,255];const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return[r,g,b,255];}
function rgb2hx(r,g,b){return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}

// â”€â”€ Magic Wand â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyWand(x,y){
  const l=aL();const id=l.ctx.getImageData(0,0,W,H),d=id.data;
  const tol=+document.getElementById('tol-sl').value;
  const contiguous=document.getElementById('contiguous-chk').checked;
  const idx=(x+y*W)*4,tR=d[idx],tG=d[idx+1],tB=d[idx+2],tA=d[idx+3];
  const mask=new Uint8Array(W*H);
  function inTol(i){return Math.abs(d[i]-tR)+Math.abs(d[i+1]-tG)+Math.abs(d[i+2]-tB)+Math.abs(d[i+3]-tA)<=tol*4;}
  if(contiguous){
    const stk=[[x,y]],vis=new Uint8Array(W*H);
    while(stk.length){const[cx,cy]=stk.pop();if(cx<0||cx>=W||cy<0||cy>=H||vis[cx+cy*W])continue;const i4=(cx+cy*W)*4;if(!inTol(i4))continue;vis[cx+cy*W]=1;mask[cx+cy*W]=1;stk.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);}
  } else {
    for(let i=0;i<W*H;i++){if(inTol(i*4))mask[i]=1;}
  }
  // draw selection overlay
  selCtx.clearRect(0,0,W,H);selCtx.fillStyle='rgba(0,210,255,.35)';
  for(let py=0;py<H;py++)for(let px=0;px<W;px++){if(mask[px+py*W])selCtx.fillRect(px,py,1,1);}
  wandMask=mask;selOn=true;
  document.getElementById('desel-btn').style.display='block';
}

// â”€â”€ Lasso â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLassoPath(){
  if(!lassoPoints.length)return;
  const px=zoom;let d='M '+lassoPoints[0][0]*px+' '+lassoPoints[0][1]*px;
  lassoPoints.slice(1).forEach(p=>d+=' L '+p[0]*px+' '+p[1]*px);
  document.getElementById('lasso-path').setAttribute('d',d);
}
function finaliseLasso(){
  lassoActive=false;
  if(lassoPoints.length<3){clearSel();return;}
  const px=zoom;
  // close path
  const d=document.getElementById('lasso-path').getAttribute('d')+' Z';
  document.getElementById('lasso-path').setAttribute('d',d);
  // rasterize into selCtx as mask
  selCtx.clearRect(0,0,W,H);
  // Use the overlay at pixel scale, then read back
  const tmpCv=document.createElement('canvas');tmpCv.width=W;tmpCv.height=H;
  const tc=tmpCv.getContext('2d');tc.fillStyle='rgba(0,210,255,.5)';
  tc.beginPath();lassoPoints.forEach((p,i)=>i===0?tc.moveTo(p[0],p[1]):tc.lineTo(p[0],p[1]));tc.closePath();tc.fill();
  selCtx.drawImage(tmpCv,0,0);
  wandMask=null;selOn=true;
  document.getElementById('desel-btn').style.display='block';
}

// â”€â”€ Rect selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updSelRect(){const px=zoom;document.getElementById('sel-rect').setAttribute('x',Math.min(sx,sx+sw)*px);document.getElementById('sel-rect').setAttribute('y',Math.min(sy,sy+sh)*px);document.getElementById('sel-rect').setAttribute('width',Math.abs(sw)*px);document.getElementById('sel-rect').setAttribute('height',Math.abs(sh)*px);}
function finalSel(p){sw=p.x-sx;sh=p.y-sy;if(Math.abs(sw)<1||Math.abs(sh)<1){clearSel();return;}if(sw<0){sx+=sw;sw=Math.abs(sw);}if(sh<0){sy+=sh;sh=Math.abs(sh);}selOn=true;selData=aL().ctx.getImageData(sx,sy,sw,sh);document.getElementById('desel-btn').style.display='block';updSelRect();}
function clearSel(){selOn=false;selData=null;wandMask=null;lassoPoints=[];document.getElementById('sel-rect').setAttribute('width',0);document.getElementById('sel-rect').setAttribute('height',0);document.getElementById('lasso-path').setAttribute('d','');selCtx.clearRect(0,0,W,H);document.getElementById('desel-btn').style.display='none';}
function moveSel(dx,dy){if(!selData||!selOn)return;saveSt();const l=aL();l.ctx.clearRect(sx,sy,sw,sh);sx+=dx;sy+=dy;l.ctx.putImageData(selData,sx,sy);updSelRect();}
function flipSelH(){if(!selData||!selOn)return;saveSt();const t=document.createElement('canvas');t.width=sw;t.height=sh;t.getContext('2d').putImageData(selData,0,0);const l=aL();l.ctx.clearRect(sx,sy,sw,sh);l.ctx.save();l.ctx.translate(sx+sw,sy);l.ctx.scale(-1,1);l.ctx.drawImage(t,0,0);l.ctx.restore();selData=l.ctx.getImageData(sx,sy,sw,sh);}
function flipSelV(){if(!selData||!selOn)return;saveSt();const t=document.createElement('canvas');t.width=sw;t.height=sh;t.getContext('2d').putImageData(selData,0,0);const l=aL();l.ctx.clearRect(sx,sy,sw,sh);l.ctx.save();l.ctx.translate(sx,sy+sh);l.ctx.scale(1,-1);l.ctx.drawImage(t,0,0);l.ctx.restore();selData=l.ctx.getImageData(sx,sy,sw,sh);}

// â”€â”€ Eyedropper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickCol(x,y){const t=document.createElement('canvas');t.width=W;t.height=H;const tc=t.getContext('2d');layers.forEach(l=>{if(l.vis){tc.globalAlpha=l.opacity/100;tc.drawImage(l.cv,0,0);}});tc.globalAlpha=1;const px=tc.getImageData(x,y,1,1).data;if(px[3]===0)return;setPri(rgb2hx(px[0],px[1],px[2]));setTool('pencil');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FFS COLOR REMAP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initRemapSlots(count){remapSlots=Array.from({length:count},()=>({from:null,to:null}));}

function applyRemapToImageData(id){
  // Build fast lookup from remapSlots
  const slots=remapSlots.filter(s=>s.from&&s.to);
  if(!slots.length)return id;
  const d=id.data;
  for(let i=0;i<d.length;i+=4){
    if(d[i+3]===0)continue;
    for(const s of slots){
      const fr=hx2rgb(s.from),to=hx2rgb(s.to);
      if(d[i]===fr[0]&&d[i+1]===fr[1]&&d[i+2]===fr[2]&&d[i+3]===fr[3]){
        d[i]=to[0];d[i+1]=to[1];d[i+2]=to[2];break;
      }
    }
  }
  return id;
}

function applyRemapToLayer(l){const id=l.ctx.getImageData(0,0,W,H);applyRemapToImageData(id);l.ctx.putImageData(id,0,0);}

function remapCurrentFrame(){
  saveSt();layers.forEach(l=>applyRemapToLayer(l));toast('âœ… Remap applied to current frame','var(--purple)');
}

function remapAllFrames(){
  if(!confirm('Apply remap to ALL '+frames.length+' frames? This is undoable for the current frame only.'))return;
  saveFrame();
  frames.forEach((f,fi)=>{
    layers.forEach(l=>{
      if(f[l.id]){
        const id=new ImageData(new Uint8ClampedArray(f[l.id].data),f[l.id].width,f[l.id].height);
        applyRemapToImageData(id);f[l.id]=id;
      }
    });
  });
  loadFrame(aFidx);
  toast('âœ… Remap applied to all frames','var(--purple)');
}

async function remapAllPersonalSprites(){
  if(!myHandle)return alert('Log in first.');
  if(!confirm('Apply this remap to ALL your saved personal sprites? This cannot be undone.'))return;
  const slots=remapSlots.filter(s=>s.from&&s.to);
  if(!slots.length)return alert('No remap slots defined.');
  toast('â³ Recoloring sprites...','#888');
  const{data}=await _S.from('user_sprites').select('*').eq('owner_handle',myHandle);
  if(!data||!data.length){toast('No personal sprites found','#888');return;}
  let count=0;
  for(const sp of data){
    const img=new Image();await new Promise(res=>{img.onload=res;img.src=sp.image_data;});
    const cv=document.createElement('canvas');cv.width=img.naturalWidth;cv.height=img.naturalHeight;
    const c=cv.getContext('2d');c.drawImage(img,0,0);
    const id=c.getImageData(0,0,cv.width,cv.height);applyRemapToImageData(id);c.putImageData(id,0,0);
    await _S.from('user_sprites').update({image_data:cv.toDataURL('image/png')}).eq('id',sp.id);
    count++;
  }
  toast(`âœ… Recolored ${count} sprites!`,'var(--purple)');
  fetchLib();
}

// â”€â”€ Palette extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractColors(){
  const tmp=document.createElement('canvas');tmp.width=W;tmp.height=H;const tc=tmp.getContext('2d');
  layers.forEach(l=>{if(l.vis){tc.globalAlpha=l.opacity/100;tc.drawImage(l.cv,0,0);}});tc.globalAlpha=1;
  const id=tc.getImageData(0,0,W,H);const d=id.data;const seen=new Set();const cols=[];
  for(let i=0;i<d.length;i+=4){if(d[i+3]<10)continue;const h=rgb2hx(d[i],d[i+1],d[i+2]);if(!seen.has(h)){seen.add(h);cols.push(h);}}
  extractedPalette=cols.slice(0,48);
  switchTab('palette');
  toast('âœ… '+extractedPalette.length+' colors extracted','var(--teal)');
}

// â”€â”€ Adapt image to extracted palette (FFS "Adapt Image to Palette") â”€â”€
function adaptToExtractedPalette(){
  if(!extractedPalette.length)return alert('Extract colors first.');
  saveSt();
  // For each pixel, remap to the nearest color in the extracted palette
  layers.forEach(l=>{
    const id=l.ctx.getImageData(0,0,W,H);const d=id.data;
    const palRgb=extractedPalette.map(hx2rgb);
    for(let i=0;i<d.length;i+=4){
      if(d[i+3]===0)continue;
      let best=0,bestDist=Infinity;
      palRgb.forEach((p,pi)=>{const dist=(d[i]-p[0])**2+(d[i+1]-p[1])**2+(d[i+2]-p[2])**2;if(dist<bestDist){bestDist=dist;best=pi;}});
      const c=palRgb[best];d[i]=c[0];d[i+1]=c[1];d[i+2]=c[2];
    }
    l.ctx.putImageData(id,0,0);
  });
  toast('âœ… Adapted to palette','var(--teal)');
}

// â”€â”€ Palette presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePalettePreset(){
  const name=document.getElementById('preset-name').value.trim();if(!name)return;
  palPresets[name]=remapSlots.map(s=>({...s}));
  document.getElementById('pal-preset-modal').style.display='none';
  if(cTab==='remap')renderR();
  toast('ğŸ’¾ Preset "'+name+'" saved','var(--purple)');
}
function loadPalettePreset(name){remapSlots=palPresets[name].map(s=>({...s}));renderR();}

// â”€â”€ Undo/Redo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSt(){uStack.push(layers.map(l=>({id:l.id,d:l.ctx.getImageData(0,0,W,H)})));if(uStack.length>50)uStack.shift();rStack=[];}
function undo(){if(!uStack.length)return;rStack.push(layers.map(l=>({id:l.id,d:l.ctx.getImageData(0,0,W,H)})));const p=uStack.pop();p.forEach(s=>{const l=layers.find(l=>l.id===s.id);if(l)l.ctx.putImageData(s.d,0,0);});}
function redo(){if(!rStack.length)return;uStack.push(layers.map(l=>({id:l.id,d:l.ctx.getImageData(0,0,W,H)})));const n=rStack.pop();n.forEach(s=>{const l=layers.find(l=>l.id===s.id);if(l)l.ctx.putImageData(s.d,0,0);});}

// â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onKey(e){if(e.target.tagName==='INPUT')return;const k=e.key.toLowerCase();
  if(k==='p')setTool('pencil');if(k==='e')setTool('eraser');if(k==='l')setTool('line');
  if(k==='f')setTool('fill');if(k==='i')setTool('eyedrop');if(k==='s')setTool('select');
  if(k==='o')setTool('ellipse');if(k==='x')swapC();if(k==='g')toggleGrid();
  if((e.ctrlKey||e.metaKey)&&k==='z'){e.preventDefault();e.shiftKey?redo():undo();}
  if((e.ctrlKey||e.metaKey)&&k==='s'){e.preventDefault();openSave();}
  if(selOn&&selData){
    if(k==='arrowleft')moveSel(-1,0);if(k==='arrowright')moveSel(1,0);
    if(k==='arrowup')moveSel(0,-1);if(k==='arrowdown')moveSel(0,1);
  }
}

// â”€â”€ Right panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t){cTab=t;['layers','actions','remap','palette','lib','color'].forEach(n=>document.getElementById('rtab-'+n).classList.toggle('active',n===t));renderR();}

function renderR(){
  const body=document.getElementById('rbody');body.innerHTML='';

  if(cTab==='layers'){
    const br=document.createElement('div');br.style.cssText='display:flex;gap:3px;margin-bottom:4px;';
    [['ï¼‹',addLayer,'Add'],['âˆ’',delLayer,'Del'],['â†‘',mvLU,'Up'],['â†“',mvLD,'Down'],['â‡©',mergeDn,'Mergeâ†“'],['âŠ•',mergeAll,'Merge All']].forEach(([lbl,fn,tip])=>{const b=document.createElement('button');b.className='nb';b.style.cssText='flex:1;padding:4px 2px;font-size:9px;';b.innerText=lbl;b.title=tip;b.onclick=()=>{fn();};br.appendChild(b);});
    body.appendChild(br);
    [...layers].reverse().forEach((l,ri)=>{
      const idx=layers.length-1-ri;const row=document.createElement('div');row.className='lrow'+(idx===aLidx?' alay':'');
      const th=document.createElement('canvas');th.width=W;th.height=H;th.style.cssText='width:26px;height:26px;';th.getContext('2d').drawImage(l.cv,0,0);
      const nm=document.createElement('div');nm.className='lname';nm.innerText=l.name;nm.ondblclick=()=>{const n=prompt('Name:',l.name);if(n){l.name=n;renderR();}};
      const vis=document.createElement('span');vis.style.cssText='font-size:11px;cursor:pointer;opacity:.5;flex-shrink:0;';vis.innerText=l.vis?'ğŸ‘':'ğŸš«';vis.onclick=e=>{e.stopPropagation();l.vis=!l.vis;l.cv.style.display=l.vis?'block':'none';renderR();};
      row.append(th,nm,vis);row.onclick=()=>{aLidx=idx;document.getElementById('lopac').value=l.opacity;document.getElementById('lopval').innerText=l.opacity+'%';renderR();};body.appendChild(row);
    });
    // Blend mode selector
    const blRow=document.createElement('div');blRow.style.cssText='display:flex;align-items:center;gap:5px;margin-top:4px;';
    const blLbl=document.createElement('div');blLbl.style.cssText='font-size:8px;color:#333;font-weight:900;text-transform:uppercase;';blLbl.innerText='Blend';
    const blSel=document.createElement('select');blSel.className='nb';blSel.style.cssText='flex:1;font-size:9px;padding:4px;';
    ['source-over','multiply','screen','overlay','darken','lighten','color-dodge','color-burn','hard-light','soft-light','difference','exclusion','hue','saturation','color','luminosity'].forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m.replace(/-/g,' ');if(m===aL().blend)o.selected=true;blSel.appendChild(o);});
    blSel.onchange=()=>{aL().blend=blSel.value;aL().cv.style.mixBlendMode=blSel.value;};
    blRow.append(blLbl,blSel);body.appendChild(blRow);
    // Selection flip
    if(selOn&&selData){const sr=document.createElement('div');sr.style.cssText='display:flex;gap:4px;margin-top:4px;';[['â†” Flip H',flipSelH],['â†• Flip V',flipSelV]].forEach(([lbl,fn])=>{const b=document.createElement('button');b.className='nb';b.style.flex='1';b.innerText=lbl;b.onclick=fn;sr.appendChild(b);});body.appendChild(sr);}

  } else if(cTab==='actions'){
    if(!actions.length){body.innerHTML='<div style="color:#1e1e1e;font-size:10px;text-align:center;padding:16px;line-height:1.6;">Draw a pose, then add it<br>as a named action.</div>';}
    else{const g=document.createElement('div');g.className='agrid';actions.forEach((a,i)=>{const c=document.createElement('div');c.className='acard';const cv=document.createElement('canvas');cv.width=W;cv.height=H;cv.style.cssText='width:100%;aspect-ratio:1;';drawFrameOn(a.snap,cv);const nm=document.createElement('div');nm.className='acname';nm.innerText=a.name;const dl=document.createElement('button');dl.className='adel';dl.innerText='âœ•';dl.onclick=e=>{e.stopPropagation();actions.splice(i,1);renderR();};c.onclick=()=>{saveSt();const sp=a.snap;layers.forEach(l=>{l.ctx.clearRect(0,0,W,H);if(sp[l.id])l.ctx.putImageData(sp[l.id],0,0);});};c.append(cv,nm,dl);g.appendChild(c);});body.appendChild(g);}
    const ab=document.createElement('button');ab.className='nb green';ab.style.cssText='width:100%;padding:7px;margin-top:4px;';ab.innerText='â• Add Current Pose';ab.onclick=openAct;body.appendChild(ab);

  } else if(cTab==='remap'){
    // â”€â”€ FFS REMAP PANEL â”€â”€
    const title=document.createElement('div');title.style.cssText='font-size:9px;font-weight:900;color:#444;margin-bottom:6px;line-height:1.5;';title.innerText='Map source colors â†’ target colors. Click a swatch to pick, eyedrop from canvas, or right-click to clear.';
    body.appendChild(title);
    remapSlots.forEach((slot,i)=>{
      const row=document.createElement('div');row.className='remap-slot';
      const num=document.createElement('span');num.style.cssText='font-size:8px;font-weight:900;color:#252525;min-width:14px;';num.innerText=i+1;
      const fromSw=document.createElement('div');fromSw.className='remap-from';fromSw.style.background=slot.from||'transparent';fromSw.title='Click: eyedrop from canvas | Right-click: clear';
      fromSw.onclick=()=>{setTool('eyedrop');toast('ğŸ‘‰ Click sprite to pick FROM color','#888');pendingRemapSlot={idx:i,which:'from'};};
      fromSw.oncontextmenu=e=>{e.preventDefault();slot.from=null;fromSw.style.background='transparent';};
      const arrow=document.createElement('span');arrow.className='remap-arrow';arrow.innerText='â†’';
      const toSw=document.createElement('div');toSw.className='remap-to';toSw.style.background=slot.to||'transparent';toSw.title='Click: pick replacement color';
      toSw.onclick=()=>{const inp=document.createElement('input');inp.type='color';inp.value=slot.to||'#ff0000';inp.oninput=v=>{slot.to=inp.value;toSw.style.background=inp.value;};document.body.appendChild(inp);inp.click();setTimeout(()=>inp.remove(),3000);};
      toSw.oncontextmenu=e=>{e.preventDefault();slot.to=null;toSw.style.background='transparent';};
      row.append(num,fromSw,arrow,toSw);body.appendChild(row);
    });
    // Buttons
    const btnRow=document.createElement('div');btnRow.className='remap-btn-row';btnRow.style.marginTop='8px';
    [
      ['Apply Frame','var(--purple)',remapCurrentFrame],
      ['Apply ALL Frames','var(--purple)',remapAllFrames],
      ['Apply to My Sprites','var(--danger)',remapAllPersonalSprites],
      ['Clear All',null,()=>{initRemapSlots(12);renderR();}],
    ].forEach(([lbl,col,fn])=>{const b=document.createElement('button');b.className='nb';b.style.cssText=`flex:1;padding:6px 3px;font-size:8px;${col?'border-color:'+col+';color:'+col+';':''}`;b.innerText=lbl;b.onclick=fn;btnRow.appendChild(b);});
    body.appendChild(btnRow);
    // Palette Presets
    const presDiv=document.createElement('div');presDiv.style.marginTop='10px';
    const presHdr=document.createElement('div');presHdr.style.cssText='display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;';
    const presLbl=document.createElement('div');presLbl.style.cssText='font-size:8px;font-weight:900;color:#2a2a2a;text-transform:uppercase;letter-spacing:1px;';presLbl.innerText='Palette Presets';
    const savePresetBtn=document.createElement('button');savePresetBtn.className='nb purple';savePresetBtn.style.cssText='font-size:8px;padding:3px 7px;';savePresetBtn.innerText='+ Save';savePresetBtn.onclick=()=>document.getElementById('pal-preset-modal').style.display='flex';
    presHdr.append(presLbl,savePresetBtn);presDiv.appendChild(presHdr);
    const presList=document.createElement('div');presList.style.cssText='display:flex;flex-direction:column;gap:3px;';
    Object.keys(palPresets).forEach(name=>{
      const pr=document.createElement('div');pr.style.cssText='display:flex;gap:4px;align-items:center;';
      const lb=document.createElement('button');lb.className='nb';lb.style.cssText='flex:1;padding:5px;font-size:9px;';lb.innerText=name;lb.onclick=()=>loadPalettePreset(name);
      const del=document.createElement('button');del.className='nb';del.style.cssText='color:var(--danger);padding:5px 7px;font-size:9px;';del.innerText='âœ•';del.onclick=()=>{delete palPresets[name];renderR();};
      pr.append(lb,del);presList.appendChild(pr);
    });
    if(!Object.keys(palPresets).length){const empty=document.createElement('div');empty.style.cssText='font-size:9px;color:#1e1e1e;';empty.innerText='No presets yet.';presList.appendChild(empty);}
    presDiv.appendChild(presList);body.appendChild(presDiv);

  } else if(cTab==='palette'){
    // Extract + adapt buttons
    const topRow=document.createElement('div');topRow.style.cssText='display:flex;gap:4px;';
    const extBtn=document.createElement('button');extBtn.className='nb teal';extBtn.style.cssText='flex:1;padding:6px;font-size:9px;';extBtn.innerText='ğŸ” Extract Colors';extBtn.onclick=extractColors;
    const adapBtn=document.createElement('button');adapBtn.className='nb';adapBtn.style.cssText='flex:1;padding:6px;font-size:9px;';adapBtn.innerText='ğŸ¯ Adapt to Palette';adapBtn.onclick=adaptToExtractedPalette;
    topRow.append(extBtn,adapBtn);body.appendChild(topRow);
    if(extractedPalette.length){
      const lbl=document.createElement('div');lbl.style.cssText='font-size:8px;color:#2a2a2a;font-weight:900;margin:6px 0 3px;text-transform:uppercase;letter-spacing:1px;';lbl.innerText='Extracted ('+extractedPalette.length+' colors)';
      const grid=document.createElement('div');grid.className='pal-editor-grid';
      extractedPalette.forEach((h,i)=>{const d=document.createElement('div');d.className='pal-dot';d.style.background=h;d.title=h;d.onclick=()=>{setPri(h);};d.oncontextmenu=e=>{e.preventDefault();const si=remapSlots.findIndex(s=>!s.from);if(si>=0){remapSlots[si].from=h;switchTab('remap');}};grid.appendChild(d);});
      body.append(lbl,grid);
      // Gradient fill for palette
      const gHdr=document.createElement('div');gHdr.style.cssText='font-size:8px;color:#2a2a2a;font-weight:900;margin:8px 0 4px;text-transform:uppercase;letter-spacing:1px;';gHdr.innerText='Palette Gradient Fill';
      const gRow=document.createElement('div');gRow.style.cssText='display:flex;gap:5px;align-items:center;';
      const gFrom=document.createElement('div');gFrom.style.cssText='width:22px;height:22px;border-radius:4px;background:'+priCol+';border:1.5px solid #333;cursor:pointer;';gFrom.onclick=()=>{document.getElementById('pri-pk').click();};
      const gTo=document.createElement('div');gTo.style.cssText='width:22px;height:22px;border-radius:4px;background:'+secCol+';border:1.5px solid #333;cursor:pointer;';gTo.onclick=()=>{document.getElementById('sec-pk').click();};
      const gCount=document.createElement('input');gCount.type='number';gCount.min=2;gCount.max=32;gCount.value=8;gCount.style.cssText='width:36px;background:#111;border:1px solid #222;color:#aaa;border-radius:5px;padding:3px 4px;font-size:10px;text-align:center;';
      const gBtn=document.createElement('button');gBtn.className='nb';gBtn.style.cssText='flex:1;font-size:9px;padding:5px;';gBtn.innerText='Fill Gradient';
      gBtn.onclick=()=>{
        const n=Math.max(2,Math.min(32,+gCount.value));
        const fr=hx2rgb(priCol),to=hx2rgb(secCol);
        const grads=Array.from({length:n},(_,i)=>{const t=i/(n-1);return rgb2hx((fr[0]+(to[0]-fr[0])*t)|0,(fr[1]+(to[1]-fr[1])*t)|0,(fr[2]+(to[2]-fr[2])*t)|0);});
        extractedPalette=[...grads,...extractedPalette].slice(0,48);renderR();
      };
      gRow.append(gFrom,document.createTextNode('â†’'),gTo,gCount,gBtn);
      body.append(gHdr,gRow);
    } else {
      const hint=document.createElement('div');hint.style.cssText='font-size:9px;color:#1e1e1e;text-align:center;padding:16px;line-height:1.6;';hint.innerText='Click "Extract Colors"\nto scan your sprite\nand build a palette.';body.appendChild(hint);
    }

  } else if(cTab==='lib'){
    if(!mySprites.length){body.innerHTML='<div style="color:#1a1a1a;font-size:10px;text-align:center;padding:16px;">Your saved sprites appear here.</div>';}
    else{const g=document.createElement('div');g.className='agrid';mySprites.forEach(sp=>{const c=document.createElement('div');c.className='scard';const img=document.createElement('img');img.src=sp.image_data;const ub=document.createElement('div');ub.className='ubadge';ub.innerText='LOAD';const lbl=document.createElement('div');lbl.className='slbl';lbl.innerText=sp.name;c.onclick=()=>loadSprLib(sp);c.append(img,ub,lbl);g.appendChild(c);});body.appendChild(g);}

  } else if(cTab==='color'){
    body.innerHTML=`<div class="slabel">Recent Colors</div><div class="chistrow" id="chist"></div><div class="slabel" style="margin-top:7px;">Hue</div><input type="range" class="hsl-trk" id="hsl-h" min="0" max="360" value="0" style="background:linear-gradient(to right,red,yellow,lime,cyan,blue,magenta,red);" oninput="updHSL()"><div class="slabel" style="margin-top:5px;">Saturation</div><input type="range" class="hsl-trk" id="hsl-s" min="0" max="100" value="100" oninput="updHSL()"><div class="slabel" style="margin-top:5px;">Lightness</div><input type="range" class="hsl-trk" id="hsl-l" min="0" max="100" value="50" oninput="updHSL()"><div id="hsl-prev" style="width:100%;height:22px;border-radius:5px;margin-top:4px;border:1px solid #222;"></div><div class="slabel" style="margin-top:8px;">Palette</div><div class="pgrid" id="pgrid-el"></div>`;
    // Build palette
    const pg=document.getElementById('pgrid-el');
    PALETTE.forEach(h=>{const d=document.createElement('div');d.className='pc';d.style.background=h;d.onclick=()=>setPri(h);d.oncontextmenu=e=>{e.preventDefault();setSec(h);};pg.appendChild(d);});
    // Color history
    const ch=document.getElementById('chist');colHist.forEach(c=>{const d=document.createElement('div');d.className='cdot';d.style.background=c;d.onclick=()=>setPri(c);ch.appendChild(d);});
    const h=+(document.getElementById('hsl-h')||{value:0}).value;document.getElementById('hsl-prev').style.background=`hsl(${h},100%,50%)`;
  }
}

// â”€â”€ Pending remap slot pick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingRemapSlot=null;
const origPickCol=pickCol;
// Override pickCol to also check pending remap
function interceptedPickCol(x,y){
  const t=document.createElement('canvas');t.width=W;t.height=H;const tc=t.getContext('2d');layers.forEach(l=>{if(l.vis){tc.globalAlpha=l.opacity/100;tc.drawImage(l.cv,0,0);}});tc.globalAlpha=1;
  const px=tc.getImageData(x,y,1,1).data;if(px[3]===0)return;
  const hex=rgb2hx(px[0],px[1],px[2]);
  if(pendingRemapSlot){const{idx,which}=pendingRemapSlot;remapSlots[idx][which]=hex;pendingRemapSlot=null;switchTab('remap');setTool('pencil');toast('Color picked for slot '+(idx+1),'var(--purple)');return;}
  setPri(hex);setTool('pencil');
}

// â”€â”€ HSL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updHSL(){const h=+document.getElementById('hsl-h').value,s=+document.getElementById('hsl-s').value,l=+document.getElementById('hsl-l').value;document.getElementById('hsl-prev').style.background=`hsl(${h},${s}%,${l}%)`;setPri(hslHex(h,s,l));}
function hslHex(h,s,l){h=+h;s=+s/100;l=+l/100;const a=s*Math.min(l,1-l);const f=n=>{const k=(n+h/30)%12;const c=l-a*Math.max(-1,Math.min(k-3,9-k,1));return Math.round(255*c).toString(16).padStart(2,'0');};return'#'+f(0)+f(8)+f(4);}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAct(){document.getElementById('act-modal').style.display='flex';setTimeout(()=>document.getElementById('act-iname').focus(),80);}
function closeAct(){document.getElementById('act-modal').style.display='none';}
function confirmAct(){const name=document.getElementById('act-iname').value.trim()||'Action '+(actions.length+1);closeAct();saveFrame();actions.push({name,snap:capFrame()});switchTab('actions');}

// â”€â”€ Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLib(){if(!myHandle)return;const{data}=await _S.from('user_sprites').select('*').eq('owner_handle',myHandle).order('created_at',{ascending:false});mySprites=data||[];if(cTab==='lib')renderR();}
function loadSprLib(sp){saveSt();const img=new Image();img.onload=()=>{aL().ctx.clearRect(0,0,W,H);aL().ctx.drawImage(img,0,0,W,H);};img.src=sp.image_data;const acts=typeof sp.actions==='string'?JSON.parse(sp.actions):(sp.actions||{});actions=Object.entries(acts).map(([name,dataUrl])=>{const sn={};layers.forEach(l=>sn[l.id]=l.ctx.getImageData(0,0,W,H));return{name,snap:sn};});if(cTab==='actions')renderR();}

// â”€â”€ Composite / Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function composite(frameIdx){
  const f=frames[frameIdx]||capFrame();
  const t=document.createElement('canvas');t.width=W;t.height=H;const c=t.getContext('2d');
  layers.forEach(l=>{if(!l.vis)return;const d=f[l.id];if(!d)return;
    const tmp=document.createElement('canvas');tmp.width=W;tmp.height=H;tmp.getContext('2d').putImageData(d,0,0);
    c.globalAlpha=l.opacity/100;c.globalCompositeOperation=l.blend;c.drawImage(tmp,0,0);
  });c.globalAlpha=1;c.globalCompositeOperation='source-over';return t.toDataURL('image/png');
}
function compositeAll(){return frames.map((_,i)=>composite(i));}

function exportPNG(){const a=document.createElement('a');a.href=composite(aFidx);a.download='sprite.png';a.click();}

function exportGIF(){
  if(frames.length<=1&&!confirm('Only 1 frame â€” export anyway?'))return;
  toast('â³ Generating GIF...','#888');
  try{
    const gif=new GIF({workers:2,quality:10,width:W,height:H,workerScript:'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'});
    const fps=Math.max(1,+document.getElementById('fps-inp').value||8);
    const delay=Math.round(1000/fps);
    saveFrame();
    frames.forEach((_,i)=>{
      const cv=document.createElement('canvas');cv.width=W;cv.height=H;
      const dataUrl=composite(i);
      const img=new Image();img.src=dataUrl;
      const c=cv.getContext('2d');c.drawImage(img,0,0);
      gif.addFrame(cv,{delay,copy:true});
    });
    gif.on('finished',blob=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sprite.gif';a.click();toast('âœ… GIF exported!','var(--teal)');});
    gif.render();
  }catch(err){toast('âš  GIF export unavailable in this browser','var(--danger)');}
}

// â”€â”€ Save / Publish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPub(){document.getElementById('pub-modal').style.display='flex';}
function closePub(){document.getElementById('pub-modal').style.display='none';}
function openSave(){document.getElementById('save-modal').style.display='flex';}
function closeSave(){document.getElementById('save-modal').style.display='none';}
async function savePersonal(){if(!myHandle)return alert('Log in to save.');const name=document.getElementById('save-name').value.trim()||'Sprite';const ao={};actions.forEach(a=>{const t=document.createElement('canvas');t.width=W;t.height=H;drawFrameOn(a.snap,t);ao[a.name]=t.toDataURL('image/png');});const{error}=await _S.from('user_sprites').insert([{owner_handle:myHandle,name,image_data:composite(aFidx),actions:ao}]);if(error)return alert('Error: '+error.message);closeSave();toast('âœ… Saved!','var(--teal)');fetchLib();}
async function publishSprite(){if(!myHandle)return alert('Log in.');const name=document.getElementById('pub-name').value.trim();if(!name)return alert('Name required!');const tags=document.getElementById('pub-tags').value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);const btn=document.getElementById('pub-btn');btn.innerText='Publishing...';btn.disabled=true;const img=composite(aFidx);const ao={};actions.forEach(a=>{const t=document.createElement('canvas');t.width=W;t.height=H;drawFrameOn(a.snap,t);ao[a.name]=t.toDataURL('image/png');});const[{error:e1},{error:e2}]=await Promise.all([_S.from('sprites_library').insert([{name,image_data:img,actions:ao,creator:myHandle,tags}]),_S.from('user_sprites').insert([{owner_handle:myHandle,name,image_data:img,actions:ao}])]);btn.innerText='PUBLISH';btn.disabled=false;if(e1)return alert('Error: '+e1.message);closePub();toast('âœ… Published!','var(--accent)');fetchLib();}

// â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function importImg(inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{saveSt();aL().ctx.clearRect(0,0,W,H);aL().ctx.drawImage(img,0,0,W,H);};img.src=e.target.result;};r.readAsDataURL(f);inp.value='';}
function newSprite(){if(!confirm('Start fresh?'))return;layers.forEach(l=>l.ctx.clearRect(0,0,W,H));actions=[];frames=[capFrame()];aFidx=0;uStack=[];rStack=[];renderFstrip();renderR();}
function clearCv(){if(!confirm('Clear this layer?'))return;saveSt();aL().ctx.clearRect(0,0,W,H);}

// â”€â”€ Eyedrop override for remap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hitCv.addEventListener('pointerdown',e=>{}, {capture:true});
// Patch onDn to use intercepted pick
const _origOnDn=onDn;

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg,col='white'){const t=document.createElement('div');t.style.cssText=`position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:${col};color:#000;padding:8px 18px;border-radius:10px;font-weight:900;font-size:11px;z-index:9999;pointer-events:none;white-space:nowrap;`;t.innerText=msg;document.body.appendChild(t);setTimeout(()=>{t.style.opacity=0;t.style.transition='opacity .4s';},1800);setTimeout(()=>t.remove(),2400);}

// Patch eyedrop to use intercepted version
function pickCol(x,y){interceptedPickCol(x,y);}
</script>
</body>
=======
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ComicCore â€” Sprite Editor</title>
<link rel="stylesheet" href="theme.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
:root{--bg:#0d0d0f;--card:#1c1c1e;--text:#f5f5f7;--accent:#ff7a00;--border:#2c2c2e;--teal:#00d2ff;--danger:#ff3b30;--green:#32d74b;--purple:#bf5af2;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100dvh;overflow:hidden;user-select:none;}

/* â”€â”€ Top bar â”€â”€ */
.topbar{height:50px;background:#111;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0;gap:6px;}
.nb{background:#1e1e1e;border:1px solid #2a2a2a;color:#ccc;padding:6px 10px;border-radius:7px;cursor:pointer;font-size:11px;font-weight:700;transition:.15s;white-space:nowrap;}
.nb:hover{background:#2a2a2a;color:white;}
.nb.teal{border-color:var(--teal);color:var(--teal);}
.nb.accent{border-color:var(--accent);color:var(--accent);}
.nb.purple{border-color:var(--purple);color:var(--purple);}
.nb.green{border-color:var(--green);color:var(--green);}

/* â”€â”€ Workspace â”€â”€ */
.workspace{display:flex;flex:1;overflow:hidden;}

/* â”€â”€ Left toolbar â”€â”€ */
.lbar{width:50px;background:#0a0a0a;border-right:1px solid #1a1a1a;display:flex;flex-direction:column;align-items:center;padding:7px 0;gap:3px;flex-shrink:0;overflow-y:auto;}
.lbar::-webkit-scrollbar{width:2px;}
.tb{width:36px;height:36px;background:#141414;border:1.5px solid #202020;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:.1s;position:relative;flex-shrink:0;}
.tb:hover{border-color:#444;background:#1e1e1e;}
.tb.active{background:var(--accent);border-color:var(--accent);color:#000;}
.tb.on{background:rgba(0,210,255,.12);border-color:var(--teal);}
.tb.on-green{background:rgba(50,215,75,.12);border-color:var(--green);}
.ttip{position:absolute;left:42px;top:50%;transform:translateY(-50%);background:#000;color:#ddd;padding:3px 8px;border-radius:5px;font-size:9px;font-weight:700;white-space:nowrap;pointer-events:none;opacity:0;transition:.1s;z-index:400;border:1px solid #2a2a2a;}
.tb:hover .ttip{opacity:1;}
.tsep{width:26px;height:1px;background:#1a1a1a;margin:2px 0;flex-shrink:0;}

/* â”€â”€ Canvas â”€â”€ */
.cwrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#050505;position:relative;overflow:hidden;}
.cstack{position:relative;outline:1px solid #1a1a1a;}
.cstack canvas{position:absolute;top:0;left:0;image-rendering:pixelated;image-rendering:crisp-edges;}
.cbottom{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:4px;background:rgba(0,0,0,.85);padding:6px 10px;border-radius:11px;border:1px solid #1e1e1e;align-items:center;backdrop-filter:blur(8px);flex-wrap:wrap;max-width:96vw;justify-content:center;}
.cbb{background:#1a1a1a;border:1px solid #282828;color:#aaa;padding:5px 9px;border-radius:6px;cursor:pointer;font-size:10px;font-weight:700;}
.cbb:hover{background:#252525;color:white;}
.cbb.danger{color:var(--danger);}
.zdsp{color:#444;font-size:10px;font-weight:700;min-width:28px;text-align:center;}
select.cbb{appearance:none;}
/* playback */
.play-btn{background:var(--green);color:#000;border:none;padding:5px 10px;border-radius:6px;font-weight:900;font-size:11px;cursor:pointer;}
.play-btn.playing{background:var(--danger);}
.fps-input{width:38px;background:#1a1a1a;border:1px solid #2a2a2a;color:#aaa;border-radius:5px;font-size:10px;font-weight:700;padding:4px 5px;text-align:center;}
/* axis dot */
#axis-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:rgba(255,0,0,0.8);border:1.5px solid white;cursor:move;z-index:20;transform:translate(-50%,-50%);display:none;}
#axis-cross-h{position:absolute;height:1px;background:rgba(255,0,0,0.4);pointer-events:none;z-index:19;display:none;}
#axis-cross-v{position:absolute;width:1px;background:rgba(255,0,0,0.4);pointer-events:none;z-index:19;display:none;}

/* â”€â”€ Right panel â”€â”€ */
.rbar{width:220px;background:#0a0a0a;border-left:1px solid #1a1a1a;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.rtabs{display:flex;border-bottom:1px solid #1a1a1a;flex-shrink:0;overflow-x:auto;}
.rtabs::-webkit-scrollbar{height:2px;}
.rtab{flex-shrink:0;padding:8px 7px;text-align:center;font-size:8px;font-weight:900;color:#333;cursor:pointer;border:none;background:none;transition:.1s;text-transform:uppercase;letter-spacing:.3px;}
.rtab.active{color:var(--teal);border-bottom:2px solid var(--teal);}
.rbody{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px;}
.rbody::-webkit-scrollbar{width:2px;}
.slabel{font-size:8px;font-weight:900;color:#2e2e2e;text-transform:uppercase;letter-spacing:1px;}

/* layer row */
.lrow{display:flex;align-items:center;gap:4px;background:#111;border:1.5px solid #1e1e1e;border-radius:7px;padding:4px 5px;cursor:pointer;transition:.1s;}
.lrow:hover{border-color:#333;}
.lrow.alay{border-color:var(--accent);}
.lrow canvas{border-radius:3px;border:1px solid #222;flex-shrink:0;image-rendering:pixelated;}
.lname{flex:1;font-size:9px;font-weight:700;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;}

/* frame strip */
.fstrip{display:flex;gap:4px;overflow-x:auto;padding:6px 8px;border-top:1px solid #1a1a1a;flex-shrink:0;align-items:center;min-height:58px;}
.fstrip::-webkit-scrollbar{height:2px;}
.fthumb{flex-shrink:0;border:2px solid #1e1e1e;border-radius:5px;cursor:pointer;overflow:hidden;transition:.1s;text-align:center;}
.fthumb:hover{border-color:#444;}
.fthumb.af{border-color:var(--accent);}
.fthumb canvas{display:block;image-rendering:pixelated;}
.fadd{flex-shrink:0;width:38px;height:44px;border:2px dashed #1e1e1e;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:16px;color:#222;cursor:pointer;transition:.1s;}
.fadd:hover{border-color:#444;color:#555;}

/* action/sprite cards */
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.acard{background:#0f0f0f;border:1.5px solid #181818;border-radius:7px;overflow:hidden;cursor:pointer;transition:.1s;position:relative;}
.acard:hover{border-color:#333;}
.acard canvas{display:block;width:100%;image-rendering:pixelated;}
.acname{padding:2px 5px 5px;font-size:8px;font-weight:800;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.adel{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.9);border:none;color:var(--danger);font-size:8px;border-radius:3px;padding:1px 4px;cursor:pointer;opacity:0;transition:.1s;}
.acard:hover .adel{opacity:1;}
.scard{background:#080812;border:1.5px solid #14142a;border-radius:8px;overflow:hidden;cursor:pointer;transition:.1s;position:relative;}
.scard:hover{border-color:var(--teal);}
.scard img{width:100%;aspect-ratio:1;object-fit:contain;padding:4px;display:block;image-rendering:pixelated;}
.slbl{padding:2px 6px 5px;font-size:8px;font-weight:800;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ubadge{position:absolute;inset:0 0 auto 0;background:rgba(0,210,255,.9);color:#000;font-size:8px;font-weight:900;text-align:center;padding:3px;opacity:0;transition:.1s;}
.scard:hover .ubadge{opacity:1;}

/* â”€â”€ REMAP (FFS-style) â”€â”€ */
.remap-slot{display:flex;align-items:center;gap:5px;padding:4px 0;border-bottom:1px solid #141414;}
.remap-from,.remap-to{width:24px;height:24px;border-radius:5px;border:1.5px solid #2a2a2a;cursor:pointer;flex-shrink:0;transition:.1s;}
.remap-from:hover,.remap-to:hover{border-color:#666;transform:scale(1.1);}
.remap-arrow{color:#333;font-size:11px;font-weight:900;}
.remap-empty{color:#252525;font-size:9px;font-weight:700;}
.remap-btn-row{display:flex;gap:4px;flex-wrap:wrap;}
.remap-btn-row .nb{flex:1;padding:6px 4px;font-size:9px;text-align:center;}

/* â”€â”€ Palette editor â”€â”€ */
.pal-editor-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;}
.pal-dot{aspect-ratio:1;border-radius:3px;cursor:pointer;border:1.5px solid transparent;transition:.1s;position:relative;}
.pal-dot:hover{transform:scale(1.2);z-index:2;}
.pal-dot.sel{border-color:white;}
.pal-dot.empty{background:repeating-linear-gradient(45deg,#1a1a1a,#1a1a1a 3px,#111 3px,#111 6px);border-color:#222;}

/* â”€â”€ Color panel â”€â”€ */
.chistrow{display:flex;gap:3px;flex-wrap:wrap;}
.cdot{width:18px;height:18px;border-radius:3px;border:1.5px solid #222;cursor:pointer;}
.cdot:hover{transform:scale(1.2);}
.hsl-trk{width:100%;height:12px;border-radius:4px;cursor:pointer;outline:none;padding:0;border:none;appearance:none;-webkit-appearance:none;}
.hsl-trk::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:white;border:2px solid #000;cursor:pointer;}
.pgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:2px;}
.pc{aspect-ratio:1;border-radius:3px;cursor:pointer;border:1.5px solid transparent;transition:.1s;}
.pc:hover{transform:scale(1.15);}
.pc.sel{border-color:white;}
.srow{display:flex;align-items:center;gap:5px;}
.srow input[type=range]{flex:1;accent-color:var(--accent);}
.sval{font-size:9px;font-weight:700;color:#555;min-width:26px;text-align:right;}

/* â”€â”€ Modals â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9000;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(10px);}
.modal{background:#111;padding:20px;border-radius:16px;width:100%;max-width:340px;border:1px solid #222;}
.modal h3{margin:0 0 12px;font-size:13px;font-weight:900;letter-spacing:1px;}
.modal input{width:100%;padding:9px 11px;background:#0a0a0a;border:1px solid #2a2a2a;color:white;border-radius:7px;margin-bottom:10px;font-family:inherit;font-size:13px;outline:none;box-sizing:border-box;}
.modal input:focus{border-color:var(--accent);}
.mrow{display:flex;gap:7px;}
.mrow .nb{flex:1;text-align:center;padding:9px;}

/* selection marching ants */
@keyframes march{to{stroke-dashoffset:-8;}}
#sel-rect{fill:none;stroke:white;stroke-width:1;stroke-dasharray:4 4;animation:march .5s linear infinite;pointer-events:none;}
#lasso-path{fill:rgba(255,255,255,.08);stroke:white;stroke-width:1;stroke-dasharray:3 3;animation:march .5s linear infinite;pointer-events:none;}

/* tolerance row */
.tol-row{display:flex;align-items:center;gap:5px;padding:2px 0;}
.tol-row input{flex:1;accent-color:var(--teal);}
.tol-val{font-size:9px;font-weight:700;color:#555;min-width:26px;text-align:right;}
</style>
</head>
<body>

<!-- Modals -->
<div id="pub-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--accent)">ğŸ“¤ Publish Sprite</h3>
    <input id="pub-name" placeholder="Character Name"><input id="pub-tags" placeholder="Tags: hero, female, robot...">
    <div class="mrow"><button class="nb" onclick="closePub()">Cancel</button><button class="nb accent" id="pub-btn" onclick="publishSprite()">PUBLISH</button></div>
  </div>
</div>
<div id="save-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--teal)">ğŸ’¾ Save to Your Sprites</h3>
    <input id="save-name" placeholder="Name this sprite...">
    <div class="mrow"><button class="nb" onclick="closeSave()">Cancel</button><button class="nb teal" onclick="savePersonal()">SAVE</button></div>
  </div>
</div>
<div id="act-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--green)">â• Name This Pose</h3>
    <input id="act-iname" placeholder="e.g. Attack, Idle, Running...">
    <div class="mrow"><button class="nb" onclick="closeAct()">Cancel</button><button class="nb green" onclick="confirmAct()">ADD</button></div>
  </div>
</div>
<div id="pal-preset-modal" class="overlay">
  <div class="modal"><h3 style="color:var(--purple)">ğŸ’¾ Save Palette Preset</h3>
    <input id="preset-name" placeholder="e.g. Red Alt, Evil Version...">
    <div class="mrow"><button class="nb" onclick="document.getElementById('pal-preset-modal').style.display='none'">Cancel</button><button class="nb purple" onclick="savePalettePreset()">SAVE</button></div>
  </div>
</div>

<!-- top bar -->
<div class="topbar">
  <div style="display:flex;gap:5px;align-items:center;">
    <button class="nb" onclick="location.href='index.html'">ğŸ </button>
    <span style="font-size:11px;font-weight:900;color:var(--accent);letter-spacing:1px;">SPRITE EDITOR</span>
  </div>
  <div style="display:flex;gap:4px;flex-wrap:wrap;">
    <button class="nb" onclick="newSprite()">ğŸ†•</button>
    <button class="nb" onclick="document.getElementById('imp-inp').click()">ğŸ“ Import</button>
    <button class="nb" onclick="exportPNG()">â¬‡ PNG</button>
    <button class="nb" onclick="exportGIF()">ğŸ GIF</button>
    <button class="nb teal" onclick="openSave()">ğŸ’¾ Save</button>
    <button class="nb accent" onclick="openPub()">ğŸ“¤ Publish</button>
    <input type="file" id="imp-inp" hidden accept="image/*" onchange="importImg(this)">
  </div>
</div>

<div class="workspace">
  <!-- Left toolbar -->
  <div class="lbar" id="lbar">
    <!-- Draw tools -->
    <div class="tb active" id="tl-pencil"  onclick="setTool('pencil')" ><span>âœï¸</span><div class="ttip">Pencil (P)</div></div>
    <div class="tb" id="tl-pixperf" onclick="togglePP()"><span style="font-size:10px;font-weight:900;letter-spacing:-1px;">PP</span><div class="ttip">Pixel Perfect</div></div>
    <div class="tb" id="tl-line"    onclick="setTool('line')"   ><span style="font-size:12px;font-weight:900;">â•±</span><div class="ttip">Line (L)</div></div>
    <div class="tb" id="tl-rect"    onclick="setTool('rect')"   ><span>â¬œ</span><div class="ttip">Rectangle</div></div>
    <div class="tb" id="tl-ellipse" onclick="setTool('ellipse')"><span>â­•</span><div class="ttip">Ellipse (O)</div></div>
    <div class="tb" id="tl-fill"    onclick="setTool('fill')"   ><span>ğŸª£</span><div class="ttip">Fill (F) â€” right-click=global</div></div>
    <div class="tb" id="tl-gradient" onclick="setTool('gradient')"><span style="font-size:11px">ğŸŒˆ</span><div class="ttip">Gradient Fill</div></div>
    <div class="tb" id="tl-shade"   onclick="setTool('shade')"  ><span>ğŸŒ‘</span><div class="ttip">Shade/Tint</div></div>
    <div class="tb" id="tl-dither"  onclick="setTool('dither')" ><span style="font-size:11px">â–“</span><div class="ttip">Dither Brush</div></div>
    <div class="tb" id="tl-eraser"  onclick="setTool('eraser')" ><span>ğŸ©¹</span><div class="ttip">Eraser (E)</div></div>
    <div class="tb" id="tl-eyedrop" onclick="setTool('eyedrop')"><span>ğŸ’‰</span><div class="ttip">Eyedropper (I)</div></div>
    <div class="tsep"></div>
    <!-- Selection tools -->
    <div class="tb" id="tl-select"  onclick="setTool('select')" ><span style="font-size:12px">â¬š</span><div class="ttip">Rect Select (S)</div></div>
    <div class="tb" id="tl-lasso"   onclick="setTool('lasso')"  ><span style="font-size:12px">ğŸ”®</span><div class="ttip">Lasso Select</div></div>
    <div class="tb" id="tl-wand"    onclick="setTool('wand')"   ><span style="font-size:12px">ğŸª„</span><div class="ttip">Magic Wand</div></div>
    <div class="tsep"></div>
    <!-- Toggles -->
    <div class="tb" id="tl-mh"    onclick="toggleMirror('h')"><span style="font-size:11px">â†”</span><div class="ttip">Mirror H</div></div>
    <div class="tb" id="tl-mv"    onclick="toggleMirror('v')"><span style="font-size:11px">â†•</span><div class="ttip">Mirror V</div></div>
    <div class="tb" id="tl-grid"  onclick="toggleGrid()"     ><span style="font-size:11px">#</span><div class="ttip">Grid (G)</div></div>
    <div class="tb" id="tl-onion" onclick="toggleOnion()"    ><span style="font-size:12px">ğŸ§…</span><div class="ttip">Onion Skin</div></div>
    <div class="tb" id="tl-axis"  onclick="toggleAxisMode()" ><span style="font-size:11px">âœ›</span><div class="ttip">Show Axis/Origin</div></div>
    <div class="tsep"></div>
    <!-- Colors -->
    <div style="position:relative;width:36px;height:36px;flex-shrink:0;cursor:pointer;">
      <div id="sec-sw" style="position:absolute;right:0;bottom:0;width:20px;height:20px;border-radius:4px;border:2px solid #0a0a0a;background:#000;cursor:pointer;z-index:1;" onclick="document.getElementById('sec-pk').click()"></div>
      <div id="pri-sw" style="position:absolute;left:0;top:0;width:20px;height:20px;border-radius:4px;border:2px solid #444;background:#fff;z-index:2;cursor:pointer;" onclick="document.getElementById('pri-pk').click()"></div>
    </div>
    <input type="color" id="pri-pk" hidden value="#ffffff" oninput="setPri(this.value)">
    <input type="color" id="sec-pk" hidden value="#000000" oninput="setSec(this.value)">
    <div style="font-size:7px;color:#1e1e1e;font-weight:900;text-align:center;">PÂ·S</div>
  </div>

  <!-- Canvas area -->
  <div class="cwrap" id="cwrap">
    <div class="cstack" id="cstack" style="width:256px;height:256px;">
      <canvas id="cv-checker" width="64" height="64" style="width:256px;height:256px;z-index:0;"></canvas>
      <canvas id="cv-onion"   width="64" height="64" style="width:256px;height:256px;z-index:2;pointer-events:none;opacity:.3;display:none;"></canvas>
      <!-- layer canvases at z-index:3+ injected by JS -->
      <canvas id="cv-grid"    width="64" height="64" style="width:256px;height:256px;z-index:10;pointer-events:none;"></canvas>
      <canvas id="cv-overlay" width="64" height="64" style="width:256px;height:256px;z-index:11;pointer-events:none;"></canvas>
      <canvas id="cv-sel"     width="64" height="64" style="width:256px;height:256px;z-index:12;pointer-events:none;"></canvas>
      <svg id="sel-svg" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:13;pointer-events:none;overflow:visible;">
        <rect id="sel-rect" x="0" y="0" width="0" height="0"/>
        <path id="lasso-path" d=""/>
      </svg>
      <canvas id="cv-hit"     width="64" height="64" style="width:256px;height:256px;z-index:14;cursor:crosshair;background:transparent;"></canvas>
      <!-- Axis marker -->
      <div id="axis-cross-h" style="top:50%;left:0;right:0;"></div>
      <div id="axis-cross-v" style="left:50%;top:0;bottom:0;"></div>
      <div id="axis-dot" title="Drag to move axis"></div>
    </div>

    <div class="cbottom">
      <button class="cbb" onclick="undo()">â†©</button>
      <button class="cbb" onclick="redo()">â†ª</button>
      <span class="zdsp" id="zlbl">4Ã—</span>
      <button class="cbb" onclick="chZoom(-1)">âˆ’</button>
      <button class="cbb" onclick="chZoom(1)">+</button>
      <select class="cbb" id="sz-sel" onchange="resizeCv(+this.value)">
        <option value="16">16</option><option value="32">32</option>
        <option value="64" selected>64</option><option value="128">128</option>
        <option value="256">256</option><option value="512">512</option>
      </select>
      <button class="play-btn" id="play-btn" onclick="togglePlay()">â–¶ Play</button>
      <input class="fps-input" id="fps-inp" type="number" min="1" max="60" value="8" title="FPS">
      <button class="cbb" id="desel-btn" style="display:none;color:var(--teal);" onclick="clearSel()">âœ•Sel</button>
      <button class="cbb danger" onclick="clearCv()">Clear</button>
    </div>
  </div>

  <!-- Right panel -->
  <div class="rbar">
    <div class="rtabs" id="rtabs">
      <button class="rtab active" id="rtab-layers"  onclick="switchTab('layers')">Layers</button>
      <button class="rtab"        id="rtab-actions" onclick="switchTab('actions')">Actions</button>
      <button class="rtab"        id="rtab-remap"   onclick="switchTab('remap')" style="color:var(--purple)">Recolor</button>
      <button class="rtab"        id="rtab-palette" onclick="switchTab('palette')">Palette</button>
      <button class="rtab"        id="rtab-lib"     onclick="switchTab('lib')">Sprites</button>
      <button class="rtab"        id="rtab-color"   onclick="switchTab('color')">Color</button>
    </div>
    <div class="rbody" id="rbody"></div>

    <!-- Always-visible controls -->
    <div style="border-top:1px solid #141414;padding:7px;flex-shrink:0;">
      <div class="slabel" style="margin-bottom:3px;">Brush Size</div>
      <div class="srow"><input type="range" id="bsize" min="1" max="32" value="2" oninput="updBrush()"><span class="sval" id="bval">2px</span></div>
      <!-- Wand tolerance (shows when wand/lasso active) -->
      <div id="tol-group" style="display:none;">
        <div class="slabel" style="margin:4px 0 3px;">Wand Tolerance</div>
        <div class="tol-row"><input type="range" id="tol-sl" min="0" max="128" value="32" oninput="document.getElementById('tol-val-lbl').innerText=this.value"><span class="tol-val" id="tol-val-lbl">32</span></div>
        <label style="font-size:9px;color:#444;cursor:pointer;display:flex;align-items:center;gap:4px;margin-top:2px;"><input type="checkbox" id="contiguous-chk" checked style="accent-color:var(--teal);">Contiguous</label>
      </div>
      <div class="slabel" style="margin:5px 0 3px;">Layer Opacity</div>
      <div class="srow"><input type="range" id="lopac" min="0" max="100" value="100" oninput="setLayerOpac(+this.value)"><span class="sval" id="lopval">100%</span></div>
    </div>
    <!-- Frame strip -->
    <div class="fstrip" id="fstrip"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ComicCore Sprite Editor â€” FFS-inspired full edition
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _S = supabase.createClient('https://mmycqeejhguzhtzkyjaj.supabase.co','sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE');

// â”€â”€ Global state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let W=64,H=64,zoom=4;
let tool='pencil',priCol='#ffffff',secCol='#000000',bsize=2;
let pixPerf=false,mirH=false,mirV=false,showGrid=false,showOnion=false,showAxis=false;
let drawing=false,lx=null,ly=null,shStart=null;
let selOn=false,sx=0,sy=0,sw=0,sh=0,selData=null;
let lassoPoints=[],lassoActive=false;
let wandMask=null; // ImageData mask for wand selection
let axisX=0,axisY=0,axisDragging=false;
let playTimer=null;
let layers=[],aLidx=0;
let frames=[],aFidx=0,actions=[],mySprites=[];
let uStack=[],rStack=[],cTab='layers',myHandle=null,colHist=[];
let remapSlots=[]; // [{from, to}] â€” FFS remap table
let palPresets={}; // named palette presets
let extractedPalette=[]; // from "extract colors"
let blendMode='source-over';

const PALETTE=['#000','#fff','#ff0000','#ff7a00','#ffd700','#00e64d','#00d2ff','#3366ff',
  '#cc00ff','#7c3aed','#10b981','#f59e0b','#6b7280','#1f2937','#111','#ef4444',
  '#fde68a','#bbf7d0','#bfdbfe','#fce7f3','#713f12','#14532d','#1e3a8a','#581c87','#9d174d'];

// DOM refs
const hitCv=document.getElementById('cv-hit'),gridCv=document.getElementById('cv-grid'),
  ovCv=document.getElementById('cv-overlay'),onionCv=document.getElementById('cv-onion'),
  checkCv=document.getElementById('cv-checker'),selCv=document.getElementById('cv-sel'),
  cstack=document.getElementById('cstack'),axisDot=document.getElementById('axis-dot'),
  axisH=document.getElementById('axis-cross-h'),axisV=document.getElementById('axis-cross-v');
const gridCtx=gridCv.getContext('2d'),ovCtx=ovCv.getContext('2d'),onionCtx=onionCv.getContext('2d'),selCtx=selCv.getContext('2d');

// Init
window.onload=()=>{
  myHandle=JSON.parse(localStorage.getItem('user_profile')||'{}').handle||null;
  mkLayers(); initRemapSlots(12); initFrame();
  drawChecker(); applyZoom(); renderFstrip(); switchTab('layers');
  fetchLib(); buildStaticPal(); updSwatches();
  axisX=W/2; axisY=H;

  hitCv.addEventListener('pointerdown',onDn);
  hitCv.addEventListener('pointermove',onMv);
  hitCv.addEventListener('pointerup',  onUp);
  hitCv.addEventListener('pointerleave',()=>{ovCtx.clearRect(0,0,W,H);drawing=false;});
  hitCv.addEventListener('contextmenu',e=>{e.preventDefault();swapC();});
  axisDot.addEventListener('pointerdown',startAxisDrag);
  window.addEventListener('keydown',onKey);
};

// â”€â”€ Layers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkLayer(name='Layer'){
  const cv=document.createElement('canvas');cv.width=W;cv.height=H;
  cv.style.cssText=`position:absolute;top:0;left:0;width:${W*zoom}px;height:${H*zoom}px;image-rendering:pixelated;image-rendering:crisp-edges;z-index:3;pointer-events:none;`;
  return{id:Date.now()+Math.random(),name,vis:true,opacity:100,blend:'source-over',cv,ctx:cv.getContext('2d')};
}
function mkLayers(){layers=[mkLayer('Lineart'),mkLayer('Color')];aLidx=0;layers.forEach(l=>cstack.insertBefore(l.cv,gridCv));}
function aL(){return layers[aLidx];}
function addLayer(){saveSt();const l=mkLayer('Layer '+(layers.length+1));layers.splice(aLidx+1,0,l);aLidx++;cstack.insertBefore(layers[aLidx].cv,gridCv);renderR();}
function delLayer(){if(layers.length<=1)return alert('Need at least 1 layer.');saveSt();cstack.removeChild(layers[aLidx].cv);layers.splice(aLidx,1);aLidx=Math.max(0,aLidx-1);renderR();}
function mvLU(){if(aLidx<=0)return;saveSt();[layers[aLidx],layers[aLidx-1]]=[layers[aLidx-1],layers[aLidx]];aLidx--;reorderDOM();renderR();}
function mvLD(){if(aLidx>=layers.length-1)return;saveSt();[layers[aLidx],layers[aLidx+1]]=[layers[aLidx+1],layers[aLidx]];aLidx++;reorderDOM();renderR();}
function reorderDOM(){layers.forEach(l=>{if(l.cv.parentNode)cstack.removeChild(l.cv);});layers.forEach(l=>cstack.insertBefore(l.cv,gridCv));}
function mergeDn(){if(aLidx>=layers.length-1)return;saveSt();const a=layers[aLidx],b=layers[aLidx+1];b.ctx.globalAlpha=a.opacity/100;b.ctx.globalCompositeOperation=a.blend;b.ctx.drawImage(a.cv,0,0);b.ctx.globalAlpha=1;b.ctx.globalCompositeOperation='source-over';cstack.removeChild(a.cv);layers.splice(aLidx,1);aLidx=Math.min(aLidx,layers.length-1);renderR();}
function mergeAll(){saveSt();const m=mkLayer('Merged');layers.forEach(l=>{if(!l.vis)return;m.ctx.globalAlpha=l.opacity/100;m.ctx.globalCompositeOperation=l.blend;m.ctx.drawImage(l.cv,0,0);});m.ctx.globalAlpha=1;m.ctx.globalCompositeOperation='source-over';layers.forEach(l=>{if(l.cv.parentNode)cstack.removeChild(l.cv);});layers=[m];aLidx=0;cstack.insertBefore(layers[0].cv,gridCv);renderR();}
function setLayerOpac(v){aL().opacity=v;aL().cv.style.opacity=v/100;document.getElementById('lopval').innerText=v+'%';}

// â”€â”€ Frames â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function capFrame(){const s={};layers.forEach(l=>{s[l.id]=l.ctx.getImageData(0,0,W,H);});return s;}
function initFrame(){frames=[capFrame()];aFidx=0;}
function saveFrame(){frames[aFidx]=capFrame();}
function loadFrame(i){const s=frames[i];layers.forEach(l=>{l.ctx.clearRect(0,0,W,H);if(s&&s[l.id])l.ctx.putImageData(s[l.id],0,0);});}
function addFrame(){saveFrame();frames.push({}); // blank frame
  aFidx=frames.length-1;renderFstrip();}
function dupFrame(){saveFrame();frames.splice(aFidx+1,0,capFrame());aFidx++;loadFrame(aFidx);renderFstrip();}
function switchFrame(i){saveFrame();aFidx=i;loadFrame(i);renderFstrip();if(showOnion)drawOnion();}
function delFrame(i){if(frames.length<=1)return;frames.splice(i,1);aFidx=Math.max(0,Math.min(aFidx,frames.length-1));loadFrame(aFidx);renderFstrip();}
function drawFrameOn(f,cv){const c=cv.getContext('2d');c.clearRect(0,0,cv.width,cv.height);layers.forEach(l=>{if(!l.vis)return;const d=f[l.id];if(d)c.putImageData(d,0,0);});}

// â”€â”€ Animation playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePlay(){
  if(playTimer){clearInterval(playTimer);playTimer=null;document.getElementById('play-btn').textContent='â–¶ Play';document.getElementById('play-btn').classList.remove('playing');return;}
  saveFrame();
  const fps=Math.max(1,Math.min(60,+document.getElementById('fps-inp').value||8));
  document.getElementById('play-btn').textContent='â¹ Stop';document.getElementById('play-btn').classList.add('playing');
  playTimer=setInterval(()=>{
    let next=(aFidx+1)%frames.length;
    loadFrame(next);aFidx=next;renderFstrip();
  },1000/fps);
}

// â”€â”€ Frame strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFstrip(){
  if(playTimer)return; // don't re-render while playing
  const s=document.getElementById('fstrip');s.innerHTML='';
  const ts=38;
  frames.forEach((f,i)=>{
    const w=document.createElement('div');w.className='fthumb'+(i===aFidx?' af':'');w.style.width=ts+'px';
    const cv=document.createElement('canvas');cv.width=W;cv.height=H;cv.style.cssText=`width:${ts}px;height:${ts}px;display:block;`;
    drawFrameOn(f,cv);
    const n=document.createElement('div');n.style.cssText=`font-size:7px;font-weight:900;color:${i===aFidx?'var(--accent)':'#2a2a2a'};text-align:center;padding:1px 0 2px;`;n.innerText=i+1;
    w.append(cv,n);
    w.onclick=()=>switchFrame(i);
    w.oncontextmenu=e=>{e.preventDefault();
      const m=document.createElement('div');m.style.cssText='position:fixed;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px;z-index:500;display:flex;flex-direction:column;gap:3px;';
      m.style.left=e.clientX+'px';m.style.top=e.clientY+'px';
      [['Duplicate',()=>{switchFrame(i);dupFrame();}],['Delete',()=>{if(frames.length>1&&confirm('Delete frame '+(i+1)+'?'))delFrame(i);}]].forEach(([lbl,fn])=>{const b=document.createElement('button');b.className='nb';b.style.cssText='padding:5px 10px;font-size:10px;';b.innerText=lbl;b.onclick=()=>{m.remove();fn();};m.appendChild(b);});
      document.body.appendChild(m);setTimeout(()=>document.addEventListener('click',()=>m.remove(),{once:true}),50);
    };
    s.appendChild(w);
  });
  const add=document.createElement('div');add.className='fadd';add.innerText='+';add.onclick=addFrame;s.appendChild(add);
}

function drawOnion(){onionCtx.clearRect(0,0,W,H);if(!showOnion||aFidx===0)return;const p=frames[aFidx-1];layers.forEach(l=>{if(p&&p[l.id]){onionCtx.globalAlpha=1;onionCtx.putImageData(p[l.id],0,0);}});}

// â”€â”€ Axis / origin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAxisMode(){showAxis=!showAxis;document.getElementById('tl-axis').classList.toggle('on',showAxis);updateAxisDisplay();}
function updateAxisDisplay(){
  const d=showAxis;axisDot.style.display=d?'block':'none';axisH.style.display=d?'block':'none';axisV.style.display=d?'block':'none';
  if(!d)return;
  const px=zoom;axisDot.style.left=(axisX*px)+'px';axisDot.style.top=(axisY*px)+'px';
  axisH.style.top=(axisY*px)+'px';axisH.style.left='0';axisH.style.right='0';axisH.style.height='1px';axisH.style.position='absolute';
  axisV.style.left=(axisX*px)+'px';axisV.style.top='0';axisV.style.bottom='0';axisV.style.width='1px';axisV.style.position='absolute';
}
function startAxisDrag(e){e.preventDefault();e.stopPropagation();axisDragging=true;const up=()=>{axisDragging=false;window.removeEventListener('pointermove',doDrag);window.removeEventListener('pointerup',up);};const doDrag=(ev)=>{const r=cstack.getBoundingClientRect();axisX=Math.max(0,Math.min(W,Math.round((ev.clientX-r.left)/zoom)));axisY=Math.max(0,Math.min(H,Math.round((ev.clientY-r.top)/zoom)));updateAxisDisplay();};window.addEventListener('pointermove',doDrag);window.addEventListener('pointerup',up);}

// â”€â”€ Zoom / Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyZoom(){
  const pw=W*zoom,ph=H*zoom;
  cstack.style.width=pw+'px';cstack.style.height=ph+'px';
  [checkCv,gridCv,ovCv,onionCv,hitCv,selCv,...layers.map(l=>l.cv)].forEach(cv=>{cv.style.width=pw+'px';cv.style.height=ph+'px';});
  document.getElementById('zlbl').innerText=zoom+'Ã—';
  drawChecker();if(showGrid)drawGrid();updateAxisDisplay();
}
function chZoom(d){const st=[1,2,3,4,6,8,12,16];const i=st.indexOf(zoom);zoom=st[Math.max(0,Math.min(st.length-1,i+d))];applyZoom();}
function resizeCv(ns){
  if(!confirm(`Resize to ${ns}Ã—${ns}?`)){document.getElementById('sz-sel').value=W;return;}
  saveSt();W=ns;H=ns;
  [checkCv,gridCv,ovCv,onionCv,hitCv,selCv].forEach(cv=>{cv.width=ns;cv.height=ns;});
  layers.forEach(l=>{const t=document.createElement('canvas');t.width=ns;t.height=ns;t.getContext('2d').drawImage(l.cv,0,0,ns,ns);l.cv.width=ns;l.cv.height=ns;l.ctx.drawImage(t,0,0);});
  frames=frames.map(()=>capFrame());drawChecker();applyZoom();
}
function drawChecker(){const c=checkCv.getContext('2d'),s=4;for(let y=0;y<H;y+=s)for(let x=0;x<W;x+=s){c.fillStyle=((x/s+y/s)%2===0)?'#222':'#161616';c.fillRect(x,y,s,s);}}
function drawGrid(){gridCtx.clearRect(0,0,W,H);if(!showGrid)return;gridCtx.strokeStyle='rgba(255,255,255,.08)';gridCtx.lineWidth=.5;const st=W>=64?8:4;for(let x=0;x<=W;x+=st){gridCtx.beginPath();gridCtx.moveTo(x,0);gridCtx.lineTo(x,H);gridCtx.stroke();}for(let y=0;y<=H;y+=st){gridCtx.beginPath();gridCtx.moveTo(0,y);gridCtx.lineTo(W,y);gridCtx.stroke();}}
function toggleGrid(){showGrid=!showGrid;document.getElementById('tl-grid').classList.toggle('on',showGrid);drawGrid();}
function toggleOnion(){showOnion=!showOnion;onionCv.style.display=showOnion?'block':'none';document.getElementById('tl-onion').classList.toggle('on',showOnion);drawOnion();}

// â”€â”€ Tool switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTool(t){
  tool=t;
  document.querySelectorAll('#lbar .tb[id^="tl-"]').forEach(b=>b.classList.remove('active'));
  document.getElementById('tl-'+t)?.classList.add('active');
  hitCv.style.cursor=t==='select'||t==='lasso'||t==='wand'?'default':'crosshair';
  document.getElementById('tol-group').style.display=(t==='wand'||t==='lasso')?'block':'none';
  if(t!=='select'&&t!=='lasso'&&t!=='wand')clearSel();
}
function togglePP(){pixPerf=!pixPerf;document.getElementById('tl-pixperf').classList.toggle('on',pixPerf);}
function toggleMirror(a){if(a==='h'){mirH=!mirH;document.getElementById('tl-mh').classList.toggle('on',mirH);}else{mirV=!mirV;document.getElementById('tl-mv').classList.toggle('on',mirV);}}

// â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPri(h){priCol=h;document.getElementById('pri-sw').style.background=h;document.getElementById('pri-pk').value=h;addHist(h);if(cTab==='color')renderR();}
function setSec(h){secCol=h;document.getElementById('sec-sw').style.background=h;document.getElementById('sec-pk').value=h;}
function swapC(){[priCol,secCol]=[secCol,priCol];updSwatches();}
function updSwatches(){document.getElementById('pri-sw').style.background=priCol;document.getElementById('sec-sw').style.background=secCol;document.getElementById('pri-pk').value=priCol;document.getElementById('sec-pk').value=secCol;}
function addHist(h){colHist=[h,...colHist.filter(c=>c!==h)].slice(0,20);}
function updBrush(){bsize=+document.getElementById('bsize').value;document.getElementById('bval').innerText=bsize+'px';}
function buildStaticPal(){} // built dynamically in renderR

// â”€â”€ Pointer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gPos(e){const r=hitCv.getBoundingClientRect();return{x:Math.max(0,Math.min(W-1,Math.floor((e.clientX-r.left)/zoom))),y:Math.max(0,Math.min(H-1,Math.floor((e.clientY-r.top)/zoom)))};}
function onDn(e){e.preventDefault();if(axisDragging)return;const p=gPos(e),col=e.button===2?secCol:priCol;saveSt();drawing=true;lx=p.x;ly=p.y;
  if(tool==='select'){selOn=false;sx=p.x;sy=p.y;sw=0;sh=0;updSelRect();return;}
  if(tool==='lasso'){lassoPoints=[[p.x,p.y]];lassoActive=true;updateLassoPath();return;}
  if(tool==='wand'){applyWand(p.x,p.y,col);return;}
  if(tool==='fill'){flood(p.x,p.y,col,e.button===2);return;}
  if(tool==='gradient'){shStart=p;return;}
  if(tool==='eyedrop'){pickCol(p.x,p.y);return;}
  if(['line','rect','ellipse'].includes(tool)){shStart=p;return;}
  paint(p.x,p.y,col);
}
function onMv(e){if(!drawing)return;e.preventDefault();const p=gPos(e),col=e.buttons===2?secCol:priCol;
  if(tool==='select'){sw=p.x-sx;sh=p.y-sy;updSelRect();return;}
  if(tool==='lasso'){lassoPoints.push([p.x,p.y]);updateLassoPath();return;}
  if(tool==='line'){ovCtx.clearRect(0,0,W,H);ovCtx.strokeStyle=col;ovCtx.lineWidth=Math.max(1,bsize);ovCtx.beginPath();ovCtx.moveTo(shStart.x+.5,shStart.y+.5);ovCtx.lineTo(p.x+.5,p.y+.5);ovCtx.stroke();return;}
  if(tool==='rect'){ovCtx.clearRect(0,0,W,H);ovCtx.strokeStyle=col;ovCtx.lineWidth=Math.max(1,bsize);ovCtx.strokeRect(shStart.x+.5,shStart.y+.5,p.x-shStart.x,p.y-shStart.y);return;}
  if(tool==='ellipse'){ovCtx.clearRect(0,0,W,H);const cx=(shStart.x+p.x)/2+.5,cy=(shStart.y+p.y)/2+.5,rx=Math.abs(p.x-shStart.x)/2,ry=Math.abs(p.y-shStart.y)/2;ovCtx.strokeStyle=col;ovCtx.lineWidth=Math.max(1,bsize);ovCtx.beginPath();ovCtx.ellipse(cx,cy,Math.max(1,rx),Math.max(1,ry),0,0,Math.PI*2);ovCtx.stroke();return;}
  if(tool==='gradient'){ovCtx.clearRect(0,0,W,H);const grd=ovCtx.createLinearGradient(shStart.x,shStart.y,p.x,p.y);grd.addColorStop(0,priCol);grd.addColorStop(1,secCol);ovCtx.fillStyle=grd;ovCtx.fillRect(0,0,W,H);return;}
  if(['pencil','eraser','shade','dither'].includes(tool))plotLine(lx,ly,p.x,p.y,col);
  lx=p.x;ly=p.y;
}
function onUp(e){if(!drawing)return;drawing=false;const p=gPos(e),col=e.button===2?secCol:priCol;
  ovCtx.clearRect(0,0,W,H);
  if(tool==='select'){finalSel(p);return;}
  if(tool==='lasso'){finaliseLasso();return;}
  const l=aL();
  if(tool==='line'){l.ctx.strokeStyle=col;l.ctx.lineWidth=bsize;l.ctx.beginPath();l.ctx.moveTo(shStart.x+.5,shStart.y+.5);l.ctx.lineTo(p.x+.5,p.y+.5);l.ctx.stroke();if(mirH){l.ctx.beginPath();l.ctx.moveTo(W-1-shStart.x+.5,shStart.y+.5);l.ctx.lineTo(W-1-p.x+.5,p.y+.5);l.ctx.stroke();}}
  if(tool==='rect'){l.ctx.strokeStyle=col;l.ctx.lineWidth=bsize;l.ctx.strokeRect(shStart.x+.5,shStart.y+.5,p.x-shStart.x,p.y-shStart.y);}
  if(tool==='ellipse'){const cx=(shStart.x+p.x)/2+.5,cy=(shStart.y+p.y)/2+.5,rx=Math.abs(p.x-shStart.x)/2,ry=Math.abs(p.y-shStart.y)/2;l.ctx.strokeStyle=col;l.ctx.lineWidth=bsize;l.ctx.beginPath();l.ctx.ellipse(cx,cy,Math.max(1,rx),Math.max(1,ry),0,0,Math.PI*2);l.ctx.stroke();}
  if(tool==='gradient'){const grd=l.ctx.createLinearGradient(shStart.x,shStart.y,p.x,p.y);grd.addColorStop(0,priCol);grd.addColorStop(1,secCol);l.ctx.fillStyle=grd;l.ctx.fillRect(0,0,W,H);}
}

// â”€â”€ Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function paint(x,y,col){const l=aL();if(!l.vis)return;const h=Math.floor(bsize/2);
  if(tool==='eraser'){l.ctx.clearRect(x-h,y-h,bsize,bsize);if(mirH)l.ctx.clearRect(W-1-x-h,y-h,bsize,bsize);if(mirV)l.ctx.clearRect(x-h,H-1-y-h,bsize,bsize);return;}
  if(tool==='shade'){const id=l.ctx.getImageData(x,y,1,1).data;if(id[3]===0)return;const f=col===secCol?1.15:.85;l.ctx.fillStyle=`rgb(${Math.min(255,id[0]*f)|0},${Math.min(255,id[1]*f)|0},${Math.min(255,id[2]*f)|0})`;l.ctx.fillRect(x-h,y-h,bsize,bsize);return;}
  if(tool==='dither'){if((x+y)%2===0){l.ctx.fillStyle=col;l.ctx.fillRect(x-h,y-h,bsize,bsize);}return;}
  if(pixPerf&&lx!==null){const dx=Math.abs(x-lx),dy=Math.abs(y-ly);if(dx===1&&dy===1){l.ctx.fillStyle=col;l.ctx.fillRect(x,y,1,1);return;}}
  l.ctx.fillStyle=col;l.ctx.fillRect(x-h,y-h,bsize,bsize);
  if(mirH)l.ctx.fillRect(W-1-x-h,y-h,bsize,bsize);
  if(mirV)l.ctx.fillRect(x-h,H-1-y-h,bsize,bsize);
}
function plotLine(x0,y0,x1,y1,col){let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx=x0<x1?1:-1,sy=y0<y1?1:-1,err=dx-dy;for(;;){paint(x0,y0,col);if(x0===x1&&y0===y1)break;const e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}}

// â”€â”€ Fill (with global option) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flood(sx2,sy2,fc,global=false){
  const l=aL();const id=l.ctx.getImageData(0,0,W,H),d=id.data;
  const idx=(sx2+sy2*W)*4,tg=[d[idx],d[idx+1],d[idx+2],d[idx+3]],fl=hx2rgb(fc);
  if(tg.every((v,j)=>v===fl[j]))return;
  if(global){
    // Replace ALL matching pixels regardless of connectivity (FFS non-contiguous fill)
    for(let i=0;i<d.length;i+=4){if(mC(d,i,tg)){d[i]=fl[0];d[i+1]=fl[1];d[i+2]=fl[2];d[i+3]=fl[3];}}
    l.ctx.putImageData(id,0,0);return;
  }
  const stk=[[sx2,sy2]],vis=new Uint8Array(W*H);
  while(stk.length){const[x,y]=stk.pop();if(x<0||x>=W||y<0||y>=H||vis[x+y*W])continue;const i4=(x+y*W)*4;if(!mC(d,i4,tg))continue;vis[x+y*W]=1;d[i4]=fl[0];d[i4+1]=fl[1];d[i4+2]=fl[2];d[i4+3]=fl[3];stk.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);}
  l.ctx.putImageData(id,0,0);
}
function mC(d,i,t){return d[i]===t[0]&&d[i+1]===t[1]&&d[i+2]===t[2]&&d[i+3]===t[3];}
function hx2rgb(h){if(!h||h.length<7)return[0,0,0,255];const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return[r,g,b,255];}
function rgb2hx(r,g,b){return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}

// â”€â”€ Magic Wand â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyWand(x,y){
  const l=aL();const id=l.ctx.getImageData(0,0,W,H),d=id.data;
  const tol=+document.getElementById('tol-sl').value;
  const contiguous=document.getElementById('contiguous-chk').checked;
  const idx=(x+y*W)*4,tR=d[idx],tG=d[idx+1],tB=d[idx+2],tA=d[idx+3];
  const mask=new Uint8Array(W*H);
  function inTol(i){return Math.abs(d[i]-tR)+Math.abs(d[i+1]-tG)+Math.abs(d[i+2]-tB)+Math.abs(d[i+3]-tA)<=tol*4;}
  if(contiguous){
    const stk=[[x,y]],vis=new Uint8Array(W*H);
    while(stk.length){const[cx,cy]=stk.pop();if(cx<0||cx>=W||cy<0||cy>=H||vis[cx+cy*W])continue;const i4=(cx+cy*W)*4;if(!inTol(i4))continue;vis[cx+cy*W]=1;mask[cx+cy*W]=1;stk.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);}
  } else {
    for(let i=0;i<W*H;i++){if(inTol(i*4))mask[i]=1;}
  }
  // draw selection overlay
  selCtx.clearRect(0,0,W,H);selCtx.fillStyle='rgba(0,210,255,.35)';
  for(let py=0;py<H;py++)for(let px=0;px<W;px++){if(mask[px+py*W])selCtx.fillRect(px,py,1,1);}
  wandMask=mask;selOn=true;
  document.getElementById('desel-btn').style.display='block';
}

// â”€â”€ Lasso â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLassoPath(){
  if(!lassoPoints.length)return;
  const px=zoom;let d='M '+lassoPoints[0][0]*px+' '+lassoPoints[0][1]*px;
  lassoPoints.slice(1).forEach(p=>d+=' L '+p[0]*px+' '+p[1]*px);
  document.getElementById('lasso-path').setAttribute('d',d);
}
function finaliseLasso(){
  lassoActive=false;
  if(lassoPoints.length<3){clearSel();return;}
  const px=zoom;
  // close path
  const d=document.getElementById('lasso-path').getAttribute('d')+' Z';
  document.getElementById('lasso-path').setAttribute('d',d);
  // rasterize into selCtx as mask
  selCtx.clearRect(0,0,W,H);
  // Use the overlay at pixel scale, then read back
  const tmpCv=document.createElement('canvas');tmpCv.width=W;tmpCv.height=H;
  const tc=tmpCv.getContext('2d');tc.fillStyle='rgba(0,210,255,.5)';
  tc.beginPath();lassoPoints.forEach((p,i)=>i===0?tc.moveTo(p[0],p[1]):tc.lineTo(p[0],p[1]));tc.closePath();tc.fill();
  selCtx.drawImage(tmpCv,0,0);
  wandMask=null;selOn=true;
  document.getElementById('desel-btn').style.display='block';
}

// â”€â”€ Rect selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updSelRect(){const px=zoom;document.getElementById('sel-rect').setAttribute('x',Math.min(sx,sx+sw)*px);document.getElementById('sel-rect').setAttribute('y',Math.min(sy,sy+sh)*px);document.getElementById('sel-rect').setAttribute('width',Math.abs(sw)*px);document.getElementById('sel-rect').setAttribute('height',Math.abs(sh)*px);}
function finalSel(p){sw=p.x-sx;sh=p.y-sy;if(Math.abs(sw)<1||Math.abs(sh)<1){clearSel();return;}if(sw<0){sx+=sw;sw=Math.abs(sw);}if(sh<0){sy+=sh;sh=Math.abs(sh);}selOn=true;selData=aL().ctx.getImageData(sx,sy,sw,sh);document.getElementById('desel-btn').style.display='block';updSelRect();}
function clearSel(){selOn=false;selData=null;wandMask=null;lassoPoints=[];document.getElementById('sel-rect').setAttribute('width',0);document.getElementById('sel-rect').setAttribute('height',0);document.getElementById('lasso-path').setAttribute('d','');selCtx.clearRect(0,0,W,H);document.getElementById('desel-btn').style.display='none';}
function moveSel(dx,dy){if(!selData||!selOn)return;saveSt();const l=aL();l.ctx.clearRect(sx,sy,sw,sh);sx+=dx;sy+=dy;l.ctx.putImageData(selData,sx,sy);updSelRect();}
function flipSelH(){if(!selData||!selOn)return;saveSt();const t=document.createElement('canvas');t.width=sw;t.height=sh;t.getContext('2d').putImageData(selData,0,0);const l=aL();l.ctx.clearRect(sx,sy,sw,sh);l.ctx.save();l.ctx.translate(sx+sw,sy);l.ctx.scale(-1,1);l.ctx.drawImage(t,0,0);l.ctx.restore();selData=l.ctx.getImageData(sx,sy,sw,sh);}
function flipSelV(){if(!selData||!selOn)return;saveSt();const t=document.createElement('canvas');t.width=sw;t.height=sh;t.getContext('2d').putImageData(selData,0,0);const l=aL();l.ctx.clearRect(sx,sy,sw,sh);l.ctx.save();l.ctx.translate(sx,sy+sh);l.ctx.scale(1,-1);l.ctx.drawImage(t,0,0);l.ctx.restore();selData=l.ctx.getImageData(sx,sy,sw,sh);}

// â”€â”€ Eyedropper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickCol(x,y){const t=document.createElement('canvas');t.width=W;t.height=H;const tc=t.getContext('2d');layers.forEach(l=>{if(l.vis){tc.globalAlpha=l.opacity/100;tc.drawImage(l.cv,0,0);}});tc.globalAlpha=1;const px=tc.getImageData(x,y,1,1).data;if(px[3]===0)return;setPri(rgb2hx(px[0],px[1],px[2]));setTool('pencil');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FFS COLOR REMAP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initRemapSlots(count){remapSlots=Array.from({length:count},()=>({from:null,to:null}));}

function applyRemapToImageData(id){
  // Build fast lookup from remapSlots
  const slots=remapSlots.filter(s=>s.from&&s.to);
  if(!slots.length)return id;
  const d=id.data;
  for(let i=0;i<d.length;i+=4){
    if(d[i+3]===0)continue;
    for(const s of slots){
      const fr=hx2rgb(s.from),to=hx2rgb(s.to);
      if(d[i]===fr[0]&&d[i+1]===fr[1]&&d[i+2]===fr[2]&&d[i+3]===fr[3]){
        d[i]=to[0];d[i+1]=to[1];d[i+2]=to[2];break;
      }
    }
  }
  return id;
}

function applyRemapToLayer(l){const id=l.ctx.getImageData(0,0,W,H);applyRemapToImageData(id);l.ctx.putImageData(id,0,0);}

function remapCurrentFrame(){
  saveSt();layers.forEach(l=>applyRemapToLayer(l));toast('âœ… Remap applied to current frame','var(--purple)');
}

function remapAllFrames(){
  if(!confirm('Apply remap to ALL '+frames.length+' frames? This is undoable for the current frame only.'))return;
  saveFrame();
  frames.forEach((f,fi)=>{
    layers.forEach(l=>{
      if(f[l.id]){
        const id=new ImageData(new Uint8ClampedArray(f[l.id].data),f[l.id].width,f[l.id].height);
        applyRemapToImageData(id);f[l.id]=id;
      }
    });
  });
  loadFrame(aFidx);
  toast('âœ… Remap applied to all frames','var(--purple)');
}

async function remapAllPersonalSprites(){
  if(!myHandle)return alert('Log in first.');
  if(!confirm('Apply this remap to ALL your saved personal sprites? This cannot be undone.'))return;
  const slots=remapSlots.filter(s=>s.from&&s.to);
  if(!slots.length)return alert('No remap slots defined.');
  toast('â³ Recoloring sprites...','#888');
  const{data}=await _S.from('user_sprites').select('*').eq('owner_handle',myHandle);
  if(!data||!data.length){toast('No personal sprites found','#888');return;}
  let count=0;
  for(const sp of data){
    const img=new Image();await new Promise(res=>{img.onload=res;img.src=sp.image_data;});
    const cv=document.createElement('canvas');cv.width=img.naturalWidth;cv.height=img.naturalHeight;
    const c=cv.getContext('2d');c.drawImage(img,0,0);
    const id=c.getImageData(0,0,cv.width,cv.height);applyRemapToImageData(id);c.putImageData(id,0,0);
    await _S.from('user_sprites').update({image_data:cv.toDataURL('image/png')}).eq('id',sp.id);
    count++;
  }
  toast(`âœ… Recolored ${count} sprites!`,'var(--purple)');
  fetchLib();
}

// â”€â”€ Palette extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractColors(){
  const tmp=document.createElement('canvas');tmp.width=W;tmp.height=H;const tc=tmp.getContext('2d');
  layers.forEach(l=>{if(l.vis){tc.globalAlpha=l.opacity/100;tc.drawImage(l.cv,0,0);}});tc.globalAlpha=1;
  const id=tc.getImageData(0,0,W,H);const d=id.data;const seen=new Set();const cols=[];
  for(let i=0;i<d.length;i+=4){if(d[i+3]<10)continue;const h=rgb2hx(d[i],d[i+1],d[i+2]);if(!seen.has(h)){seen.add(h);cols.push(h);}}
  extractedPalette=cols.slice(0,48);
  switchTab('palette');
  toast('âœ… '+extractedPalette.length+' colors extracted','var(--teal)');
}

// â”€â”€ Adapt image to extracted palette (FFS "Adapt Image to Palette") â”€â”€
function adaptToExtractedPalette(){
  if(!extractedPalette.length)return alert('Extract colors first.');
  saveSt();
  // For each pixel, remap to the nearest color in the extracted palette
  layers.forEach(l=>{
    const id=l.ctx.getImageData(0,0,W,H);const d=id.data;
    const palRgb=extractedPalette.map(hx2rgb);
    for(let i=0;i<d.length;i+=4){
      if(d[i+3]===0)continue;
      let best=0,bestDist=Infinity;
      palRgb.forEach((p,pi)=>{const dist=(d[i]-p[0])**2+(d[i+1]-p[1])**2+(d[i+2]-p[2])**2;if(dist<bestDist){bestDist=dist;best=pi;}});
      const c=palRgb[best];d[i]=c[0];d[i+1]=c[1];d[i+2]=c[2];
    }
    l.ctx.putImageData(id,0,0);
  });
  toast('âœ… Adapted to palette','var(--teal)');
}

// â”€â”€ Palette presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePalettePreset(){
  const name=document.getElementById('preset-name').value.trim();if(!name)return;
  palPresets[name]=remapSlots.map(s=>({...s}));
  document.getElementById('pal-preset-modal').style.display='none';
  if(cTab==='remap')renderR();
  toast('ğŸ’¾ Preset "'+name+'" saved','var(--purple)');
}
function loadPalettePreset(name){remapSlots=palPresets[name].map(s=>({...s}));renderR();}

// â”€â”€ Undo/Redo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSt(){uStack.push(layers.map(l=>({id:l.id,d:l.ctx.getImageData(0,0,W,H)})));if(uStack.length>50)uStack.shift();rStack=[];}
function undo(){if(!uStack.length)return;rStack.push(layers.map(l=>({id:l.id,d:l.ctx.getImageData(0,0,W,H)})));const p=uStack.pop();p.forEach(s=>{const l=layers.find(l=>l.id===s.id);if(l)l.ctx.putImageData(s.d,0,0);});}
function redo(){if(!rStack.length)return;uStack.push(layers.map(l=>({id:l.id,d:l.ctx.getImageData(0,0,W,H)})));const n=rStack.pop();n.forEach(s=>{const l=layers.find(l=>l.id===s.id);if(l)l.ctx.putImageData(s.d,0,0);});}

// â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onKey(e){if(e.target.tagName==='INPUT')return;const k=e.key.toLowerCase();
  if(k==='p')setTool('pencil');if(k==='e')setTool('eraser');if(k==='l')setTool('line');
  if(k==='f')setTool('fill');if(k==='i')setTool('eyedrop');if(k==='s')setTool('select');
  if(k==='o')setTool('ellipse');if(k==='x')swapC();if(k==='g')toggleGrid();
  if((e.ctrlKey||e.metaKey)&&k==='z'){e.preventDefault();e.shiftKey?redo():undo();}
  if((e.ctrlKey||e.metaKey)&&k==='s'){e.preventDefault();openSave();}
  if(selOn&&selData){
    if(k==='arrowleft')moveSel(-1,0);if(k==='arrowright')moveSel(1,0);
    if(k==='arrowup')moveSel(0,-1);if(k==='arrowdown')moveSel(0,1);
  }
}

// â”€â”€ Right panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t){cTab=t;['layers','actions','remap','palette','lib','color'].forEach(n=>document.getElementById('rtab-'+n).classList.toggle('active',n===t));renderR();}

function renderR(){
  const body=document.getElementById('rbody');body.innerHTML='';

  if(cTab==='layers'){
    const br=document.createElement('div');br.style.cssText='display:flex;gap:3px;margin-bottom:4px;';
    [['ï¼‹',addLayer,'Add'],['âˆ’',delLayer,'Del'],['â†‘',mvLU,'Up'],['â†“',mvLD,'Down'],['â‡©',mergeDn,'Mergeâ†“'],['âŠ•',mergeAll,'Merge All']].forEach(([lbl,fn,tip])=>{const b=document.createElement('button');b.className='nb';b.style.cssText='flex:1;padding:4px 2px;font-size:9px;';b.innerText=lbl;b.title=tip;b.onclick=()=>{fn();};br.appendChild(b);});
    body.appendChild(br);
    [...layers].reverse().forEach((l,ri)=>{
      const idx=layers.length-1-ri;const row=document.createElement('div');row.className='lrow'+(idx===aLidx?' alay':'');
      const th=document.createElement('canvas');th.width=W;th.height=H;th.style.cssText='width:26px;height:26px;';th.getContext('2d').drawImage(l.cv,0,0);
      const nm=document.createElement('div');nm.className='lname';nm.innerText=l.name;nm.ondblclick=()=>{const n=prompt('Name:',l.name);if(n){l.name=n;renderR();}};
      const vis=document.createElement('span');vis.style.cssText='font-size:11px;cursor:pointer;opacity:.5;flex-shrink:0;';vis.innerText=l.vis?'ğŸ‘':'ğŸš«';vis.onclick=e=>{e.stopPropagation();l.vis=!l.vis;l.cv.style.display=l.vis?'block':'none';renderR();};
      row.append(th,nm,vis);row.onclick=()=>{aLidx=idx;document.getElementById('lopac').value=l.opacity;document.getElementById('lopval').innerText=l.opacity+'%';renderR();};body.appendChild(row);
    });
    // Blend mode selector
    const blRow=document.createElement('div');blRow.style.cssText='display:flex;align-items:center;gap:5px;margin-top:4px;';
    const blLbl=document.createElement('div');blLbl.style.cssText='font-size:8px;color:#333;font-weight:900;text-transform:uppercase;';blLbl.innerText='Blend';
    const blSel=document.createElement('select');blSel.className='nb';blSel.style.cssText='flex:1;font-size:9px;padding:4px;';
    ['source-over','multiply','screen','overlay','darken','lighten','color-dodge','color-burn','hard-light','soft-light','difference','exclusion','hue','saturation','color','luminosity'].forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m.replace(/-/g,' ');if(m===aL().blend)o.selected=true;blSel.appendChild(o);});
    blSel.onchange=()=>{aL().blend=blSel.value;aL().cv.style.mixBlendMode=blSel.value;};
    blRow.append(blLbl,blSel);body.appendChild(blRow);
    // Selection flip
    if(selOn&&selData){const sr=document.createElement('div');sr.style.cssText='display:flex;gap:4px;margin-top:4px;';[['â†” Flip H',flipSelH],['â†• Flip V',flipSelV]].forEach(([lbl,fn])=>{const b=document.createElement('button');b.className='nb';b.style.flex='1';b.innerText=lbl;b.onclick=fn;sr.appendChild(b);});body.appendChild(sr);}

  } else if(cTab==='actions'){
    if(!actions.length){body.innerHTML='<div style="color:#1e1e1e;font-size:10px;text-align:center;padding:16px;line-height:1.6;">Draw a pose, then add it<br>as a named action.</div>';}
    else{const g=document.createElement('div');g.className='agrid';actions.forEach((a,i)=>{const c=document.createElement('div');c.className='acard';const cv=document.createElement('canvas');cv.width=W;cv.height=H;cv.style.cssText='width:100%;aspect-ratio:1;';drawFrameOn(a.snap,cv);const nm=document.createElement('div');nm.className='acname';nm.innerText=a.name;const dl=document.createElement('button');dl.className='adel';dl.innerText='âœ•';dl.onclick=e=>{e.stopPropagation();actions.splice(i,1);renderR();};c.onclick=()=>{saveSt();const sp=a.snap;layers.forEach(l=>{l.ctx.clearRect(0,0,W,H);if(sp[l.id])l.ctx.putImageData(sp[l.id],0,0);});};c.append(cv,nm,dl);g.appendChild(c);});body.appendChild(g);}
    const ab=document.createElement('button');ab.className='nb green';ab.style.cssText='width:100%;padding:7px;margin-top:4px;';ab.innerText='â• Add Current Pose';ab.onclick=openAct;body.appendChild(ab);

  } else if(cTab==='remap'){
    // â”€â”€ FFS REMAP PANEL â”€â”€
    const title=document.createElement('div');title.style.cssText='font-size:9px;font-weight:900;color:#444;margin-bottom:6px;line-height:1.5;';title.innerText='Map source colors â†’ target colors. Click a swatch to pick, eyedrop from canvas, or right-click to clear.';
    body.appendChild(title);
    remapSlots.forEach((slot,i)=>{
      const row=document.createElement('div');row.className='remap-slot';
      const num=document.createElement('span');num.style.cssText='font-size:8px;font-weight:900;color:#252525;min-width:14px;';num.innerText=i+1;
      const fromSw=document.createElement('div');fromSw.className='remap-from';fromSw.style.background=slot.from||'transparent';fromSw.title='Click: eyedrop from canvas | Right-click: clear';
      fromSw.onclick=()=>{setTool('eyedrop');toast('ğŸ‘‰ Click sprite to pick FROM color','#888');pendingRemapSlot={idx:i,which:'from'};};
      fromSw.oncontextmenu=e=>{e.preventDefault();slot.from=null;fromSw.style.background='transparent';};
      const arrow=document.createElement('span');arrow.className='remap-arrow';arrow.innerText='â†’';
      const toSw=document.createElement('div');toSw.className='remap-to';toSw.style.background=slot.to||'transparent';toSw.title='Click: pick replacement color';
      toSw.onclick=()=>{const inp=document.createElement('input');inp.type='color';inp.value=slot.to||'#ff0000';inp.oninput=v=>{slot.to=inp.value;toSw.style.background=inp.value;};document.body.appendChild(inp);inp.click();setTimeout(()=>inp.remove(),3000);};
      toSw.oncontextmenu=e=>{e.preventDefault();slot.to=null;toSw.style.background='transparent';};
      row.append(num,fromSw,arrow,toSw);body.appendChild(row);
    });
    // Buttons
    const btnRow=document.createElement('div');btnRow.className='remap-btn-row';btnRow.style.marginTop='8px';
    [
      ['Apply Frame','var(--purple)',remapCurrentFrame],
      ['Apply ALL Frames','var(--purple)',remapAllFrames],
      ['Apply to My Sprites','var(--danger)',remapAllPersonalSprites],
      ['Clear All',null,()=>{initRemapSlots(12);renderR();}],
    ].forEach(([lbl,col,fn])=>{const b=document.createElement('button');b.className='nb';b.style.cssText=`flex:1;padding:6px 3px;font-size:8px;${col?'border-color:'+col+';color:'+col+';':''}`;b.innerText=lbl;b.onclick=fn;btnRow.appendChild(b);});
    body.appendChild(btnRow);
    // Palette Presets
    const presDiv=document.createElement('div');presDiv.style.marginTop='10px';
    const presHdr=document.createElement('div');presHdr.style.cssText='display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;';
    const presLbl=document.createElement('div');presLbl.style.cssText='font-size:8px;font-weight:900;color:#2a2a2a;text-transform:uppercase;letter-spacing:1px;';presLbl.innerText='Palette Presets';
    const savePresetBtn=document.createElement('button');savePresetBtn.className='nb purple';savePresetBtn.style.cssText='font-size:8px;padding:3px 7px;';savePresetBtn.innerText='+ Save';savePresetBtn.onclick=()=>document.getElementById('pal-preset-modal').style.display='flex';
    presHdr.append(presLbl,savePresetBtn);presDiv.appendChild(presHdr);
    const presList=document.createElement('div');presList.style.cssText='display:flex;flex-direction:column;gap:3px;';
    Object.keys(palPresets).forEach(name=>{
      const pr=document.createElement('div');pr.style.cssText='display:flex;gap:4px;align-items:center;';
      const lb=document.createElement('button');lb.className='nb';lb.style.cssText='flex:1;padding:5px;font-size:9px;';lb.innerText=name;lb.onclick=()=>loadPalettePreset(name);
      const del=document.createElement('button');del.className='nb';del.style.cssText='color:var(--danger);padding:5px 7px;font-size:9px;';del.innerText='âœ•';del.onclick=()=>{delete palPresets[name];renderR();};
      pr.append(lb,del);presList.appendChild(pr);
    });
    if(!Object.keys(palPresets).length){const empty=document.createElement('div');empty.style.cssText='font-size:9px;color:#1e1e1e;';empty.innerText='No presets yet.';presList.appendChild(empty);}
    presDiv.appendChild(presList);body.appendChild(presDiv);

  } else if(cTab==='palette'){
    // Extract + adapt buttons
    const topRow=document.createElement('div');topRow.style.cssText='display:flex;gap:4px;';
    const extBtn=document.createElement('button');extBtn.className='nb teal';extBtn.style.cssText='flex:1;padding:6px;font-size:9px;';extBtn.innerText='ğŸ” Extract Colors';extBtn.onclick=extractColors;
    const adapBtn=document.createElement('button');adapBtn.className='nb';adapBtn.style.cssText='flex:1;padding:6px;font-size:9px;';adapBtn.innerText='ğŸ¯ Adapt to Palette';adapBtn.onclick=adaptToExtractedPalette;
    topRow.append(extBtn,adapBtn);body.appendChild(topRow);
    if(extractedPalette.length){
      const lbl=document.createElement('div');lbl.style.cssText='font-size:8px;color:#2a2a2a;font-weight:900;margin:6px 0 3px;text-transform:uppercase;letter-spacing:1px;';lbl.innerText='Extracted ('+extractedPalette.length+' colors)';
      const grid=document.createElement('div');grid.className='pal-editor-grid';
      extractedPalette.forEach((h,i)=>{const d=document.createElement('div');d.className='pal-dot';d.style.background=h;d.title=h;d.onclick=()=>{setPri(h);};d.oncontextmenu=e=>{e.preventDefault();const si=remapSlots.findIndex(s=>!s.from);if(si>=0){remapSlots[si].from=h;switchTab('remap');}};grid.appendChild(d);});
      body.append(lbl,grid);
      // Gradient fill for palette
      const gHdr=document.createElement('div');gHdr.style.cssText='font-size:8px;color:#2a2a2a;font-weight:900;margin:8px 0 4px;text-transform:uppercase;letter-spacing:1px;';gHdr.innerText='Palette Gradient Fill';
      const gRow=document.createElement('div');gRow.style.cssText='display:flex;gap:5px;align-items:center;';
      const gFrom=document.createElement('div');gFrom.style.cssText='width:22px;height:22px;border-radius:4px;background:'+priCol+';border:1.5px solid #333;cursor:pointer;';gFrom.onclick=()=>{document.getElementById('pri-pk').click();};
      const gTo=document.createElement('div');gTo.style.cssText='width:22px;height:22px;border-radius:4px;background:'+secCol+';border:1.5px solid #333;cursor:pointer;';gTo.onclick=()=>{document.getElementById('sec-pk').click();};
      const gCount=document.createElement('input');gCount.type='number';gCount.min=2;gCount.max=32;gCount.value=8;gCount.style.cssText='width:36px;background:#111;border:1px solid #222;color:#aaa;border-radius:5px;padding:3px 4px;font-size:10px;text-align:center;';
      const gBtn=document.createElement('button');gBtn.className='nb';gBtn.style.cssText='flex:1;font-size:9px;padding:5px;';gBtn.innerText='Fill Gradient';
      gBtn.onclick=()=>{
        const n=Math.max(2,Math.min(32,+gCount.value));
        const fr=hx2rgb(priCol),to=hx2rgb(secCol);
        const grads=Array.from({length:n},(_,i)=>{const t=i/(n-1);return rgb2hx((fr[0]+(to[0]-fr[0])*t)|0,(fr[1]+(to[1]-fr[1])*t)|0,(fr[2]+(to[2]-fr[2])*t)|0);});
        extractedPalette=[...grads,...extractedPalette].slice(0,48);renderR();
      };
      gRow.append(gFrom,document.createTextNode('â†’'),gTo,gCount,gBtn);
      body.append(gHdr,gRow);
    } else {
      const hint=document.createElement('div');hint.style.cssText='font-size:9px;color:#1e1e1e;text-align:center;padding:16px;line-height:1.6;';hint.innerText='Click "Extract Colors"\nto scan your sprite\nand build a palette.';body.appendChild(hint);
    }

  } else if(cTab==='lib'){
    if(!mySprites.length){body.innerHTML='<div style="color:#1a1a1a;font-size:10px;text-align:center;padding:16px;">Your saved sprites appear here.</div>';}
    else{const g=document.createElement('div');g.className='agrid';mySprites.forEach(sp=>{const c=document.createElement('div');c.className='scard';const img=document.createElement('img');img.src=sp.image_data;const ub=document.createElement('div');ub.className='ubadge';ub.innerText='LOAD';const lbl=document.createElement('div');lbl.className='slbl';lbl.innerText=sp.name;c.onclick=()=>loadSprLib(sp);c.append(img,ub,lbl);g.appendChild(c);});body.appendChild(g);}

  } else if(cTab==='color'){
    body.innerHTML=`<div class="slabel">Recent Colors</div><div class="chistrow" id="chist"></div><div class="slabel" style="margin-top:7px;">Hue</div><input type="range" class="hsl-trk" id="hsl-h" min="0" max="360" value="0" style="background:linear-gradient(to right,red,yellow,lime,cyan,blue,magenta,red);" oninput="updHSL()"><div class="slabel" style="margin-top:5px;">Saturation</div><input type="range" class="hsl-trk" id="hsl-s" min="0" max="100" value="100" oninput="updHSL()"><div class="slabel" style="margin-top:5px;">Lightness</div><input type="range" class="hsl-trk" id="hsl-l" min="0" max="100" value="50" oninput="updHSL()"><div id="hsl-prev" style="width:100%;height:22px;border-radius:5px;margin-top:4px;border:1px solid #222;"></div><div class="slabel" style="margin-top:8px;">Palette</div><div class="pgrid" id="pgrid-el"></div>`;
    // Build palette
    const pg=document.getElementById('pgrid-el');
    PALETTE.forEach(h=>{const d=document.createElement('div');d.className='pc';d.style.background=h;d.onclick=()=>setPri(h);d.oncontextmenu=e=>{e.preventDefault();setSec(h);};pg.appendChild(d);});
    // Color history
    const ch=document.getElementById('chist');colHist.forEach(c=>{const d=document.createElement('div');d.className='cdot';d.style.background=c;d.onclick=()=>setPri(c);ch.appendChild(d);});
    const h=+(document.getElementById('hsl-h')||{value:0}).value;document.getElementById('hsl-prev').style.background=`hsl(${h},100%,50%)`;
  }
}

// â”€â”€ Pending remap slot pick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingRemapSlot=null;
const origPickCol=pickCol;
// Override pickCol to also check pending remap
function interceptedPickCol(x,y){
  const t=document.createElement('canvas');t.width=W;t.height=H;const tc=t.getContext('2d');layers.forEach(l=>{if(l.vis){tc.globalAlpha=l.opacity/100;tc.drawImage(l.cv,0,0);}});tc.globalAlpha=1;
  const px=tc.getImageData(x,y,1,1).data;if(px[3]===0)return;
  const hex=rgb2hx(px[0],px[1],px[2]);
  if(pendingRemapSlot){const{idx,which}=pendingRemapSlot;remapSlots[idx][which]=hex;pendingRemapSlot=null;switchTab('remap');setTool('pencil');toast('Color picked for slot '+(idx+1),'var(--purple)');return;}
  setPri(hex);setTool('pencil');
}

// â”€â”€ HSL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updHSL(){const h=+document.getElementById('hsl-h').value,s=+document.getElementById('hsl-s').value,l=+document.getElementById('hsl-l').value;document.getElementById('hsl-prev').style.background=`hsl(${h},${s}%,${l}%)`;setPri(hslHex(h,s,l));}
function hslHex(h,s,l){h=+h;s=+s/100;l=+l/100;const a=s*Math.min(l,1-l);const f=n=>{const k=(n+h/30)%12;const c=l-a*Math.max(-1,Math.min(k-3,9-k,1));return Math.round(255*c).toString(16).padStart(2,'0');};return'#'+f(0)+f(8)+f(4);}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAct(){document.getElementById('act-modal').style.display='flex';setTimeout(()=>document.getElementById('act-iname').focus(),80);}
function closeAct(){document.getElementById('act-modal').style.display='none';}
function confirmAct(){const name=document.getElementById('act-iname').value.trim()||'Action '+(actions.length+1);closeAct();saveFrame();actions.push({name,snap:capFrame()});switchTab('actions');}

// â”€â”€ Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLib(){if(!myHandle)return;const{data}=await _S.from('user_sprites').select('*').eq('owner_handle',myHandle).order('created_at',{ascending:false});mySprites=data||[];if(cTab==='lib')renderR();}
function loadSprLib(sp){saveSt();const img=new Image();img.onload=()=>{aL().ctx.clearRect(0,0,W,H);aL().ctx.drawImage(img,0,0,W,H);};img.src=sp.image_data;const acts=typeof sp.actions==='string'?JSON.parse(sp.actions):(sp.actions||{});actions=Object.entries(acts).map(([name,dataUrl])=>{const sn={};layers.forEach(l=>sn[l.id]=l.ctx.getImageData(0,0,W,H));return{name,snap:sn};});if(cTab==='actions')renderR();}

// â”€â”€ Composite / Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function composite(frameIdx){
  const f=frames[frameIdx]||capFrame();
  const t=document.createElement('canvas');t.width=W;t.height=H;const c=t.getContext('2d');
  layers.forEach(l=>{if(!l.vis)return;const d=f[l.id];if(!d)return;
    const tmp=document.createElement('canvas');tmp.width=W;tmp.height=H;tmp.getContext('2d').putImageData(d,0,0);
    c.globalAlpha=l.opacity/100;c.globalCompositeOperation=l.blend;c.drawImage(tmp,0,0);
  });c.globalAlpha=1;c.globalCompositeOperation='source-over';return t.toDataURL('image/png');
}
function compositeAll(){return frames.map((_,i)=>composite(i));}

function exportPNG(){const a=document.createElement('a');a.href=composite(aFidx);a.download='sprite.png';a.click();}

function exportGIF(){
  if(frames.length<=1&&!confirm('Only 1 frame â€” export anyway?'))return;
  toast('â³ Generating GIF...','#888');
  try{
    const gif=new GIF({workers:2,quality:10,width:W,height:H,workerScript:'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'});
    const fps=Math.max(1,+document.getElementById('fps-inp').value||8);
    const delay=Math.round(1000/fps);
    saveFrame();
    frames.forEach((_,i)=>{
      const cv=document.createElement('canvas');cv.width=W;cv.height=H;
      const dataUrl=composite(i);
      const img=new Image();img.src=dataUrl;
      const c=cv.getContext('2d');c.drawImage(img,0,0);
      gif.addFrame(cv,{delay,copy:true});
    });
    gif.on('finished',blob=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sprite.gif';a.click();toast('âœ… GIF exported!','var(--teal)');});
    gif.render();
  }catch(err){toast('âš  GIF export unavailable in this browser','var(--danger)');}
}

// â”€â”€ Save / Publish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPub(){document.getElementById('pub-modal').style.display='flex';}
function closePub(){document.getElementById('pub-modal').style.display='none';}
function openSave(){document.getElementById('save-modal').style.display='flex';}
function closeSave(){document.getElementById('save-modal').style.display='none';}
async function savePersonal(){if(!myHandle)return alert('Log in to save.');const name=document.getElementById('save-name').value.trim()||'Sprite';const ao={};actions.forEach(a=>{const t=document.createElement('canvas');t.width=W;t.height=H;drawFrameOn(a.snap,t);ao[a.name]=t.toDataURL('image/png');});const{error}=await _S.from('user_sprites').insert([{owner_handle:myHandle,name,image_data:composite(aFidx),actions:ao}]);if(error)return alert('Error: '+error.message);closeSave();toast('âœ… Saved!','var(--teal)');fetchLib();}
async function publishSprite(){if(!myHandle)return alert('Log in.');const name=document.getElementById('pub-name').value.trim();if(!name)return alert('Name required!');const tags=document.getElementById('pub-tags').value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);const btn=document.getElementById('pub-btn');btn.innerText='Publishing...';btn.disabled=true;const img=composite(aFidx);const ao={};actions.forEach(a=>{const t=document.createElement('canvas');t.width=W;t.height=H;drawFrameOn(a.snap,t);ao[a.name]=t.toDataURL('image/png');});const[{error:e1},{error:e2}]=await Promise.all([_S.from('sprites_library').insert([{name,image_data:img,actions:ao,creator:myHandle,tags}]),_S.from('user_sprites').insert([{owner_handle:myHandle,name,image_data:img,actions:ao}])]);btn.innerText='PUBLISH';btn.disabled=false;if(e1)return alert('Error: '+e1.message);closePub();toast('âœ… Published!','var(--accent)');fetchLib();}

// â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function importImg(inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{saveSt();aL().ctx.clearRect(0,0,W,H);aL().ctx.drawImage(img,0,0,W,H);};img.src=e.target.result;};r.readAsDataURL(f);inp.value='';}
function newSprite(){if(!confirm('Start fresh?'))return;layers.forEach(l=>l.ctx.clearRect(0,0,W,H));actions=[];frames=[capFrame()];aFidx=0;uStack=[];rStack=[];renderFstrip();renderR();}
function clearCv(){if(!confirm('Clear this layer?'))return;saveSt();aL().ctx.clearRect(0,0,W,H);}

// â”€â”€ Eyedrop override for remap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hitCv.addEventListener('pointerdown',e=>{}, {capture:true});
// Patch onDn to use intercepted pick
const _origOnDn=onDn;

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg,col='white'){const t=document.createElement('div');t.style.cssText=`position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:${col};color:#000;padding:8px 18px;border-radius:10px;font-weight:900;font-size:11px;z-index:9999;pointer-events:none;white-space:nowrap;`;t.innerText=msg;document.body.appendChild(t);setTimeout(()=>{t.style.opacity=0;t.style.transition='opacity .4s';},1800);setTimeout(()=>t.remove(),2400);}

// Patch eyedrop to use intercepted version
function pickCol(x,y){interceptedPickCol(x,y);}
</script>
</body>
>>>>>>> ba49e38988dbbfe6054c14b4b3cd75b00beef1af
</html>