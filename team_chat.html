<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore | Team Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); display: flex; align-items: center; gap: 15px; z-index: 10; }
        .back-btn { cursor: pointer; font-size: 20px; }
        #chatPic { width: 38px; height: 38px; border-radius: 8px; background: #222; background-size: cover; border: 1px solid var(--border); }

        #chatContainer { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
        
        /* --- MESSAGE ROWS --- */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; position: relative; }
        .mine { justify-content: flex-end; }
        .theirs { justify-content: flex-start; }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .sender-name { font-size: 10px; color: var(--secondary); margin-bottom: 4px; font-weight: 700; margin-left: 2px; }
        .mine .sender-name { display: none; } /* Hide your own name */

        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .mine .bubble { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .theirs .bubble { background: #222; color: #fff; border-bottom-left-radius: 4px; }
        
        .reaction-badge { position: absolute; bottom: -8px; right: 8px; background: #1a1a1a; border: 1px solid var(--border); border-radius: 10px; padding: 2px 6px; font-size: 11px; z-index: 2; }

        .input-area { padding: 15px 20px 30px; background: #000; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .input-area input { flex: 1; background: #111; border: 1px solid var(--border); border-radius: 25px; padding: 12px 18px; color: white; outline: none; }
        .btn-round { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; background: #222; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        .error-screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; gap: 10px; padding: 20px; }
    </style>
</head>
<body>

    <div class="error-screen" id="errorScreen">
        <h2 style="margin:0;">Access Denied</h2>
        <p style="color:#777; font-size:14px;">You must be a member of this team to view the chat.</p>
        <button onclick="location.href='teams.html'" style="padding:10px 20px; border-radius:20px; background:var(--accent); color:#000; border:none; font-weight:800; margin-top:10px; cursor:pointer;">Back to Teams</button>
    </div>

    <div id="mainUI" style="display:flex; flex-direction:column; height:100%;">
        <div class="header">
            <span class="back-btn" onclick="location.href='teams.html'">‚¨ÖÔ∏è</span>
            <div id="chatPic"></div>
            <div>
                <h3 id="headerTitle" style="margin:0; font-size:15px;">...</h3>
                <span style="font-size:11px; color:#aaa;">Team Chat</span>
            </div>
        </div>

        <div id="chatContainer"></div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Message the team..." autocomplete="off">
            <button class="btn-round" style="background:var(--accent); color:#000;" onclick="sendMessage()">üöÄ</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://mmycqeejhguzhtzkyjaj.supabase.co';
        const supabaseKey = 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
        const myHandle = myProfile.handle;
        const urlParams = new URLSearchParams(window.location.search);
        const activeTeamId = urlParams.get('id');

        async function init() {
            if (!activeTeamId || !myHandle) return showError();

            // 1. Fetch Team Details
            const { data: team } = await _supabase.from('team_tickets').select('*').eq('id', activeTeamId).single();
            if (!team) return showError();

            // 2. Validate Membership (Is Owner OR is Accepted Member?)
            const isOwner = team.owner_handle === myHandle;
            if (!isOwner) {
                const { data: req } = await _supabase.from('team_requests')
                    .select('status')
                    .eq('ticket_id', activeTeamId)
                    .eq('sender_handle', myHandle)
                    .single();
                
                if (!req || req.status !== 'accepted') {
                    return showError();
                }
            }

            // Setup UI
            document.getElementById('headerTitle').innerText = team.team_name;
            if (team.pfp) document.getElementById('chatPic').style.backgroundImage = `url(${team.pfp})`;

            // Load Messages & Listeners
            await loadMessages();
            setupRealtime();
        }

        function showError() {
            document.getElementById('mainUI').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
        }

        function setupRealtime() {
            // Use a unique channel name per team to avoid collisions
            const channelName = `team_chat_${activeTeamId}`;
            _supabase.channel(channelName).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'team_messages' }, payload => {
                const m = payload.new;
                // Only append if it belongs to this team chat
                if (String(m.ticket_id) === String(activeTeamId)) {
                    appendMessage(m);
                }
            }).subscribe();
        }

        function isImageContent(text) {
            if (text.startsWith('data:image')) return true;
            return text.match(/\.(jpeg|jpg|gif|png|webp|svg)/i) && text.startsWith('http');
        }

        function buildMessageHTML(m) {
            let html = "";
            if (isImageContent(m.content)) {
                html += `<div class="bubble" style="padding:4px;"><img src="${m.content}" style="width:100%; border-radius:14px; display:block;"></div>`;
            } else {
                html += `<div class="bubble"><span>${m.content}</span></div>`;
            }
            if (m.reaction) html += `<div class="reaction-badge">${m.reaction}</div>`;
            return html;
        }

        async function loadMessages() {
            const { data } = await _supabase.from('team_messages')
                .select('*')
                .eq('ticket_id', activeTeamId)
                .order('created_at', { ascending: true });
            
            document.getElementById('chatContainer').innerHTML = "";
            data?.forEach(appendMessage);
        }

        function appendMessage(m) {
            if (document.getElementById(`row-${m.id}`)) return;
            const isMine = m.sender_handle === myHandle;
            
            const row = document.createElement('div');
            row.className = `msg-row ${isMine ? 'mine' : 'theirs'}`;
            row.id = `row-${m.id}`;

            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            
            // Add sender's name above the bubble
            wrapper.innerHTML = `
                <div class="sender-name">@${m.sender_handle}</div>
                ${buildMessageHTML(m)}
            `;
            
            row.appendChild(wrapper);
            
            const container = document.getElementById('chatContainer');
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const val = input.value.trim();
            if (!val) return;
            input.value = "";
            await _supabase.from('team_messages').insert([{ 
                ticket_id: activeTeamId, 
                sender_handle: myHandle, 
                content: val 
            }]);
        }

        window.onload = init;
        document.getElementById('msgInput').onkeypress = e => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
=======
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore | Team Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); display: flex; align-items: center; gap: 15px; z-index: 10; }
        .back-btn { cursor: pointer; font-size: 20px; }
        #chatPic { width: 38px; height: 38px; border-radius: 8px; background: #222; background-size: cover; border: 1px solid var(--border); }

        #chatContainer { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
        
        /* --- MESSAGE ROWS --- */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; position: relative; }
        .mine { justify-content: flex-end; }
        .theirs { justify-content: flex-start; }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .sender-name { font-size: 10px; color: var(--secondary); margin-bottom: 4px; font-weight: 700; margin-left: 2px; }
        .mine .sender-name { display: none; } /* Hide your own name */

        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .mine .bubble { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .theirs .bubble { background: #222; color: #fff; border-bottom-left-radius: 4px; }
        
        .reaction-badge { position: absolute; bottom: -8px; right: 8px; background: #1a1a1a; border: 1px solid var(--border); border-radius: 10px; padding: 2px 6px; font-size: 11px; z-index: 2; }

        .input-area { padding: 15px 20px 30px; background: #000; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .input-area input { flex: 1; background: #111; border: 1px solid var(--border); border-radius: 25px; padding: 12px 18px; color: white; outline: none; }
        .btn-round { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; background: #222; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        .error-screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; gap: 10px; padding: 20px; }
    </style>
</head>
<body>

    <div class="error-screen" id="errorScreen">
        <h2 style="margin:0;">Access Denied</h2>
        <p style="color:#777; font-size:14px;">You must be a member of this team to view the chat.</p>
        <button onclick="location.href='teams.html'" style="padding:10px 20px; border-radius:20px; background:var(--accent); color:#000; border:none; font-weight:800; margin-top:10px; cursor:pointer;">Back to Teams</button>
    </div>

    <div id="mainUI" style="display:flex; flex-direction:column; height:100%;">
        <div class="header">
            <span class="back-btn" onclick="location.href='teams.html'">‚¨ÖÔ∏è</span>
            <div id="chatPic"></div>
            <div>
                <h3 id="headerTitle" style="margin:0; font-size:15px;">...</h3>
                <span style="font-size:11px; color:#aaa;">Team Chat</span>
            </div>
        </div>

        <div id="chatContainer"></div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Message the team..." autocomplete="off">
            <button class="btn-round" style="background:var(--accent); color:#000;" onclick="sendMessage()">üöÄ</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://mmycqeejhguzhtzkyjaj.supabase.co';
        const supabaseKey = 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
        const myHandle = myProfile.handle;
        const urlParams = new URLSearchParams(window.location.search);
        const activeTeamId = urlParams.get('id');

        async function init() {
            if (!activeTeamId || !myHandle) return showError();

            // 1. Fetch Team Details
            const { data: team } = await _supabase.from('team_tickets').select('*').eq('id', activeTeamId).single();
            if (!team) return showError();

            // 2. Validate Membership (Is Owner OR is Accepted Member?)
            const isOwner = team.owner_handle === myHandle;
            if (!isOwner) {
                const { data: req } = await _supabase.from('team_requests')
                    .select('status')
                    .eq('ticket_id', activeTeamId)
                    .eq('sender_handle', myHandle)
                    .single();
                
                if (!req || req.status !== 'accepted') {
                    return showError();
                }
            }

            // Setup UI
            document.getElementById('headerTitle').innerText = team.team_name;
            if (team.pfp) document.getElementById('chatPic').style.backgroundImage = `url(${team.pfp})`;

            // Load Messages & Listeners
            await loadMessages();
            setupRealtime();
        }

        function showError() {
            document.getElementById('mainUI').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
        }

        function setupRealtime() {
            // Use a unique channel name per team to avoid collisions
            const channelName = `team_chat_${activeTeamId}`;
            _supabase.channel(channelName).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'team_messages' }, payload => {
                const m = payload.new;
                // Only append if it belongs to this team chat
                if (String(m.ticket_id) === String(activeTeamId)) {
                    appendMessage(m);
                }
            }).subscribe();
        }

        function isImageContent(text) {
            if (text.startsWith('data:image')) return true;
            return text.match(/\.(jpeg|jpg|gif|png|webp|svg)/i) && text.startsWith('http');
        }

        function buildMessageHTML(m) {
            let html = "";
            if (isImageContent(m.content)) {
                html += `<div class="bubble" style="padding:4px;"><img src="${m.content}" style="width:100%; border-radius:14px; display:block;"></div>`;
            } else {
                html += `<div class="bubble"><span>${m.content}</span></div>`;
            }
            if (m.reaction) html += `<div class="reaction-badge">${m.reaction}</div>`;
            return html;
        }

        async function loadMessages() {
            const { data } = await _supabase.from('team_messages')
                .select('*')
                .eq('ticket_id', activeTeamId)
                .order('created_at', { ascending: true });
            
            document.getElementById('chatContainer').innerHTML = "";
            data?.forEach(appendMessage);
        }

        function appendMessage(m) {
            if (document.getElementById(`row-${m.id}`)) return;
            const isMine = m.sender_handle === myHandle;
            
            const row = document.createElement('div');
            row.className = `msg-row ${isMine ? 'mine' : 'theirs'}`;
            row.id = `row-${m.id}`;

            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            
            // Add sender's name above the bubble
            wrapper.innerHTML = `
                <div class="sender-name">@${m.sender_handle}</div>
                ${buildMessageHTML(m)}
            `;
            
            row.appendChild(wrapper);
            
            const container = document.getElementById('chatContainer');
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const val = input.value.trim();
            if (!val) return;
            input.value = "";
            await _supabase.from('team_messages').insert([{ 
                ticket_id: activeTeamId, 
                sender_handle: myHandle, 
                content: val 
            }]);
        }

        window.onload = init;
        document.getElementById('msgInput').onkeypress = e => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
>>>>>>> ba49e38988dbbfe6054c14b4b3cd75b00beef1af
</html>