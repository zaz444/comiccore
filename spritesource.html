<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpriteSource | Pro Library</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        /* colors now in theme.css */

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: white; overflow-x: hidden; }

        .header { 
            padding: 15px 30px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; background: rgba(5,5,5,0.9); backdrop-filter: blur(10px); z-index: 100; 
        }

        .container { padding: 20px 30px 100px 30px; max-width: 1400px; margin: auto; }

        #admin-panel { display: none; background: #0a0a0a; border: 1px solid var(--teal); padding: 25px; border-radius: 15px; margin-bottom: 40px; }
        
        .main-upload-area { display: flex; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .preview-box { width: 120px; height: 120px; background: #000; border: 1px solid #333; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden; }
        .preview-box img { width: 100%; height: 100%; object-fit: contain; }

        .actions-manager { background: #111; padding: 20px; border-radius: 10px; border: 1px solid var(--border); }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-control { flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 12px; text-align: center; border: 1px solid transparent; transition: 0.2s; }
        .btn-bulk { background: var(--teal); color: white; }
        .btn-add { background: #222; color: white; border-color: #333; }
        .btn-clear { background: #441111; color: #ff5555; max-width: 100px; }

        .actions-list { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 10px; max-height: 500px; overflow-y: auto; padding-right: 10px;
        }
        
        .action-item { background: #000; border: 1px solid #333; padding: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .action-item input[type="text"] { background: #111; border: 1px solid #222; color: white; padding: 5px; border-radius: 4px; font-size: 11px; flex: 1; }
        .action-item img { width: 35px; height: 35px; object-fit: contain; background: #111; border-radius: 4px; }

        #preview-overlay {
            position: fixed; top: 0; right: -100%; width: 400px; height: 100%;
            background: #0a0a0a; border-left: 1px solid var(--border);
            z-index: 1001; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 30px;
            box-shadow: -20px 0 50px rgba(0,0,0,0.8); overflow-y: auto;
        }
        #preview-overlay.active { right: 0; }
        .overlay-close { cursor: pointer; color: var(--secondary); font-size: 11px; font-weight: 900; letter-spacing: 1px; margin-bottom: 20px; display: block; }
        
        .view-main-img { width: 100%; aspect-ratio: 1; background: #000; border-radius: 12px; object-fit: contain; border: 1px solid #222; margin-bottom: 20px; }
        .view-actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .view-chip { background: #111; border: 1px solid #222; padding: 8px; border-radius: 8px; text-align: center; }
        .view-chip img { width: 100%; height: 50px; object-fit: contain; margin-bottom: 5px; }
        .view-chip span { font-size: 9px; color: var(--secondary); font-weight: 700; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .btn-publish { width: 100%; padding: 18px; background: var(--teal); color: white; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; margin-top: 25px; }
        
        .sprite-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .sprite-card { aspect-ratio: 1; background: var(--card); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; overflow: hidden; transition: 0.2s; position: relative; }
        .sprite-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .sprite-card img { width: 100%; height: 100%; object-fit: contain; padding: 10px; }
        .sprite-card-label { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px 8px; background: rgba(0,0,0,0.7); font-size: 10px; font-weight: 800; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Search bar */
        .search-wrap { position: relative; margin-bottom: 14px; }
        .search-bar { width: 100%; padding: 12px 16px; background: #111; border: 1px solid #333; color: white; border-radius: 10px; font-size: 13px; font-weight: 600; outline: none; box-sizing: border-box; }
        .search-bar:focus { border-color: var(--accent); }

        /* Autocomplete dropdown */
        .suggest-drop {
            position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 500;
            background: #111; border: 1px solid #333; border-radius: 10px;
            overflow: hidden; display: none; box-shadow: 0 8px 32px rgba(0,0,0,.8);
        }
        .suggest-drop.open { display: block; }
        .suggest-item {
            padding: 10px 14px; font-size: 12px; font-weight: 700; color: #aaa;
            cursor: pointer; display: flex; align-items: center; gap: 10px; transition: .12s;
            border-bottom: 1px solid #1a1a1a;
        }
        .suggest-item:last-child { border-bottom: none; }
        .suggest-item:hover, .suggest-item.focused { background: #1a1a1a; color: white; }
        .suggest-icon { font-size: 14px; flex-shrink: 0; }
        .suggest-match { color: var(--accent); }
        .suggest-count { margin-left: auto; font-size: 10px; color: #444; font-weight: 800; flex-shrink: 0; }

        /* Tag chips */
        .tag-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
        .tag-chip { padding: 5px 12px; border-radius: 20px; background: #1c1c1e; border: 1px solid #333; color: #aaa; font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.15s; }
        .tag-chip:hover { border-color: #555; color: white; }
        .tag-chip.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .tag-chips-label { font-size: 9px; font-weight: 900; color: #333; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }

        /* Your Sprites section */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 14px; border-top: 1px solid #222; padding-top: 24px; }
        .section-title { font-size: 12px; font-weight: 900; color: var(--teal); letter-spacing: 2px; text-transform: uppercase; }
        .your-sprite-card { aspect-ratio: 1; background: #0a0a0a; border: 2px solid #1e1e2e; border-radius: 12px; cursor: pointer; overflow: hidden; transition: 0.2s; position: relative; }
        .your-sprite-card:hover { border-color: var(--teal); transform: translateY(-2px); }
        .your-sprite-card img { width: 100%; height: 100%; object-fit: contain; padding: 10px; }
        .your-sprite-nametag { position: absolute; bottom: 0; left: 0; right: 0; padding: 5px 8px; background: rgba(0,210,255,0.15); border-top: 1px solid rgba(0,210,255,0.3); font-size: 10px; font-weight: 800; color: var(--teal); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .your-sprite-actions { position: absolute; top: 4px; right: 4px; display: flex; gap: 4px; opacity: 0; transition: 0.15s; }
        .your-sprite-card:hover .your-sprite-actions { opacity: 1; }
        .sprite-action-btn { background: rgba(0,0,0,0.8); border: 1px solid #333; color: white; border-radius: 5px; padding: 3px 7px; font-size: 10px; font-weight: 800; cursor: pointer; }
        .sprite-action-btn.danger { color: #ff453a; border-color: #552222; }

        /* ‚îÄ‚îÄ Skeleton / lazy-load ‚îÄ‚îÄ */
        .sprite-skeleton {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #1a1a1a 25%, #242424 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
        }
        @keyframes shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .sprite-card img { opacity: 0; transition: opacity 0.25s ease; }
        .sprite-card img.loaded { opacity: 1; }

        /* Admin Delete Styles */
        .admin-btn-delete {
            width: 100%; padding: 12px; background: #331111; color: #ff5555; 
            border: 1px solid #552222; border-radius: 8px; font-weight: 800; 
            cursor: pointer; margin-top: 15px; font-size: 10px; letter-spacing: 1px;
            transition: 0.2s;
        }
        .admin-btn-delete:hover { background: #551111; color: white; }
    </style>
</head>
<body>

<div class="header">
    <a href="create.html" style="color:white; text-decoration:none; font-size:12px;">‚Üê BACK TO EDITOR</a>
    <h1 style="font-size: 16px; margin:0;">SPRITE SOURCE</h1>
    <div id="status-badge" style="font-size: 10px; color:var(--teal);">CREATOR MODE</div>
</div>

<div id="preview-overlay">
    <span class="overlay-close" onclick="closePreview()">‚úï CLOSE PREVIEW</span>
    <img id="v-img" class="view-main-img">
    <h2 id="v-name" style="margin:0; font-weight:900;"></h2>
    <div id="v-creator-link" style="color:var(--teal); font-size:11px; margin-bottom:20px; cursor:pointer; text-decoration:underline;"></div>
    
    <div style="border-top: 1px solid #222; padding-top:20px;">
        <span style="font-size: 10px; font-weight:800; color:var(--secondary);">PACK ASSETS</span>
        <div id="v-actions" class="view-actions-grid"></div>
    </div>
    <button class="btn-publish" style="background:var(--accent);" id="v-use-btn">USE ASSET PACK</button>
    <div id="admin-action-container"></div> 
</div>

<div class="container">
    <div id="admin-panel">
        <div class="main-upload-area">
            <div class="preview-box" id="main-preview">MAIN</div>
            <div style="flex:1">
                <input type="text" id="sprite-name" placeholder="Character Name" style="width:100%; padding:12px; background:#000; border:1px solid #333; color:white; border-radius:6px; margin-bottom:10px;">
                <input type="text" id="sprite-tags" placeholder="üè∑ Tags (comma-separated: warrior, female, fantasy)" style="width:100%; padding:12px; background:#111; border:1px solid var(--teal); color:white; border-radius:6px; margin-bottom:10px; font-size:12px; outline:none;">
                <input type="file" id="main-file-input" accept="image/*" onchange="previewMain(this)">
            </div>
        </div>

        <div class="actions-manager">
            <div class="controls">
                <div class="btn-control btn-bulk" onclick="document.getElementById('bulk-input').click()">+ BULK ACTIONS</div>
                <div class="btn-control btn-add" onclick="addActionSlot()">+ MANUAL</div>
                <div class="btn-control btn-clear" onclick="clearActions()">CLEAR</div>
            </div>
            <input type="file" id="bulk-input" multiple accept="image/*" style="display:none;" onchange="handleBulkUpload(this)">
            <div class="actions-list" id="actions-list"></div>
        </div>

        <button class="btn-publish" id="upload-btn" onclick="uploadToDatabase()">PUBLISH ASSET PACK</button>
    </div>

    <div class="search-wrap">
        <input type="text" class="search-bar" id="sprite-search"
            placeholder="üîç Search sprites by name or tag..."
            oninput="onSearchInput()"
            onkeydown="onSearchKey(event)"
            autocomplete="off" spellcheck="false">
        <div class="suggest-drop" id="suggest-drop"></div>
    </div>
    <div class="tag-chips-label">üî• Top Tags</div>
    <div class="tag-chips" id="tag-chips-row"></div>

    <div id="your-sprites-section" style="display:none;">
        <div class="section-header">
            <span class="section-title">üé® Your Sprites</span>
            <span style="font-size:11px; color:#555; font-weight:700;">Only visible to you</span>
        </div>
        <div class="sprite-grid" id="your-sprites-grid"></div>
    </div>

    <div class="section-header" style="margin-top:20px;">
        <span class="section-title">üìö Public Library</span>
        <span id="sprite-count" style="font-size:11px; color:#555; font-weight:700;"></span>
    </div>
    <div class="sprite-grid" id="main-grid"></div>
</div>

<script>
    const supabaseUrl = 'https://mmycqeejhguzhtzkyjaj.supabase.co';
    const supabaseKey = 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const ADMIN_ID = "de0b7378-e779-4e0d-9e3d-b33bf643df3e";

    // Check all possible field names Supabase / localStorage might use for the UUID
    function checkIsAdmin(user) {
        const uid = user.permanent_id || user.id || user.user_id || user.uid || '';
        if (uid === ADMIN_ID) return true;
        const handle = (user.handle || user.username || '').toLowerCase().replace('@', '');
        return handle === 'jeffyplays';
    }

    let mainBase64 = "";
    let allSprites = [];
    let allTags = new Set();
    let tagCounts = {};
    let activeTagFilter = null;
    let myHandle = null;

    window.onload = async () => {
        const user = JSON.parse(localStorage.getItem('user_profile') || '{}');
        myHandle = user.handle || null;

        // Check localStorage profile first
        let isAdmin = checkIsAdmin(user);
        // Also try the live Supabase session in case user_profile is stale or missing
        if (!isAdmin) {
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                if (session && session.user) isAdmin = checkIsAdmin(session.user);
            } catch(e) {}
        }

        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'block';
        }
        
        fetchLibrary();
        if (myHandle) fetchMySprites();

        const incomingSave = localStorage.getItem('save_sprite_to_personal');
        if (incomingSave) {
            localStorage.removeItem('save_sprite_to_personal');
            const pack = JSON.parse(incomingSave);
            saveToPersonal(pack);
        }
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ RESTORED LOGIC START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function previewMain(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            mainBase64 = e.target.result;
            document.getElementById('main-preview').innerHTML = `<img src="${mainBase64}">`;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function handleBulkUpload(input) {
        const currentCount = document.querySelectorAll('.action-item').length;
        const remaining = 280 - currentCount;
        const files = Array.from(input.files).slice(0, remaining);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => createActionItem(file.name.split('.')[0], e.target.result);
            reader.readAsDataURL(file);
        });
        input.value = "";
    }

    function addActionSlot() {
        if (document.querySelectorAll('.action-item').length >= 280) return alert("Limit reached");
        createActionItem("", "");
    }

    function createActionItem(name, base64) {
        const container = document.getElementById('actions-list');
        const div = document.createElement('div');
        div.className = 'action-item';
        div.innerHTML = `
            <img src="${base64 || ''}" style="display:${base64 ? 'block' : 'none'}">
            <input type="text" value="${name}" placeholder="Action Name">
            <span style="color:#ff4444; cursor:pointer;" onclick="this.parentElement.remove()">√ó</span>
        `;
        div.dataset.base64 = base64;
        container.appendChild(div);
    }

    async function uploadToDatabase() {
        const name = document.getElementById('sprite-name').value;
        const tagsRaw = document.getElementById('sprite-tags').value;
        const tags = tagsRaw.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
        const btn = document.getElementById('upload-btn');
        if (!name || !mainBase64) return alert("Character Name and Main Image required!");

        btn.disabled = true;
        btn.innerText = "UPLOADING PACK...";

        const actionsObj = {};
        document.querySelectorAll('.action-item').forEach(item => {
            const aName = item.querySelector('input').value || "Action";
            if (item.dataset.base64) actionsObj[aName] = item.dataset.base64;
        });

        const { error } = await _supabase.from('sprites_library').insert([{
            name, image_data: mainBase64, actions: actionsObj,
            creator: myHandle || "Guest", tags
        }]);

        if (error) {
            alert("Upload Failed: " + error.message);
            btn.disabled = false;
            btn.innerText = "PUBLISH ASSET PACK";
        } else {
            localStorage.removeItem(META_CACHE_KEY);
            alert("Success! Pack Published.");
            location.reload();
        }
    }

    // ‚îÄ‚îÄ Caching & Lazy Loading ‚îÄ‚îÄ
    const META_CACHE_KEY = 'cc_sprites_meta_v2';
    const META_CACHE_TTL = 10 * 60 * 1000; 

    function saveMetaCache(data) {
        try { localStorage.setItem(META_CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch(e) {}
    }

    function loadMetaCache() {
        try {
            const raw = localStorage.getItem(META_CACHE_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (Date.now() - parsed.ts > META_CACHE_TTL) { localStorage.removeItem(META_CACHE_KEY); return null; }
            return parsed.data;
        } catch(e) { return null; }
    }

    function getCachedImage(id) { try { return sessionStorage.getItem('cc_simg_' + id); } catch(e) { return null; } }
    function setCachedImage(id, b64) { try { sessionStorage.setItem('cc_simg_' + id, b64); } catch(e) {} }

    let lazyQueue = [];
    let lazyTimer = null;

    const lazyObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            lazyObserver.unobserve(entry.target);
            const id = entry.target.dataset.id;
            if (!id) return;
            const cached = getCachedImage(id);
            if (cached) { applyImageToCard(entry.target, cached); } 
            else { lazyQueue.push(id); scheduleBatchFetch(); }
        });
    }, { rootMargin: '300px 0px' });

    function scheduleBatchFetch() {
        if (lazyTimer) return;
        lazyTimer = setTimeout(flushBatch, 40);
    }

    async function flushBatch() {
        lazyTimer = null;
        if (!lazyQueue.length) return;
        const batch = [...new Set(lazyQueue.splice(0, 20))];
        const { data } = await _supabase.from('sprites_library').select('id, image_data').in('id', batch);
        if (!data) return;
        data.forEach(row => {
            setCachedImage(row.id, row.image_data);
            const sprite = allSprites.find(s => s.id === row.id);
            if (sprite) sprite.image_data = row.image_data;
            const card = document.querySelector(`.sprite-card[data-id="${row.id}"]`);
            if (card) applyImageToCard(card, row.image_data);
        });
        if (lazyQueue.length) scheduleBatchFetch();
    }

    function applyImageToCard(card, src) {
        const skeleton = card.querySelector('.sprite-skeleton');
        if (!skeleton) return;
        const img = document.createElement('img');
        img.onload = () => { skeleton.replaceWith(img); img.classList.add('loaded'); };
        img.src = src;
    }

    const fullDataCache = new Map();

    async function fetchFullSprite(id) {
        if (fullDataCache.has(id)) return fullDataCache.get(id);
        const sprite = allSprites.find(s => s.id === id);
        const hasImage = !!(sprite && sprite.image_data);
        const fields = hasImage ? 'id, actions' : 'id, image_data, actions';
        const { data } = await _supabase.from('sprites_library').select(fields).eq('id', id).single();
        if (!data) return null;
        if (sprite && data.image_data) sprite.image_data = data.image_data;
        fullDataCache.set(id, data);
        return data;
    }

    async function fetchLibrary() {
        const cached = loadMetaCache();
        if (cached) { allSprites = cached; initAfterMetaFetch(false); }
        const { data } = await _supabase.from('sprites_library').select('id, name, tags, creator, created_at').order('created_at', { ascending: false });
        const fresh = data || [];
        const cachedIds = (allSprites || []).map(s => s.id).join(',');
        const freshIds  = fresh.map(s => s.id).join(',');
        if (freshIds !== cachedIds || !cached) {
            allSprites = fresh;
            saveMetaCache(fresh);
            initAfterMetaFetch(true);
        }
    }

    async function fetchMySprites() {
        const { data } = await _supabase.from('user_sprites').select('id, name, actions, image_data, created_at').eq('owner_handle', myHandle).order('created_at', { ascending: false });
        if (!data || data.length === 0) return;
        document.getElementById('your-sprites-section').style.display = 'block';
        const grid = document.getElementById('your-sprites-grid');
        grid.innerHTML = '';
        data.forEach(sprite => {
            const card = document.createElement('div');
            card.className = 'your-sprite-card';
            card.innerHTML = `
                <img src="${sprite.image_data}" loading="lazy" style="width:100%;height:100%;object-fit:contain;padding:10px;">
                <div class="your-sprite-nametag">${sprite.name}</div>
                <div class="your-sprite-actions">
                    <button class="sprite-action-btn" onclick="useMySprite(event, ${JSON.stringify(sprite).replace(/"/g, '&quot;')})">USE</button>
                    <button class="sprite-action-btn danger" onclick="deleteMySprite(event, ${sprite.id})">‚úï</button>
                </div>
            `;
            card.onclick = () => openPreview(sprite, true);
            grid.appendChild(card);
        });
    }

    async function saveToPersonal(pack) {
        if (!myHandle) { alert('Log in to save sprites.'); return; }
        const { error } = await _supabase.from('user_sprites').insert([{
            owner_handle: myHandle,
            name: pack.name,
            image_data: pack.image_data,
            actions: pack.actions || {}
        }]);
        if (!error) { alert('‚úÖ Saved to Your Sprites!'); fetchMySprites(); }
        else { alert('Error saving: ' + error.message); }
    }

    function useMySprite(e, sprite) {
        e.stopPropagation();
        localStorage.setItem('incoming_sprite_pack', JSON.stringify(sprite));
        location.href = 'create.html';
    }

    async function deleteMySprite(e, id) {
        e.stopPropagation();
        if (!confirm('Remove from your sprites?')) return;
        await _supabase.from('user_sprites').delete().eq('id', id);
        fetchMySprites();
    }

    // ‚îÄ‚îÄ Search & Autocomplete Restored ‚îÄ‚îÄ
    let suggestFocusIdx = -1;

    function renderTagChips() {
        const row = document.getElementById('tag-chips-row');
        if (!allTags.size) { row.style.display = 'none'; return; }
        row.style.display = 'flex';
        const sortedTags = [...allTags].sort((a, b) => (tagCounts[b]||0) - (tagCounts[a]||0));
        const top10 = sortedTags.slice(0, 10);
        let html = `<button class="tag-chip ${!activeTagFilter ? 'active' : ''}" data-tag="">All</button>`;
        html += top10.map(t => `<button class="tag-chip ${activeTagFilter === t ? 'active' : ''}" data-tag="${t}">${t}</button>`).join('');
        row.innerHTML = html;
        row.querySelectorAll('.tag-chip').forEach(chip => {
            chip.onclick = () => {
                activeTagFilter = chip.dataset.tag || null;
                document.getElementById('sprite-search').value = '';
                closeSuggest();
                renderTagChips();
                filterSprites();
            };
        });
    }

    function onSearchInput() { filterSprites(); updateSuggestions(); }

    function updateSuggestions() {
        const q = document.getElementById('sprite-search').value.toLowerCase().trim();
        const drop = document.getElementById('suggest-drop');
        if (!q) { closeSuggest(); return; }
        const sortedTags = [...allTags].sort((a, b) => (tagCounts[b]||0) - (tagCounts[a]||0));
        const matches = sortedTags.filter(t => t.includes(q)).slice(0, 8);
        if (!matches.length) { closeSuggest(); return; }
        
        suggestFocusIdx = -1;
        drop.innerHTML = matches.map(t => {
            const count = tagCounts[t] || 0;
            return `<div class="suggest-item" onmousedown="pickSuggest(event,'${t}','tag')">
                <span class="suggest-icon">üè∑</span>
                <span>${t}</span>
                <span class="suggest-count">${count} packs</span>
            </div>`;
        }).join('');
        drop.classList.add('open');
    }

    function pickSuggest(e, val) {
        e.preventDefault();
        document.getElementById('sprite-search').value = val;
        activeTagFilter = val;
        renderTagChips();
        closeSuggest();
        filterSprites();
    }

    function closeSuggest() { 
        const drop = document.getElementById('suggest-drop');
        drop.classList.remove('open');
        drop.innerHTML = '';
        suggestFocusIdx = -1;
    }

    function onSearchKey(e) {
        const drop = document.getElementById('suggest-drop');
        const items = drop.querySelectorAll('.suggest-item');
        if (!items.length) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            suggestFocusIdx = Math.min(suggestFocusIdx + 1, items.length - 1);
            items.forEach((it, i) => it.classList.toggle('focused', i === suggestFocusIdx));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            suggestFocusIdx = Math.max(suggestFocusIdx - 1, 0);
            items.forEach((it, i) => it.classList.toggle('focused', i === suggestFocusIdx));
        } else if (e.key === 'Enter' && suggestFocusIdx >= 0) {
            e.preventDefault();
            const focused = items[suggestFocusIdx];
            focused.onmousedown(e); 
        } else if (e.key === 'Escape') {
            closeSuggest();
        }
    }

    function filterSprites() {
        const query = document.getElementById('sprite-search').value.toLowerCase().trim();
        let filtered = allSprites;
        if (activeTagFilter) filtered = filtered.filter(s => (s.tags || []).includes(activeTagFilter));
        if (query) filtered = filtered.filter(s => s.name.toLowerCase().includes(query) || (s.tags || []).some(t => t.includes(query)));
        renderPublicGrid(filtered);
        document.getElementById('sprite-count').innerText = filtered.length + ' packs';
    }

    function initAfterMetaFetch(rerender) {
        allTags = new Set(); tagCounts = {};
        allSprites.forEach(s => { (s.tags || []).forEach(t => { allTags.add(t); tagCounts[t] = (tagCounts[t] || 0) + 1; }); });
        renderTagChips();
        if (rerender) { renderPublicGrid(allSprites); document.getElementById('sprite-count').innerText = allSprites.length + ' packs'; }
        else { renderPublicGrid(allSprites); document.getElementById('sprite-count').innerText = allSprites.length + ' packs'; }
    }

    function renderPublicGrid(sprites) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '';
        sprites.forEach(item => {
            const card = document.createElement('div');
            card.className = 'sprite-card';
            card.dataset.id = item.id;
            const cachedSrc = item.image_data || getCachedImage(item.id);
            if (cachedSrc) { card.innerHTML = `<img src="${cachedSrc}" class="loaded"><div class="sprite-card-label">${item.name}</div>`; } 
            else { card.innerHTML = `<div class="sprite-skeleton"></div><div class="sprite-card-label">${item.name}</div>`; lazyObserver.observe(card); }
            card.onclick = () => openPreview(item);
            grid.appendChild(card);
        });
    }

    async function openPreview(item, isPersonal = false) {
        document.getElementById('v-img').src = '';
        document.getElementById('v-img').style.opacity = '0';
        document.getElementById('v-name').innerText = item.name.toUpperCase();
        document.getElementById('v-actions').innerHTML = '<div style="color:#333;font-size:11px;font-weight:700;padding:8px;">Loading actions...</div>';
        document.getElementById('preview-overlay').classList.add('active');

        const creatorLink = document.getElementById('v-creator-link');
        creatorLink.innerText = isPersonal ? 'üîí YOUR PERSONAL SPRITE' : (item.creator ? `CREATED BY ${item.creator}` : '');
        creatorLink.onclick = isPersonal ? null : () => { location.href = `profile.html?u=${item.creator.replace('@','')}`; };

        const adminContainer = document.getElementById('admin-action-container');
        adminContainer.innerHTML = '';
        const user = JSON.parse(localStorage.getItem('user_profile') || '{}');
        const isAdmin = checkIsAdmin(user);

        if (!isPersonal && isAdmin) {
            const delBtn = document.createElement('button');
            delBtn.className = 'admin-btn-delete';
            delBtn.innerText = 'DELETE ASSET PACK';
            delBtn.onclick = async () => {
                if (!confirm("Delete this pack?")) return;
                await _supabase.from('sprites_library').delete().eq('id', item.id);
                localStorage.removeItem(META_CACHE_KEY);
                location.reload();
            };
            adminContainer.appendChild(delBtn);
        }

        document.getElementById('v-use-btn').onclick = async () => {
            const full = await fetchFullSprite(item.id);
            localStorage.setItem('incoming_sprite_pack', JSON.stringify({ ...item, ...full }));
            location.href = 'create.html';
        };

        const full = await fetchFullSprite(item.id);
        const vImg = document.getElementById('v-img');
        if (full.image_data || item.image_data) {
            vImg.src = full.image_data || item.image_data;
            vImg.style.opacity = '1';
        }

        const actGrid = document.getElementById('v-actions');
        actGrid.innerHTML = '';
        let actions = full.actions;
        if (typeof actions === 'string') try { actions = JSON.parse(actions); } catch(e) {}
        if (actions && Object.keys(actions).length) {
            Object.entries(actions).forEach(([key, val]) => {
                const chip = document.createElement('div');
                chip.className = 'view-chip';
                chip.innerHTML = `<img src="${val}" loading="lazy"><span>${key}</span>`;
                actGrid.appendChild(chip);
            });
        } else { actGrid.innerHTML = 'No actions found.'; }
    }

    function closePreview() { document.getElementById('preview-overlay').classList.remove('active'); }
    function clearActions() { if (confirm("Clear all?")) document.getElementById('actions-list').innerHTML = ""; }
</script>
</body>
</html>