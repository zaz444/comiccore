<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ComicCore â€” My Comics</title>
<link rel="stylesheet" href="theme.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
:root{--bg:#0d0d0f;--card:#141416;--text:#f0f0f2;--accent:#ff7a00;--border:#222224;--teal:#00d2ff;--danger:#ff3b30;--green:#32d74b;--muted:#666;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;display:flex;flex-direction:column;}

/* â”€â”€ Top bar â”€â”€ */
.topbar{position:sticky;top:0;z-index:100;height:54px;background:rgba(13,13,15,.96);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:10px;backdrop-filter:blur(12px);}
.topbar-title{font-size:15px;font-weight:900;letter-spacing:.5px;color:var(--accent);}
.topbar-sub{font-size:11px;color:#333;font-weight:700;flex:1;}
.tb{background:#1a1a1c;border:1px solid var(--border);color:#aaa;padding:7px 12px;border-radius:8px;cursor:pointer;font-size:11px;font-weight:700;transition:.15s;white-space:nowrap;}
.tb:hover{background:#222224;color:white;}
.tb.accent{border-color:var(--accent);color:var(--accent);}
.tb.teal{border-color:var(--teal);color:var(--teal);}

/* â”€â”€ Tab switcher â”€â”€ */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);background:rgba(13,13,15,.7);position:sticky;top:54px;z-index:90;backdrop-filter:blur(8px);}
.tab{flex:1;padding:13px 8px;text-align:center;font-size:11px;font-weight:900;letter-spacing:.5px;color:#2a2a2a;cursor:pointer;border:none;background:none;transition:.12s;text-transform:uppercase;border-bottom:2px solid transparent;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-count{background:#1e1e20;color:#444;border-radius:10px;padding:1px 6px;font-size:9px;margin-left:4px;font-weight:900;}
.tab.active .tab-count{background:rgba(255,122,0,.15);color:var(--accent);}

/* â”€â”€ Content area â”€â”€ */
.content{flex:1;padding:16px;max-width:680px;margin:0 auto;width:100%;}

/* â”€â”€ Toolbar row â”€â”€ */
.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
.search-box{flex:1;min-width:140px;background:#111;border:1px solid #1e1e1e;color:#ddd;padding:8px 12px;border-radius:9px;font-family:inherit;font-size:12px;outline:none;transition:.15s;}
.search-box:focus{border-color:var(--accent);}
.search-box::placeholder{color:#333;}
select.tb{appearance:none;padding-right:10px;}

/* â”€â”€ Comics grid â”€â”€ */
.comics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;}

/* â”€â”€ Comic card â”€â”€ */
.comic-card{background:var(--card);border:1.5px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;transition:.18s;position:relative;display:flex;flex-direction:column;}
.comic-card:hover{border-color:#333;transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.5);}
.comic-card.draft-card:hover{border-color:var(--teal);}
.comic-card.pub-card:hover{border-color:var(--accent);}
.comic-thumb{width:100%;aspect-ratio:.7;background:#0a0a0a;position:relative;overflow:hidden;flex-shrink:0;}
.comic-thumb canvas{width:100%;height:100%;object-fit:cover;display:block;}
.comic-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
.comic-thumb .thumb-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:32px;background:linear-gradient(135deg,#111,#0a0a12);}
.comic-thumb .page-badge{position:absolute;bottom:5px;right:5px;background:rgba(0,0,0,.85);color:#888;font-size:8px;font-weight:900;padding:2px 6px;border-radius:6px;letter-spacing:.5px;}
.comic-thumb .status-badge{position:absolute;top:7px;left:7px;font-size:8px;font-weight:900;padding:2px 8px;border-radius:6px;letter-spacing:.5px;text-transform:uppercase;}
.badge-draft{background:rgba(0,210,255,.15);color:var(--teal);border:1px solid rgba(0,210,255,.25);}
.badge-pub{background:rgba(255,122,0,.15);color:var(--accent);border:1px solid rgba(255,122,0,.25);}
.comic-info{padding:9px 10px 10px;flex:1;display:flex;flex-direction:column;gap:3px;}
.comic-title{font-size:12px;font-weight:900;color:#e0e0e0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.comic-meta{font-size:9px;color:#333;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.comic-stars{font-size:10px;color:#666;font-weight:700;display:flex;align-items:center;gap:3px;}
/* Quick actions on hover */
.card-actions{position:absolute;inset:0;background:rgba(0,0,0,.75);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:7px;opacity:0;transition:.18s;backdrop-filter:blur(3px);}
.comic-card:hover .card-actions{opacity:1;}
.ca-btn{padding:8px 18px;border-radius:9px;font-size:11px;font-weight:900;cursor:pointer;border:none;transition:.12s;min-width:110px;text-align:center;letter-spacing:.3px;}
.ca-btn:hover{filter:brightness(1.1);}
.ca-open{background:var(--accent);color:#000;}
.ca-edit{background:#222;color:#ddd;border:1px solid #333;}
.ca-read{background:var(--teal);color:#000;}
.ca-del{background:transparent;color:var(--danger);border:1px solid rgba(255,59,48,.3);font-size:10px;padding:5px 14px;}

/* â”€â”€ Empty state â”€â”€ */
.empty{text-align:center;padding:60px 20px;display:flex;flex-direction:column;align-items:center;gap:12px;}
.empty-icon{font-size:52px;opacity:.3;}
.empty-title{font-size:15px;font-weight:900;color:#333;}
.empty-sub{font-size:12px;color:#222;line-height:1.6;max-width:260px;}
.empty .tb{margin-top:8px;padding:10px 22px;font-size:12px;}

/* â”€â”€ Stats bar (published) â”€â”€ */
.stats-bar{display:flex;gap:16px;align-items:center;padding:10px 0 6px;border-bottom:1px solid var(--border);margin-bottom:14px;flex-wrap:wrap;}
.stat-item{display:flex;flex-direction:column;gap:1px;}
.stat-val{font-size:18px;font-weight:900;color:var(--text);line-height:1;}
.stat-lbl{font-size:9px;font-weight:700;color:#2a2a2a;text-transform:uppercase;letter-spacing:1px;}

/* â”€â”€ New comic modal â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:5000;display:none;align-items:flex-end;justify-content:center;padding-bottom:0;backdrop-filter:blur(12px);}
.bottom-sheet{background:#111;border-radius:20px 20px 0 0;border:1px solid #222;padding:24px 20px 36px;width:100%;max-width:500px;position:relative;}
.sheet-handle{width:36px;height:4px;background:#2a2a2a;border-radius:2px;margin:0 auto 20px;}
.sheet-title{font-size:16px;font-weight:900;margin-bottom:6px;letter-spacing:.5px;}
.sheet-sub{font-size:12px;color:#444;margin-bottom:20px;line-height:1.5;}
.ratio-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.ratio-opt{background:#0a0a0a;border:2px solid #1e1e1e;border-radius:12px;padding:14px 8px;text-align:center;cursor:pointer;transition:.12s;display:flex;flex-direction:column;align-items:center;gap:8px;}
.ratio-opt:hover{border-color:#444;}
.ratio-opt.sel{border-color:var(--accent);background:rgba(255,122,0,.05);}
.ratio-preview{background:#1a1a1a;border-radius:4px;}
.ratio-name{font-size:10px;font-weight:900;color:#888;letter-spacing:.3px;}
.ratio-dims{font-size:8px;color:#333;font-weight:700;}

/* â”€â”€ Confirm delete sheet â”€â”€ */
.del-sheet{background:#111;border-radius:20px 20px 0 0;border:1px solid #1e1e1e;padding:24px 20px 36px;width:100%;max-width:500px;}

/* â”€â”€ Toast â”€â”€ */
.toast-el{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:9px 20px;border-radius:11px;font-weight:900;font-size:12px;z-index:9999;pointer-events:none;white-space:nowrap;transition:opacity .4s;}

/* â”€â”€ Rename input â”€â”€ */
.rename-input{background:#0a0a0a;border:1px solid #2a2a2a;color:white;padding:9px 12px;border-radius:8px;font-family:inherit;font-size:13px;outline:none;width:100%;margin-bottom:10px;}
.rename-input:focus{border-color:var(--accent);}
</style>
</head>
<body>

<!-- New comic sheet -->
<div id="new-sheet" class="overlay" onclick="if(event.target===this)closeNew()">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ğŸ“– New Comic</div>
    <div class="sheet-sub">Pick the panel shape for your comic. This sets the canvas ratio and can't be changed after creation.</div>
    <div class="ratio-grid" id="ratio-grid"></div>
    <button class="tb accent" style="width:100%;padding:13px;font-size:13px;border-radius:11px;" onclick="startNewComic()">START CREATING â†’</button>
  </div>
</div>

<!-- Rename draft sheet -->
<div id="rename-sheet" class="overlay" onclick="if(event.target===this)closeRename()">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">âœï¸ Rename Draft</div>
    <input class="rename-input" id="rename-inp" placeholder="Comic title...">
    <div style="display:flex;gap:8px;">
      <button class="tb" style="flex:1;padding:11px;" onclick="closeRename()">Cancel</button>
      <button class="tb accent" style="flex:1;padding:11px;" onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<!-- Delete confirm sheet -->
<div id="del-sheet" class="overlay" onclick="if(event.target===this)closeDel()">
  <div class="del-sheet">
    <div class="sheet-handle"></div>
    <div id="del-title" style="font-size:14px;font-weight:900;margin-bottom:6px;color:var(--danger)">ğŸ—‘ Delete Comic?</div>
    <div id="del-sub" style="font-size:12px;color:#444;margin-bottom:20px;line-height:1.5;"></div>
    <div style="display:flex;gap:8px;">
      <button class="tb" style="flex:1;padding:11px;" onclick="closeDel()">Cancel</button>
      <button class="tb" style="flex:1;padding:11px;border-color:var(--danger);color:var(--danger);" onclick="confirmDelete()">DELETE</button>
    </div>
  </div>
</div>

<!-- Top bar -->
<div class="topbar">
  <button class="tb" onclick="location.href='index.html'">â† Home</button>
  <div>
    <div class="topbar-title">My Comics</div>
    <div class="topbar-sub" id="topbar-sub">Loading...</div>
  </div>
  <button class="tb accent" onclick="openNew()">+ New Comic</button>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab active" id="tab-drafts" onclick="switchTab('drafts')">
    Drafts <span class="tab-count" id="drafts-count">0</span>
  </button>
  <button class="tab" id="tab-published" onclick="switchTab('published')">
    Published <span class="tab-count" id="pub-count">0</span>
  </button>
</div>

<!-- Content -->
<div class="content">
  <!-- Drafts toolbar -->
  <div class="toolbar" id="drafts-toolbar">
    <input class="search-box" id="draft-search" placeholder="ğŸ” Search drafts..." oninput="renderDrafts()">
    <select class="tb" id="draft-sort" onchange="renderDrafts()">
      <option value="newest">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="alpha">Aâ†’Z</option>
      <option value="pages">Most pages</option>
    </select>
  </div>

  <!-- Published toolbar -->
  <div class="toolbar" id="pub-toolbar" style="display:none;">
    <input class="search-box" id="pub-search" placeholder="ğŸ” Search published..." oninput="renderPublished()">
    <select class="tb" id="pub-sort" onchange="renderPublished()">
      <option value="newest">Newest</option>
      <option value="stars">Most Starred</option>
      <option value="alpha">Aâ†’Z</option>
    </select>
  </div>

  <!-- Drafts stats -->
  <div id="draft-stats" class="stats-bar" style="display:none;"></div>

  <!-- Published stats -->
  <div id="pub-stats" class="stats-bar" style="display:none;"></div>

  <!-- Grid container -->
  <div id="grid-container"></div>
</div>

<script>
const _sb = supabase.createClient('https://mmycqeejhguzhtzkyjaj.supabase.co','sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE');

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTab = 'drafts';
let drafts = [];
let published = [];
let myHandle = null, myName = null;
let pendingDeleteId = null, pendingDeleteType = null;
let renameTargetId = null;
let selectedRatio = { w: 9, h: 13, label: 'Comic', dims: '9:13' };

const RATIOS = [
  { w:9,  h:13, label:'Comic',     dims:'9:13',   icon:{ w:38, h:54 } },
  { w:1,  h:1,  label:'Square',    dims:'1:1',    icon:{ w:46, h:46 } },
  { w:9,  h:16, label:'Vertical',  dims:'9:16',   icon:{ w:36, h:62 } },
  { w:16, h:9,  label:'Wide',      dims:'16:9',   icon:{ w:64, h:36 } },
  { w:4,  h:3,  label:'Classic',   dims:'4:3',    icon:{ w:54, h:40 } },
  { w:3,  h:4,  label:'Portrait',  dims:'3:4',    icon:{ w:42, h:56 } },
];

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = async () => {
  const profile = JSON.parse(localStorage.getItem('user_profile') || '{}');
  myHandle = profile.handle || null;
  myName = profile.name || 'Creator';

  loadDrafts();
  await loadPublished();
  renderStats();
  renderDrafts();
  buildRatioGrid();
};

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDrafts() {
  drafts = JSON.parse(localStorage.getItem('comic_drafts') || '[]');
  document.getElementById('drafts-count').innerText = drafts.length;
}

async function loadPublished() {
  if (!myHandle) { published = []; document.getElementById('pub-count').innerText = 0; return; }
  const { data, error } = await _sb.from('comics').select('id,title,description,cover,tags,stars,data,canvas_ratio,created_at,owner_handle').eq('owner_handle', myHandle).order('id', { ascending: false });
  published = data || [];
  document.getElementById('pub-count').innerText = published.length;
  document.getElementById('topbar-sub').innerText = `${drafts.length} draft${drafts.length!==1?'s':''} Â· ${published.length} published`;
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats() {
  // Draft stats
  const totalPages = drafts.reduce((a, d) => a + (d.data?.length || 0), 0);
  const draftEl = document.getElementById('draft-stats');
  if (drafts.length) {
    draftEl.style.display = 'flex';
    draftEl.innerHTML = [
      { v: drafts.length, l: 'Drafts' },
      { v: totalPages,    l: 'Total Pages' },
      { v: drafts.reduce((a,d) => Math.max(a, d.data?.length||0), 0), l: 'Longest' },
    ].map(s => `<div class="stat-item"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
  } else { draftEl.style.display = 'none'; }

  // Published stats
  const totalStars = published.reduce((a, c) => a + (c.stars || 0), 0);
  const pubEl = document.getElementById('pub-stats');
  if (published.length) {
    pubEl.style.display = 'flex';
    pubEl.innerHTML = [
      { v: published.length, l: 'Published' },
      { v: totalStars, l: 'Total Stars' },
      { v: Math.max(...published.map(c => c.stars||0), 0), l: 'Top Stars' },
    ].map(s => `<div class="stat-item"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
  } else { pubEl.style.display = 'none'; }
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-drafts').classList.toggle('active', tab === 'drafts');
  document.getElementById('tab-published').classList.toggle('active', tab === 'published');
  document.getElementById('drafts-toolbar').style.display = tab === 'drafts' ? 'flex' : 'none';
  document.getElementById('pub-toolbar').style.display = tab === 'published' ? 'flex' : 'none';
  document.getElementById('draft-stats').style.display = (tab==='drafts'&&drafts.length) ? 'flex' : 'none';
  document.getElementById('pub-stats').style.display = (tab==='published'&&published.length) ? 'flex' : 'none';
  tab === 'drafts' ? renderDrafts() : renderPublished();
}

// â”€â”€ Render drafts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDrafts() {
  const q = document.getElementById('draft-search').value.toLowerCase();
  const sort = document.getElementById('draft-sort').value;
  let list = drafts.filter(d => !q || d.title?.toLowerCase().includes(q));

  if (sort === 'newest') list = [...list].reverse();
  else if (sort === 'oldest') {} // already chronological
  else if (sort === 'alpha') list = [...list].sort((a,b) => (a.title||'').localeCompare(b.title||''));
  else if (sort === 'pages') list = [...list].sort((a,b) => (b.data?.length||0) - (a.data?.length||0));

  const grid = document.getElementById('grid-container');
  if (!list.length) {
    grid.innerHTML = '';
    const empty = document.createElement('div');
    empty.className = 'empty';
    empty.innerHTML = `
      <div class="empty-icon">âœï¸</div>
      <div class="empty-title">${q ? 'No drafts found' : 'No drafts yet'}</div>
      <div class="empty-sub">${q ? 'Try a different search.' : 'Start building your first comic. Saved drafts appear here so you can come back and finish anytime.'}</div>
      ${!q ? `<button class="tb accent" onclick="openNew()">+ Create Your First Comic</button>` : ''}
    `;
    grid.appendChild(empty);
    return;
  }

  grid.innerHTML = '';
  const dg = document.createElement('div');
  dg.className = 'comics-grid';
  list.forEach(d => dg.appendChild(makeDraftCard(d)));
  grid.appendChild(dg);
}

function makeDraftCard(d) {
  const card = document.createElement('div');
  card.className = 'comic-card draft-card';

  const pageCount = d.data?.length || 0;
  const firstFrame = d.data?.[0];
  const thumbHtml = makeDraftThumb(firstFrame, d.ratio);

  card.innerHTML = `
    <div class="comic-thumb">
      ${thumbHtml}
      <div class="status-badge badge-draft">Draft</div>
      <div class="page-badge">${pageCount} page${pageCount!==1?'s':''}</div>
    </div>
    <div class="comic-info">
      <div class="comic-title">${escHtml(d.title || 'Untitled')}</div>
      <div class="comic-meta">Edited ${d.lastModified || 'recently'}</div>
    </div>
    <div class="card-actions">
      <button class="ca-btn ca-open" onclick="event.stopPropagation();resumeDraft(${d.id})">âœï¸ Resume</button>
      <button class="ca-btn ca-edit" onclick="event.stopPropagation();openRename(${d.id},'${escAttr(d.title||'Untitled')}')">Rename</button>
      <button class="ca-btn ca-del" onclick="event.stopPropagation();askDelete(${d.id},'draft','${escAttr(d.title||'Untitled')}')">Delete Draft</button>
    </div>
  `;
  card.onclick = () => resumeDraft(d.id);
  return card;
}

function makeDraftThumb(frame, ratio) {
  if (!frame) return `<div class="thumb-placeholder">ğŸ“„</div>`;
  const bg = frame.background || '#fff';
  const hasImage = frame.layers?.some(l => l.type === 'img' && l.src);
  if (hasImage) {
    const imgLayer = frame.layers.find(l => l.type === 'img' && l.src);
    return `<img src="${imgLayer.src}" style="object-fit:cover;" onerror="this.parentNode.innerHTML='<div class=\\'thumb-placeholder\\'>ğŸ“„</div>'">`;
  }
  const isGradient = typeof bg === 'string' && bg.includes('gradient');
  const isUrl = typeof bg === 'string' && (bg.startsWith('http') || bg.startsWith('data:'));
  let bgCss;
  if (isUrl) bgCss = `background:url('${bg}') center/cover`;
  else if (isGradient) bgCss = `background:${bg}`;
  else bgCss = `background:${bg}`;
  const textLayers = frame.layers?.filter(l => ['text','bubble','thinking','subtitle'].includes(l.type)) || [];
  const textPreview = textLayers.length ? `<div style="position:absolute;bottom:6px;left:6px;right:6px;font-size:7px;font-weight:700;color:rgba(0,0,0,.7);background:rgba(255,255,255,.8);padding:2px 5px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(textLayers[0].content?.slice(0,30)||'')}</div>` : '';
  return `<div style="width:100%;height:100%;${bgCss};">${textPreview}</div>`;
}

// â”€â”€ Render published â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPublished() {
  const q = document.getElementById('pub-search').value.toLowerCase();
  const sort = document.getElementById('pub-sort').value;
  let list = published.filter(c => !q || c.title?.toLowerCase().includes(q) || c.description?.toLowerCase().includes(q));

  if (sort === 'newest') {} // already sorted desc
  else if (sort === 'stars') list = [...list].sort((a,b) => (b.stars||0) - (a.stars||0));
  else if (sort === 'alpha') list = [...list].sort((a,b) => (a.title||'').localeCompare(b.title||''));

  const grid = document.getElementById('grid-container');
  if (!list.length) {
    grid.innerHTML = '';
    const empty = document.createElement('div');
    empty.className = 'empty';
    empty.innerHTML = `
      <div class="empty-icon">ğŸŒ</div>
      <div class="empty-title">${q ? 'No matches' : 'Nothing published yet'}</div>
      <div class="empty-sub">${q ? 'Try different search terms.' : 'When you publish a comic from the editor it appears here. Your fans can discover and star your work.'}</div>
      ${!q ? `<button class="tb accent" onclick="openNew()">Create & Publish</button>` : ''}
    `;
    grid.appendChild(empty);
    return;
  }

  grid.innerHTML = '';
  const dg = document.createElement('div');
  dg.className = 'comics-grid';
  list.forEach(c => dg.appendChild(makePublishedCard(c)));
  grid.appendChild(dg);
}

function makePublishedCard(c) {
  const card = document.createElement('div');
  card.className = 'comic-card pub-card';
  const pageCount = c.data?.length || 0;
  const stars = c.stars || 0;
  const thumbHtml = c.cover
    ? `<img src="${c.cover}" onerror="this.src='';this.parentNode.innerHTML='<div class=\\'thumb-placeholder\\'>ğŸ“–</div>'">`
    : `<div class="thumb-placeholder">ğŸ“–</div>`;

  card.innerHTML = `
    <div class="comic-thumb">
      ${thumbHtml}
      <div class="status-badge badge-pub">Live</div>
      <div class="page-badge">${pageCount}p</div>
    </div>
    <div class="comic-info">
      <div class="comic-title">${escHtml(c.title || 'Untitled')}</div>
      <div class="comic-stars">â­ ${stars} star${stars!==1?'s':''}</div>
      ${c.description ? `<div class="comic-meta">${escHtml(c.description.slice(0,50))}${c.description.length>50?'â€¦':''}</div>` : ''}
    </div>
    <div class="card-actions">
      <button class="ca-btn ca-read" onclick="event.stopPropagation();readComic('${c.id}')">ğŸ“– Read</button>
      <button class="ca-btn ca-edit" onclick="event.stopPropagation();editPublished('${c.id}')">âœï¸ Edit</button>
      <button class="ca-btn ca-del" onclick="event.stopPropagation();askDelete('${c.id}','published','${escAttr(c.title||'Untitled')}')">Delete</button>
    </div>
  `;
  card.onclick = () => readComic(c.id);
  return card;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resumeDraft(id) {
  localStorage.removeItem('edit_comic_id');
  localStorage.setItem('active_draft_id', id);
  location.href = 'create.html';
}

function editPublished(id) {
  localStorage.removeItem('active_draft_id');
  localStorage.setItem('edit_comic_id', id);
  location.href = 'create.html';
}

function readComic(id) {
  location.href = `reader.html?id=${id}`;
}

// â”€â”€ Delete flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function askDelete(id, type, title) {
  pendingDeleteId = id;
  pendingDeleteType = type;
  document.getElementById('del-sub').innerText = `"${title}" will be permanently deleted${type==='published'?' and removed from the discover feed':' from your device'}. This can't be undone.`;
  document.getElementById('del-sheet').style.display = 'flex';
}
function closeDel() { document.getElementById('del-sheet').style.display = 'none'; pendingDeleteId = null; }
async function confirmDelete() {
  closeDel();
  if (pendingDeleteType === 'draft') {
    drafts = drafts.filter(d => d.id != pendingDeleteId);
    localStorage.setItem('comic_drafts', JSON.stringify(drafts));
    document.getElementById('drafts-count').innerText = drafts.length;
    renderStats(); renderDrafts();
    toast('ğŸ—‘ Draft deleted');
  } else {
    const { error } = await _sb.from('comics').delete().eq('id', pendingDeleteId);
    if (error) { toast('âš  Could not delete: ' + error.message, 'var(--danger)'); return; }
    published = published.filter(c => c.id != pendingDeleteId);
    document.getElementById('pub-count').innerText = published.length;
    renderStats(); renderPublished();
    toast('ğŸ—‘ Comic unpublished & deleted');
  }
}

// â”€â”€ Rename flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRename(id, currentTitle) {
  renameTargetId = id;
  document.getElementById('rename-inp').value = currentTitle;
  document.getElementById('rename-sheet').style.display = 'flex';
  setTimeout(() => document.getElementById('rename-inp').focus(), 100);
}
function closeRename() { document.getElementById('rename-sheet').style.display = 'none'; }
function confirmRename() {
  const newTitle = document.getElementById('rename-inp').value.trim();
  if (!newTitle) return;
  closeRename();
  const idx = drafts.findIndex(d => d.id == renameTargetId);
  if (idx >= 0) {
    drafts[idx].title = newTitle;
    localStorage.setItem('comic_drafts', JSON.stringify(drafts));
    renderDrafts();
    toast('âœ… Renamed!');
  }
}

// â”€â”€ New comic flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNew() {
  document.getElementById('new-sheet').style.display = 'flex';
}
function closeNew() { document.getElementById('new-sheet').style.display = 'none'; }

function buildRatioGrid() {
  const grid = document.getElementById('ratio-grid');
  grid.innerHTML = '';
  RATIOS.forEach((r, i) => {
    const opt = document.createElement('div');
    opt.className = 'ratio-opt' + (i === 0 ? ' sel' : '');
    opt.innerHTML = `
      <div class="ratio-preview" style="width:${r.icon.w}px;height:${r.icon.h}px;"></div>
      <div class="ratio-name">${r.label}</div>
      <div class="ratio-dims">${r.dims}</div>
    `;
    opt.onclick = () => {
      document.querySelectorAll('.ratio-opt').forEach(o => o.classList.remove('sel'));
      opt.classList.add('sel');
      selectedRatio = r;
    };
    grid.appendChild(opt);
  });
  selectedRatio = RATIOS[0];
}

function startNewComic() {
  closeNew();
  localStorage.removeItem('active_draft_id');
  localStorage.removeItem('edit_comic_id');
  localStorage.removeItem('cc-pending-frames');
  localStorage.setItem('cc-new-comic-ratio', JSON.stringify({ w: selectedRatio.w, h: selectedRatio.h }));
  location.href = 'create.html';
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return String(s).replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

function toast(msg, col = 'var(--green)') {
  const t = document.createElement('div');
  t.className = 'toast-el';
  t.style.background = col; t.style.color = '#000';
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; }, 2000);
  setTimeout(() => t.remove(), 2500);
}
</script>
</body>
</html>