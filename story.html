<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore - Story Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Source+Serif+4:ital,wght@0,400;0,700;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Nunito:wght@400;600;700&family=Georgia&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* ‚îÄ‚îÄ Top Toolbar ‚îÄ‚îÄ */
        .toolbar-top {
            height: 56px; background: var(--card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 14px; gap: 8px; flex-shrink: 0; z-index: 100;
        }
        .nav-btn {
            background: #2c2c2e; border: 1px solid var(--border); color: var(--text);
            padding: 7px 14px; border-radius: 8px; cursor: pointer;
            font-size: 12px; font-weight: 700; transition: 0.2s; white-space: nowrap;
        }
        .nav-btn:hover { background: #3a3a3c; }

        /* ‚îÄ‚îÄ Format Toolbar ‚îÄ‚îÄ */
        .toolbar-format {
            background: var(--card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 4px; padding: 6px 14px;
            flex-wrap: wrap; flex-shrink: 0;
        }
        .fmt-btn {
            background: #2a2a2a; border: 1px solid #444; color: var(--text);
            border-radius: 7px; padding: 5px 10px; cursor: pointer;
            font-size: 13px; font-weight: 700; transition: 0.15s;
            min-width: 32px; text-align: center;
        }
        .fmt-btn:hover { background: #3a3a3a; }
        .fmt-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .fmt-divider { width: 1px; height: 22px; background: #333; margin: 0 4px; }
        .fmt-select {
            background: #2a2a2a; border: 1px solid #444; color: var(--text);
            border-radius: 7px; padding: 5px 8px; font-size: 12px; outline: none; cursor: pointer;
        }
        .fmt-size-group { display: flex; align-items: center; gap: 3px; }
        .fmt-size-num {
            background: #1a1a1a; border: 1px solid #444; color: var(--text);
            border-radius: 6px; width: 34px; text-align: center; padding: 4px 2px;
            font-size: 12px; font-weight: 700;
        }

        /* ‚îÄ‚îÄ Writing Area ‚îÄ‚îÄ */
        #writing-area-wrap {
            flex: 1; overflow-y: auto; background: #0a0a0a;
            display: flex; flex-direction: column; align-items: center;
            padding: 40px 20px 0;
        }
        #pages-container {
            width: 100%; max-width: 760px;
            display: flex; flex-direction: column; gap: 0;
        }
        .story-page,
        .story-page *,
        [data-theme] .story-page,
        [data-theme] .story-page * {
            color: #111 !important;
            -webkit-text-fill-color: #111 !important;
        }
        .story-page {
            width: 100%; background: #fff !important; color: #111 !important;
            padding: 60px 70px;
            box-shadow: 0 4px 40px rgba(0,0,0,0.5);
            outline: none; font-size: 18px; line-height: 1.8;
            font-family: 'Merriweather', Georgia, serif;
            caret-color: #ff6600;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 900px;
            position: relative;
            box-sizing: border-box;
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: none;
        }
        @media (max-width: 600px) {
            .story-page { padding: 40px 24px; min-height: 600px; font-size: 16px; }
            #writing-area-wrap { padding: 20px 8px 0; }
            .toolbar-format { gap: 4px; padding: 6px 8px; }
            .fmt-btn { padding: 5px 7px; font-size: 12px; }
        }
        .story-page:first-child { border-radius: 4px 4px 0 0; }
        .story-page:last-child  { border-radius: 0 0 4px 4px; margin-bottom: 0; }
        .story-page:only-child  { border-radius: 4px; }
        .story-page:not(:last-child) { border-bottom: 2px dashed #ddd; }
        .story-page.is-empty::before {
            content: attr(data-placeholder);
            color: #bbb; pointer-events: none;
            position: absolute; top: 60px; left: 70px;
        }
        .page-label {
            position: absolute; bottom: 12px; right: 20px;
            font-size: 11px; color: #ccc; font-family: 'Inter',sans-serif;
            pointer-events: none; user-select: none;
        }
        .page-delete-btn {
            position: absolute; top: 14px; right: 16px;
            background: none; border: none; color: #ddd; font-size: 16px;
            cursor: pointer; padding: 4px 8px; border-radius: 6px;
            opacity: 0; transition: 0.2s; pointer-events: all;
        }
        .story-page:hover .page-delete-btn { opacity: 1; }
        .page-delete-btn:hover { background: #ffe0e0; color: #cc0000; }

        /* ‚îÄ‚îÄ Word Count Bar ‚îÄ‚îÄ */
        .status-bar {
            height: 30px; background: var(--card); border-top: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 16px; gap: 20px;
            font-size: 11px; color: var(--secondary); font-weight: 600; flex-shrink: 0;
        }
        .status-bar span { color: var(--text); font-weight: 800; }

        /* ‚îÄ‚îÄ Overlays ‚îÄ‚îÄ */
        .overlay-full {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            padding: 20px; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--card); padding: 28px; border-radius: 20px;
            width: 100%; max-width: 420px; border: 1px solid var(--border);
        }
        .pub-input {
            width: 100%; padding: 12px; background: #111; border: 1px solid #333;
            color: white; border-radius: 10px; margin-bottom: 12px;
            box-sizing: border-box; font-family: inherit; font-size: 14px;
        }
        .pub-input:focus { outline: none; border-color: var(--accent); }

        /* ‚îÄ‚îÄ Export Modal tabs ‚îÄ‚îÄ */
        .export-tab-row { display: flex; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 18px; }
        .export-tab { flex: 1; padding: 10px; text-align: center; font-weight: 800; font-size: 13px; cursor: pointer; background: #1a1a1a; color: #666; border: none; transition: 0.2s; }
        .export-tab.active { background: var(--teal); color: #000; }
        .export-section { display: none; flex-direction: column; gap: 12px; }
        .export-section.active { display: flex; }

        /* ‚îÄ‚îÄ Drafts Modal ‚îÄ‚îÄ */
        #drafts-modal {
            display: none; position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);
            align-items: flex-end; justify-content: center;
        }
        #drafts-modal.open { display: flex; }
        #drafts-panel {
            background: #1a1a1a; border: 1px solid #2c2c2e;
            border-radius: 20px 20px 0 0;
            width: 100%; max-width: 600px; max-height: 75dvh;
            display: flex; flex-direction: column;
            animation: draftsUp .3s cubic-bezier(.4,0,.2,1);
            overflow: hidden;
        }
        @keyframes draftsUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        #drafts-panel-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 18px 20px 14px; border-bottom: 1px solid #2c2c2e; flex-shrink: 0;
        }
        #drafts-panel-head h2 { margin: 0; font-size: 16px; font-weight: 900; color: #fff; }
        #drafts-panel-head button { background: none; border: none; color: #555; font-size: 22px; cursor: pointer; padding: 0; }
        #drafts-list {
            flex: 1; overflow-y: auto; padding: 10px 16px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .sdraft-item {
            display: flex; align-items: center; gap: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 12px 14px; cursor: pointer; transition: background 0.15s;
        }
        .sdraft-item:hover, .sdraft-item:active { background: rgba(255,255,255,0.1); }
        .sdraft-icon { font-size: 28px; flex-shrink: 0; }
        .sdraft-info { flex: 1; min-width: 0; }
        .sdraft-title { font-size: 14px; font-weight: 800; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sdraft-meta { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 3px; font-weight: 600; }
        .sdraft-del {
            background: none; border: none; color: rgba(255,255,255,0.25);
            font-size: 18px; cursor: pointer; padding: 4px 6px; flex-shrink: 0;
            transition: color 0.15s; line-height: 1;
        }
        .sdraft-del:hover { color: #ff453a; }
        .sdraft-new {
            width: 100%; padding: 13px; background: rgba(255,255,255,0.06);
            border: 1px dashed rgba(255,255,255,0.18); border-radius: 12px;
            color: rgba(255,255,255,0.6); font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: inherit; transition: background 0.15s;
        }
        .sdraft-new:hover { background: rgba(255,255,255,0.11); }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Publish Modal ‚îÄ‚îÄ -->
<div id="publish-modal" class="overlay-full">
    <div class="modal-content">
        <h2 style="margin-top:0; color:var(--accent);">Publish Story</h2>
        <div id="cover-box" style="width:100%; aspect-ratio:2/3; max-height:200px; background:#111; border:2px dashed #444; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; margin-bottom:14px;" onclick="document.getElementById('cover-input').click()">
            <img id="cover-img" style="width:100%; height:100%; object-fit:cover; display:none;">
            <span id="cover-label" style="color:#555; font-size:13px;">Click to upload cover</span>
        </div>
        <input type="file" id="cover-input" accept="image/*" style="display:none;" onchange="handleCover(this)">
        <input type="text"     id="pub-title" class="pub-input" placeholder="Story Title">
        <input type="text"     id="pub-tags"  class="pub-input" placeholder="Tags (e.g. romance, sci-fi, fantasy)">
        <textarea              id="pub-desc"  class="pub-input" placeholder="Brief description..." style="height:80px; resize:none;"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="closePublish()" style="flex:1; padding:13px; background:#333; color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">Cancel</button>
            <button id="pub-btn" onclick="finalPublish()" style="flex:2; padding:13px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:900; cursor:pointer;">PUBLISH</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Export Modal ‚îÄ‚îÄ -->
<div id="export-modal" class="overlay-full">
    <div class="modal-content">
        <h2 style="margin-top:0; color:var(--teal);">Export Story</h2>
        <div class="export-tab-row">
            <button class="export-tab active" onclick="switchExportTab('txt')">üìÑ TXT</button>
            <button class="export-tab"        onclick="switchExportTab('pdf')">üìë PDF</button>
        </div>
        <div id="export-txt" class="export-section active">
            <p style="font-size:13px; color:var(--secondary); margin:0;">Exports your story as a plain .txt file. Clean, simple, universally readable.</p>
            <button onclick="doExportTxt()" style="background:var(--teal); color:#000; border:none; padding:13px; border-radius:12px; font-weight:900; cursor:pointer;">SAVE AS TXT</button>
        </div>
        <div id="export-pdf" class="export-section">
            <p style="font-size:13px; color:var(--secondary); margin:0;">Exports your story as a formatted PDF with your title, font, and layout preserved.</p>
            <button onclick="doExportPdf()" style="background:var(--teal); color:#000; border:none; padding:13px; border-radius:12px; font-weight:900; cursor:pointer;">SAVE AS PDF</button>
        </div>
        <button onclick="document.getElementById('export-modal').style.display='none'" style="width:100%; margin-top:10px; padding:12px; background:#222; color:#aaa; border:none; border-radius:12px; font-weight:700; cursor:pointer;">Cancel</button>
    </div>
</div>

<!-- ‚îÄ‚îÄ Top Toolbar ‚îÄ‚îÄ -->
<div class="toolbar-top">
    <div style="display:flex; gap:8px;">
        <button class="nav-btn" onclick="handleExit()">üè† EXIT</button>
        <button class="nav-btn" onclick="undo()" title="Undo">‚Ü©Ô∏è</button>
        <button class="nav-btn" onclick="redo()" title="Redo">‚Ü™Ô∏è</button>
    </div>
    <div style="font-size:13px; font-weight:900; color:var(--accent); letter-spacing:1px;">STORY EDITOR</div>
    <div style="display:flex; gap:8px;">
        <button class="nav-btn" onclick="saveDraft()" style="color:var(--teal); border-color:var(--teal);">üíæ SAVE</button>
        <button class="nav-btn" onclick="openDraftsModal()" style="color:var(--teal); border-color:var(--teal);">üìÇ DRAFTS</button>
        <button class="nav-btn" onclick="document.getElementById('export-modal').style.display='flex'" style="color:var(--teal); border-color:var(--teal);">EXPORT</button>
        <button onclick="openPublish()" style="color:var(--accent); background:none; border:none; font-weight:900; cursor:pointer; font-size:14px;">PUBLISH</button>
    </div>
</div>

<!-- ‚îÄ‚îÄ Format Toolbar ‚îÄ‚îÄ -->
<div class="toolbar-format">
    <!-- Bold, Italic, Underline -->
    <button class="fmt-btn" id="btn-bold"      onmousedown="event.preventDefault()" onclick="fmt('bold')"          title="Bold"><b>B</b></button>
    <button class="fmt-btn" id="btn-italic"    onmousedown="event.preventDefault()" onclick="fmt('italic')"        title="Italic"><i>I</i></button>
    <button class="fmt-btn" id="btn-underline" onmousedown="event.preventDefault()" onclick="fmt('underline')"     title="Underline"><u>U</u></button>
    <div class="fmt-divider"></div>
    <!-- Font size -->
    <div class="fmt-size-group">
        <button class="fmt-btn" onmousedown="event.preventDefault()" onclick="changeFontSize(-2)">‚àí</button>
        <div class="fmt-size-num" id="size-display">18</div>
        <button class="fmt-btn" onmousedown="event.preventDefault()" onclick="changeFontSize(+2)">+</button>
    </div>
    <div class="fmt-divider"></div>
    <!-- Font family -->
    <select class="fmt-select" id="font-select" onchange="applyFont(this.value)">
        <option value="'Merriweather', Georgia, serif">Merriweather</option>
        <option value="'Lora', Georgia, serif">Lora</option>
        <option value="'Playfair Display', Georgia, serif">Playfair</option>
        <option value="'Crimson Text', Georgia, serif">Crimson</option>
        <option value="'EB Garamond', Georgia, serif">Garamond</option>
        <option value="'Libre Baskerville', Georgia, serif">Baskerville</option>
        <option value="'Source Serif 4', Georgia, serif">Source Serif</option>
        <option value="'Nunito', sans-serif">Nunito</option>
        <option value="'Inter', sans-serif">Inter</option>
        <option value="monospace">Monospace</option>
    </select>
    <div class="fmt-divider"></div>
    <!-- Alignment -->
    <button class="fmt-btn" id="btn-left"    onmousedown="event.preventDefault()" onclick="fmt('justifyLeft')"   title="Left">‚â°L</button>
    <button class="fmt-btn" id="btn-center"  onmousedown="event.preventDefault()" onclick="fmt('justifyCenter')" title="Center">‚â°C</button>
    <button class="fmt-btn" id="btn-right"   onmousedown="event.preventDefault()" onclick="fmt('justifyRight')"  title="Right">‚â°R</button>
    <button class="fmt-btn" id="btn-justify" onmousedown="event.preventDefault()" onclick="fmt('justifyFull')"   title="Justify">‚â°J</button>
    <div class="fmt-divider"></div>
    <!-- Heading styles -->
    <select class="fmt-select" id="heading-select" onchange="applyHeading(this.value)">
        <option value="p">Paragraph</option>
        <option value="h1">Heading 1</option>
        <option value="h2">Heading 2</option>
        <option value="h3">Heading 3</option>
    </select>
    <div class="fmt-divider"></div>
    <!-- Line spacing -->
    <select class="fmt-select" id="spacing-select" onchange="applySpacing(this.value)" title="Line spacing">
        <option value="1.4">Tight</option>
        <option value="1.8" selected>Normal</option>
        <option value="2.2">Relaxed</option>
        <option value="2.8">Double</option>
    </select>
</div>

<!-- ‚îÄ‚îÄ Writing Canvas ‚îÄ‚îÄ -->
<div id="writing-area-wrap">
    <div id="pages-container"></div>
    <div style="display:flex; justify-content:center; padding:20px 0 40px;">
        <button onclick="addPage()" style="
            background:#1a1a1a; border:2px dashed #444; color:#666;
            padding:12px 36px; border-radius:12px; cursor:pointer;
            font-size:13px; font-weight:700; transition:0.2s;
            font-family:'Inter',sans-serif;
        " onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'"
           onmouseout="this.style.borderColor='#444';this.style.color='#666'">
            + ADD PAGE
        </button>
    </div>
</div>

<!-- ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ -->
<div class="status-bar">
    <div>Words: <span id="word-count">0</span></div>
    <div>Characters: <span id="char-count">0</span></div>
    <div>Pages: <span id="page-count">1</span></div>
    <div>Read time: <span id="read-time">0 min</span></div>
    <div style="margin-left:auto; color:var(--secondary);" id="save-status">Unsaved</div>
</div>

<!-- ‚îÄ‚îÄ Drafts Modal ‚îÄ‚îÄ -->
<div id="drafts-modal" onclick="if(event.target===this)closeDraftsModal()">
    <div id="drafts-panel">
        <div id="drafts-panel-head">
            <h2>üìÇ Story Drafts</h2>
            <button onclick="closeDraftsModal()">‚úï</button>
        </div>
        <div id="drafts-list"></div>
        <div style="padding:0 16px 14px;">
            <button class="sdraft-new" onclick="startNewStory()">+ New Story</button>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://mmycqeejhguzhtzkyjaj.supabase.co', 'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE');
    const myProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');

    let activeDraftId = null;
    let hasUnsaved = false;
    let coverBase64 = null;
    let currentFontSize = 18;
    let currentFont = "'Merriweather', Georgia, serif";
    let activePage = null; // currently focused page element

    // ‚îÄ‚îÄ Page Management ‚îÄ‚îÄ
    function createPage(content, pageNum) {
        const page = document.createElement('div');
        page.className = 'story-page';
        page.contentEditable = 'true';
        page.spellcheck = true;
        page.setAttribute('data-placeholder', pageNum === 1 ? 'Start writing your story...' : 'Continue your story...');
        page.innerHTML = content || '';
        page.style.fontFamily = currentFont;
        page.style.fontSize = currentFontSize + 'px';

        const label = document.createElement('div');
        label.className = 'page-label';
        label.innerText = 'Page ' + pageNum;

        const delBtn = document.createElement('button');
        delBtn.className = 'page-delete-btn';
        delBtn.title = 'Delete page';
        delBtn.innerHTML = '‚úï';
        delBtn.onclick = () => deletePage(page);

        page.appendChild(label);
        page.appendChild(delBtn);

        page.addEventListener('focus',  () => { activePage = page; updateToolbarState(); });
        page.addEventListener('keyup',  () => { saveSelection(); updateStats(); hasUnsaved = true; updatePageNumbers(); updatePlaceholder(page); });
        page.addEventListener('input',  () => updatePlaceholder(page));
        page.addEventListener('mouseup',() => { saveSelection(); updateToolbarState(); });
        page.addEventListener('touchend', () => { saveSelection(); updateToolbarState(); });
        page.addEventListener('keydown', handleKeyDown);
        // Mobile tap: ensure contenteditable gets focus and keyboard opens
        page.addEventListener('touchstart', function(e) {
            if (e.target === page || e.target.classList.contains('story-page')) {
                setTimeout(() => { activePage = page; page.focus(); }, 50);
            }
        }, { passive: true });

        return page;
    }

    function addPage(content) {
        const container = document.getElementById('pages-container');
        const pageNum = container.children.length + 1;
        const page = createPage(content || '', pageNum);
        container.appendChild(page);
        updatePageNumbers();
        updatePlaceholder(page);
        // Focus new page
        setTimeout(() => { page.focus(); scrollToPage(page); updatePlaceholder(page); }, 50);
        return page;
    }

    function deletePage(page) {
        const container = document.getElementById('pages-container');
        if (container.children.length <= 1) return; // keep at least 1 page
        if (!confirm('Delete this page?')) return;
        page.remove();
        updatePageNumbers();
        updateStats();
    }

    function updatePageNumbers() {
        const pages = document.querySelectorAll('.story-page');
        pages.forEach((p, i) => {
            const label = p.querySelector('.page-label');
            if (label) label.innerText = 'Page ' + (i + 1);
        });
    }

    function scrollToPage(page) {
        page.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function getAllPages() {
        return Array.from(document.querySelectorAll('.story-page'));
    }

    function getAllText() {
        return getAllPages().map(p => p.innerText).join('\n\n');
    }

    function getAllHTML() {
        return getAllPages().map((p, i) => {
            // Clone without the label/delete button for clean HTML
            const clone = p.cloneNode(true);
            clone.querySelectorAll('.page-label, .page-delete-btn').forEach(el => el.remove());
            return clone.innerHTML;
        }).join('<hr class="page-break">');
    }

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    window.onload = function() {
        const resumeId = localStorage.getItem('active_story_draft_id');
        if (resumeId) {
            const drafts = JSON.parse(localStorage.getItem('story_drafts') || '[]');
            const found = drafts.find(d => d.id == resumeId);
            if (found) {
                activeDraftId = resumeId;
                document.getElementById('pub-title').value = found.title || '';
                if (found.fontSize) { currentFontSize = found.fontSize; document.getElementById('size-display').innerText = currentFontSize; }
                if (found.font)     { currentFont = found.font; document.getElementById('font-select').value = currentFont; }
                // Restore pages
                const pages = found.pages || [found.content || ''];
                pages.forEach((html, i) => addPage(html));
                document.getElementById('save-status').innerText = 'Draft loaded';
                updateStats();
                return;
            }
        }
        // New story ‚Äî start with one blank page
        addPage('');
    };

    // ‚îÄ‚îÄ Selection save/restore (keeps cursor in place when toolbar buttons are clicked) ‚îÄ‚îÄ
    let _savedRange = null;

    function saveSelection() {
        var sel = window.getSelection();
        if (sel && sel.rangeCount > 0) {
            _savedRange = sel.getRangeAt(0).cloneRange();
        }
    }

    function restoreSelection() {
        if (!_savedRange) {
            if (activePage) activePage.focus();
            return;
        }
        if (activePage) activePage.focus();
        var sel = window.getSelection();
        if (sel) {
            sel.removeAllRanges();
            sel.addRange(_savedRange);
        }
    }

    // ‚îÄ‚îÄ Formatting ‚îÄ‚îÄ
    function fmt(cmd) {
        restoreSelection();
        document.execCommand(cmd, false, null);
        saveSelection();
        updateToolbarState();
    }

    function changeFontSize(delta) {
        currentFontSize = Math.min(Math.max(currentFontSize + delta, 10), 72);
        document.getElementById('size-display').innerText = currentFontSize;
        getAllPages().forEach(p => p.style.fontSize = currentFontSize + 'px');
        hasUnsaved = true;
        restoreSelection();
    }

    function applyFont(font) {
        currentFont = font;
        getAllPages().forEach(p => p.style.fontFamily = font);
        hasUnsaved = true;
        restoreSelection();
    }

    function applyHeading(tag) {
        restoreSelection();
        document.execCommand('formatBlock', false, tag);
        saveSelection();
    }

    function applySpacing(val) {
        getAllPages().forEach(p => p.style.lineHeight = val);
        restoreSelection();
    }

    function updateToolbarState() {
        document.getElementById('btn-bold').classList.toggle('active',      document.queryCommandState('bold'));
        document.getElementById('btn-italic').classList.toggle('active',    document.queryCommandState('italic'));
        document.getElementById('btn-underline').classList.toggle('active', document.queryCommandState('underline'));
    }

    function handleKeyDown(e) {
        hasUnsaved = true;
        if (e.key === 'Tab') {
            e.preventDefault();
            document.execCommand('insertHTML', false, '&emsp;&emsp;');
        }
    }

    // ‚îÄ‚îÄ Placeholder helper ‚îÄ‚îÄ
    function updatePlaceholder(page) {
        var text = page.innerText.replace(/[\s\u200B]/g, '');
        page.classList.toggle('is-empty', text.length === 0);
    }

    // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
    function updateStats() {
        const text  = getAllText();
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const chars = text.length;
        const mins  = Math.max(1, Math.ceil(words / 200));
        const pages = getAllPages().length;
        document.getElementById('word-count').innerText  = words.toLocaleString();
        document.getElementById('char-count').innerText  = chars.toLocaleString();
        document.getElementById('read-time').innerText   = mins + ' min';
        document.getElementById('page-count').innerText  = pages;
        document.getElementById('save-status').innerText = 'Unsaved changes';
    }

    // ‚îÄ‚îÄ Undo/Redo ‚îÄ‚îÄ
    function undo() { document.execCommand('undo'); }
    function redo() { document.execCommand('redo'); }

    // ‚îÄ‚îÄ Save Draft ‚îÄ‚îÄ
    function saveDraft() {
        let drafts = JSON.parse(localStorage.getItem('story_drafts') || '[]');
        let title = document.getElementById('pub-title').value;
        if (!title) {
            title = prompt('Story name:', 'My Story') || 'Untitled Story';
            document.getElementById('pub-title').value = title;
        }

        const draftData = {
            pages: getAllPages().map(p => {
                const clone = p.cloneNode(true);
                clone.querySelectorAll('.page-label,.page-delete-btn').forEach(el => el.remove());
                return clone.innerHTML;
            }),
            title,
            fontSize: currentFontSize,
            font: currentFont,
            updated: Date.now(),
            lastModified: new Date().toLocaleString()
        };

        if (activeDraftId) {
            const idx = drafts.findIndex(d => d.id == activeDraftId);
            if (idx !== -1) { Object.assign(drafts[idx], draftData); }
            else { draftData.id = activeDraftId; drafts.push(draftData); }
        } else {
            draftData.id = Date.now();
            activeDraftId = draftData.id;
            drafts.push(draftData);
        }

        localStorage.setItem('story_drafts', JSON.stringify(drafts));
        localStorage.setItem('active_story_draft_id', activeDraftId);
        hasUnsaved = false;
        document.getElementById('save-status').innerText = 'Saved ‚úì';
    }

    // ‚îÄ‚îÄ Publish ‚îÄ‚îÄ
    function openPublish() { document.getElementById('publish-modal').style.display = 'flex'; }
    function closePublish() { document.getElementById('publish-modal').style.display = 'none'; }

    function handleCover(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            coverBase64 = e.target.result;
            document.getElementById('cover-img').src = coverBase64;
            document.getElementById('cover-img').style.display = 'block';
            document.getElementById('cover-label').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    async function finalPublish() {
        const title = document.getElementById('pub-title').value.trim();
        const tags  = document.getElementById('pub-tags').value.split(',').map(t => t.trim()).filter(Boolean);
        const desc  = document.getElementById('pub-desc').value.trim();
        if (!title) return alert('Please add a title!');

        const btn = document.getElementById('pub-btn');
        btn.innerText = 'Publishing...'; btn.disabled = true;

        const plainText = getAllText();
        const htmlContent = getAllHTML();
        const pageCount = getAllPages().length;

        const { error } = await _supabase.from('stories').insert([{
            title,
            description: desc,
            tags,
            cover: coverBase64 || null,
            content_html: htmlContent,
            content_text: plainText,
            word_count: plainText.trim() ? plainText.trim().split(/\s+/).length : 0,
            page_count: pageCount,
            owner_name: myProfile.name || 'Author',
            owner_handle: myProfile.handle || 'user',
            font: currentFont,
            font_size: currentFontSize,
        }]);

        if (error) {
            alert('Error: ' + error.message);
            btn.innerText = 'PUBLISH'; btn.disabled = false;
        } else {
            hasUnsaved = false;
            alert('Story published!');
            location.href = 'discover.html';
        }
    }

    // ‚îÄ‚îÄ Export ‚îÄ‚îÄ
    function switchExportTab(tab) {
        document.querySelectorAll('.export-tab').forEach((t, i) => t.classList.toggle('active', (i === 0) === (tab === 'txt')));
        document.getElementById('export-txt').classList.toggle('active', tab === 'txt');
        document.getElementById('export-pdf').classList.toggle('active', tab === 'pdf');
    }

    function doExportTxt() {
        const title = document.getElementById('pub-title').value || 'My Story';
        const text  = getAllText();
        const blob  = new Blob([title + '\n' + '='.repeat(title.length) + '\n\n' + text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = title.replace(/\s+/g, '-').toLowerCase() + '.txt';
        a.click();
    }

    function doExportPdf() {
        const title = document.getElementById('pub-title').value || 'My Story';
        const win = window.open('', '_blank');
        const pdfHtml = [
            '<!DOCTYPE html><html><head>',
            '<title>' + title + '</title>',
            '<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">',
            '<style>',
            'body{font-family:' + currentFont + ';font-size:' + currentFontSize + 'px;line-height:1.8;max-width:700px;margin:60px auto;padding:0 40px;color:#111;}',
            'h1{font-size:2em;margin-bottom:8px;}',
            '.meta{color:#888;font-size:13px;margin-bottom:40px;border-bottom:1px solid #ddd;padding-bottom:16px;}',
            'hr.page-break{border:none;page-break-after:always;margin:40px 0;border-top:1px dashed #ddd;}',
            '@media print{body{margin:0;}hr.page-break{page-break-after:always;}}',
            '</style></head><body>',
            '<h1>' + title + '</h1>',
            '<div class="meta">by ' + (myProfile.name || 'Author') + ' ¬∑ ComicCore</div>',
            getAllHTML(),
            '<scr' + 'ipt>window.onload=function(){window.print();}</scr' + 'ipt>',
            '</body></html>'
        ].join('\n');
        win.document.write(pdfHtml);
        win.document.close();
    }

    // ‚îÄ‚îÄ Drafts Modal ‚îÄ‚îÄ
    function openDraftsModal() {
        let drafts = [];
        try { drafts = JSON.parse(localStorage.getItem('story_drafts') || '[]'); } catch(e) {}
        drafts.sort((a, b) => (b.updated || b.lastModified || 0) - (a.updated || a.lastModified || 0));
        const list = document.getElementById('drafts-list');

        if (!drafts.length) {
            list.innerHTML = '<div style="color:#444;font-size:13px;text-align:center;padding:30px 0;">No drafts saved yet.</div>';
        } else {
            list.innerHTML = '';
            drafts.forEach(draft => {
                const item = document.createElement('div');
                item.className = 'sdraft-item';
                const isCurrent = String(draft.id) === String(activeDraftId);
                const pageCount = (draft.pages || [draft.content]).filter(Boolean).length || 1;
                const wordEst = draft.pages
                    ? draft.pages.map(p => { const tmp = document.createElement('div'); tmp.innerHTML = p; return tmp.innerText; }).join(' ').trim().split(/\s+/).filter(Boolean).length
                    : 0;
                const dateStr = draft.lastModified || (draft.updated ? new Date(draft.updated).toLocaleDateString() : '');
                item.innerHTML = `
                    <div class="sdraft-icon">üìÑ</div>
                    <div class="sdraft-info">
                        <div class="sdraft-title">${isCurrent ? '‚ñ∂ ' : ''}${draft.title || 'Untitled Story'}</div>
                        <div class="sdraft-meta">${pageCount} page${pageCount !== 1 ? 's' : ''} ¬∑ ~${wordEst} words ¬∑ ${dateStr}</div>
                    </div>
                    <button class="sdraft-del" title="Delete draft" onclick="event.stopPropagation(); deleteDraft('${draft.id}')">üóë</button>
                `;
                item.addEventListener('click', () => loadDraft(draft.id));
                list.appendChild(item);
            });
        }
        document.getElementById('drafts-modal').classList.add('open');
    }

    function closeDraftsModal() {
        document.getElementById('drafts-modal').classList.remove('open');
    }

    function deleteDraft(id) {
        if (!confirm('Delete this draft?')) return;
        let drafts = JSON.parse(localStorage.getItem('story_drafts') || '[]');
        drafts = drafts.filter(d => String(d.id) !== String(id));
        localStorage.setItem('story_drafts', JSON.stringify(drafts));
        if (String(id) === String(activeDraftId)) {
            activeDraftId = null;
            localStorage.removeItem('active_story_draft_id');
        }
        openDraftsModal(); // refresh
    }

    function loadDraft(id) {
        if (String(id) === String(activeDraftId)) { closeDraftsModal(); return; }
        if (hasUnsaved && !confirm('You have unsaved changes. Switch drafts anyway?')) return;
        const drafts = JSON.parse(localStorage.getItem('story_drafts') || '[]');
        const draft = drafts.find(d => String(d.id) === String(id));
        if (!draft) return;
        // Clear pages
        const container = document.getElementById('pages-container');
        container.innerHTML = '';
        // Restore state
        activeDraftId = draft.id;
        localStorage.setItem('active_story_draft_id', String(draft.id));
        document.getElementById('pub-title').value = draft.title || '';
        if (draft.fontSize) { currentFontSize = draft.fontSize; document.getElementById('size-display').innerText = currentFontSize; }
        if (draft.font) { currentFont = draft.font; document.getElementById('font-select').value = currentFont; }
        const pages = draft.pages || [draft.content || ''];
        pages.forEach(html => addPage(html));
        hasUnsaved = false;
        document.getElementById('save-status').innerText = 'Draft loaded';
        updateStats();
        closeDraftsModal();
        // Focus first page
        const first = container.querySelector('.story-page');
        if (first) setTimeout(() => first.focus(), 100);
    }

    function startNewStory() {
        if (hasUnsaved && !confirm('You have unsaved changes. Start new story anyway?')) return;
        activeDraftId = null;
        localStorage.removeItem('active_story_draft_id');
        const container = document.getElementById('pages-container');
        container.innerHTML = '';
        document.getElementById('pub-title').value = '';
        currentFontSize = 18; document.getElementById('size-display').innerText = 18;
        currentFont = "'Merriweather', Georgia, serif";
        document.getElementById('font-select').value = currentFont;
        hasUnsaved = false;
        addPage('');
        document.getElementById('save-status').innerText = 'New story';
        closeDraftsModal();
    }

    // ‚îÄ‚îÄ Exit ‚îÄ‚îÄ
    function handleExit() {
        if (hasUnsaved && !confirm('Exit without saving?')) return;
        localStorage.removeItem('active_story_draft_id');
        location.href = 'index.html';
    }
</script>
</body>
</html>