<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ComicCore â€” Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&family=Kalam:wght@700&family=Permanent+Marker&family=Creepster&family=Luckiest+Guy&family=Orbitron:wght@900&family=Rock+Salt&family=Special+Elite&family=Fredoka+One&family=Boogaloo&family=Anton&family=Chewy&family=Gloria+Hallelujah&family=Shadows+Into+Light&family=Press+Start+2P&family=Caveat:wght@700&family=Bungee+Inline&family=Righteous&family=Pacifico&family=Abril+Fatface&family=Lilita+One&family=Audiowide&family=Russo+One&family=Black+Ops+One&family=Satisfy&family=Dancing+Script:wght@700&family=Bebas+Neue&family=Alfa+Slab+One&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;font-family:'Inter',sans-serif;background:#000;color:#fff;height:100dvh;overflow:hidden;display:flex;flex-direction:column;user-select:none;}

/* â”€â”€ Progress bar â”€â”€ */
.prog-track{position:fixed;top:0;left:0;right:0;height:3px;z-index:500;background:rgba(255,255,255,.08);}
.prog-fill{height:100%;background:#ff7a00;transition:width .4s cubic-bezier(.4,0,.2,1);}

/* â”€â”€ Top bar â”€â”€ */
.top-bar{
position:fixed;top:0;left:0;right:0;z-index:100;
padding:calc(14px + env(safe-area-inset-top)) 16px 18px;
background:linear-gradient(to bottom,rgba(0,0,0,.92) 55%,transparent);
display:flex;align-items:center;gap:10px;
transition:opacity .3s,transform .3s;
}
.top-bar.hide{opacity:0;pointer-events:none;transform:translateY(-100%);}
.round-btn{
background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.14);
color:white;width:38px;height:38px;border-radius:50%;cursor:pointer;
font-size:17px;display:flex;align-items:center;justify-content:center;
flex-shrink:0;transition:.15s;backdrop-filter:blur(8px);
}
.round-btn:hover{background:rgba(255,255,255,.2);}
.round-btn.starred{background:rgba(255,215,0,.18);border-color:rgba(255,215,0,.4);color:#ffd700;}
.round-btn.edit-c{border-color:rgba(0,210,255,.35);color:#00d2ff;}
.top-info{flex:1;min-width:0;}
.top-title{font-size:14px;font-weight:900;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
.top-author{font-size:11px;color:rgba(255,255,255,.38);font-weight:600;margin-top:1px;}

/* â”€â”€ Viewport â”€â”€ */
.reader-vp{
flex:1;display:flex;align-items:center;justify-content:center;
width:100%;height:100dvh;position:relative;overflow:hidden;touch-action:none;
}

/* â”€â”€ Comic frame (the actual rendered canvas) â”€â”€ */
#comic-frame{
position:relative;overflow:hidden;background:#fff;
box-shadow:0 8px 60px rgba(0,0,0,.85);
transition:opacity .2s;
}
#comic-frame.fade{opacity:0;}

/* All layer types sit inside #comic-frame */
.r-layer{position:absolute;pointer-events:none;transform-origin:top left;}

/* Speech bubble â€” base */
.speech-bubble{
padding:14px 18px;background:#fff;color:#000;font-weight:800;
text-align:center;min-width:60px;position:relative;
word-wrap:break-word;line-height:1.35;
}

/* â”€â”€ Style 1: Classic Round â”€â”€ */
.bubble-style-round{border:3.5px solid var(--bubble-border,#000);border-radius:999px;box-shadow:3px 3px 0 var(--bubble-border,#000);}
.bubble-style-round .bubble-tail{position:absolute;bottom:-20px;left:28px;width:0;height:0;border-left:12px solid transparent;border-right:4px solid transparent;border-top:20px solid var(--bubble-border,#000);}
.bubble-style-round .bubble-tail::after{content:'';position:absolute;top:-19px;left:-9px;width:0;height:0;border-left:8px solid transparent;border-right:2px solid transparent;border-top:16px solid var(--bubble-bg,#fff);}

/* â”€â”€ Style 2: Chat â”€â”€ */
.bubble-style-chat{border:3px solid var(--bubble-border,#000);border-radius:18px;box-shadow:3px 3px 0 var(--bubble-border,#000);}
.bubble-style-chat .bubble-tail{position:absolute;bottom:-18px;right:24px;width:0;height:0;border-left:14px solid transparent;border-right:0px solid transparent;border-top:18px solid var(--bubble-border,#000);}
.bubble-style-chat .bubble-tail::after{content:'';position:absolute;top:-17px;left:-11px;width:0;height:0;border-left:10px solid transparent;border-top:14px solid var(--bubble-bg,#fff);}

/* â”€â”€ Style 3: Rect â”€â”€ */
.bubble-style-rect{border:3px solid var(--bubble-border,#000);border-radius:4px;box-shadow:4px 4px 0 var(--bubble-border,#000);}
.bubble-style-rect .bubble-tail{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:18px solid var(--bubble-border,#000);}
.bubble-style-rect .bubble-tail::after{content:'';position:absolute;top:-17px;left:-9px;width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-top:14px solid var(--bubble-bg,#fff);}

/* â”€â”€ Style 4: Spiky / Burst â”€â”€ */
.bubble-style-spiky{border:3px solid var(--bubble-border,#000);clip-path:polygon(50% 0%,61% 6%,74% 2%,79% 13%,93% 12%,91% 25%,100% 33%,90% 41%,98% 52%,86% 56%,90% 70%,76% 70%,75% 84%,62% 79%,54% 92%,43% 83%,30% 88%,28% 74%,15% 76%,17% 61%,4% 56%,13% 45%,3% 35%,14% 27%,8% 14%,22% 14%,25% 2%,38% 7%);padding:22px 28px;box-shadow:none;}
.bubble-style-spiky .bubble-tail{display:none;}

/* â”€â”€ Style 5: Cloud (thinking) â”€â”€ */
.bubble-style-cloud{border:3px solid var(--bubble-border,#000);border-radius:50px;box-shadow:3px 3px 0 var(--bubble-border,#000);position:relative;}
.bubble-style-cloud::before,.bubble-style-cloud::after{content:'';position:absolute;background:var(--bubble-bg,#fff);border:3px solid var(--bubble-border,#000);border-radius:50%;}
.bubble-style-cloud::before{width:40%;height:55%;top:-28%;left:15%;}
.bubble-style-cloud::after{width:30%;height:45%;top:-22%;right:18%;}
.bubble-style-cloud .bubble-tail{display:none;}

/* â”€â”€ Style 6: Shout â”€â”€ */
.bubble-style-shout{background:var(--bubble-bg,#ffeb3b);border:3.5px solid var(--bubble-border,#000);clip-path:polygon(5% 10%,20% 0%,35% 10%,50% 0%,65% 10%,80% 0%,95% 10%,100% 30%,95% 50%,100% 70%,95% 90%,80% 100%,65% 90%,50% 100%,35% 90%,20% 100%,5% 90%,0% 70%,5% 50%,0% 30%);padding:20px 24px;box-shadow:none;}
.bubble-style-shout .bubble-tail{display:none;}

/* â”€â”€ Style 7: Whisper â”€â”€ */
.bubble-style-whisper{border:3px dashed var(--bubble-border,#000);border-radius:999px;background:var(--bubble-bg,rgba(255,255,255,0.92));box-shadow:none;font-style:italic;}
.bubble-style-whisper .bubble-tail{position:absolute;bottom:-16px;left:36px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:16px solid var(--bubble-border,#000);}
.bubble-style-whisper .bubble-tail::after{content:'';position:absolute;top:-15px;left:-5px;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:12px solid var(--bubble-bg,#fff);}

/* â”€â”€ Style 8: Electric â”€â”€ */
.bubble-style-electric{border:3.5px solid var(--bubble-border,#000);background:var(--bubble-bg,#fff);clip-path:polygon(8% 0%,92% 0%,100% 8%,100% 92%,92% 100%,65% 100%,60% 115%,52% 100%,8% 100%,0% 92%,0% 8%);padding:14px 18px 24px;box-shadow:none;}
.bubble-style-electric .bubble-tail{display:none;}

/* â”€â”€ Style 9: Narrator â”€â”€ */
.bubble-style-narrator{border:3px solid var(--bubble-border,#000);border-radius:6px;background:var(--bubble-bg,#fffde7);box-shadow:5px 5px 0 var(--bubble-border,#000);border-left:6px solid var(--bubble-border,#000);}
.bubble-style-narrator .bubble-tail{display:none;}

/* Thought dots */
.thought-dot-1,.thought-dot-2,.thought-dot-3{position:absolute;background:#fff;border:3px solid #000;border-radius:50%;}
.thought-dot-1{width:14px;height:14px;bottom:-22px;left:28px;}
.thought-dot-2{width:9px;height:9px;bottom:-34px;left:22px;}
.thought-dot-3{width:5px;height:5px;bottom:-42px;left:17px;}

/* Legacy fallback */
.thinking .bubble-tail{display:none;}

/* â”€â”€ Tap nav zones â”€â”€ */
.nav-zone{position:absolute;z-index:50;cursor:pointer;}
#nz-left{left:0;top:0;width:33%;height:100%;}
#nz-right{right:0;top:0;width:33%;height:100%;}
#nz-up{top:0;left:0;width:100%;height:33%;display:none;}
#nz-down{bottom:0;left:0;width:100%;height:33%;display:none;}
#nz-mid{left:33%;top:0;width:34%;height:100%;z-index:51;}

/* â”€â”€ Bottom bar â”€â”€ */
.bottom-bar{
position:fixed;bottom:0;left:0;right:0;z-index:100;
padding:36px 18px calc(14px + env(safe-area-inset-bottom));
background:linear-gradient(to top,rgba(0,0,0,.92) 55%,transparent);
display:flex;align-items:flex-end;justify-content:space-between;gap:8px;
transition:opacity .3s,transform .3s;
}
.bottom-bar.hide{opacity:0;pointer-events:none;transform:translateY(100%);}
.frame-ctr{font-size:12px;font-weight:900;color:rgba(255,255,255,.55);letter-spacing:.5px;white-space:nowrap;line-height:38px;}
.nav-btns{display:flex;gap:8px;}
.nb{
background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.18);
color:white;width:42px;height:42px;border-radius:50%;cursor:pointer;
font-size:17px;display:flex;align-items:center;justify-content:center;
transition:.15s;backdrop-filter:blur(8px);
}
.nb:hover{background:rgba(255,255,255,.22);}
.nb:disabled{opacity:.2;cursor:default;}
.fdots{display:flex;gap:4px;align-items:center;flex-wrap:wrap;justify-content:center;max-width:180px;line-height:42px;}
.fd{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.22);transition:.2s;cursor:pointer;flex-shrink:0;}
.fd.on{background:#ff7a00;width:14px;border-radius:3px;}

/* â”€â”€ Finish overlay â”€â”€ */
.finish-card{
position:absolute;inset:0;background:rgba(0,0,0,.9);
display:none;flex-direction:column;align-items:center;justify-content:center;
gap:14px;z-index:200;backdrop-filter:blur(14px);padding:32px;text-align:center;
}
.finish-emoji{font-size:54px;animation:pop .4s cubic-bezier(.4,0,.2,1);}
@keyframes pop{0%{transform:scale(.5);opacity:0;}80%{transform:scale(1.15);}100%{transform:scale(1);opacity:1;}}
.finish-title{font-size:20px;font-weight:900;}
.finish-sub{font-size:12px;color:rgba(255,255,255,.45);line-height:1.7;max-width:260px;}
.finish-star-btn{
background:#ffd700;color:#000;border:none;
padding:13px 28px;border-radius:12px;font-size:14px;font-weight:900;
cursor:pointer;transition:.15s;min-width:160px;
}
.finish-star-btn:hover{filter:brightness(1.08);}
.finish-star-btn.done{background:#32d74b;color:#000;}
.finish-back{
background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);
color:white;padding:11px 22px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;transition:.15s;
}
.finish-back:hover{background:rgba(255,255,255,.2);}
.finish-reread{
background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.18);
color:rgba(255,255,255,.8);padding:11px 22px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;transition:.15s;
}
.finish-reread:hover{background:rgba(255,255,255,.16);color:#fff;}

/* â”€â”€ Share sheet â”€â”€ */
.share-sheet{
position:fixed;inset:0;z-index:900;
display:none;align-items:flex-end;justify-content:center;
background:rgba(0,0,0,.7);backdrop-filter:blur(8px);
padding:0 0 env(safe-area-inset-bottom);
}
.share-sheet.open{display:flex;}
.share-inner{
background:#1c1c1e;border:1px solid #2c2c2e;
border-radius:20px 20px 0 0;padding:24px 20px 28px;
width:100%;max-width:480px;
animation:slideUp .3s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.share-title{font-size:16px;font-weight:900;margin:0 0 4px;letter-spacing:.3px;}
.share-sub{font-size:12px;color:rgba(255,255,255,.4);margin:0 0 18px;}

.link-row{
display:flex;gap:8px;align-items:center;
background:#111;border:1px solid #2c2c2e;border-radius:12px;
padding:10px 12px;margin-bottom:18px;
}
.link-text{
flex:1;font-size:12px;color:rgba(255,255,255,.5);
white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
font-family:â€˜Courier Newâ€™,monospace;
}
.copy-btn{
background:#ff7a00;color:#000;border:none;
border-radius:8px;padding:7px 14px;font-size:12px;font-weight:900;
cursor:pointer;white-space:nowrap;transition:.15s;flex-shrink:0;
}
.copy-btn:hover{filter:brightness(1.1);}
.copy-btn.copied{background:#32d74b;}

.platforms{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.plat-btn{
flex:1;min-width:calc(50% - 5px);
display:flex;align-items:center;gap:8px;
background:#2c2c2e;border:1px solid #3a3a3c;color:white;
padding:12px 14px;border-radius:12px;font-size:13px;font-weight:700;
cursor:pointer;transition:.15s;text-decoration:none;
}
.plat-btn:hover{background:#3a3a3c;transform:translateY(-1px);}
.plat-btn .pi{font-size:20px;flex-shrink:0;}

.qr-wrap{
display:flex;align-items:center;gap:14px;
background:#111;border:1px solid #2c2c2e;border-radius:12px;
padding:12px 14px;
}
#qr-canvas{border-radius:6px;flex-shrink:0;}
.qr-info{flex:1;min-width:0;}
.qr-label{font-size:11px;font-weight:900;color:rgba(255,255,255,.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.qr-hint{font-size:11px;color:rgba(255,255,255,.3);line-height:1.5;}

.sheet-close{
width:100%;margin-top:16px;padding:13px;
background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
color:white;border-radius:12px;font-size:14px;font-weight:700;
cursor:pointer;transition:.15s;
}
.sheet-close:hover{background:rgba(255,255,255,.14);}

/* â”€â”€ Comments overlay â”€â”€ */
.comment-overlay{
position:fixed;inset:0;z-index:950;
display:none;align-items:flex-end;justify-content:center;
background:rgba(0,0,0,.75);backdrop-filter:blur(8px);
}
.comment-overlay.open{display:flex;}
.comment-sheet{
background:#1c1c1e;border:1px solid #2c2c2e;
border-radius:20px 20px 0 0;width:100%;max-width:480px;
max-height:75dvh;display:flex;flex-direction:column;
animation:slideUp .3s cubic-bezier(.4,0,.2,1);
padding:20px 18px 0;
}
.comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.comment-header span{font-weight:900;font-size:15px;}
.comment-header button{background:none;border:none;color:white;font-size:22px;cursor:pointer;}
.comment-list{flex:1;overflow-y:auto;padding-bottom:8px;}
.comment-item{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06);}
.comment-user{font-size:11px;font-weight:800;color:#ff7a00;margin-bottom:3px;}
.comment-text{font-size:13px;color:rgba(255,255,255,.85);}
.comment-empty{text-align:center;padding:30px 20px;color:rgba(255,255,255,.2);font-size:12px;font-weight:700;}
.comment-input-row{
display:flex;gap:8px;padding:12px 0 calc(14px + env(safe-area-inset-bottom));
border-top:1px solid rgba(255,255,255,.08);margin-top:auto;
}
.comment-input{
flex:1;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
color:white;padding:10px 14px;border-radius:12px;font-family:inherit;font-size:13px;outline:none;
}
.comment-input:focus{border-color:#ff7a00;}
.comment-post-btn{
background:#ff7a00;border:none;color:#000;
padding:10px 16px;border-radius:12px;font-weight:900;cursor:pointer;font-size:13px;
}

/* â”€â”€ Toast â”€â”€ */
.toast{
position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(20px);
background:#1c1c1e;border:1px solid #3a3a3c;color:#fff;
padding:10px 20px;border-radius:20px;font-size:13px;font-weight:700;
opacity:0;transition:.25s;z-index:1000;white-space:nowrap;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>

</head>
<body>

<div class="prog-track"><div class="prog-fill" id="prog"></div></div>

<!-- Top bar -->

<div class="top-bar" id="top-bar">
  <button class="round-btn" onclick="goBack()">â†</button>
  <div class="top-info">
    <div class="top-title" id="top-title">Loadingâ€¦</div>
    <div class="top-author" id="top-author"></div>
  </div>
  <div style="display:flex;gap:6px;flex-shrink:0;">
    <button class="round-btn" id="star-btn" onclick="toggleStar()" title="Star">â˜†</button>
    <button class="round-btn" id="comment-btn" onclick="openComments()" title="Comments" style="font-size:15px;">ğŸ’¬</button>
    <button class="round-btn" id="share-btn" onclick="openShare()" title="Share" style="font-size:15px;">â†—</button>
    <button class="round-btn edit-c" id="edit-btn" style="display:none;" onclick="editComic()" title="Edit">âœ</button>
    <button class="round-btn" id="fs-btn" onclick="toggleFS()" title="Fullscreen">â›¶</button>
  </div>
</div>

<!-- Viewport -->

<div class="reader-vp" id="vp">
  <div class="nav-zone" id="nz-left"  onclick="prevFrame()"></div>
  <div class="nav-zone" id="nz-mid"   onclick="onMidTap()"></div>
  <div class="nav-zone" id="nz-right" onclick="nextFrame()"></div>
  <div class="nav-zone" id="nz-up"    onclick="prevFrame()"></div>
  <div class="nav-zone" id="nz-down"  onclick="nextFrame()"></div>

  <div id="comic-frame"></div>

  <!-- Finish overlay -->

  <div class="finish-card" id="finish">
    <div class="finish-emoji">ğŸ‰</div>
    <div class="finish-title" id="fin-title">You finished it!</div>
    <div class="finish-sub">Loved the story? Show the creator some love.</div>
    <button class="finish-star-btn" id="fin-star" onclick="finishStar()">â­ Give a Star</button>
    <button class="finish-back" onclick="openShare()" style="border-color:rgba(255,122,0,.4);color:#ff7a00;">â†— Share this comic</button>
    <button class="finish-reread" onclick="rereadComic()">â†º Re-read from beginning</button>
    <button class="finish-back" onclick="goBack()">â† Back to Discover</button>
  </div>
</div>

<!-- Bottom bar -->

<div class="bottom-bar" id="bot-bar">
  <span class="frame-ctr" id="fctr">1 / 1</span>
  <div class="fdots" id="fdots"></div>
  <div class="nav-btns">
    <button class="nb" id="btn-prev" onclick="prevFrame()" disabled>â—€</button>
    <button class="nb" id="btn-next" onclick="nextFrame()">â–¶</button>
  </div>
</div>

<!-- Share Sheet -->

<div class="share-sheet" id="share-sheet" onclick="if(event.target===this)closeShare()">
  <div class="share-inner">
    <div class="share-title" id="sh-title">Share Comic</div>
    <div class="share-sub" id="sh-sub">Anyone with this link can read it</div>
    <div class="link-row">
      <span class="link-text" id="sh-link-text">loadingâ€¦</span>
      <button class="copy-btn" id="copy-btn" onclick="copyLink()">Copy</button>
    </div>
    <div class="platforms">
      <a class="plat-btn" id="discord-btn" href="#" onclick="e=>{e.preventDefault();copyLink();showToast('Link copied! Paste it into Discord ğŸ®');}">
        <span class="pi">ğŸ®</span><span>Discord</span>
      </a>
      <a class="plat-btn" id="twitter-btn" href="#" target="_blank">
        <span class="pi">ğ•</span><span>X / Twitter</span>
      </a>
      <a class="plat-btn" id="whatsapp-btn" href="#" target="_blank">
        <span class="pi">ğŸ’¬</span><span>WhatsApp</span>
      </a>
      <button class="plat-btn" onclick="nativeShare()">
        <span class="pi">â¬†</span><span>Moreâ€¦</span>
      </button>
    </div>
    <div class="qr-wrap">
      <canvas id="qr-canvas" width="80" height="80"></canvas>
      <div class="qr-info">
        <div class="qr-label">QR Code</div>
        <div class="qr-hint">Scan with any camera app to open on another device</div>
      </div>
    </div>
    <button class="sheet-close" onclick="closeShare()">Close</button>
  </div>
</div>

<!-- Comments overlay -->

<div class="comment-overlay" id="comment-overlay" onclick="if(event.target===this)closeComments()">
  <div class="comment-sheet">
    <div class="comment-header">
      <span>Comments</span>
      <button onclick="closeComments()">âœ•</button>
    </div>
    <div class="comment-list" id="comment-list">
      <div class="comment-empty">Loadingâ€¦</div>
    </div>
    <div class="comment-input-row">
      <input class="comment-input" id="comment-input" placeholder="Add a commentâ€¦" onkeydown="if(event.key==='Enter')postComment()">
      <button class="comment-post-btn" onclick="postComment()">Post</button>
    </div>
  </div>
</div>

<!-- Toast -->

<div class="toast" id="toast"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const READER_BASE = location.origin + location.pathname;
const _sb = supabase.createClient(
  'https://mmycqeejhguzhtzkyjaj.supabase.co',
  'sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE'
);
const myP = JSON.parse(localStorage.getItem('user_profile') || '{"handle":"guest"}');

let comic = null, frames = [], idx = 0, comicId = null, isStarred = false;
let uiOn = true, hideTimer = null;
let swipeDir = 'horizontal';
let txX = 0, txY = 0, txT = 0;
let shareUrl = '';
// The canonical editor canvas size (create.html uses 900px base)
const EDITOR_BASE = 900;

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  comicId = new URLSearchParams(location.search).get('id');
  if (!comicId) return location.href = 'discover.html';

  const { data, error } = await _sb.from('comics').select('*').eq('id', comicId).single();
  if (error || !data) { alert('Comic not found.'); return location.href = 'discover.html'; }

  comic = data;
  frames = data.data || data.frames || [];
  document.title = (data.title || 'Comic') + ' â€” ComicCore';
  document.getElementById('top-title').innerText = data.title || 'Untitled';
  document.getElementById('top-author').innerText = 'by @' + (data.owner_handle || 'unknown');
  // Swipe direction: user pref='creator' means use comic creator's setting, otherwise user's choice wins
  const userSwipePref = localStorage.getItem('cc-swipe-dir') || 'creator';
  swipeDir = (userSwipePref === 'creator')
    ? (data.swipe_dir || 'horizontal')
    : userSwipePref;
  setSwipeDir(swipeDir);

  // Show edit button only to owner
  if (myP.handle && myP.handle !== 'guest' && myP.handle === data.owner_handle) {
    document.getElementById('edit-btn').style.display = 'flex';
  }
  // Hide star for owner
  if (myP.handle && myP.handle === data.owner_handle) {
    document.getElementById('star-btn').style.display = 'none';
  }

  await checkStar();

  // Restore reading progress
  const sv = localStorage.getItem('cc-progress-' + comicId);
  if (sv !== null && sv !== '__done__') { const i = parseInt(sv); if (i > 0 && i < frames.length) idx = i; }

  buildDots();
  renderFrame();
  sched();
  buildShareUrl();
}

// â”€â”€ Share URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildShareUrl() {
  shareUrl = `${READER_BASE}?id=${encodeURIComponent(comicId)}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ FAITHFUL FRAME RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mirrors create.html's render() logic exactly so what you
// see in the editor is what readers see.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCanvasRatio() {
  // 1. Top-level DB column (set by publishes after the fix)
  if (comic?.canvas_ratio?.w && comic?.canvas_ratio?.h) return comic.canvas_ratio;
  // 2. Per-frame _ratio stamped by editor (most reliable for older comics re-saved as draft)
  for (const f of frames) {
    if (f?._ratio?.w && f?._ratio?.h) return f._ratio;
    if (f?.ratio?.w  && f?.ratio?.h)  return f.ratio;
    if (f?.canvas_ratio?.w && f?.canvas_ratio?.h) return f.canvas_ratio;
  }
  // 3. URL param ?ratio=4:3 (passed by discover.html as a hint for comics with known ratio)
  const urlRatio = new URLSearchParams(location.search).get('ratio');
  if (urlRatio) {
    const parts = urlRatio.split(':').map(Number);
    if (parts.length === 2 && parts[0] > 0 && parts[1] > 0) return { w: parts[0], h: parts[1] };
  }
  // 4. localStorage cc-active-ratio (valid if reader opened immediately after editing)
  try {
    const stored = JSON.parse(localStorage.getItem('cc-active-ratio') || 'null');
    if (stored?.w && stored?.h) return stored;
  } catch(e) {}
  // 5. Default: 1:1
  return { w: 1, h: 1 };
}

function sizeFrame() {
  const cf = document.getElementById('comic-frame');
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  const r = getCanvasRatio();
  const ar = r.w / r.h;
  let cw, ch;
  if (vw / vh > ar) { ch = vh * 0.98; cw = ch * ar; }
  else              { cw = vw * 0.98; ch = cw / ar; }

  cf.style.width  = Math.floor(cw) + 'px';
  cf.style.height = Math.floor(ch) + 'px';
  cf.style.backgroundSize = 'cover';
  return { cw: Math.floor(cw), ch: Math.floor(ch) };
}

function getEditorDimensions() {
  // create.html uses BASE_SIZE=900 on the longest edge â€” must match setRatio() exactly
  const r = getCanvasRatio();
  const ew = r.w >= r.h ? EDITOR_BASE : Math.round(EDITOR_BASE * r.w / r.h);
  const eh = r.h >= r.w ? EDITOR_BASE : Math.round(EDITOR_BASE * r.h / r.w);
  return { ew, eh };
}

function getSpriteFilterCSS(layer) {
  const blurType = layer.blurType || 'none';
  if (blurType === 'none') return '';
  const amt = layer.blurAmount ?? layer.blurAmt ?? 4;  // desktop: blurAmount, mobile: blurAmt
  if (blurType === 'soft')  return `blur(${amt}px)`;
  if (blurType === 'pixel') return `blur(${Math.max(1, Math.round(amt * 0.6))}px) contrast(${100 + amt * 4}%) saturate(120%)`;
  return '';
}

function renderFrame(anim = false) {
  const cf = document.getElementById('comic-frame');
  if (anim) { cf.classList.add('fade'); setTimeout(() => cf.classList.remove('fade'), 220); }

  const f = frames[idx];
  if (!f) return;

  // 1. Size the frame to fit the viewport, preserving aspect ratio
  const { cw, ch } = sizeFrame();

  // 2. Scale factors: editor â†’ reader
  const { ew, eh } = getEditorDimensions();
  const sx = cw / ew;
  const sy = ch / eh;

  // 3. Helpers
  function isAnimatedBg(src) {
    if (!src) return false;
    if (src.startsWith('data:image/gif'))  return true;
    if (src.startsWith('data:image/webp')) return true;
    if (src.startsWith('data:image/apng')) return true;
    const lower = src.toLowerCase();
    return lower.includes('.gif') || lower.includes('.webp');
  }

  // 3. Apply background â€” mirrors updated create.html render():
  //    filter goes ONLY on the bg-layer div, never on cf root, so sprites are unaffected.
  const bg = f.background || '#ffffff';
  const isBgImage    = bg.startsWith('http') || bg.startsWith('data:image');
  const isBgGradient = bg.startsWith('linear-gradient') || bg.startsWith('radial-gradient');
  const isBgAnimated = isBgImage && isAnimatedBg(bg);

  // Remove previous bg-layer and legacy r-bg-div elements
  cf.querySelectorAll('.r-bg-div, #r-bg-layer').forEach(e => e.remove());

  // Reset canvas-level bg props â€” filter NEVER goes on cf, only on r-bg-layer
  cf.style.filter          = '';
  cf.style.backgroundImage = 'none';
  cf.style.backgroundColor = '#ffffff';
  cf.style.backgroundSize  = '';
  cf.style.backgroundPosition = '';

  const s = f.bgSettings || {};
  const scale  = s.scale  ?? 100;
  const rotate = s.rotate ?? 0;
  const xOff   = s.x      ?? 0;
  const yOff   = s.y      ?? 0;
  const filter = s.filter || 'none';
  const filterCSS = filter === 'none' ? '' : filter;

  const bgLayer = document.createElement('div');
  bgLayer.id = 'r-bg-layer';
  bgLayer.className = 'r-bg-div';
  bgLayer.style.cssText = 'position:absolute;inset:0;z-index:0;pointer-events:none;overflow:hidden;';
  if (filterCSS) bgLayer.style.filter = filterCSS;

  if (isBgImage) {
    cf.style.backgroundColor = 'transparent';
    if (isBgAnimated) {
      // GIF/WebP-anim: must use <img> â€” background-image freezes GIF animation
      const img = document.createElement('img');
      img.src = bg;
      const posX = 50 + xOff, posY = 50 + yOff;
      img.style.cssText = `position:absolute;width:${scale}%;height:auto;min-height:${scale}%;` +
        `object-fit:cover;pointer-events:none;` +
        `left:${posX}%;top:${posY}%;` +
        `transform:translate(-50%,-50%) rotate(${rotate}deg);transform-origin:center center;`;
      bgLayer.appendChild(img);
    } else if (rotate !== 0) {
      const bgDiv = document.createElement('div');
      bgDiv.style.cssText = `position:absolute;top:-60%;left:-60%;width:220%;height:220%;` +
        `background:url(${bg});background-size:${scale * 2.2}%;` +
        `background-position:center;background-repeat:no-repeat;` +
        `transform:rotate(${rotate}deg);transform-origin:center center;`;
      bgLayer.appendChild(bgDiv);
    } else {
      bgLayer.style.background           = `url(${bg})`;
      bgLayer.style.backgroundSize       = scale + '%';
      bgLayer.style.backgroundPosition   = (50 + xOff) + '% ' + (50 + yOff) + '%';
      bgLayer.style.backgroundRepeat     = 'no-repeat';
    }
  } else if (isBgGradient) {
    cf.style.backgroundColor = 'transparent';
    if (rotate !== 0) {
      const bgDiv = document.createElement('div');
      bgDiv.style.cssText = `position:absolute;top:-60%;left:-60%;width:220%;height:220%;` +
        `background:${bg};background-size:cover;background-position:center;` +
        `transform:rotate(${rotate}deg);transform-origin:center center;`;
      bgLayer.appendChild(bgDiv);
    } else {
      bgLayer.style.background     = bg;
      bgLayer.style.backgroundSize = 'cover';
    }
  } else {
    // Solid color â€” no bgLayer needed for color, but still insert empty one for z-index consistency
    cf.style.backgroundColor = bg;
  }

  cf.insertBefore(bgLayer, cf.firstChild);

  // 4. Remove old layers, add new ones
  cf.querySelectorAll('.r-layer').forEach(e => e.remove());

  f.layers.forEach((l, layerIdx) => {
    const el = document.createElement('div');
    el.className = 'r-layer';

    // Position & size â€” scaled from editor coords
    const lx = l.x * sx;
    const ly = l.y * sy;
    const lw = l.w * sx;

    el.style.left   = lx + 'px';
    el.style.top    = ly + 'px';
    el.style.width  = lw + 'px';
    el.style.zIndex = 10 + layerIdx;

    // Rotation + flip â€” transform-origin MUST be center to match create.html
    const rot  = l.rotation || 0;
    const flip = l.flipped ? -1 : 1;
    el.style.transform       = `rotate(${rot}deg) scaleX(${flip})`;
    el.style.transformOrigin = 'center center';

    // Opacity â€” handle both desktop (opacity 0-100) and mobile (fxOpacity 0-100)
    const opacityVal = l.opacity ?? l.fxOpacity;
    if (opacityVal != null && opacityVal !== 100) {
      el.style.opacity = opacityVal / 100;
    }

    // FX: blur + layer filter â€” handle both desktop and mobile field names
    const blurCSS = getSpriteFilterCSS(l);
    // desktop: l.layerFilter, mobile: l.fxFilter
    const lfCSS = ((l.layerFilter && l.layerFilter !== 'none') ? l.layerFilter : '')
               || ((l.fxFilter    && l.fxFilter    !== 'none') ? l.fxFilter    : '');
    const combinedFilter = [blurCSS, lfCSS].filter(Boolean).join(' ');

    if (l.type === 'img') {
      const img = document.createElement('img');
      img.src = l.src;
      img.style.cssText = 'width:100%;height:auto;display:block;pointer-events:none;';
      if (combinedFilter) img.style.filter = combinedFilter;
      el.appendChild(img);

    } else if (l.type === 'bubble' || l.type === 'thinking') {
      const fs = (l.fontSize || 28) * sx;
      const ff = l.fontFamily || "'Inter', sans-serif";
      const textColor = l.color || '#000';
      const boldW     = l.bold   ? '900' : '800';
      const italicS   = l.italic ? 'italic' : 'normal';
      const alignS    = l.align  || 'center';
      const decos     = [l.underline ? 'underline' : '', l.strikethrough ? 'line-through' : ''].filter(Boolean).join(' ') || 'none';
      const isThinking = l.type === 'thinking';

      // Determine bubble style â€” default: cloud for thinking, round for speech
      const bStyle = l.bubbleStyle || (isThinking ? 'cloud' : 'round');
      const isCloud = bStyle === 'cloud';

      // Bubble-level border/bg color overrides (stored on layer in create.html)
      const bubBorder = l.bubbleBorderColor || '#000';
      const bubBg     = l.bubbleBg || (bStyle === 'shout' ? '#ffeb3b' : bStyle === 'narrator' ? '#fffde7' : '#fff');

      el.style.width = lw + 'px';

      const bubble = document.createElement('div');
      bubble.className = `speech-bubble bubble-style-${bStyle}`;
      bubble.style.cssText = [
        `font-size:${fs}px`,
        `font-family:${ff}`,
        `color:${textColor}`,
        `font-weight:${boldW}`,
        `font-style:${italicS}`,
        `text-align:${alignS}`,
        `text-decoration:${decos}`,
        `border-color:${bubBorder}`,
        `background:${bubBg}`,
        // Sync the ::after pseudo-element color for tails that use #fff fill
        `--bubble-bg:${bubBg}`,
        `--bubble-border:${bubBorder}`,
      ].join(';');
      bubble.appendChild(document.createTextNode(l.content || ''));

      // Tail: shown only for styles that use one (same logic as create.html)
      const showTail = !['spiky','shout','electric','narrator','cloud'].includes(bStyle);
      if (showTail) {
        const tail = document.createElement('div');
        tail.className = 'bubble-tail';
        bubble.appendChild(tail);
      }

      // Thought dots: shown for cloud/thinking bubbles
      if (isCloud || isThinking) {
        ['thought-dot-1','thought-dot-2','thought-dot-3'].forEach(cls => {
          const d = document.createElement('div');
          d.className = cls;
          // Scale dot size to match the scale factor
          bubble.appendChild(d);
        });
      }

      if (combinedFilter) el.style.filter = combinedFilter;
      el.appendChild(bubble);

    } else if (l.type === 'subtitle') {
      const fs = (l.fontSize || 28) * sx;
      const ff = l.fontFamily || "'Inter', sans-serif";
      const nameColor   = l.nameColor  || '#ff9500';
      const dialogColor = l.color || '#111';
      const alignS  = l.align  || 'left';
      const boldW   = l.bold   ? '900' : '700';
      const italicS = l.italic ? 'italic' : 'normal';

      el.style.width    = lw + 'px';
      el.style.overflow = 'visible';
      el.innerHTML = `
        <div style="background:${nameColor};color:#fff;font-size:${Math.max(8, fs * 0.55)}px;font-weight:900;font-family:${ff};padding:3px 10px;border-radius:5px 5px 0 0;letter-spacing:1px;text-transform:uppercase;line-height:1.5;text-align:${alignS};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(l.characterName || 'CHARACTER')}</div>
        <div style="background:rgba(255,255,255,0.96);color:${dialogColor};font-size:${fs}px;font-weight:${boldW};font-style:${italicS};font-family:${ff};padding:6px 10px;border-radius:0 0 5px 5px;text-align:${alignS};line-height:1.4;border:1.5px solid rgba(0,0,0,.1);border-top:none;">${esc(l.content || '')}</div>`;

      if (combinedFilter) el.style.filter = combinedFilter;

    } else {
      // Plain text (type === 'text' or any unlisted type)
      const fs = (l.fontSize || 28) * sx;
      const ff = l.fontFamily || "'Inter', sans-serif";
      const decos = [l.underline ? 'underline' : '', l.strikethrough ? 'line-through' : ''].filter(Boolean).join(' ') || 'none';
      el.style.color          = l.color || '#000';
      el.style.fontWeight     = l.bold   ? '900' : '700';
      el.style.fontStyle      = l.italic ? 'italic' : 'normal';
      el.style.textDecoration = decos;
      el.style.textAlign      = l.align || 'left';
      el.style.fontSize       = fs + 'px';
      el.style.fontFamily     = ff;
      el.style.lineHeight     = '1.3';
      el.style.whiteSpace     = 'pre-wrap';
      el.innerText            = l.content || '';

      if (combinedFilter) el.style.filter = combinedFilter;
    }

    cf.appendChild(el);
  });

  // 5. Update UI chrome
  const tot = frames.length;
  document.getElementById('fctr').innerText = `${idx + 1} / ${tot}`;
  document.getElementById('prog').style.width = ((idx + 1) / tot * 100) + '%';
  document.getElementById('btn-prev').disabled = idx === 0;
  document.getElementById('btn-next').disabled = idx === tot - 1;
  document.getElementById('btn-prev').innerText = swipeDir === 'vertical' ? 'â–²' : 'â—€';
  document.getElementById('btn-next').innerText = swipeDir === 'vertical' ? 'â–¼' : 'â–¶';
  document.querySelectorAll('.fd').forEach((d, i) => d.classList.toggle('on', i === idx));
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextFrame() {
  if (idx < frames.length - 1) { idx++; renderFrame(true); saveProg(); resetUI(); }
  else showFinish();
}
function prevFrame() {
  if (idx > 0) { idx--; renderFrame(true); saveProg(); resetUI(); }
}
function jumpTo(i) { idx = i; renderFrame(true); saveProg(); }

function setSwipeDir(d) {
  swipeDir = d;
  const v = d === 'vertical';
  document.getElementById('nz-left').style.display  = v ? 'none' : 'block';
  document.getElementById('nz-right').style.display = v ? 'none' : 'block';
  document.getElementById('nz-up').style.display    = v ? 'block' : 'none';
  document.getElementById('nz-down').style.display  = v ? 'block' : 'none';
}

// â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveProg() {
  if (!comicId) return;
  if (idx >= frames.length - 1) {
    // Mark as finished but keep progress key so re-read can resume correctly
    localStorage.setItem('cc-progress-' + comicId, '__done__');
  } else {
    localStorage.setItem('cc-progress-' + comicId, idx);
  }
}

function isFinished() {
  return localStorage.getItem('cc-progress-' + comicId) === '__done__';
}

// â”€â”€ Star â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkStar() {
  if (!myP.handle || myP.handle === 'guest') return;
  if (myP.handle === comic?.owner_handle) return;
  const { data } = await _sb
    .from('messages')
    .select('id')
    .eq('sender_handle', myP.handle)
    .eq('receiver_hand', comicId)
    .eq('reaction', 'â­')
    .maybeSingle();
  isStarred = !!data;
  updStar();
}

function updStar() {
  const b = document.getElementById('star-btn');
  b.innerHTML = isStarred ? 'â­' : 'â˜†';
  b.classList.toggle('starred', isStarred);
}

async function toggleStar() {
  if (!myP.handle || myP.handle === 'guest') return showToast('Log in to star!');
  if (myP.handle === comic?.owner_handle) return;
  if (isStarred) {
    await _sb.from('messages').delete()
      .eq('sender_handle', myP.handle)
      .eq('receiver_hand', comicId)
      .eq('reaction', 'â­');
    isStarred = false;
  } else {
    await _sb.from('messages').insert([{
      sender_handle: myP.handle,
      receiver_hand: comicId,
      content: 'â­',
      reaction: 'â­'
    }]);
    isStarred = true;
  }
  updStar();
  const b = document.getElementById('star-btn');
  b.style.transform = 'scale(1.4)';
  setTimeout(() => b.style.transform = '', 220);
  showToast(isStarred ? 'â­ Starred!' : 'Star removed');
}

// â”€â”€ Finish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFinish() {
  saveProg(); // mark as __done__
  const fc = document.getElementById('finish');
  fc.style.display = 'flex';
  document.getElementById('fin-title').innerText = comic?.title ? `Finished "${comic.title}"!` : 'You finished it!';
  const sb = document.getElementById('fin-star');
  if (isStarred) { sb.textContent = 'â­ Already Starred'; sb.classList.add('done'); }
  else if (myP.handle === comic?.owner_handle) sb.style.display = 'none';
}

function rereadComic() {
  // Clear finished flag and go back to frame 0
  localStorage.removeItem('cc-progress-' + comicId);
  idx = 0;
  document.getElementById('finish').style.display = 'none';
  renderFrame(true);
  resetUI();
  buildDots();
}

async function finishStar() {
  if (isStarred) return;
  await toggleStar();
  const sb = document.getElementById('fin-star');
  sb.textContent = 'â­ Starred!';
  sb.classList.add('done');
}

// â”€â”€ Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openComments() {
  document.getElementById('comment-overlay').classList.add('open');
  clearTimeout(hideTimer);
  await fetchComments();
}

function closeComments() {
  document.getElementById('comment-overlay').classList.remove('open');
  resetUI();
}

async function fetchComments() {
  const list = document.getElementById('comment-list');
  list.innerHTML = '<div class="comment-empty">Loadingâ€¦</div>';
  const { data: comments, error } = await _sb
    .from('messages')
    .select('*')
    .eq('receiver_hand', comicId)
    .is('reaction', null)
    .order('created_at', { ascending: false });
  if (error) { list.innerHTML = '<div class="comment-empty">Could not load comments.</div>'; return; }
  if (!comments || !comments.length) {
    list.innerHTML = '<div class="comment-empty">No comments yet. Be first!</div>'; return;
  }
  list.innerHTML = comments.map(m => `
    <div class="comment-item">
      <div class="comment-user">@${esc(m.sender_handle)}</div>
      <div class="comment-text">${esc(m.content)}</div>
    </div>`).join('');
}

async function postComment() {
  const input = document.getElementById('comment-input');
  const text = input.value.trim();
  if (!text) return;
  if (!myP.handle || myP.handle === 'guest') return showToast('Log in to comment!');
  const { error } = await _sb.from('messages').insert([{
    sender_handle: myP.handle,
    receiver_hand: comicId,
    content: text
  }]);
  if (error) { showToast('Error posting comment'); return; }
  input.value = '';
  await fetchComments();
}

function esc(s) {
  return String(s || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// â”€â”€ Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editComic() {
  localStorage.setItem('edit_comic_id', comicId);
  location.href = 'create.html';
}

// â”€â”€ Fullscreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFS() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    (document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen)
      .call(document.documentElement);
  } else {
    (document.exitFullscreen || document.webkitExitFullscreen).call(document);
  }
}
document.addEventListener('fullscreenchange', () => {
  document.getElementById('fs-btn').innerHTML = document.fullscreenElement ? 'âœ•â›¶' : 'â›¶';
  renderFrame();
});

// â”€â”€ UI auto-hide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sched() {
  hideTimer = setTimeout(() => {
    document.getElementById('top-bar').classList.add('hide');
    document.getElementById('bot-bar').classList.add('hide');
    uiOn = false;
  }, 4000);
}
function resetUI() {
  clearTimeout(hideTimer);
  document.getElementById('top-bar').classList.remove('hide');
  document.getElementById('bot-bar').classList.remove('hide');
  uiOn = true; sched();
}
function onMidTap() {
  uiOn
    ? (document.getElementById('top-bar').classList.contains('hide') ? resetUI() : hideUI())
    : resetUI();
}
function hideUI() {
  document.getElementById('top-bar').classList.add('hide');
  document.getElementById('bot-bar').classList.add('hide');
  uiOn = false;
}

// â”€â”€ Dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDots() {
  const c = document.getElementById('fdots');
  if (frames.length > 24) { c.style.display = 'none'; return; }
  c.innerHTML = frames.map((_, i) =>
    `<div class="fd${i === 0 ? ' on' : ''}" onclick="event.stopPropagation();jumpTo(${i})"></div>`
  ).join('');
}

// â”€â”€ Back â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goBack() {
  document.referrer && (
    document.referrer.includes('discover') ||
    document.referrer.includes('my-comics') ||
    document.referrer.includes('favorites')
  ) ? history.back() : location.href = 'discover.html';
}

// â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShare() {
  if (!shareUrl) buildShareUrl();
  const title   = comic?.title || 'this comic';
  const author  = comic?.owner_handle ? ` by @${comic.owner_handle}` : '';
  const framesN = frames.length;
  document.getElementById('sh-title').innerText = `Share "${title}"`;
  document.getElementById('sh-sub').innerText   = `${framesN} frame${framesN !== 1 ? 's' : ''} Â· Anyone with this link can read it`;
  document.getElementById('sh-link-text').innerText = shareUrl;
  document.getElementById('copy-btn').textContent = 'Copy';
  document.getElementById('copy-btn').classList.remove('copied');

  const enc     = encodeURIComponent(shareUrl);
  const txt     = encodeURIComponent(`"${title}"${author} â€” a comic on ComicCore ğŸ¨`);
  document.getElementById('discord-btn').onclick = e => { e.preventDefault(); copyLink(); showToast('Link copied! Paste into Discord ğŸ®'); };
  document.getElementById('twitter-btn').href   = `https://twitter.com/intent/tweet?text=${txt}&url=${enc}`;
  document.getElementById('whatsapp-btn').href  = `https://wa.me/?text=${txt}%20${enc}`;

  drawQR(shareUrl);
  document.getElementById('share-sheet').classList.add('open');
  clearTimeout(hideTimer);
}

function closeShare() {
  document.getElementById('share-sheet').classList.remove('open');
  resetUI();
}

async function copyLink() {
  try { await navigator.clipboard.writeText(shareUrl); }
  catch {
    const ta = document.createElement('textarea');
    ta.value = shareUrl; ta.style.cssText = 'position:fixed;opacity:0;';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
  }
  const btn = document.getElementById('copy-btn');
  btn.textContent = 'âœ“ Copied'; btn.classList.add('copied');
  setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2500);
  showToast('Link copied to clipboard!');
}

async function nativeShare() {
  if (navigator.share) {
    try {
      await navigator.share({ title: comic?.title || 'ComicCore', text: `Check out "${comic?.title || 'this comic'}" on ComicCore!`, url: shareUrl });
    } catch(e) { if (e.name !== 'AbortError') copyLink(); }
  } else { copyLink(); }
}

// â”€â”€ QR Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawQR(url) {
  const canvas = document.getElementById('qr-canvas');
  if (!canvas) return;
  if (typeof QRCode !== 'undefined') { renderQR(canvas, url); return; }
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js';
  s.onload = () => renderQR(canvas, url);
  s.onerror = () => {
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, 80, 80);
    ctx.fillStyle = '#333'; ctx.font = '8px Inter'; ctx.textAlign = 'center';
    ctx.fillText('QR unavailable', 40, 44);
  };
  document.head.appendChild(s);
}

function renderQR(canvas, url) {
  try {
    const qr = qrcode(0, 'M');
    qr.addData(url); qr.make();
    const size = 80, ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, size, size);
    const mc = qr.getModuleCount(), cell = size / mc;
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = '#000000';
    for (let row = 0; row < mc; row++)
      for (let col = 0; col < mc; col++)
        if (qr.isDark(row, col))
          ctx.fillRect(Math.floor(col * cell), Math.floor(row * cell), Math.ceil(cell), Math.ceil(cell));
  } catch(e) { console.warn('QR render error:', e); }
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ Touch swipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vp = document.getElementById('vp');
vp.addEventListener('touchstart', e => {
  txX = e.touches[0].clientX; txY = e.touches[0].clientY; txT = Date.now();
}, { passive: true });
vp.addEventListener('touchend', e => {
  const dx = txX - e.changedTouches[0].clientX;
  const dy = txY - e.changedTouches[0].clientY;
  const dt = Date.now() - txT;
  if (dt > 700) return;
  if (swipeDir === 'vertical') {
    if (Math.abs(dy) > 45 && Math.abs(dy) > Math.abs(dx)) { dy > 0 ? nextFrame() : prevFrame(); return; }
  } else {
    if (Math.abs(dx) > 45 && Math.abs(dx) > Math.abs(dy)) { dx > 0 ? nextFrame() : prevFrame(); return; }
  }
  if (Math.abs(dx) < 10 && Math.abs(dy) < 10 && dt < 280) resetUI();
}, { passive: true });

// â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('keydown', e => {
  if (document.getElementById('share-sheet').classList.contains('open')) {
    if (e.key === 'Escape') closeShare();
    return;
  }
  if (document.getElementById('comment-overlay').classList.contains('open')) {
    if (e.key === 'Escape') closeComments();
    return;
  }
  const v = swipeDir === 'vertical';
  if (e.key === 'ArrowRight' || (!v && e.key === 'ArrowDown')) nextFrame();
  else if (e.key === 'ArrowLeft' || (!v && e.key === 'ArrowUp')) prevFrame();
  else if (v && e.key === 'ArrowDown') nextFrame();
  else if (v && e.key === 'ArrowUp') prevFrame();
  else if (e.key === 'f' || e.key === 'F') toggleFS();
  else if (e.key === 's' || e.key === 'S') openShare();
  else if (e.key === 'Escape') { document.getElementById('finish').style.display = 'none'; resetUI(); }
  resetUI();
});

window.addEventListener('resize', () => renderFrame());
window.onload = boot;
</script>

</body>
</html>