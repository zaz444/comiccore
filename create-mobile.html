<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore - Mobile Creator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&family=Kalam:wght@700&family=Permanent+Marker&family=Creepster&family=Luckiest+Guy&family=Orbitron:wght@900&family=Rock+Salt&family=Special+Elite&family=Fredoka+One&family=Boogaloo&family=Anton&family=Chewy&family=Gloria+Hallelujah&family=Shadows+Into+Light&family=Caveat:wght@700&family=Pacifico&family=Bebas+Neue&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
    :root {
        --bg: #0f0f11; --card: #1c1c1e; --text: #f5f5f7;
        --accent: #ff7a00; --border: #2c2c2e; --teal: #00d2ff;
        --danger: #ff3b30; --sheet-bg: #161618;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0; font-family: 'Inter', sans-serif;
        background: var(--bg); color: var(--text);
        overflow: hidden; display: flex; flex-direction: column;
        height: 100vh; height: 100dvh; /* dynamic viewport for mobile */
    }

    /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
    #top-bar {
        height: 52px; background: var(--card); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 10px; gap: 6px;
        z-index: 200; flex-shrink: 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    .tb-btn {
        background: rgba(255,255,255,0.07); border: 1px solid var(--border);
        color: var(--text); padding: 7px 11px; border-radius: 8px;
        cursor: pointer; font-size: 12px; font-weight: 700;
        font-family: inherit; display: flex; align-items: center; gap: 4px;
        white-space: nowrap; transition: 0.15s;
    }
    .tb-btn:active { opacity: 0.7; }
    .tb-btn.accent { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 900; }
    .tb-spacer { flex: 1; }
    #frame-counter {
        font-size: 12px; font-weight: 900; color: var(--accent);
        letter-spacing: 0.5px; padding: 0 4px;
    }

    /* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
    #viewport {
        flex: 1; display: flex; justify-content: center; align-items: center;
        background: #050505; position: relative; overflow: hidden;
        touch-action: manipulation;
    }
    #canvas-container {
        position: relative; display: inline-block;
        will-change: transform; transform-origin: center center;
    }
    #comic-frame {
        background: #fff; position: relative; overflow: hidden;
        box-shadow: 0 8px 30px rgba(0,0,0,0.7);
        background-size: cover; background-position: center;
        touch-action: none;
    }
    canvas#onion-skin-canvas {
        position: absolute; inset: 0; pointer-events: none; z-index: 5; display: none;
    }
    #global-frame-indicator {
        position: absolute; top: 6px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.65); color: var(--accent);
        font-size: 9px; font-weight: 900; padding: 3px 9px; border-radius: 6px;
        letter-spacing: 1px; pointer-events: none; z-index: 20;
        display: none;
    }

    /* ‚îÄ‚îÄ LAYERS ‚îÄ‚îÄ */
    .layer { position: absolute; cursor: move; user-select: none; transform-origin: center; touch-action: none; z-index: 10; }
    .layer.active { outline: 2px solid var(--accent); outline-offset: 3px; z-index: 99 !important; }

    /* ‚îÄ‚îÄ RESIZE HANDLES ‚îÄ‚îÄ */
    .resize-handle {
        position: absolute; width: 26px; height: 26px; z-index: 200;
        background: var(--accent); border: 2px solid #000; border-radius: 5px;
        touch-action: none; cursor: nwse-resize;
        display: flex; align-items: center; justify-content: center;
        font-size: 9px; font-weight: 900; color: #000;
    }
    .resize-handle.tl { top: -13px; left: -13px; }
    .resize-handle.tr { top: -13px; right: -13px; cursor: nesw-resize; }
    .resize-handle.bl { bottom: -13px; left: -13px; cursor: nesw-resize; }
    .resize-handle.br { bottom: -13px; right: -13px; }

    /* ‚îÄ‚îÄ BUBBLE STYLES (same as PC) ‚îÄ‚îÄ */
    .speech-bubble { padding: 12px 16px; background: #fff; color: #000; font-weight: 800; text-align: center; min-width: 50px; position: relative; word-wrap: break-word; line-height: 1.35; }
    .bubble-style-round { border: 3.5px solid #000; border-radius: 999px; box-shadow: 3px 3px 0 #000; }
    .bubble-style-round .bubble-tail { position: absolute; bottom: -20px; left: 28px; width: 0; height: 0; border-left: 12px solid transparent; border-right: 4px solid transparent; border-top: 20px solid #000; }
    .bubble-style-round .bubble-tail::after { content: ''; position: absolute; top: -19px; left: -9px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 2px solid transparent; border-top: 16px solid #fff; }
    .bubble-style-chat { border: 3px solid #000; border-radius: 18px; box-shadow: 3px 3px 0 #000; }
    .bubble-style-chat .bubble-tail { position: absolute; bottom: -18px; right: 24px; width: 0; height: 0; border-left: 14px solid transparent; border-top: 18px solid #000; }
    .bubble-style-chat .bubble-tail::after { content: ''; position: absolute; top: -17px; left: -11px; width: 0; height: 0; border-left: 10px solid transparent; border-top: 14px solid #fff; }
    .bubble-style-rect { border: 3px solid #000; border-radius: 4px; box-shadow: 4px 4px 0 #000; }
    .bubble-style-rect .bubble-tail { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 18px solid #000; }
    .bubble-style-rect .bubble-tail::after { content: ''; position: absolute; top: -17px; left: -9px; width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-top: 14px solid #fff; }
    .bubble-style-spiky { border: 3px solid #000; clip-path: polygon(50% 0%, 61% 6%, 74% 2%, 79% 13%, 93% 12%, 91% 25%, 100% 33%, 90% 41%, 98% 52%, 86% 56%, 90% 70%, 76% 70%, 75% 84%, 62% 79%, 54% 92%, 43% 83%, 30% 88%, 28% 74%, 15% 76%, 17% 61%, 4% 56%, 13% 45%, 3% 35%, 14% 27%, 8% 14%, 22% 14%, 25% 2%, 38% 7%); padding: 22px 28px; }
    .bubble-style-spiky .bubble-tail { display: none; }
    .bubble-style-cloud { border: 3px solid #000; border-radius: 50px; box-shadow: 3px 3px 0 #000; }
    .bubble-style-cloud::before, .bubble-style-cloud::after { content: ''; position: absolute; background: #fff; border: 3px solid #000; border-radius: 50%; }
    .bubble-style-cloud::before { width: 40%; height: 55%; top: -28%; left: 15%; }
    .bubble-style-cloud::after { width: 30%; height: 45%; top: -22%; right: 18%; }
    .bubble-style-cloud .bubble-tail { display: none; }
    .thought-dot-1, .thought-dot-2, .thought-dot-3 { position: absolute; background: #fff; border: 3px solid #000; border-radius: 50%; }
    .thought-dot-1 { width: 14px; height: 14px; bottom: -22px; left: 28px; }
    .thought-dot-2 { width: 9px; height: 9px; bottom: -34px; left: 22px; }
    .thought-dot-3 { width: 5px; height: 5px; bottom: -42px; left: 17px; }
    .bubble-style-shout { background: #ffeb3b; border: 3.5px solid #000; clip-path: polygon(5% 10%, 20% 0%, 35% 10%, 50% 0%, 65% 10%, 80% 0%, 95% 10%, 100% 30%, 95% 50%, 100% 70%, 95% 90%, 80% 100%, 65% 90%, 50% 100%, 35% 90%, 20% 100%, 5% 90%, 0% 70%, 5% 50%, 0% 30%); padding: 20px 24px; }
    .bubble-style-shout .bubble-tail { display: none; }
    .bubble-style-whisper { border: 3px dashed #000; border-radius: 999px; background: rgba(255,255,255,0.92); font-style: italic; }
    .bubble-style-whisper .bubble-tail { position: absolute; bottom: -16px; left: 36px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 16px solid #000; }
    .bubble-style-narrator { border: 3px solid #000; border-radius: 6px; background: #fffde7; box-shadow: 5px 5px 0 #000; border-left: 6px solid #000; }
    .bubble-style-narrator .bubble-tail { display: none; }

    /* ‚îÄ‚îÄ BOTTOM TOOLBAR ‚îÄ‚îÄ */
    #bottom-bar {
        height: 62px; background: var(--card); border-top: 1px solid var(--border);
        display: flex; align-items: center;
        z-index: 200; flex-shrink: 0; padding: 0 4px;
        overflow-x: auto; overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* hide scrollbar on Firefox */
    }
    #bottom-bar::-webkit-scrollbar { display: none; }
    .bot-btn {
        display: flex; flex-direction: column; align-items: center; gap: 3px;
        background: none; border: none; color: #888; cursor: pointer;
        font-size: 9px; font-weight: 800; text-transform: uppercase;
        letter-spacing: 0.5px; padding: 6px 10px; border-radius: 10px;
        transition: 0.15s; font-family: inherit; min-width: 54px; flex-shrink: 0;
    }
    .bot-btn:active { background: rgba(255,255,255,0.06); }
    .bot-btn.active { color: var(--accent); }
    .bot-btn .bico { font-size: 22px; line-height: 1; }
    .bot-custom-icon { width: 26px; height: 26px; object-fit: contain; display: block; filter: brightness(0.6); transition: filter 0.15s; }
    .bot-btn:active .bot-custom-icon { filter: brightness(1) sepia(1) saturate(10) hue-rotate(0deg); }
    .bot-btn.onion-on { color: var(--teal); }
    .bot-btn.onion-on .bico { filter: drop-shadow(0 0 4px var(--teal)); }

    /* ‚îÄ‚îÄ ZOOM / PAN OVERLAY ‚îÄ‚îÄ */
    #zoom-controls {
        position: fixed; right: 12px; bottom: 80px; z-index: 500;
        display: flex; flex-direction: column; gap: 4px;
    }
    .zoom-ctrl-btn {
        width: 36px; height: 36px; background: rgba(28,28,30,0.92);
        border: 1px solid #333; color: #fff; border-radius: 10px;
        font-size: 18px; font-weight: 900; display: flex; align-items: center;
        justify-content: center; cursor: pointer; font-family: inherit;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5); transition: 0.15s;
        -webkit-tap-highlight-color: transparent;
    }
    .zoom-ctrl-btn:active { opacity: 0.6; }
    #zoom-reset-btn { font-size: 9px; font-weight: 900; letter-spacing: 0.3px; }
    #zoom-indicator {
        position: fixed; bottom: 80px; left: 12px; z-index: 500;
        background: rgba(0,0,0,0.7); color: #fff; font-size: 11px; font-weight: 800;
        padding: 4px 10px; border-radius: 8px; pointer-events: none;
        opacity: 0; transition: opacity 0.3s; letter-spacing: 0.5px;
    }
    #zoom-indicator.visible { opacity: 1; }

    /* ‚îÄ‚îÄ ONION OPACITY POPUP ‚îÄ‚îÄ */
    #onion-opacity-popup {
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
        background: rgba(28,28,30,0.96); border: 1px solid var(--teal);
        border-radius: 14px; padding: 12px 16px; z-index: 600;
        display: none; align-items: center; gap: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    #onion-opacity-popup.visible { display: flex; }
    #onion-opacity-popup span { font-size: 10px; font-weight: 900; color: var(--teal); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }

    /* ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ */
    .sheet-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        z-index: 300; display: none; backdrop-filter: blur(4px);
    }
    .sheet-overlay.open { display: block; }
    /* Transparent backdrop for transform sheet so tapping outside closes it */
    #transform-sheet-backdrop {
        position: fixed; inset: 0; z-index: 499; display: none;
    }
    #transform-sheet-backdrop.open { display: block; }

    .bottom-sheet {
        position: fixed; bottom: -100%; left: 0; right: 0;
        background: var(--sheet-bg); border-radius: 20px 20px 0 0;
        z-index: 400; transition: bottom 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 75vh; display: flex; flex-direction: column;
        border-top: 1px solid var(--border);
    }
    .bottom-sheet.open { bottom: 0; }
    .sheet-handle {
        width: 36px; height: 4px; background: #444; border-radius: 2px;
        margin: 10px auto 0; flex-shrink: 0;
    }
    .sheet-title {
        font-size: 13px; font-weight: 900; color: var(--accent); letter-spacing: 1.5px;
        text-transform: uppercase; padding: 12px 16px 8px;
        border-bottom: 1px solid var(--border); flex-shrink: 0;
        display: flex; justify-content: space-between; align-items: center;
    }
    .sheet-close { background: none; border: none; color: #555; font-size: 18px; cursor: pointer; padding: 4px; }
    .sheet-body { flex: 1; overflow-y: auto; padding: 12px; -webkit-overflow-scrolling: touch; }

    /* ‚îÄ‚îÄ ADD SHEET ‚îÄ‚îÄ */
    .add-section-label {
        font-size: 9px; font-weight: 900; color: #555; text-transform: uppercase;
        letter-spacing: 1.5px; margin: 14px 0 8px; padding: 0 2px;
    }
    .add-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 4px; }
    .add-btn {
        background: #222; border: 1.5px solid #2c2c2e; border-radius: 14px;
        color: var(--text); padding: 14px 10px; text-align: center;
        font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit;
        display: flex; flex-direction: column; align-items: center; gap: 6px;
        transition: 0.15s;
    }
    .add-btn:active { border-color: var(--accent); background: #2a1500; }
    .add-btn .add-ico { font-size: 24px; }

    /* ‚îÄ‚îÄ SPRITES SHEET ‚îÄ‚îÄ */
    #mob-sprite-search {
        width: 100%; padding: 10px 14px; background: #1a1a1a;
        border: 1px solid #252525; color: white; border-radius: 10px;
        font-size: 13px; font-weight: 600; outline: none; font-family: inherit;
        margin-bottom: 10px;
    }
    #mob-sprite-search:focus { border-color: var(--accent); }
    #mob-sprite-grid {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
    }
    .mob-sprite-card {
        background: var(--card); border: 2px solid var(--border); border-radius: 12px;
        cursor: pointer; overflow: hidden; aspect-ratio: 1; position: relative;
        display: flex; align-items: center; justify-content: center;
        transition: 0.15s;
    }
    .mob-sprite-card:active { border-color: var(--accent); transform: scale(0.96); }
    .mob-sprite-card img { width: 100%; height: 100%; object-fit: contain; padding: 6px; }
    .mob-sprite-name {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: rgba(0,0,0,0.7); color: #fff;
        font-size: 8px; font-weight: 800; text-align: center;
        padding: 3px 2px; text-transform: uppercase; letter-spacing: 0.3px;
    }

    /* ‚îÄ‚îÄ LAYERS SHEET ‚îÄ‚îÄ */
    .mob-layer-actions {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;
    }
    .mob-lay-btn {
        background: #222; border: 1px solid #333; color: #aaa;
        padding: 10px 4px; border-radius: 10px; font-size: 10px;
        font-weight: 800; text-align: center; cursor: pointer; font-family: inherit;
        transition: 0.15s;
    }
    .mob-lay-btn:active { background: #333; }
    .mob-lay-btn.danger { color: var(--danger); border-color: rgba(255,59,48,0.3); }
    #mob-layer-list { display: flex; flex-direction: column; gap: 6px; }
    .mob-layer-item {
        display: flex; align-items: center; gap: 10px; padding: 10px 12px;
        background: #222; border: 1.5px solid #2c2c2e; border-radius: 10px;
        cursor: pointer; transition: 0.15s;
    }
    .mob-layer-item.active-l { border-color: var(--accent); background: rgba(255,122,0,0.1); }
    .mob-layer-item .l-thumb {
        width: 32px; height: 32px; border-radius: 6px; background: #333;
        object-fit: contain; flex-shrink: 0;
    }
    .mob-layer-item .l-info { flex: 1; min-width: 0; }
    .mob-layer-item .l-name { font-size: 12px; font-weight: 700; color: var(--text); }
    .mob-layer-item .l-type { font-size: 10px; color: #666; margin-top: 1px; }
    .mob-layer-item .l-del { background: none; border: none; color: #444; cursor: pointer; font-size: 16px; padding: 4px; }
    .mob-layer-item .l-del:active { color: var(--danger); }

    /* ‚îÄ‚îÄ FRAMES SHEET ‚îÄ‚îÄ */
    .frames-top { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .frames-top-btn {
        flex: 1; min-width: 100px; padding: 11px; background: #222; border: 1.5px solid #2c2c2e;
        color: var(--text); border-radius: 10px; font-size: 12px; font-weight: 800;
        cursor: pointer; font-family: inherit; text-align: center; transition: 0.15s;
    }
    .frames-top-btn:active { border-color: var(--accent); }
    .frames-top-btn.accent-btn { background: rgba(255,122,0,0.15); border-color: var(--accent); color: var(--accent); }
    #mob-frame-scroll {
        display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
    }
    #mob-frame-scroll::-webkit-scrollbar { height: 3px; }
    #mob-frame-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .mob-frame-thumb {
        flex-shrink: 0; width: 80px; height: 80px; background: #222;
        border: 2px solid transparent; border-radius: 10px; cursor: pointer;
        background-size: cover; background-position: center; position: relative;
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 900; color: #555; transition: 0.15s;
        overflow: hidden;
    }
    .mob-frame-thumb.active { border-color: var(--accent); }
    .mob-frame-del {
        position: absolute; top: 3px; right: 3px; background: rgba(0,0,0,0.7);
        border: none; color: var(--danger); font-size: 12px; border-radius: 4px;
        cursor: pointer; padding: 2px 5px; line-height: 1;
    }

    /* ‚îÄ‚îÄ TRANSFORM SHEET (appears from bottom when layer tapped) ‚îÄ‚îÄ */
    #transform-sheet {
        position: fixed; bottom: -100%; left: 0; right: 0;
        background: var(--sheet-bg); border-radius: 20px 20px 0 0;
        z-index: 500; transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 60vh; overflow-y: auto;
        border-top: 1px solid var(--border); padding: 0 16px 24px;
    }
    #transform-sheet.open { bottom: 62px; /* above bottom bar */ }
    .ts-handle { width: 36px; height: 4px; background: #444; border-radius: 2px; margin: 10px auto 14px; }
    .ts-title { font-size: 11px; font-weight: 900; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 14px; display: flex; justify-content: space-between; }
    .ts-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .ts-label { font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase; width: 52px; flex-shrink: 0; letter-spacing: 0.5px; }
    .ts-row input[type=range] { flex: 1; accent-color: var(--accent); }
    .ts-num { width: 50px; background: #111; border: 1px solid #333; color: var(--accent); padding: 5px; border-radius: 7px; font-size: 11px; font-weight: 800; text-align: center; font-family: inherit; outline: none; }
    .ts-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
    .ts-act-btn {
        padding: 10px 4px; background: #222; border: 1.5px solid #333;
        color: var(--text); border-radius: 10px; font-size: 11px; font-weight: 800;
        cursor: pointer; font-family: inherit; text-align: center; transition: 0.15s;
    }
    .ts-act-btn:active { opacity: 0.7; }
    .ts-act-btn.danger { background: rgba(255,59,48,0.1); border-color: rgba(255,59,48,0.3); color: var(--danger); }
    .ts-act-btn.done { background: var(--accent); border-color: var(--accent); color: #000; }
    #ts-swap-btn { background: rgba(0,210,255,0.12); border-color: rgba(0,210,255,0.4) !important; color: var(--teal) !important; }

    /* Text editing row in transform sheet */
    .ts-text-section { border-top: 1px solid #2c2c2e; padding-top: 14px; margin-top: 4px; }
    .ts-text-section input[type=text], .ts-text-section select {
        width: 100%; padding: 10px 12px; background: #1a1a1a; border: 1px solid #333;
        color: white; border-radius: 10px; font-size: 13px; font-family: inherit;
        outline: none; margin-bottom: 8px;
    }
    .ts-text-section input:focus, .ts-text-section select:focus { border-color: var(--accent); }
    .ts-text-format { display: flex; gap: 8px; margin-bottom: 8px; }
    .ts-fmt-btn {
        flex: 1; padding: 8px; background: #222; border: 1.5px solid #333;
        color: #aaa; border-radius: 8px; font-size: 13px; cursor: pointer;
        font-family: inherit; transition: 0.15s;
    }
    .ts-fmt-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }

    /* BG sheet */
    .bg-action-btn {
        width: 100%; padding: 14px; background: #222; border: 1.5px solid #2c2c2e;
        color: var(--text); border-radius: 12px; font-size: 14px; font-weight: 700;
        cursor: pointer; font-family: inherit; text-align: left; display: flex;
        align-items: center; gap: 12px; margin-bottom: 10px; transition: 0.15s;
    }
    .bg-action-btn:active { border-color: var(--accent); }

    /* BG adjust sliders */
    .bg-slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .bg-slider-row span { font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase; width: 48px; flex-shrink: 0; }
    .bg-slider-row input[type=range] { flex: 1; accent-color: var(--accent); }
    .bg-val { font-size: 10px; font-weight: 800; color: var(--teal); min-width: 32px; text-align: right; }
    .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; margin-bottom: 10px; }
    .filter-chip { flex-shrink: 0; padding: 6px 13px; border-radius: 20px; background: #2c2c2e; border: 1.5px solid #3a3a3c; color: #aaa; font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.15s; white-space: nowrap; }
    .filter-chip.active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* ‚îÄ‚îÄ OVERLAYS (same as PC) ‚îÄ‚îÄ */
    .overlay-full {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9);
        z-index: 600; display: none; flex-direction: column;
        align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(5px);
        /* Allow tap-off to close by listening on the backdrop itself */
        cursor: pointer;
    }
    /* But not on the modal content card */
    .modal-content {
        background: var(--card); width: 100%; max-width: 460px;
        border-radius: 20px; padding: 22px; box-sizing: border-box;
        max-height: 88vh; overflow-y: auto; border: 1px solid var(--border);
        cursor: default;
    }
    .pub-input {
        width: 100%; padding: 12px; background: #111; border: 1px solid #333;
        color: white; border-radius: 10px; font-size: 14px; font-family: inherit;
        outline: none; margin-bottom: 12px;
    }
    .pub-input:focus { border-color: var(--accent); }

    /* Bubble picker */
    #bubble-style-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 16px; }
    .bubble-preview-btn {
        background: #111; border: 2px solid #333; border-radius: 12px;
        padding: 12px 6px; cursor: pointer; text-align: center;
        display: flex; flex-direction: column; align-items: center; gap: 6px;
        transition: 0.15s;
    }
    .bubble-preview-btn:active, .bubble-preview-btn.selected { border-color: var(--accent); background: rgba(255,122,0,0.1); }
    .bubble-preview-btn .bpico { font-size: 22px; }
    .bubble-preview-btn span { font-size: 9px; font-weight: 800; color: #888; text-transform: uppercase; }

    /* Sprite action modal */
    .action-selector-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-top: 12px; }
    .action-option { background: #111; border: 2px solid #333; padding: 8px; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.2s; }
    .action-option:active { border-color: var(--teal); }
    .action-option img { width: 100%; aspect-ratio: 1; object-fit: contain; }
    .action-option strong { display: block; font-size: 10px; margin-top: 4px; color: #aaa; }

    /* Export sheet */
    .export-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; font-size: 13px; }
    .export-tab-row { display: flex; gap: 8px; margin-bottom: 16px; }
    .export-tab { flex: 1; padding: 10px; background: #222; border: 1.5px solid #333; color: #888; border-radius: 10px; font-size: 12px; font-weight: 800; cursor: pointer; font-family: inherit; transition: 0.15s; }
    .export-tab.active { background: var(--teal); border-color: var(--teal); color: #000; }
    .export-section { display: none; }
    .export-section.active { display: block; }
    #gif-progress-bar { height: 4px; background: #222; border-radius: 4px; margin-bottom: 10px; display: none; }
    #gif-progress-fill { height: 100%; background: var(--teal); border-radius: 4px; width: 0%; transition: 0.3s; }
    #gif-status { font-size: 11px; color: #888; margin-bottom: 10px; }

    /* Crop modal */
    #crop-modal { z-index: 700; }

    /* ‚îÄ‚îÄ FX Panel as sheet ‚îÄ‚îÄ */
    .fx-sheet-section { margin-bottom: 14px; }
    .fx-sheet-label { font-size: 9px; font-weight: 900; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
    .fx-chip-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
    .fx-chip { flex-shrink: 0; padding: 6px 14px; border-radius: 20px; background: #2c2c2e; border: 1.5px solid #3a3a3c; color: #aaa; font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.15s; white-space: nowrap; }
    .fx-chip.active { background: var(--teal); color: #000; border-color: var(--teal); }

    /* Multi-import */
    .multi-drop-zone { border: 2px dashed #444; border-radius: 12px; padding: 24px 16px; text-align: center; cursor: pointer; transition: 0.2s; background: #111; }
    .multi-drop-zone.dragover { border-color: var(--accent); background: #1a1a1a; }
    #multi-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; max-height: 180px; overflow-y: auto; margin-top: 10px; }
    .multi-thumb { aspect-ratio: 1; border-radius: 8px; background-size: cover; background-position: center; border: 2px solid #333; position: relative; overflow: hidden; }
    .multi-thumb .order-badge { position: absolute; top: 3px; left: 3px; background: var(--accent); color: #000; font-size: 8px; font-weight: 900; padding: 1px 4px; border-radius: 3px; }

    /* Sprite nametag */
    .sprite-nametag { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.75); color: var(--accent); font-size: 9px; font-weight: 900; padding: 2px 7px; border-radius: 4px; white-space: nowrap; pointer-events: none; border: 1px solid rgba(255,122,0,0.3); }

    /* Shimmer loading animation for sprite cards */
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* BG import choice */
    #bg-import-choice-modal { z-index: 600; }

    /* Modal close spans - make them tap-friendly */
    .modal-content [onclick*="close"], .overlay-full [onclick*="close"] {
        min-width: 44px; min-height: 44px; display: inline-flex;
        align-items: center; justify-content: center;
    }

    /* Selections outline */
    .layer.active { outline-color: rgba(var(--sel-r,255),var(--sel-g,122),var(--sel-b,0),var(--sel-opacity,1)); }

    /* ‚îÄ‚îÄ FRAME COUNTER PILL ‚îÄ‚îÄ */
    #frame-counter {
        font-size: 11px; font-weight: 900; color: #000;
        background: var(--accent); border-radius: 8px;
        padding: 4px 10px; letter-spacing: 0.5px; flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ DRAFTS MODAL ‚îÄ‚îÄ */
    #drafts-modal {
        display: none; position: fixed; inset: 0; z-index: 9999;
        background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);
        align-items: flex-end; justify-content: center;
    }
    #drafts-modal.open { display: flex; }
    #drafts-panel {
        background: #1a1a1a; border: 1px solid #2c2c2e;
        border-radius: 20px 20px 0 0;
        width: 100%; max-width: 480px; max-height: 75dvh;
        display: flex; flex-direction: column;
        animation: draftsSlideUp .3s cubic-bezier(.4,0,.2,1);
        overflow: hidden;
    }
    @keyframes draftsSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    #drafts-panel-head {
        display: flex; align-items: center; justify-content: space-between;
        padding: 18px 18px 12px; border-bottom: 1px solid #2c2c2e; flex-shrink: 0;
    }
    #drafts-panel-head h2 { margin: 0; font-size: 16px; font-weight: 900; color: #fff; }
    #drafts-list {
        flex: 1; overflow-y: auto; padding: 10px 14px;
        display: flex; flex-direction: column; gap: 8px;
    }
    .draft-item {
        display: flex; align-items: center; gap: 12px;
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px; padding: 10px 12px; cursor: pointer;
        transition: background 0.15s;
    }
    .draft-item:active { background: rgba(255,255,255,0.12); }
    .draft-thumb {
        width: 48px; height: 48px; border-radius: 8px;
        background: #2c2c2e; object-fit: cover; flex-shrink: 0;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .draft-info { flex: 1; min-width: 0; }
    .draft-title { font-size: 13px; font-weight: 800; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .draft-meta { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 3px; font-weight: 600; }
    .draft-del {
        background: none; border: none; color: rgba(255,255,255,0.3);
        font-size: 18px; cursor: pointer; padding: 4px 6px; flex-shrink: 0;
        transition: color 0.15s; line-height: 1;
    }
    .draft-del:active { color: #ff453a; }
    .draft-new {
        width: 100%; padding: 13px; background: rgba(255,255,255,0.07);
        border: 1px dashed rgba(255,255,255,0.2); border-radius: 12px;
        color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 700;
        cursor: pointer; font-family: inherit; transition: background 0.15s;
    }
    .draft-new:active { background: rgba(255,255,255,0.12); }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ OVERLAY MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

<!-- Library / sprite chooser -->
<div id="library-modal" class="overlay-full">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2 style="margin:0;color:var(--teal);font-size:17px;">SPRITE LIBRARY</h2>
            <span onclick="closeLibrary()" style="cursor:pointer;font-size:22px;">‚úï</span>
        </div>
        <div id="library-grid" class="action-selector-grid"></div>
    </div>
</div>

<!-- Action/pose picker -->
<div id="action-modal" class="overlay-full">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2 style="margin:0;color:var(--teal);font-size:17px;" id="pack-title">Character Pack</h2>
            <span onclick="closeActionModal()" style="cursor:pointer;font-size:22px;">‚úï</span>
        </div>
        <div id="action-selector-list" class="action-selector-grid"></div>
    </div>
</div>

<!-- Publish -->
<div id="publish-modal" class="overlay-full">
    <div class="modal-content">
        <h2 style="margin-top:0;color:var(--accent);font-size:18px;">Publish Comic</h2>
        <div id="cover-preview-box" style="width:100%;aspect-ratio:1;background:#111;border:2px dashed #444;margin-bottom:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;border-radius:12px;" onclick="document.getElementById('cover-input').click()">
            <img id="final-cover-img" style="width:100%;height:100%;object-fit:cover;display:none;">
            <span id="cover-label" style="color:#555;font-size:13px;">Tap to upload 1:1 Cover</span>
        </div>
        <input type="text" id="pub-title" class="pub-input" placeholder="Comic Title">
        <input type="text" id="pub-tags" class="pub-input" placeholder="Tags (e.g. action, comedy)">
        <textarea id="pub-desc" class="pub-input" placeholder="Brief description..." style="height:70px;resize:none;"></textarea>
        <div style="display:flex;gap:10px;">
            <button onclick="closePublish()" style="flex:1;padding:13px;background:#333;color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">Cancel</button>
            <button id="publish-btn" onclick="finalPublish()" style="flex:1;padding:13px;background:var(--accent);color:white;border:none;border-radius:12px;font-weight:900;cursor:pointer;">POST NOW</button>
        </div>
    </div>
</div>

<!-- Crop -->
<div id="crop-modal" class="overlay-full">
    <div style="width:90vw;max-width:460px;height:55vh;background:#000;border-radius:12px;overflow:hidden;">
        <img id="crop-target" style="max-width:100%;">
    </div>
    <div style="margin-top:16px;display:flex;gap:14px;">
        <button class="tb-btn" onclick="closeCrop()">Cancel</button>
        <button class="tb-btn" style="background:var(--accent);border:none;" id="apply-crop-btn">Apply</button>
    </div>
</div>

<!-- BG import choice -->
<div id="bg-import-choice-modal" class="overlay-full" style="display:none;">
    <div style="background:var(--card);border-radius:20px;padding:22px;width:92%;max-width:380px;border:1px solid var(--border);display:flex;flex-direction:column;gap:14px;">
        <div style="font-size:13px;font-weight:900;color:var(--accent);text-align:center;letter-spacing:2px;text-transform:uppercase;">Import Background</div>
        <div style="width:100%;height:120px;background:#000;border-radius:10px;overflow:hidden;">
            <img id="bg-choice-preview" style="width:100%;height:100%;object-fit:cover;">
        </div>
        <button onclick="bgChoiceCrop()" style="display:flex;align-items:center;gap:12px;padding:14px;background:#1a1a1a;border:2px solid #2c2c2e;border-radius:12px;cursor:pointer;color:white;font-family:inherit;width:100%;">
            <span style="font-size:22px;">‚úÇÔ∏è</span>
            <div style="text-align:left;"><div style="font-size:13px;font-weight:900;">Crop Import</div><div style="font-size:11px;color:#666;margin-top:2px;">Manually adjust crop</div></div>
        </button>
        <button onclick="bgChoiceFixed()" style="display:flex;align-items:center;gap:12px;padding:14px;background:#1a1a1a;border:2px solid #2c2c2e;border-radius:12px;cursor:pointer;color:white;font-family:inherit;width:100%;">
            <span style="font-size:22px;">‚ö°</span>
            <div style="text-align:left;"><div style="font-size:13px;font-weight:900;color:var(--teal);">Fixed Import</div><div style="font-size:11px;color:#666;margin-top:2px;">Auto-center crop</div></div>
        </button>
        <button onclick="closeBgChoiceModal()" style="padding:11px;background:#111;color:#555;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-family:inherit;">Cancel</button>
    </div>
</div>

<!-- Bubble Picker -->
<div id="bubble-picker-modal" class="overlay-full">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <h2 style="margin:0;font-size:16px;" id="bubble-picker-title">Choose Bubble Style</h2>
            <button onclick="closeBubblePicker()" style="background:none;border:none;color:#666;font-size:22px;cursor:pointer;">‚úï</button>
        </div>
        <div id="bubble-style-grid"></div>
        <input id="bubble-picker-text" class="pub-input" placeholder="Enter text...">
        <button onclick="confirmBubblePicker()" style="width:100%;padding:13px;background:var(--accent);color:#000;border:none;border-radius:12px;font-weight:900;font-size:14px;cursor:pointer;">Add Bubble</button>
    </div>
</div>

<!-- Export -->
<div id="export-modal" class="overlay-full">
    <div class="modal-content">
        <h2 style="margin-top:0;color:var(--teal);font-size:17px;">Export Comic</h2>
        <div class="export-tab-row">
            <button class="export-tab active" onclick="switchExportTab('frames')">üñº Frames</button>
            <button class="export-tab" onclick="switchExportTab('strip')">üìú Strip</button>
            <button class="export-tab" onclick="switchExportTab('gif')">üéû GIF</button>
        </div>
        <div id="export-frames" class="export-section active">
            <div style="font-size:11px;color:#666;margin-bottom:12px;font-weight:700;">Tap a frame to download. On iOS long-press the image to save.</div>
            <div id="export-frames-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-height:55vh;overflow-y:auto;"></div>
        </div>
        <div id="export-strip" class="export-section">
            <div class="export-row">
                <span>Frames per row</span>
                <select id="strip-cols" style="background:#1a1a1a;border:1px solid #333;color:white;padding:7px;border-radius:8px;font-size:12px;">
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                </select>
            </div>
            <div id="strip-preview-wrap" style="margin:12px 0;text-align:center;display:none;">
                <img id="strip-preview-img" style="max-width:100%;border-radius:8px;border:1px solid #333;">
                <div style="font-size:10px;color:#555;margin-top:6px;">Long-press image to save on iOS</div>
            </div>
            <div id="strip-status" style="font-size:11px;color:#888;margin-bottom:10px;"></div>
            <button onclick="exportStrip()" style="width:100%;padding:12px;background:var(--teal);color:#000;border:none;border-radius:12px;font-weight:900;cursor:pointer;">GENERATE STRIP</button>
        </div>
        <div id="export-gif" class="export-section">
            <div style="font-size:11px;color:#888;margin-bottom:10px;font-weight:700;">GIF works best on desktop. On mobile, long-press the preview to save.</div>
            <div class="export-row">
                <span>Frame Speed</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="gif-fps" min="1" max="24" value="6" oninput="document.getElementById('gif-fps-val').innerText=this.value+'fps'" style="width:100px;accent-color:var(--teal);">
                    <span id="gif-fps-val" style="color:var(--teal);font-weight:800;font-size:12px;">6fps</span>
                </div>
            </div>
            <div class="export-row">
                <span>Quality</span>
                <select id="gif-quality" style="background:#1a1a1a;border:1px solid #333;color:white;padding:7px;border-radius:8px;font-size:12px;">
                    <option value="10">Fast</option>
                    <option value="5" selected>Balanced</option>
                    <option value="1">Best</option>
                </select>
            </div>
            <div id="gif-progress-bar" style="display:none;"><div id="gif-progress-fill"></div></div>
            <div id="gif-status" style="font-size:11px;color:var(--teal);margin-bottom:10px;font-weight:800;"></div>
            <div id="gif-result-wrap" style="display:none;text-align:center;margin-bottom:10px;">
                <img id="gif-result-img" style="max-width:100%;border-radius:8px;border:1px solid #333;">
                <div style="font-size:10px;color:#555;margin-top:6px;">Long-press to save on iOS</div>
                <a id="gif-download-link" style="display:inline-block;margin-top:8px;padding:10px 20px;background:var(--teal);color:#000;border-radius:10px;font-weight:900;font-size:12px;text-decoration:none;">Download GIF</a>
            </div>
            <button onclick="exportGIF()" id="gif-generate-btn" style="width:100%;padding:12px;background:var(--teal);color:#000;border:none;border-radius:12px;font-weight:900;cursor:pointer;">GENERATE GIF</button>
        </div>
        <button onclick="closeExportModal()" style="width:100%;margin-top:10px;padding:11px;background:#222;color:#aaa;border:none;border-radius:12px;font-weight:700;cursor:pointer;">Close</button>
    </div>
</div>

<!-- Multi-import -->
<div id="multi-import-modal" class="overlay-full">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <h2 style="margin:0;font-size:16px;color:var(--teal);">Multi-Frame Import</h2>
            <span onclick="closeMultiImport()" style="cursor:pointer;font-size:22px;">‚úï</span>
        </div>
        <div class="multi-drop-zone" id="multi-drop-zone" onclick="document.getElementById('multi-file-input').click()">
            <div style="font-size:28px;margin-bottom:8px;">üóÇÔ∏è</div>
            <div style="font-weight:700;color:#aaa;font-size:13px;">Tap to choose images</div>
            <p>Each image = one frame</p>
        </div>
        <div id="multi-preview-grid"></div>
        <div id="multi-ratio-warning" class="multi-ratio-warning" style="display:none;font-size:11px;color:var(--danger);text-align:center;margin-top:6px;"></div>
        <div style="display:flex;gap:10px;margin-top:14px;">
            <select id="multi-insert-mode" style="flex:1;padding:10px;background:#111;border:1px solid #333;color:white;border-radius:10px;font-size:12px;font-weight:700;">
                <option value="replace">Replace all frames</option>
                <option value="append">Append after current</option>
                <option value="from-current">From current frame</option>
            </select>
            <button id="multi-confirm-btn" onclick="confirmMultiImport()" style="flex:1;padding:10px;background:var(--accent);color:#000;border:none;border-radius:10px;font-weight:900;cursor:pointer;" disabled>Import</button>
        </div>
        <input type="file" id="multi-file-input" multiple accept="image/*" hidden>
    </div>
</div>

<!-- ‚îÄ‚îÄ SHEET OVERLAY ‚îÄ‚îÄ -->
<div id="sheet-overlay" class="sheet-overlay" onclick="closeAllSheets()"></div>

<!-- ‚îÄ‚îÄ BOTTOM SHEETS ‚îÄ‚îÄ -->

<!-- ADD SHEET -->
<div id="sheet-add" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Add Element <button class="sheet-close" onclick="closeSheet('add')">‚úï</button></div>
    <div class="sheet-body">
        <div class="add-section-label">Text & Bubbles</div>
        <div class="add-grid">
            <button class="add-btn" onclick="openBubblePicker('speech');closeSheet('add')"><span class="add-ico">üí¨</span>Speech</button>
            <button class="add-btn" onclick="openBubblePicker('thinking');closeSheet('add')"><span class="add-ico">üí≠</span>Thinking</button>
            <button class="add-btn" onclick="addText('plain');closeSheet('add')"><span class="add-ico">‚úçÔ∏è</span>Plain Text</button>
            <button class="add-btn" onclick="addSubtitle();closeSheet('add')"><span class="add-ico">üìã</span>Subtitle Bar</button>
        </div>
        <div class="add-section-label">Media</div>
        <div class="add-grid">
            <button class="add-btn" onclick="closeSheet('add');openSheet('sprites')"><span class="add-ico">üé≠</span>Sprites</button>
            <button class="add-btn" onclick="triggerImport('object');closeSheet('add')"><span class="add-ico">üì¶</span>Upload Image</button>
            <button class="add-btn" onclick="openMultiImport();closeSheet('add')"><span class="add-ico">üóÇ</span>Multi-Frame</button>
        </div>
    </div>
</div>

<!-- SPRITES SHEET -->
<div id="sheet-sprites" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Sprites <button class="sheet-close" onclick="closeSheet('sprites')">‚úï</button></div>
    <div class="sheet-body">
        <input class="pub-input" id="mob-sprite-search" placeholder="Search sprites..." oninput="filterMobSprites()" style="margin-bottom:10px;">
        <div id="mob-sprite-grid">
            <div style="color:#555;font-size:13px;text-align:center;padding:20px;grid-column:span 3;">Tap to load sprites...</div>
        </div>
    </div>
</div>

<!-- BACKGROUND SHEET -->
<div id="sheet-bg" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Background <button class="sheet-close" onclick="closeSheet('bg')">‚úï</button></div>
    <div class="sheet-body">
        <button class="bg-action-btn" onclick="openBackgroundSource();closeSheet('bg')"><span style="font-size:22px;">üñº</span>Background Library</button>
        <button class="bg-action-btn" onclick="triggerImport('bg');closeSheet('bg')"><span style="font-size:22px;">üì∑</span>Upload Local Image</button>
        <div style="font-size:9px;font-weight:900;color:#555;text-transform:uppercase;letter-spacing:1.5px;margin:14px 0 10px;">Adjust</div>
        <div class="bg-slider-row">
            <span>Scale</span>
            <input type="range" id="mob-bg-scale" min="10" max="200" value="100" oninput="updateMobBg()">
            <span class="bg-val" id="mob-bg-scale-v">100%</span>
        </div>
        <div class="bg-slider-row">
            <span>Rotate</span>
            <input type="range" id="mob-bg-rotate" min="0" max="360" value="0" oninput="updateMobBg()">
            <span class="bg-val" id="mob-bg-rotate-v">0¬∞</span>
        </div>
        <div class="bg-slider-row">
            <span>X Offset</span>
            <input type="range" id="mob-bg-x" min="-50" max="50" value="0" oninput="updateMobBg()">
            <span class="bg-val" id="mob-bg-x-v">0</span>
        </div>
        <div class="bg-slider-row">
            <span>Y Offset</span>
            <input type="range" id="mob-bg-y" min="-50" max="50" value="0" oninput="updateMobBg()">
            <span class="bg-val" id="mob-bg-y-v">0</span>
        </div>
        <div style="font-size:9px;font-weight:900;color:#555;text-transform:uppercase;letter-spacing:1.5px;margin:10px 0 8px;">Filter</div>
        <div class="filter-row" id="mob-bg-filter-row"></div>
        <button onclick="resetBgSettings();closeSheet('bg')" style="width:100%;padding:11px;background:#222;border:1px solid #333;color:#aaa;border-radius:10px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:8px;">Reset Background</button>
    </div>
</div>

<!-- LAYERS SHEET -->
<div id="sheet-layers" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Layers <button class="sheet-close" onclick="closeSheet('layers')">‚úï</button></div>
    <div class="sheet-body">
        <div class="mob-layer-actions">
            <button class="mob-lay-btn" onclick="sbCopyLayer()">üìÑ Copy</button>
            <button class="mob-lay-btn" onclick="sbPasteLayer()">üìã Paste</button>
            <button class="mob-lay-btn" onclick="moveLayerZ(1)">‚¨Ü Up</button>
            <button class="mob-lay-btn" onclick="moveLayerZ(-1)">‚¨á Down</button>
        </div>
        <div id="mob-layer-list"></div>
    </div>
</div>

<!-- FRAMES SHEET -->
<div id="sheet-frames" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Frames <span id="mob-frame-label" style="font-size:12px;color:#888;font-weight:700;">1 / 1</span><button class="sheet-close" onclick="closeSheet('frames')">‚úï</button></div>
    <div class="sheet-body">
        <div class="frames-top">
            <button class="frames-top-btn accent-btn" onclick="addFrame()">+ New Frame</button>
            <button class="frames-top-btn" onclick="duplicateFrame()">‚ßâ Duplicate</button>
            <button class="frames-top-btn" onclick="deleteFrameIfSafe()">üóë Delete</button>
        </div>
        <div id="mob-frame-scroll"></div>
        <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="frames-top-btn" onclick="copyCurrentFrame()">üéû Copy Frame</button>
            <button class="frames-top-btn" onclick="pasteCurrentFrame()">üìã Paste Frame</button>
        </div>
    </div>
</div>

<!-- FX SHEET -->
<div id="sheet-fx" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">üé® FX <button class="sheet-close" onclick="closeSheet('fx')">‚úï</button></div>
    <div class="sheet-body">
        <div style="font-size:11px;color:#555;font-weight:700;margin-bottom:12px;" id="fx-selected-hint">Select a layer first</div>
        <div class="fx-sheet-section">
            <div class="fx-sheet-label">Blur</div>
            <div class="fx-chip-row">
                <button class="fx-chip active" id="fx-blur-none" onclick="setFxBlur('none')">None</button>
                <button class="fx-chip" id="fx-blur-soft" onclick="setFxBlur('soft')">Soft</button>
                <button class="fx-chip" id="fx-blur-pixel" onclick="setFxBlur('pixel')">Pixelate</button>
            </div>
            <div id="fx-blur-amt-row" style="display:none;margin-top:10px;" class="bg-slider-row">
                <span>Amount</span>
                <input type="range" id="fx-blur-amt" min="1" max="20" value="4" oninput="applyFxToSelected()">
                <span class="bg-val" id="fx-blur-amt-val">4px</span>
            </div>
        </div>
        <div class="fx-sheet-section">
            <div class="fx-sheet-label">Filter</div>
            <div class="fx-chip-row" id="fx-filter-row"></div>
        </div>
        <div class="fx-sheet-section">
            <div class="fx-sheet-label">Opacity</div>
            <div class="bg-slider-row">
                <span>Opacity</span>
                <input type="range" id="fx-opacity" min="10" max="100" value="100" oninput="applyFxToSelected()">
                <span class="bg-val" id="fx-opacity-val">100%</span>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button onclick="clearFxFromSelected()" style="flex:1;padding:10px;background:#222;color:#aaa;border:none;border-radius:10px;font-weight:700;cursor:pointer;">Clear FX</button>
            <button onclick="closeSheet('fx')" style="flex:1;padding:10px;background:var(--teal);color:#000;border:none;border-radius:10px;font-weight:800;cursor:pointer;">Done</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ TRANSFORM SHEET BACKDROP (tap outside to close) ‚îÄ‚îÄ -->
<div id="transform-sheet-backdrop" onclick="closeTransformSheet()"></div>

<!-- ‚îÄ‚îÄ TRANSFORM SHEET (pops above bottom bar when layer selected) ‚îÄ‚îÄ -->
<div id="transform-sheet">
    <div class="ts-handle"></div>
    <div style="padding:0 0 16px;">
        <div class="ts-title">
            <span>Transform</span>
            <button onclick="closeTransformSheet()" style="background:none;border:none;color:#555;font-size:16px;cursor:pointer;">‚úï</button>
        </div>
        <div class="ts-row">
            <span class="ts-label">Scale</span>
            <input type="range" id="size-slider" min="20" max="1000" value="200" oninput="document.getElementById('size-num').value=this.value;applyTransform&&applyTransform()">
            <input type="number" id="size-num" class="ts-num" value="200" min="20" max="1000" oninput="document.getElementById('size-slider').value=Math.min(1000,Math.max(20,+this.value||20));applyTransform&&applyTransform()">
        </div>
        <div class="ts-row">
            <span class="ts-label">Rotate</span>
            <input type="range" id="rotate-slider" min="0" max="360" value="0" oninput="document.getElementById('rotate-num').value=this.value;applyTransform&&applyTransform()">
            <input type="number" id="rotate-num" class="ts-num" value="0" min="0" max="360" oninput="document.getElementById('rotate-slider').value=Math.min(360,Math.max(0,+this.value||0));applyTransform&&applyTransform()">
        </div>

        <!-- Text options (shown only for text/bubble layers) -->
        <div id="text-settings" class="ts-text-section" style="display:none;">
            <input type="text" id="text-content-input" class="pub-input" placeholder="Edit text..." oninput="updateTextProp('content',this.value)" style="margin-bottom:8px;">
            <select id="font-family-select" class="pub-input" onchange="updateTextProp('fontFamily',this.value)" style="margin-bottom:8px;">
                <option value="'Inter', sans-serif">Standard</option>
                <option value="'Bangers', cursive">Bangers (Comic)</option>
                <option value="'Comic Neue', cursive">Comic Neue</option>
                <option value="'Kalam', cursive">Kalam (Hand)</option>
                <option value="'Permanent Marker', cursive">Marker</option>
                <option value="'Creepster', cursive">Horror</option>
                <option value="'Luckiest Guy', cursive">Luckiest Guy</option>
                <option value="'Orbitron', sans-serif">Sci-Fi</option>
                <option value="'Caveat', cursive">Caveat</option>
                <option value="'Pacifico', cursive">Pacifico</option>
                <option value="'Bebas Neue', cursive">Bebas Neue</option>
            </select>
            <div class="ts-row">
                <span class="ts-label">Size</span>
                <input type="range" id="font-size-slider" min="10" max="120" value="28" oninput="document.getElementById('font-size-num').value=this.value;updateTextProp('fontSize',this.value)">
                <input type="number" id="font-size-num" class="ts-num" value="28" oninput="document.getElementById('font-size-slider').value=+this.value;updateTextProp('fontSize',this.value)">
            </div>
            <div class="ts-text-format">
                <button class="ts-fmt-btn" id="fmt-bold" onclick="toggleTextFmt('bold')"><b>B</b></button>
                <button class="ts-fmt-btn" id="fmt-italic" onclick="toggleTextFmt('italic')"><i>I</i></button>
                <button class="ts-fmt-btn" id="fmt-underline" onclick="toggleTextFmt('underline')"><u>U</u></button>
                <button class="ts-fmt-btn" style="flex:none;padding:8px 12px;" onclick="document.getElementById('ts-text-color-input').click()">üé®</button>
                <input type="color" id="ts-text-color-input" value="#000000" style="display:none;" oninput="if(activeLayer){activeLayer.color=this.value;render();}">
            </div>
            <!-- Bubble style mini grid (shown for bubbles) -->
            <div id="bubble-style-change-row" style="display:none;margin-top:10px;">
                <div style="font-size:9px;font-weight:900;color:#555;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Bubble Style</div>
                <div id="bubble-style-mini-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;"></div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                    <span style="font-size:10px;font-weight:900;color:#555;">BG</span>
                    <input type="color" id="bubble-bg-color" value="#ffffff" oninput="if(activeLayer){activeLayer.bubbleBg=this.value;render();}" style="flex:1;height:30px;border-radius:6px;border:1px solid #333;background:none;cursor:pointer;">
                    <span style="font-size:10px;font-weight:900;color:#555;">BORDER</span>
                    <input type="color" id="bubble-border-color" value="#000000" oninput="if(activeLayer){activeLayer.bubbleBorderColor=this.value;render();}" style="flex:1;height:30px;border-radius:6px;border:1px solid #333;background:none;cursor:pointer;">
                </div>
            </div>
        </div>

        <!-- Sprite name tag -->
        <div id="sprite-nametag-row" style="display:none;border-top:1px solid #2c2c2e;padding-top:12px;margin-top:4px;">
            <div style="font-size:9px;font-weight:900;color:#555;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Private Name Tag</div>
            <input type="text" id="sprite-nametag-input" placeholder="Your label (only you see this)" class="pub-input" oninput="updateNameTag(this.value)" style="margin-bottom:8px;">
            <button onclick="saveSpriteToPersonal()" style="width:100%;padding:10px;background:#0a1a2a;border:1px solid var(--teal);color:var(--teal);border-radius:10px;font-weight:800;font-size:12px;cursor:pointer;">üíæ Save to Your Sprites</button>
        </div>

        <div class="ts-actions">
            <button class="ts-act-btn" id="ts-swap-btn" onclick="editCurrentSpriteAction()" style="display:none;">üîÑ Swap</button>
            <button class="ts-act-btn" onclick="flipHorizontal()">‚Üî Flip</button>
            <button class="ts-act-btn" onclick="resetTransform()">‚Ü∫ Reset</button>
            <button class="ts-act-btn danger" onclick="deleteLayer()">üóë Del</button>
            <button class="ts-act-btn done" onclick="closeTransformSheet()">‚úì Done</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ HIDDEN INPUTS ‚îÄ‚îÄ -->
<input type="file" id="img-input" hidden accept="image/*">
<input type="file" id="cover-input" hidden accept="image/*" onchange="handleCoverInput(event)">

<!-- ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ -->

<!-- TOP BAR -->
<div id="top-bar">
    <button class="tb-btn" onclick="handleExit()">‚Üê Exit</button>
    <button class="tb-btn" onclick="undo()" title="Undo">‚Ü©</button>
    <button class="tb-btn" onclick="redo()" title="Redo">‚Ü™</button>
    <div class="tb-spacer"></div>
    <span id="frame-counter">1 / 1</span>
    <div class="tb-spacer"></div>
    <button class="tb-btn" onclick="saveOffline(false)">üíæ</button>
    <button class="tb-btn" onclick="openDraftsModal()" title="Drafts">üìÇ</button>
    <button class="tb-btn" onclick="toggleHideUI()" title="Hide UI">üëÅ</button>
    <button class="tb-btn accent" onclick="openPublishModal()">Publish</button>
</div>
<!-- Tap-to-show bar when UI is hidden -->
<div id="hidden-ui-bar" style="display:none; position:fixed; top:0; left:0; right:0; height:38px; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
    <button onclick="toggleHideUI()" style="background:var(--accent);color:#000;border:none;padding:5px 24px;border-radius:20px;font-weight:900;font-size:12px;font-family:inherit;cursor:pointer;">TAP TO SHOW UI</button>
</div>

<!-- CANVAS VIEWPORT -->
<div id="viewport" onclick="handleViewportClick(event)">
    <div id="canvas-container">
        <canvas id="onion-skin-canvas" width="900" height="900"></canvas>
        <div id="comic-frame" onclick="deselectLayer(event)"></div>
        <div id="global-frame-indicator"></div>
    </div>
</div>

<!-- BOTTOM BAR -->
<div id="bottom-bar">
    <button class="bot-btn" onclick="openSheet('add')">
        <img src="https://media.discordapp.net/attachments/1472088820584419450/1475738268531294349/Untitled50_20260224001655.png?ex=699f3c9d&is=699deb1d&hm=3e952823d71a8451fd45b94c2a8e2f5b92e693d9ca2cb3e79869c1bb5a4945f2&=&format=webp&quality=lossless" class="bot-custom-icon" alt="add">Add
    </button>
    <button class="bot-btn" onclick="openSheet('sprites')">
        <img src="https://cdn.discordapp.com/attachments/1472088820584419450/1475305408464818337/IMG_1798.png?ex=699d00bb&is=699baf3b&hm=7564f665aa8167ab0088952702c05ee4dfe9b0446813b7e59552ac07ceea1f7d&" class="bot-custom-icon" alt="sprites">Sprites
    </button>
    <button class="bot-btn" onclick="openSheet('bg')">
        <img src="https://media.discordapp.net/attachments/1472088820584419450/1476014886181011567/Untitled.png?ex=699f957b&is=699e43fb&hm=e0df44f7e1e168ec27e6204f00a5f2b985e41df4020cbbf0865ac8ab79ede02c&=&format=webp&quality=lossless" class="bot-custom-icon" alt="bg">BG
    </button>
    <button class="bot-btn" onclick="openSheet('layers')">
        <img src="https://media.discordapp.net/attachments/1472088820584419450/1475735904231620699/Untitled50_20260224000728.png?ex=699f3a69&is=699de8e9&hm=a81ad82f44163fe2a2afbe9046d3ed4b0a81f5cd69f3fdcba041a94084b12c2b&=&format=webp&quality=lossless" class="bot-custom-icon" alt="layers">Layers
    </button>
    <button class="bot-btn" onclick="openSheet('frames')">
        <span class="bico">üéû</span>Frames
    </button>
    <button class="bot-btn" onclick="sbEditAction()">
        <img src="https://media.discordapp.net/attachments/1472088820584419450/1475740938910568600/Untitled50_20260224002716.png?ex=699f3f19&is=699ded99&hm=30eaf2b064268c3e30d7bea8fb0a52fcff552c42c5c1500ec8a89586b51cce0a&=&format=webp&quality=lossless" class="bot-custom-icon" alt="edit">Edit
    </button>
    <button class="bot-btn" onclick="openSheet('fx')">
        <img src="https://media.discordapp.net/attachments/1472088820584419450/1475743931755925720/Untitled50_20260224003926.png?ex=699f41e3&is=699df063&hm=73efb25b11c45a422741bc6f84621181e94aa3d39f92e261ad2b5f836ddb3a66&=&format=webp&quality=lossless" class="bot-custom-icon" alt="fx">FX
    </button>
    <button class="bot-btn" id="onion-bot-btn" onclick="toggleOnionMobile()">
        <span class="bico">üßÖ</span>Onion
    </button>
    <button class="bot-btn" onclick="openExportModal()">
        <span class="bico">‚¨Ü</span>Export
    </button>
</div>

<!-- ‚îÄ‚îÄ HIDDEN LEGACY DIVS FOR JS COMPAT ‚îÄ‚îÄ -->
<div id="plus-menu" style="display:none!important;"></div>
<div id="layer-menu" style="display:none!important;"></div>
<div id="transform-ui" style="display:none!important;"></div>
<div id="bg-edit-panel" style="display:none!important;"></div>
<div id="fx-panel" style="display:none!important;"></div>
<div id="frame-strip" style="display:none!important;"></div>
<div id="frame-drawer" style="display:none!important;"></div>
<!-- Legacy ids for JS functions that reference them -->
<div id="sb-sprite-grid" style="display:none;"></div>
<div id="sb-layer-list" style="display:none;"></div>
<div id="thumb-container" style="display:none;"></div>
<div id="frame-label" style="display:none;"></div>
<div id="left-sidebar" style="display:none!important;"></div>
<div id="sidebar-panel" style="display:none!important;"></div>
<div id="ui-reveal-btn" style="display:none!important;"></div>
<div id="edit-action-btn" style="display:none!important;"></div>
<div id="onion-skin-control" style="display:none!important;"></div>
<div id="onion-toggle-wrap" style="display:none;"></div>
<input type="checkbox" id="onion-toggle" style="display:none;">
<div id="editor-prefs-panel" style="display:none!important;"></div>
<input id="pos-x-input" style="display:none;">
<input id="pos-y-input" style="display:none;">

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const _supabase = supabase.createClient('https://mmycqeejhguzhtzkyjaj.supabase.co','sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE');

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let frames = [{ layers: [], background: '#ffffff' }];
let currentIdx = 0;
let history = [], redoStack = [];
let activeLayer = null;
let selectedLayers = [];
let cropper = null;
let currentImportType = null;
let hasUnsavedChanges = false;
let activeDraftId = null;
let editingComicId = null;
let finalCoverBase64 = null;
let frameClipboard = null;
let canvasRatio = { w: 1, h: 1 };
let sidebarSprites = null;

const canvas = document.getElementById('comic-frame');
const onionCanvas = document.getElementById('onion-skin-canvas');
const onionCtx = onionCanvas.getContext('2d');

// ‚îÄ‚îÄ RATIO + CANVAS SIZE ‚îÄ‚îÄ
function setRatio(w, h) {
    canvasRatio = { w, h };
    localStorage.setItem('cc-active-ratio', JSON.stringify({ w, h }));
    const vp = document.getElementById('viewport');
    const vpW = vp.clientWidth - 24;
    const vpH = vp.clientHeight - 24;
    let cw, ch;
    if (w / h > vpW / vpH) { cw = vpW; ch = Math.round(vpW * h / w); }
    else { ch = vpH; cw = Math.round(vpH * w / h); }
    canvas.style.width = cw + 'px';
    canvas.style.height = ch + 'px';
    onionCanvas.width = cw; onionCanvas.height = ch;
    render();
}

// ‚îÄ‚îÄ SHEET SYSTEM ‚îÄ‚îÄ
function openSheet(name) {
    closeAllSheets();
    document.getElementById('sheet-overlay').classList.add('open');
    document.getElementById('sheet-' + name).classList.add('open');
    if (name === 'sprites' && !sidebarSprites) loadMobSprites();
    if (name === 'layers') renderMobLayers();
    if (name === 'frames') renderMobFrames();
    if (name === 'bg') syncBgSliders();
    if (name === 'fx') syncFxPanel();
}
function closeSheet(name) {
    document.getElementById('sheet-overlay').classList.remove('open');
    document.getElementById('sheet-' + name).classList.remove('open');
}
function closeAllSheets() {
    document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
    document.getElementById('sheet-overlay').classList.remove('open');
}

// ‚îÄ‚îÄ TRANSFORM SHEET ‚îÄ‚îÄ
function openTransformSheet() {
    if (!activeLayer) return;
    document.getElementById('transform-sheet').classList.add('open');
    document.getElementById('transform-sheet-backdrop').classList.add('open');
    syncTransformSheet();
}
function closeTransformSheet() {
    document.getElementById('transform-sheet').classList.remove('open');
    document.getElementById('transform-sheet-backdrop').classList.remove('open');
}
function syncTransformSheet() {
    if (!activeLayer) return;
    document.getElementById('size-slider').value = activeLayer.w || 200;
    document.getElementById('size-num').value = activeLayer.w || 200;
    document.getElementById('rotate-slider').value = activeLayer.rotation || 0;
    document.getElementById('rotate-num').value = activeLayer.rotation || 0;

    const isText = ['text','bubble','thinking','subtitle'].includes(activeLayer.type);
    document.getElementById('text-settings').style.display = isText ? 'block' : 'none';
    document.getElementById('sprite-nametag-row').style.display = activeLayer.type === 'img' ? 'flex' : 'none';
    document.getElementById('sprite-nametag-row').style.flexDirection = 'column';

    if (isText) {
        document.getElementById('text-content-input').value = activeLayer.content || '';
        if (activeLayer.fontFamily) document.getElementById('font-family-select').value = activeLayer.fontFamily;
        if (activeLayer.fontSize) {
            document.getElementById('font-size-slider').value = activeLayer.fontSize;
            document.getElementById('font-size-num').value = activeLayer.fontSize;
        }
    }
    const isBubble = ['bubble','thinking'].includes(activeLayer.type);
    document.getElementById('bubble-style-change-row').style.display = isBubble ? 'block' : 'none';
    if (isBubble) renderBubbleMiniGrid();

    // Show Swap button only for sprite layers that have packData (i.e. from the sprite library)
    const swapBtn = document.getElementById('ts-swap-btn');
    if (swapBtn) swapBtn.style.display = (activeLayer.type === 'img' && activeLayer.packData) ? 'inline-flex' : 'none';

    if (activeLayer.type === 'img' && activeLayer.packData) {
        document.getElementById('sprite-nametag-input').value = activeLayer.nameTag || '';
    }
}

function toggleTextFmt(prop) {
    if (!activeLayer) return;
    saveState();
    if (prop === 'bold') activeLayer.bold = !activeLayer.bold;
    if (prop === 'italic') activeLayer.italic = !activeLayer.italic;
    if (prop === 'underline') activeLayer.underline = !activeLayer.underline;
    document.getElementById('fmt-' + prop).classList.toggle('active', !!activeLayer[prop]);
    render();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render() {
    canvas.innerHTML = '';
    const f = frames[currentIdx];
    const bg = f.background || '#ffffff';
    const isImg = bg.startsWith('http') || bg.startsWith('data:image');
    const isGrad = bg.startsWith('linear-gradient') || bg.startsWith('radial-gradient');
    if (isImg) { canvas.style.backgroundColor = 'transparent'; canvas.style.backgroundImage = `url(${bg})`; }
    else if (isGrad) { canvas.style.backgroundColor = 'transparent'; canvas.style.backgroundImage = bg; }
    else { canvas.style.backgroundColor = bg; canvas.style.backgroundImage = 'none'; }

    const s = f.bgSettings || {};
    const scale = s.scale ?? 100, rotate = s.rotate ?? 0, xOff = s.x ?? 0, yOff = s.y ?? 0, filter = s.filter || 'none';
    if (isImg || isGrad) {
        canvas.style.backgroundSize = isGrad ? 'cover' : scale + '%';
        canvas.style.backgroundPosition = (50 + xOff) + '% ' + (50 + yOff) + '%';
        canvas.style.filter = filter === 'none' ? '' : filter;
        if (rotate !== 0) {
            const bgDiv = document.createElement('div');
            const bgContent = isImg ? `url(${bg})` : bg;
            bgDiv.style.cssText = `position:absolute;top:-60%;left:-60%;width:220%;height:220%;background:${bgContent};background-size:${isImg ? (scale*2.2)+'%' : 'cover'};background-position:center;background-repeat:no-repeat;transform:rotate(${rotate}deg);pointer-events:none;z-index:0;filter:${filter==='none'?'none':filter};transform-origin:center center;`;
            canvas.style.backgroundImage = 'none'; canvas.style.backgroundColor = 'transparent'; canvas.style.filter = '';
            canvas.insertBefore(bgDiv, canvas.firstChild);
        }
    } else { canvas.style.backgroundSize = ''; canvas.style.backgroundPosition = ''; canvas.style.filter = ''; }

    // onion skin
    const onionOn = document.getElementById('onion-toggle').checked;
    if (onionOn && currentIdx > 0) {
        onionCanvas.style.display = 'block';
        onionCtx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
        const prevFrame = frames[currentIdx - 1];
        onionCtx.globalAlpha = parseFloat(document.getElementById('onion-opacity').value);
        prevFrame.layers.forEach(l => {
            if (l.type === 'img') {
                const img = new Image(); img.src = l.src;
                const draw = () => { onionCtx.save(); const h = l.w * (img.naturalHeight / img.naturalWidth); onionCtx.translate(l.x+l.w/2,l.y+h/2); onionCtx.rotate((l.rotation||0)*Math.PI/180); if(l.flipped)onionCtx.scale(-1,1); onionCtx.drawImage(img,-l.w/2,-h/2,l.w,h); onionCtx.restore(); };
                if (img.complete) draw(); else img.onload = draw;
            }
        });
    } else { onionCanvas.style.display = 'none'; }

    f.layers.forEach((layer, idx) => {
        const el = document.createElement('div');
        el.className = 'layer' + (layer === activeLayer ? ' active' : '');
        el.style.zIndex = idx;
        el.dataset.layerId = layer.id;

        if (layer.type === 'img') {
            const img = document.createElement('img');
            img.src = layer.src;
            img.draggable = false;
            img.style.cssText = `width:${layer.w}px;display:block;user-select:none;`;
            if (layer.flipped) img.style.transform = `rotate(${layer.rotation||0}deg) scaleX(-1)`;
            else img.style.transform = `rotate(${layer.rotation||0}deg)`;
            if (layer.blurType === 'soft') img.style.filter = `blur(${layer.blurAmt||4}px)`;
            else if (layer.blurType === 'pixel') img.style.filter = `blur(0px)`;
            if (layer.fxFilter && layer.fxFilter !== 'none') img.style.filter = (img.style.filter ? img.style.filter + ' ' : '') + layer.fxFilter;
            if (layer.fxOpacity !== undefined) img.style.opacity = layer.fxOpacity / 100;
            if (layer.nameTag) { const nt = document.createElement('div'); nt.className = 'sprite-nametag'; nt.innerText = layer.nameTag; el.appendChild(nt); }
            el.appendChild(img);
        } else if (layer.type === 'bubble' || layer.type === 'thinking') {
            const bub = document.createElement('div');
            bub.className = 'speech-bubble bubble-style-' + (layer.bubbleStyle || 'round');
            bub.style.cssText = `width:${layer.w||120}px;font-size:${layer.fontSize||18}px;font-family:${layer.fontFamily||'Inter, sans-serif'};`;
            if (layer.bold) bub.style.fontWeight = '900';
            if (layer.italic) bub.style.fontStyle = 'italic';
            if (layer.underline) bub.style.textDecoration = 'underline';
            if (layer.color) bub.style.color = layer.color;
            if (layer.bubbleBg) bub.style.backgroundColor = layer.bubbleBg;
            if (layer.bubbleBorderColor) bub.style.borderColor = layer.bubbleBorderColor;
            bub.style.transform = `rotate(${layer.rotation||0}deg)`;
            if (layer.fxOpacity !== undefined) bub.style.opacity = layer.fxOpacity / 100;
            bub.innerText = layer.content || '';
            const tail = document.createElement('div'); tail.className = 'bubble-tail'; bub.appendChild(tail);
            if (layer.type === 'thinking') {
                [1,2,3].forEach(n => { const dot = document.createElement('div'); dot.className = 'thought-dot-' + n; bub.appendChild(dot); });
            }
            el.appendChild(bub);
        } else if (layer.type === 'text') {
            const t = document.createElement('div');
            t.style.cssText = `color:${layer.color||'#000'};font-size:${layer.fontSize||24}px;font-family:${layer.fontFamily||'Inter, sans-serif'};font-weight:${layer.bold?'900':'700'};font-style:${layer.italic?'italic':'normal'};text-decoration:${layer.underline?'underline':'none'};white-space:nowrap;width:${layer.w||200}px;transform:rotate(${layer.rotation||0}deg);text-align:${layer.align||'left'};`;
            if (layer.fxOpacity !== undefined) t.style.opacity = layer.fxOpacity / 100;
            t.innerText = layer.content || 'Text';
            el.appendChild(t);
        } else if (layer.type === 'subtitle') {
            const s = document.createElement('div');
            s.style.cssText = `width:${layer.w||canvas.offsetWidth}px;background:rgba(0,0,0,0.75);color:#fff;font-size:${layer.fontSize||16}px;font-family:${layer.fontFamily||'Inter, sans-serif'};padding:8px 14px;text-align:center;transform:rotate(${layer.rotation||0}deg);`;
            if (layer.fxOpacity !== undefined) s.style.opacity = layer.fxOpacity / 100;
            s.innerText = layer.content || 'Subtitle';
            el.appendChild(s);
        }

        el.style.left = (layer.x || 0) + 'px';
        el.style.top = (layer.y || 0) + 'px';
        el.style.position = 'absolute';

        // Tap selects, drag moves ‚Äî touchstart must stop propagation so viewport pinch isn't triggered
        el.addEventListener('touchstart', (e) => {
            // 2-finger on active img layer ‚Üí pinch-to-resize (NOT viewport zoom)
            if (e.touches.length === 2 && layer === activeLayer && layer.type === 'img') {
                e.preventDefault();
                e.stopPropagation();
                startTouchPinchResize(e, layer);
                return;
            }
            // For any multi-touch on an active layer, block viewport from stealing the gesture
            if (e.touches.length > 1) {
                if (layer === activeLayer) { e.preventDefault(); e.stopPropagation(); }
                return;
            }
            e.preventDefault();
            e.stopPropagation();
            selectLayerLight(layer);
            startTouchDrag(e, layer);
        }, { passive: false });
        el.addEventListener('mousedown', (e) => { e.preventDefault(); selectLayer(layer); startDrag(e, layer); });

        // Double-tap: open transform sheet
        let lastTap = 0;
        el.addEventListener('touchend', (e) => {
            if (e.changedTouches.length === 1) {
                const now = Date.now();
                if (now - lastTap < 300) { e.preventDefault(); openTransformSheet(); }
                lastTap = now;
            }
        }, { passive: false });

        // Resize handles on active sprite layer
        if (layer === activeLayer && layer.type === 'img') {
            ['tl','tr','bl','br'].forEach(corner => {
                const h = document.createElement('div');
                h.className = 'resize-handle ' + corner;
                h.textContent = corner === 'br' ? '‚§°' : corner === 'tl' ? '‚§°' : '';
                h.addEventListener('touchstart', (ev) => {
                    ev.preventDefault(); ev.stopPropagation();
                    const t0 = ev.touches[0];
                    const origW = layer.w, origX = layer.x, origY = layer.y;
                    const startClientX = t0.clientX;
                    const startClientY = t0.clientY;
                    const isLeft = (corner === 'tl' || corner === 'bl');
                    const isTop  = (corner === 'tl' || corner === 'tr');
                    const onMove = (mv) => {
                        mv.preventDefault();
                        // Use the larger of horizontal or vertical delta for more responsive feel
                        const rawDx = (mv.touches[0].clientX - startClientX) / vpScale;
                        const rawDy = (mv.touches[0].clientY - startClientY) / vpScale;
                        // For corners: use horizontal delta primarily, with diagonal boost
                        const dx = isLeft
                            ? -(Math.abs(rawDx) > Math.abs(rawDy) ? rawDx : -rawDy)
                            :  (Math.abs(rawDx) > Math.abs(rawDy) ? rawDx :  rawDy);
                        const newW = Math.max(30, Math.round(origW + (isLeft ? -dx : dx)));
                        layer.w = newW;
                        if (isLeft) layer.x = origX + (origW - newW);
                        // sync slider if transform sheet is open
                        const sl = document.getElementById('size-slider');
                        if (sl) { sl.value = newW; const sn = document.getElementById('size-num'); if (sn) sn.value = newW; }
                        render();
                    };
                    const onUp = () => {
                        document.removeEventListener('touchmove', onMove);
                        document.removeEventListener('touchend', onUp);
                    };
                    document.addEventListener('touchmove', onMove, { passive: false });
                    document.addEventListener('touchend', onUp);
                }, { passive: false });
                el.appendChild(h);
            });
        }

        canvas.appendChild(el);
    });

    // update mobile UI
    document.getElementById('frame-counter').innerText = (currentIdx + 1) + ' / ' + frames.length;
    document.getElementById('mob-frame-label') && (document.getElementById('mob-frame-label').innerText = (currentIdx + 1) + ' / ' + frames.length);
    if (document.getElementById('global-frame-indicator')) {
        const fi = document.getElementById('global-frame-indicator');
        fi.innerText = 'FRAME ' + (currentIdx + 1);
        fi.style.display = frames.length > 1 ? 'block' : 'none';
    }
    hasUnsavedChanges = true;
}

function selectLayer(layer) {
    activeLayer = layer;
    selectedLayers = [layer];
    render();
}

function selectLayerLight(layer) {
    activeLayer = layer;
    selectedLayers = [layer];
    document.querySelectorAll('.layer').forEach(function(el) {
        el.classList.toggle('active', el.dataset.layerId == layer.id);
    });
}

// ‚îÄ‚îÄ TOUCH DRAG ‚îÄ‚îÄ
function startTouchDrag(e, layer) {
    if (e.touches.length > 1) return;
    saveState();
    var touch = e.touches[0];
    var fingerStartX = touch.clientX;
    var fingerStartY = touch.clientY;
    var layerStartX = layer.x;
    var layerStartY = layer.y;
    var hasMoved = false;
    var move = function(me) {
        if (me.touches.length > 1) {
            document.removeEventListener('touchmove', move);
            document.removeEventListener('touchend', up);
            return;
        }
        me.preventDefault();
        hasMoved = true;
        var t = me.touches[0];
        var dx = (t.clientX - fingerStartX) / vpScale;
        var dy = (t.clientY - fingerStartY) / vpScale;
        layer.x = layerStartX + dx;
        layer.y = layerStartY + dy;
        var el = document.querySelector('.layer[data-layerId="' + layer.id + '"]');
        if (el) { el.style.left = layer.x + 'px'; el.style.top = layer.y + 'px'; }
    };
    var up = function() {
        document.removeEventListener('touchmove', move);
        document.removeEventListener('touchend', up);
        if (hasMoved) render();
    };
    document.addEventListener('touchmove', move, { passive: false });
    document.addEventListener('touchend', up);
}

// ‚îÄ‚îÄ TOUCH PINCH RESIZE (2-finger spread/pinch on active sprite) ‚îÄ‚îÄ
function startTouchPinchResize(e, layer) {
    saveState();
    const t0 = e.touches[0], t1 = e.touches[1];
    const startDist = Math.hypot(t1.clientX - t0.clientX, t1.clientY - t0.clientY);
    if (startDist < 5) return;
    const origW = layer.w;

    const onMove = (mv) => {
        if (mv.touches.length < 2) return;
        mv.preventDefault();
        mv.stopPropagation();
        const a = mv.touches[0], b = mv.touches[1];
        const dist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
        const scale = dist / startDist;
        layer.w = Math.max(30, Math.round(origW * scale));
        // Sync transform sheet slider if open
        const sl = document.getElementById('size-slider');
        if (sl) { sl.value = layer.w; const sn = document.getElementById('size-num'); if (sn) sn.value = layer.w; }
        render();
    };
    const onUp = (ev) => {
        if (ev.touches.length < 2) {
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
        }
    };
    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend', onUp);
}
function startDrag(e, layer) {
    saveState();
    const cR0 = canvas.getBoundingClientRect();
    let startX = e.clientX - cR0.left - layer.x, startY = e.clientY - cR0.top - layer.y;
    let moved = false;
    const move = (me) => { moved = true; const cR = canvas.getBoundingClientRect(); const lW = layer.w||100, lH=layer.h||(layer.fontSize?layer.fontSize*2:80); layer.x=Math.min(Math.max(me.clientX-cR.left-startX,0),cR.width-lW); layer.y=Math.min(Math.max(me.clientY-cR.top-startY,0),cR.height-lH); render(); };
    const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', up);
}

function deselectLayer(e) {
    // Close transform sheet and deselect when tapping the canvas itself (not a layer)
    if (e.target === canvas || e.target === document.getElementById('canvas-container') || e.target === document.getElementById('viewport')) {
        activeLayer = null; selectedLayers = []; closeTransformSheet(); render();
    }
}
function handleViewportClick(e) {
    // Tapping the viewport background (outside the canvas) also deselects
    if (e.target === document.getElementById('viewport') || e.target === document.getElementById('canvas-container')) {
        activeLayer = null; selectedLayers = []; closeTransformSheet(); render();
    }
    // Also close bottom sheets if open
    if (e.target === document.getElementById('sheet-overlay')) closeAllSheets();
}

// ‚îÄ‚îÄ UNDO / REDO ‚îÄ‚îÄ
function saveState() {
    history.push(JSON.stringify(frames));
    if (history.length > 60) history.shift();
    redoStack = [];
}
function undo() { if (!history.length) return; redoStack.push(JSON.stringify(frames)); frames = JSON.parse(history.pop()); if (currentIdx >= frames.length) currentIdx = frames.length - 1; activeLayer = null; render(); }
function redo() { if (!redoStack.length) return; history.push(JSON.stringify(frames)); frames = JSON.parse(redoStack.pop()); activeLayer = null; render(); }

// ‚îÄ‚îÄ FRAMES ‚îÄ‚îÄ
function addFrame() { saveState(); frames.splice(currentIdx + 1, 0, { layers: [], background: '#ffffff' }); currentIdx++; activeLayer = null; render(); renderMobFrames(); }
function duplicateFrame() { saveState(); const copy = JSON.parse(JSON.stringify(frames[currentIdx])); copy.layers = copy.layers.map(l => ({ ...l, id: Date.now() + Math.random() })); frames.splice(currentIdx + 1, 0, copy); currentIdx++; render(); renderMobFrames(); }
function deleteFrameIfSafe() { if (frames.length === 1) { alert('Cannot delete the only frame.'); return; } saveState(); frames.splice(currentIdx, 1); if (currentIdx >= frames.length) currentIdx = frames.length - 1; activeLayer = null; render(); renderMobFrames(); }
function prevFrame() { if (currentIdx > 0) { currentIdx--; activeLayer = null; render(); } }
function nextFrame() { if (currentIdx < frames.length - 1) { currentIdx++; activeLayer = null; render(); } }
function goToFrame(i) { if (i >= 0 && i < frames.length) { currentIdx = i; activeLayer = null; render(); renderMobFrames(); closeSheet('frames'); } }
function copyCurrentFrame() { frameClipboard = JSON.parse(JSON.stringify(frames[currentIdx])); }
function pasteCurrentFrame() { if (!frameClipboard) return; saveState(); const copy = JSON.parse(JSON.stringify(frameClipboard)); copy.layers = copy.layers.map(l => ({...l, id: Date.now() + Math.random()})); frames.splice(currentIdx + 1, 0, copy); currentIdx++; render(); renderMobFrames(); }

function renderMobFrames() {
    const scroll = document.getElementById('mob-frame-scroll');
    if (!scroll) return;
    scroll.innerHTML = '';
    frames.forEach((f, i) => {
        const thumb = document.createElement('div');
        thumb.className = 'mob-frame-thumb' + (i === currentIdx ? ' active' : '');
        thumb.style.background = (f.background && !f.background.startsWith('http') && !f.background.startsWith('data:')) ? f.background : '#222';
        if (f.background && (f.background.startsWith('http') || f.background.startsWith('data:'))) thumb.style.backgroundImage = `url(${f.background})`;
        thumb.innerHTML = `<span>${i + 1}</span>`;
        thumb.onclick = () => goToFrame(i);
        const del = document.createElement('button');
        del.className = 'mob-frame-del'; del.innerText = '‚úï';
        del.onclick = (e) => { e.stopPropagation(); if (frames.length === 1) { alert('Cannot delete only frame.'); return; } saveState(); frames.splice(i, 1); if (currentIdx >= frames.length) currentIdx = frames.length - 1; activeLayer = null; render(); renderMobFrames(); };
        thumb.appendChild(del);
        scroll.appendChild(thumb);
    });
    if (document.getElementById('mob-frame-label')) document.getElementById('mob-frame-label').innerText = (currentIdx + 1) + ' / ' + frames.length;
}

// ‚îÄ‚îÄ LAYERS ‚îÄ‚îÄ
function renderMobLayers() {
    const list = document.getElementById('mob-layer-list');
    if (!list) return;
    list.innerHTML = '';
    const f = frames[currentIdx];
    if (!f.layers.length) { list.innerHTML = '<div style="color:#555;text-align:center;padding:20px;font-size:13px;">No layers yet</div>'; return; }
    [...f.layers].reverse().forEach((layer, ri) => {
        const i = f.layers.length - 1 - ri;
        const item = document.createElement('div');
        item.className = 'mob-layer-item' + (layer === activeLayer ? ' active-l' : '');
        const ico = layer.type === 'img' ? 'üñº' : layer.type === 'bubble' ? 'üí¨' : layer.type === 'thinking' ? 'üí≠' : layer.type === 'subtitle' ? 'üìã' : '‚úçÔ∏è';
        item.innerHTML = `<span style="font-size:20px;flex-shrink:0;">${ico}</span><div class="l-info"><div class="l-name">${layer.nameTag || (layer.content ? layer.content.substring(0,16) : (layer.type + ' ' + (i+1)))}</div><div class="l-type">${layer.type}</div></div>`;
        item.onclick = () => { activeLayer = layer; render(); renderMobLayers(); };
        // Support both double-click (PC) and double-tap (mobile) to open transform
        item.ondblclick = () => openTransformSheet();
        let layerItemLastTap = 0;
        item.addEventListener('touchend', () => {
            const now = Date.now();
            if (now - layerItemLastTap < 300) openTransformSheet();
            layerItemLastTap = now;
        });
        const del = document.createElement('button'); del.className = 'l-del'; del.innerText = 'üóë';
        del.onclick = (e) => { e.stopPropagation(); saveState(); f.layers.splice(i, 1); if (activeLayer === layer) activeLayer = null; render(); renderMobLayers(); };
        item.appendChild(del);
        list.appendChild(item);
    });
}

function deleteLayer() { if (!activeLayer) return; saveState(); const f = frames[currentIdx]; f.layers = f.layers.filter(l => l !== activeLayer); activeLayer = null; closeTransformSheet(); render(); renderMobLayers(); }
function flipHorizontal() { if (!activeLayer) return; saveState(); activeLayer.flipped = !activeLayer.flipped; render(); }
function resetTransform() { if (!activeLayer) return; saveState(); activeLayer.w = 200; activeLayer.rotation = 0; activeLayer.flipped = false; syncTransformSheet(); render(); }
function moveLayerZ(dir) { if (!activeLayer) return; saveState(); const layers = frames[currentIdx].layers; const idx = layers.findIndex(l => l.id === activeLayer.id); if (dir > 0 && idx < layers.length - 1) [layers[idx], layers[idx+1]] = [layers[idx+1], layers[idx]]; else if (dir < 0 && idx > 0) [layers[idx], layers[idx-1]] = [layers[idx-1], layers[idx]]; render(); }

function sbCopyLayer() { if (activeLayer) { window._layerClipboard = JSON.parse(JSON.stringify(activeLayer)); } }
function sbPasteLayer() { if (!window._layerClipboard) return; saveState(); const copy = { ...JSON.parse(JSON.stringify(window._layerClipboard)), id: Date.now(), x: (window._layerClipboard.x || 0) + 20, y: (window._layerClipboard.y || 0) + 20 }; frames[currentIdx].layers.push(copy); activeLayer = copy; render(); renderMobLayers(); }
function updateTextProp(prop, value) { if (activeLayer && ['bubble','thinking','text','subtitle'].includes(activeLayer.type)) { activeLayer[prop] = (prop === 'fontSize') ? parseInt(value) : value; render(); } }
function updateNameTag(val) { if (activeLayer) { activeLayer.nameTag = val; render(); } }
function clearNameTag() { if (activeLayer) { activeLayer.nameTag = ''; document.getElementById('sprite-nametag-input').value = ''; render(); } }

// ‚îÄ‚îÄ APPLY TRANSFORM ‚îÄ‚îÄ
function applyTransform() {
    if (!activeLayer) return;
    const w = parseInt(document.getElementById('size-slider').value);
    const r = parseInt(document.getElementById('rotate-slider').value);
    activeLayer.w = w; activeLayer.rotation = r;
    render();
}

// ‚îÄ‚îÄ SPRITES ‚îÄ‚îÄ
let allSidebarMeta = [];
async function loadMobSprites() {
    const grid = document.getElementById('mob-sprite-grid');
    grid.innerHTML = '<div style="color:#555;text-align:center;padding:20px;grid-column:span 3;font-size:12px;">Loading...</div>';
    const { data } = await _supabase.from('sprites_library').select('id, name, tags, creator, created_at').order('created_at', { ascending: false });
    sidebarSprites = data || [];
    allSidebarMeta = sidebarSprites;
    renderMobSpriteGrid(sidebarSprites);
}

function renderMobSpriteGrid(sprites) {
    const grid = document.getElementById('mob-sprite-grid');
    grid.innerHTML = '';
    sprites.forEach(pack => {
        const card = document.createElement('div');
        card.className = 'mob-sprite-card';
        card.innerHTML = `<div style="width:100%;height:100%;background:linear-gradient(90deg,#1e1e1e 25%,#2a2a2a 50%,#1e1e1e 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:8px;"></div><div class="mob-sprite-name">${pack.name}</div>`;
        card.onclick = async () => {
            const full = await sbFetchFull(pack.id);
            if (full) { closeSheet('sprites'); openActionModal({ ...pack, ...full }); }
        };
        // Lazy load image
        const observer = new IntersectionObserver(entries => {
            if (!entries[0].isIntersecting) return;
            observer.disconnect();
            sbFetchFull(pack.id).then(full => {
                if (!full) return;
                const old = card.querySelector('div');
                if (old) { const img = document.createElement('img'); img.src = full.image_data; old.replaceWith(img); }
            });
        }, { root: document.getElementById('mob-sprite-grid') });
        observer.observe(card);
        grid.appendChild(card);
    });
    if (!sprites.length) grid.innerHTML = '<div style="color:#555;text-align:center;padding:20px;grid-column:span 3;font-size:12px;">No sprites found</div>';
}

function filterMobSprites() {
    const q = document.getElementById('mob-sprite-search').value.toLowerCase();
    const filtered = allSidebarMeta.filter(s => s.name.toLowerCase().includes(q) || (s.tags || '').toLowerCase().includes(q));
    renderMobSpriteGrid(filtered);
}

// Sprite meta cache
function sbSaveMetaCache(data) { try { localStorage.setItem('sb-meta-cache', JSON.stringify({ ts: Date.now(), data })); } catch(e) {} }
function sbLoadMetaCache() { try { const c = JSON.parse(localStorage.getItem('sb-meta-cache')); if (c && Date.now() - c.ts < 600000) return c.data; } catch(e) {} return null; }
function sbGetImg(id) { try { return JSON.parse(localStorage.getItem('sb-img-' + id))?.img; } catch(e) { return null; } }
async function sbFetchFull(id) {
    const cached = sbGetImg(id);
    if (cached) {
        const meta = allSidebarMeta.find(s => s.id === id);
        if (meta) {
            const { data } = await _supabase.from('sprites_library').select('actions').eq('id', id).single();
            return { image_data: cached, actions: data?.actions || {} };
        }
    }
    const { data } = await _supabase.from('sprites_library').select('*').eq('id', id).single();
    if (data?.image_data) try { localStorage.setItem('sb-img-' + id, JSON.stringify({ img: data.image_data })); } catch(e) {}
    return data;
}

// ‚îÄ‚îÄ LIBRARY / ACTION MODALS ‚îÄ‚îÄ
async function openLibrary() {
    const grid = document.getElementById('library-grid');
    document.getElementById('library-modal').style.display = 'flex';
    const meta = sidebarSprites || sbLoadMetaCache();
    if (meta?.length) { renderLibraryGrid(grid, meta); return; }
    grid.innerHTML = "<p style='color:white;font-size:12px;'>Loading...</p>";
    const { data } = await _supabase.from('sprites_library').select('id, name, tags, creator, created_at').order('created_at', { ascending: false });
    sidebarSprites = data || [];
    renderLibraryGrid(grid, sidebarSprites);
}
function renderLibraryGrid(grid, sprites) {
    grid.innerHTML = '';
    sprites.forEach(pack => {
        const div = document.createElement('div');
        div.className = 'action-option';
        div.innerHTML = `<div style="width:100%;aspect-ratio:1;background:#1a1a1a;border-radius:6px;"></div><strong>${pack.name}</strong>`;
        div.onclick = async () => { const full = await sbFetchFull(pack.id); if (full) { closeLibrary(); openActionModal({ ...pack, ...full }); } };
        grid.appendChild(div);
    });
}
function closeLibrary() { document.getElementById('library-modal').style.display = 'none'; }
function closeActionModal() { document.getElementById('action-modal').style.display = 'none'; }
function openActionModal(pack, isEditing = false) {
    document.getElementById('pack-title').innerText = pack.name;
    const grid = document.getElementById('action-selector-list');
    grid.innerHTML = '';
    const main = createActionOption(pack.image_data, 'Default');
    main.onclick = () => handleActionSelect(pack.image_data, pack, isEditing);
    grid.appendChild(main);
    let actions = pack.actions;
    if (typeof actions === 'string') try { actions = JSON.parse(actions); } catch(e) { actions = {}; }
    const items = Array.isArray(actions) ? actions.map((img, i) => [`Action ${i+1}`, img]) : Object.entries(actions || {});
    items.forEach(([name, img]) => { const opt = createActionOption(img, name); opt.onclick = () => handleActionSelect(img, pack, isEditing); grid.appendChild(opt); });
    document.getElementById('action-modal').style.display = 'flex';
}
function createActionOption(src, name) {
    const div = document.createElement('div');
    div.className = 'action-option';
    div.innerHTML = `<img src="${src}"><strong>${name}</strong>`;
    return div;
}
function handleActionSelect(img, pack, isEditing) {
    if (isEditing && activeLayer) {
        saveState();
        // Preserve all transform so sprite stays same size/position/rotation
        const { w, rotation, x, y, flipped } = activeLayer;
        activeLayer.src = img;
        activeLayer.w = w; activeLayer.rotation = rotation;
        activeLayer.x = x; activeLayer.y = y; activeLayer.flipped = flipped;
    } else {
        addSpriteToCanvas(img, pack);
    }
    closeActionModal(); render();
}
function addSpriteToCanvas(src, pack) {
    saveState();
    const cw = canvas.offsetWidth || 300;
    const ch = canvas.offsetHeight || 300;
    const nl = { type: 'img', src, w: Math.round(cw * 0.4), x: Math.round(cw * 0.3), y: Math.round(ch * 0.3), rotation: 0, flipped: false, packData: pack, id: Date.now() };
    frames[currentIdx].layers.push(nl);
    activeLayer = nl;
}

// ‚îÄ‚îÄ TEXT / BUBBLES ‚îÄ‚îÄ
function addText(type) {
    saveState();
    const cw = canvas.offsetWidth || 300, ch = canvas.offsetHeight || 300;
    const nl = { type: 'text', content: 'Text', fontSize: 24, fontFamily: "'Inter', sans-serif", color: '#000', x: Math.round(cw*0.2), y: Math.round(ch*0.3), w: 160, rotation: 0, id: Date.now() };
    frames[currentIdx].layers.push(nl);
    activeLayer = nl;
    render(); openTransformSheet();
}
function addSubtitle() {
    saveState();
    const cw = canvas.offsetWidth || 300, ch = canvas.offsetHeight || 300;
    const nl = { type: 'subtitle', content: 'Subtitle', fontSize: 16, x: 0, y: Math.round(ch * 0.85), w: cw, rotation: 0, id: Date.now() };
    frames[currentIdx].layers.push(nl);
    activeLayer = nl;
    render();
}

// ‚îÄ‚îÄ BUBBLE PICKER ‚îÄ‚îÄ
const BUBBLE_STYLES = [
    { id: 'round', label: 'Speech', ico: 'üí¨' },
    { id: 'chat', label: 'Chat', ico: 'üó®' },
    { id: 'rect', label: 'Rect', ico: '‚¨ú' },
    { id: 'cloud', label: 'Thought', ico: 'üí≠' },
    { id: 'shout', label: 'Shout', ico: '‚ö°' },
    { id: 'whisper', label: 'Whisper', ico: 'ü§´' },
    { id: 'narrator', label: 'Narrator', ico: 'üìã' },
    { id: 'spiky', label: 'Spiky', ico: 'üí•' },
];
let selectedBubbleStyle = 'round';
let currentBubbleMode = 'speech';

function openBubblePicker(mode) {
    currentBubbleMode = mode;
    selectedBubbleStyle = 'round';
    document.getElementById('bubble-picker-title').innerText = mode === 'thinking' ? 'Thinking Bubble' : 'Speech Bubble';
    document.getElementById('bubble-picker-text').value = '';
    const grid = document.getElementById('bubble-style-grid');
    grid.innerHTML = '';
    BUBBLE_STYLES.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'bubble-preview-btn' + (s.id === selectedBubbleStyle ? ' selected' : '');
        btn.innerHTML = `<span class="bpico">${s.ico}</span><span>${s.label}</span>`;
        btn.onclick = () => { selectedBubbleStyle = s.id; grid.querySelectorAll('.bubble-preview-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); };
        grid.appendChild(btn);
    });
    document.getElementById('bubble-picker-modal').style.display = 'flex';
}
function closeBubblePicker() { document.getElementById('bubble-picker-modal').style.display = 'none'; }
function confirmBubblePicker() {
    const text = document.getElementById('bubble-picker-text').value || 'Hello!';
    saveState();
    const cw = canvas.offsetWidth || 300, ch = canvas.offsetHeight || 300;
    const nl = { type: currentBubbleMode === 'thinking' ? 'thinking' : 'bubble', content: text, fontSize: 18, fontFamily: "'Bangers', cursive", bubbleStyle: selectedBubbleStyle, x: Math.round(cw*0.15), y: Math.round(ch*0.1), w: Math.round(cw*0.5), rotation: 0, id: Date.now() };
    frames[currentIdx].layers.push(nl);
    activeLayer = nl;
    closeBubblePicker();
    render();
}
function renderBubbleMiniGrid() {
    const grid = document.getElementById('bubble-style-mini-grid');
    if (!grid) return;
    grid.innerHTML = '';
    BUBBLE_STYLES.forEach(s => {
        const btn = document.createElement('button');
        btn.style.cssText = `padding:6px 4px;background:${activeLayer?.bubbleStyle===s.id?'rgba(255,122,0,0.2)':'#1a1a1a'};border:1.5px solid ${activeLayer?.bubbleStyle===s.id?'var(--accent)':'#333'};border-radius:8px;cursor:pointer;text-align:center;font-size:9px;font-family:inherit;color:#aaa;`;
        btn.innerHTML = `<div style="font-size:16px;">${s.ico}</div>${s.label}`;
        btn.onclick = () => { if (activeLayer) { saveState(); activeLayer.bubbleStyle = s.id; render(); renderBubbleMiniGrid(); } };
        grid.appendChild(btn);
    });
}

// ‚îÄ‚îÄ BACKGROUND ‚îÄ‚îÄ
function openBackgroundSource() {
    if (canvasRatio) { localStorage.setItem('cc-bg-ratio-filter', JSON.stringify(canvasRatio)); localStorage.setItem('cc-active-ratio', JSON.stringify(canvasRatio)); }
    localStorage.setItem('cc-pending-frames', JSON.stringify({ frames, currentIdx }));
    location.href = 'backgroundsource.html';
}
function updateMobBg() {
    const scale = document.getElementById('mob-bg-scale').value;
    const rotate = document.getElementById('mob-bg-rotate').value;
    const x = document.getElementById('mob-bg-x').value;
    const y = document.getElementById('mob-bg-y').value;
    document.getElementById('mob-bg-scale-v').innerText = scale + '%';
    document.getElementById('mob-bg-rotate-v').innerText = rotate + '¬∞';
    document.getElementById('mob-bg-x-v').innerText = x;
    document.getElementById('mob-bg-y-v').innerText = y;
    frames[currentIdx].bgSettings = { ...frames[currentIdx].bgSettings, scale: parseInt(scale), rotate: parseInt(rotate), x: parseInt(x), y: parseInt(y) };
    render();
}
function syncBgSliders() {
    const s = frames[currentIdx].bgSettings || {};
    document.getElementById('mob-bg-scale').value = s.scale ?? 100;
    document.getElementById('mob-bg-rotate').value = s.rotate ?? 0;
    document.getElementById('mob-bg-x').value = s.x ?? 0;
    document.getElementById('mob-bg-y').value = s.y ?? 0;
    document.getElementById('mob-bg-scale-v').innerText = (s.scale ?? 100) + '%';
    document.getElementById('mob-bg-rotate-v').innerText = (s.rotate ?? 0) + '¬∞';
    document.getElementById('mob-bg-x-v').innerText = (s.x ?? 0);
    document.getElementById('mob-bg-y-v').innerText = (s.y ?? 0);
    // Filters
    const filterRow = document.getElementById('mob-bg-filter-row');
    const filters = ['none','grayscale(100%)','sepia(100%)','contrast(150%)','brightness(130%)','hue-rotate(90deg)','invert(100%)'];
    const filterLabels = ['None','B&W','Sepia','High Contrast','Bright','Color Shift','Invert'];
    filterRow.innerHTML = '';
    filters.forEach((f, i) => {
        const chip = document.createElement('button');
        chip.className = 'filter-chip' + (s.filter === f || (i === 0 && !s.filter) ? ' active' : '');
        chip.innerText = filterLabels[i];
        chip.onclick = () => { filterRow.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); chip.classList.add('active'); frames[currentIdx].bgSettings = { ...frames[currentIdx].bgSettings, filter: f }; render(); };
        filterRow.appendChild(chip);
    });
}
function resetBgSettings() { saveState(); frames[currentIdx].background = '#ffffff'; frames[currentIdx].bgSettings = {}; render(); syncBgSliders(); }

// BG import choice
let _bgChoiceSrc = null;
function showBgImportChoice(src) { _bgChoiceSrc = src; document.getElementById('bg-choice-preview').src = src; document.getElementById('bg-import-choice-modal').style.display = 'flex'; }
function closeBgChoiceModal() { document.getElementById('bg-import-choice-modal').style.display = 'none'; }
function bgChoiceCrop() { closeBgChoiceModal(); const t = document.getElementById('crop-target'); t.src = _bgChoiceSrc; document.getElementById('crop-modal').style.display = 'flex'; if (cropper) cropper.destroy(); const r = canvasRatio || { w:1, h:1 }; cropper = new Cropper(t, { aspectRatio: r.w / r.h, viewMode: 1 }); }
function bgChoiceFixed() { closeBgChoiceModal(); if (!_bgChoiceSrc) return; saveState(); const img = new Image(); img.onload = () => { const r = canvasRatio || {w:1,h:1}; const targetAR = r.w/r.h; const imgAR = img.width/img.height; let sx=0,sy=0,sw=img.width,sh=img.height; if(imgAR>targetAR){sw=img.height*targetAR;sx=(img.width-sw)/2;}else{sh=img.width/targetAR;sy=(img.height-sh)/2;} const c=document.createElement('canvas');c.width=800;c.height=Math.round(800*r.h/r.w);const ctx2=c.getContext('2d');ctx2.drawImage(img,sx,sy,sw,sh,0,0,c.width,c.height); frames[currentIdx].background=c.toDataURL('image/jpeg',0.9); render(); }; img.src=_bgChoiceSrc; }

// ‚îÄ‚îÄ FX ‚îÄ‚îÄ
const FX_FILTERS = ['none','grayscale(100%)','sepia(100%)','contrast(1.5)','brightness(1.4)','hue-rotate(90deg)','saturate(2)','invert(100%)'];
const FX_FILTER_LABELS = ['None','B&W','Sepia','Contrast','Bright','Shift','Vivid','Invert'];
function syncFxPanel() {
    const hint = document.getElementById('fx-selected-hint');
    if (!activeLayer) { hint.innerText = 'Select a layer first (tap it on canvas)'; return; }
    hint.innerText = 'Editing: ' + (activeLayer.nameTag || activeLayer.type);
    const fr = document.getElementById('fx-filter-row');
    fr.innerHTML = '';
    FX_FILTERS.forEach((f, i) => {
        const chip = document.createElement('button');
        chip.className = 'fx-chip' + (activeLayer.fxFilter === f || (i===0&&!activeLayer.fxFilter) ? ' active' : '');
        chip.innerText = FX_FILTER_LABELS[i];
        chip.onclick = () => { if(!activeLayer) return; saveState(); activeLayer.fxFilter = f; fr.querySelectorAll('.fx-chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active'); applyFxToSelected(); };
        fr.appendChild(chip);
    });
    if (activeLayer.fxOpacity !== undefined) document.getElementById('fx-opacity').value = activeLayer.fxOpacity;
}
function setFxBlur(type) {
    if (!activeLayer) return;
    saveState();
    activeLayer.blurType = type;
    document.getElementById('fx-blur-none').classList.toggle('active', type==='none');
    document.getElementById('fx-blur-soft').classList.toggle('active', type==='soft');
    document.getElementById('fx-blur-pixel').classList.toggle('active', type==='pixel');
    document.getElementById('fx-blur-amt-row').style.display = type === 'none' ? 'none' : 'flex';
    applyFxToSelected();
}
function applyFxToSelected() {
    if (!activeLayer) return;
    if (activeLayer.blurType) { const amt = document.getElementById('fx-blur-amt').value; document.getElementById('fx-blur-amt-val').innerText = amt + 'px'; activeLayer.blurAmt = parseInt(amt); }
    activeLayer.fxOpacity = parseInt(document.getElementById('fx-opacity').value);
    document.getElementById('fx-opacity-val').innerText = activeLayer.fxOpacity + '%';
    render();
}
function clearFxFromSelected() { if (!activeLayer) return; saveState(); delete activeLayer.fxFilter; delete activeLayer.fxOpacity; delete activeLayer.blurType; delete activeLayer.blurAmt; syncFxPanel(); render(); }
// stubs for PC compat
function toggleFxPanel() { openSheet('fx'); }
function closeFxPanel() { closeSheet('fx'); }

// ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ
function triggerImport(type) { currentImportType = type; document.getElementById('img-input').click(); }
document.getElementById('img-input').addEventListener('change', (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        if (currentImportType === 'bg') { currentImportType = 'bg'; showBgImportChoice(ev.target.result); }
        else { saveState(); const cw=canvas.offsetWidth||300, ch=canvas.offsetHeight||300; const nl={type:'img',src:ev.target.result,w:Math.round(cw*0.5),x:Math.round(cw*0.25),y:Math.round(ch*0.25),rotation:0,flipped:false,id:Date.now()}; frames[currentIdx].layers.push(nl); activeLayer=nl; render(); }
    };
    reader.readAsDataURL(file);
    e.target.value = '';
});
function handleCoverInput(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => { currentImportType='cover'; const t=document.getElementById('crop-target'); t.src=ev.target.result; document.getElementById('crop-modal').style.display='flex'; if(cropper)cropper.destroy(); cropper=new Cropper(t,{aspectRatio:1,viewMode:1}); };
    reader.readAsDataURL(file);
    e.target.value = '';
}
function closeCrop() { document.getElementById('crop-modal').style.display='none'; if(cropper){cropper.destroy();cropper=null;} }
document.getElementById('apply-crop-btn').onclick = () => {
    if (!cropper) return;
    const data = cropper.getCroppedCanvas().toDataURL('image/jpeg', 0.9);
    closeCrop();
    if (currentImportType === 'bg') { saveState(); frames[currentIdx].background = data; render(); }
    else if (currentImportType === 'cover') { finalCoverBase64 = data; const img = document.getElementById('final-cover-img'); img.src = data; img.style.display = 'block'; document.getElementById('cover-label').style.display = 'none'; }
    else { saveState(); const cw=canvas.offsetWidth||300, ch=canvas.offsetHeight||300; const nl={type:'img',src:data,w:Math.round(cw*0.5),x:Math.round(cw*0.25),y:Math.round(ch*0.25),rotation:0,flipped:false,id:Date.now()}; frames[currentIdx].layers.push(nl); activeLayer=nl; render(); }
};

// ‚îÄ‚îÄ MULTI IMPORT ‚îÄ‚îÄ
let multiFiles = [];
function openMultiImport() { document.getElementById('multi-import-modal').style.display='flex'; multiFiles=[]; document.getElementById('multi-preview-grid').innerHTML=''; document.getElementById('multi-confirm-btn').disabled=true; }
function closeMultiImport() { document.getElementById('multi-import-modal').style.display='none'; }
document.getElementById('multi-file-input').addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    multiFiles = [];
    document.getElementById('multi-preview-grid').innerHTML = '';
    const grid = document.getElementById('multi-preview-grid');
    files.forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            multiFiles.push({ order: i, src: ev.target.result });
            const thumb = document.createElement('div'); thumb.className = 'multi-thumb'; thumb.style.backgroundImage = `url(${ev.target.result})`;
            const badge = document.createElement('div'); badge.className = 'order-badge'; badge.innerText = i + 1; thumb.appendChild(badge);
            grid.appendChild(thumb);
            document.getElementById('multi-confirm-btn').disabled = false;
        };
        reader.readAsDataURL(file);
    });
    e.target.value = '';
});
function confirmMultiImport() {
    if (!multiFiles.length) return;
    saveState();
    const mode = document.getElementById('multi-insert-mode').value;
    const sorted = multiFiles.sort((a,b) => a.order - b.order);
    const newFrames = sorted.map(f => ({ layers: [], background: f.src, bgSettings: { scale: 100 } }));
    if (mode === 'replace') { frames = newFrames; currentIdx = 0; }
    else if (mode === 'append') { frames.splice(currentIdx + 1, 0, ...newFrames); currentIdx++; }
    else { for (let i = 0; i < newFrames.length; i++) { if (currentIdx + i < frames.length) frames[currentIdx + i] = newFrames[i]; else frames.push(newFrames[i]); } }
    activeLayer = null; closeMultiImport(); render();
}

// ‚îÄ‚îÄ SAVE / DRAFTS ‚îÄ‚îÄ
function saveOffline(silent = false) {
    try {
        const drafts = JSON.parse(localStorage.getItem('comic_drafts') || '[]');
        const ratio = canvasRatio || { w:1, h:1 };
        if (activeDraftId) {
            const idx = drafts.findIndex(d => d.id == activeDraftId);
            if (idx !== -1) { drafts[idx].data = frames; drafts[idx].ratio = ratio; drafts[idx].updated = Date.now(); }
            else { drafts.push({ id: activeDraftId, data: frames, ratio, updated: Date.now() }); }
        } else {
            const id = Date.now();
            activeDraftId = id;
            localStorage.setItem('active_draft_id', id);
            drafts.push({ id, data: frames, ratio, updated: Date.now() });
        }
        localStorage.setItem('comic_drafts', JSON.stringify(drafts));
        if (!silent) { const t = document.createElement('div'); t.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);background:#1a3a1a;color:#4cff7a;padding:8px 18px;border-radius:20px;font-size:12px;font-weight:800;z-index:9999;border:1px solid #2a5a2a;'; t.innerText='‚úì Saved'; document.body.appendChild(t); setTimeout(()=>t.remove(), 1800); }
    } catch(e) { if (!silent) alert('Save failed: storage may be full.'); }
    hasUnsavedChanges = false;
}
function goToDrafts() { saveOffline(true); location.href = 'my-comics.html'; }
function handleExit() { if (hasUnsavedChanges) { if (confirm('Save before leaving?')) saveOffline(true); } location.href = 'index.html'; }

// ‚îÄ‚îÄ PUBLISH ‚îÄ‚îÄ
function openPublishModal() { document.getElementById('publish-modal').style.display='flex'; }
function closePublish() { document.getElementById('publish-modal').style.display='none'; }
async function finalPublish() {
    const btn = document.getElementById('publish-btn');
    const title = document.getElementById('pub-title').value.trim();
    if (!title) { alert('Please enter a title.'); return; }
    if (!finalCoverBase64) { alert('Please upload a cover image.'); return; }
    btn.disabled = true; btn.innerText = editingComicId ? 'UPDATING...' : 'POSTING...';
    const tags = document.getElementById('pub-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
    const desc = document.getElementById('pub-desc').value.trim();
    const profile = JSON.parse(localStorage.getItem('user_profile') || '{"name":"Creator","handle":"user"}');
    const swipeDir = localStorage.getItem('cc-swipe-dir') || 'horizontal';
    const payload = { data: frames, cover: finalCoverBase64, title, tags, description: desc, canvas_ratio: canvasRatio, swipe_dir: swipeDir };
    let error;
    if (editingComicId) {
        ({ error } = await _supabase.from('comics').update({ ...payload }).eq('id', editingComicId));
    } else {
        ({ error } = await _supabase.from('comics').insert([{ ...payload, owner_name: profile.name, owner_handle: profile.handle, stars: 0, starred_by: [] }]));
    }
    if (error) { alert('Error: ' + error.message); btn.disabled=false; btn.innerText='POST NOW'; return; }
    hasUnsavedChanges = false;
    location.href = 'discover.html';
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function openExportModal() { document.getElementById('export-modal').style.display='flex'; openExportFramesTab(); }
function closeExportModal() { document.getElementById('export-modal').style.display='none'; }
function switchExportTab(tab) {
    document.querySelectorAll('.export-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.export-section').forEach(s=>s.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('export-'+tab).classList.add('active');
    if (tab === 'frames') openExportFramesTab();
}
async function renderFrameToCanvas(frame, cw, ch) {
    var tmp = document.createElement('canvas');
    tmp.width = cw; tmp.height = ch;
    var ctx = tmp.getContext('2d');
    var bg = frame.background || '#ffffff';
    var s = frame.bgSettings || {};
    var scale = s.scale != null ? s.scale : 100;
    var xOff = s.x != null ? s.x : 0;
    var yOff = s.y != null ? s.y : 0;
    var rot = s.rotate != null ? s.rotate : 0;
    var isImg = bg.indexOf('http') === 0 || bg.indexOf('data:image') === 0;
    await new Promise(function(res) {
        if (isImg) {
            var img = new Image(); img.crossOrigin = 'anonymous'; img.src = bg;
            var draw = function() {
                ctx.save();
                ctx.translate(cw/2 + xOff*cw/100, ch/2 + yOff*ch/100);
                ctx.rotate(rot * Math.PI / 180);
                var sc = scale / 100;
                var iw = img.naturalWidth || cw, ih = img.naturalHeight || ch;
                var ar = iw/ih, cr = cw/ch;
                var dw, dh;
                if (ar > cr) { dh = ch*sc*1.1; dw = dh*ar; } else { dw = cw*sc*1.1; dh = dw/ar; }
                ctx.drawImage(img, -dw/2, -dh/2, dw, dh);
                ctx.restore(); res();
            };
            if (img.complete && img.naturalWidth) draw();
            else { img.onload = draw; img.onerror = function() { ctx.fillStyle='#fff'; ctx.fillRect(0,0,cw,ch); res(); }; }
        } else { ctx.fillStyle = bg; ctx.fillRect(0,0,cw,ch); res(); }
    });
    for (var li = 0; li < frame.layers.length; li++) {
        var layer = frame.layers[li];
        if (layer.type === 'img') {
            await (function(lyr) {
                return new Promise(function(res) {
                    var img = new Image(); img.crossOrigin = 'anonymous'; img.src = lyr.src;
                    var draw = function() {
                        var iw = img.naturalWidth||1, ih = img.naturalHeight||1;
                        var lw = lyr.w||100, lh = lw*(ih/iw);
                        var cx = (lyr.x||0)+lw/2, cy = (lyr.y||0)+lh/2;
                        ctx.save();
                        ctx.globalAlpha = lyr.fxOpacity != null ? lyr.fxOpacity/100 : 1;
                        ctx.translate(cx, cy);
                        ctx.rotate((lyr.rotation||0)*Math.PI/180);
                        if (lyr.flipped) ctx.scale(-1,1);
                        ctx.drawImage(img,-lw/2,-lh/2,lw,lh);
                        ctx.restore(); res();
                    };
                    if (img.complete && img.naturalWidth) draw();
                    else { img.onload=draw; img.onerror=res; }
                });
            })(layer);
        } else if (layer.type==='text'||layer.type==='bubble'||layer.type==='thinking'||layer.type==='subtitle') {
            ctx.save();
            ctx.globalAlpha = layer.fxOpacity != null ? layer.fxOpacity/100 : 1;
            var lx=layer.x||0, ly=layer.y||0, fw=layer.w||160;
            var fs=layer.fontSize||(layer.type==='subtitle'?16:22);
            var ff=(layer.fontFamily||'Inter, sans-serif').replace(/['"]/g,'');
            ctx.font=(layer.bold?'900':'700')+' '+fs+'px '+ff;
            if (layer.type==='subtitle') {
                ctx.fillStyle='rgba(0,0,0,0.75)'; ctx.fillRect(lx,ly,fw,fs+20); ctx.fillStyle='#fff';
            } else if (layer.type==='bubble'||layer.type==='thinking') {
                ctx.fillStyle=layer.bubbleBg||'#fff';
                ctx.strokeStyle=layer.bubbleBorderColor||'#000'; ctx.lineWidth=3;
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(lx,ly,fw,fs+28,12); else ctx.rect(lx,ly,fw,fs+28);
                ctx.fill(); ctx.stroke();
                ctx.fillStyle=layer.color||'#000';
            } else { ctx.fillStyle=layer.color||'#000'; }
            ctx.textAlign=layer.align||'left';
            var textContent = layer.content || '';
            var textLines = textContent.split('\n');
            for (var tli=0; tli<textLines.length; tli++) {
                ctx.fillText(textLines[tli], lx+8, ly+fs+14+tli*(fs+4));
            }
            ctx.restore();
        }
    }
    return tmp;
}

function mobileDownload(dataUrl, filename) {
    try {
        var a = document.createElement('a');
        a.href=dataUrl; a.download=filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    } catch(e) { window.open(dataUrl,'_blank'); }
}

async function exportGIF() {
    var statusEl=document.getElementById('gif-status');
    var fillEl=document.getElementById('gif-progress-fill');
    var barEl=document.getElementById('gif-progress-bar');
    var resultWrap=document.getElementById('gif-result-wrap');
    var btn=document.getElementById('gif-generate-btn');
    resultWrap.style.display='none'; barEl.style.display='block'; fillEl.style.width='0%';
    statusEl.innerText='Rendering frames...'; btn.disabled=true; btn.innerText='GENERATING...';
    var fps=parseInt(document.getElementById('gif-fps').value);
    var quality=parseInt(document.getElementById('gif-quality').value);
    var cw=canvas.offsetWidth||400, ch=canvas.offsetHeight||400;
    try {
        var renderedFrames=[];
        for (var i=0;i<frames.length;i++) {
            statusEl.innerText='Rendering frame '+(i+1)+' / '+frames.length;
            fillEl.style.width=(i/frames.length*40)+'%';
            renderedFrames.push(await renderFrameToCanvas(frames[i],cw,ch));
        }
        var gif=new GIF({workers:2,quality:quality,width:cw,height:ch,workerScript:'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'});
        for (var ri=0;ri<renderedFrames.length;ri++) gif.addFrame(renderedFrames[ri],{delay:Math.round(1000/fps),copy:true});
        fillEl.style.width='50%'; statusEl.innerText='Encoding GIF...';
        gif.on('progress',function(p){fillEl.style.width=(50+p*50)+'%';statusEl.innerText='Encoding: '+Math.round(50+p*50)+'%';});
        gif.on('finished',function(blob){
            var url=URL.createObjectURL(blob);
            document.getElementById('gif-result-img').src=url;
            var dl=document.getElementById('gif-download-link'); dl.href=url; dl.download='comic.gif';
            resultWrap.style.display='block'; barEl.style.display='none';
            statusEl.innerText='Done! Long-press image to save on iOS.';
            btn.disabled=false; btn.innerText='REGENERATE';
        });
        gif.on('error',function(err){statusEl.innerText='GIF failed: '+err;barEl.style.display='none';btn.disabled=false;btn.innerText='GENERATE GIF';});
        gif.render();
    } catch(err) { statusEl.innerText='Error: '+err.message; barEl.style.display='none'; btn.disabled=false; btn.innerText='GENERATE GIF'; }
}

async function exportStrip() {
    var cols=parseInt(document.getElementById('strip-cols').value);
    var statusEl=document.getElementById('strip-status');
    var previewWrap=document.getElementById('strip-preview-wrap');
    statusEl.innerText='Rendering...';
    var cw=canvas.offsetWidth||400, ch=canvas.offsetHeight||400;
    var rows=Math.ceil(frames.length/cols), pad=10;
    var sw=(cw+pad)*cols+pad, sh=(ch+pad)*rows+pad;
    var sc=document.createElement('canvas'); sc.width=sw; sc.height=sh;
    var ctx2=sc.getContext('2d'); ctx2.fillStyle='#111'; ctx2.fillRect(0,0,sw,sh);
    for (var i=0;i<frames.length;i++) {
        statusEl.innerText='Frame '+(i+1)+' / '+frames.length;
        var fc=await renderFrameToCanvas(frames[i],cw,ch);
        var row=Math.floor(i/cols), col=i%cols;
        ctx2.drawImage(fc,pad+col*(cw+pad),pad+row*(ch+pad));
        ctx2.fillStyle='rgba(255,122,0,0.9)'; ctx2.fillRect(pad+col*(cw+pad),pad+row*(ch+pad),22,18);
        ctx2.fillStyle='#000'; ctx2.font='bold 10px Inter'; ctx2.textAlign='center';
        ctx2.fillText(i+1,pad+col*(cw+pad)+11,pad+row*(ch+pad)+13);
    }
    var dataUrl=sc.toDataURL('image/png');
    document.getElementById('strip-preview-img').src=dataUrl;
    previewWrap.style.display='block';
    statusEl.innerText='Done! Long-press image to save on iOS.';
    mobileDownload(dataUrl,'comic-strip.png');
}

async function openExportFramesTab() {
    var grid=document.getElementById('export-frames-grid');
    grid.innerHTML='<div style="color:#555;font-size:12px;padding:10px;">Rendering...</div>';
    var cw=canvas.offsetWidth||400, ch=canvas.offsetHeight||400;
    grid.innerHTML='';
    for (var i=0;i<frames.length;i++) {
        var fc=await renderFrameToCanvas(frames[i],cw,ch);
        var dataUrl=fc.toDataURL('image/png');
        var wrap=document.createElement('div');
        wrap.style.cssText='position:relative;border-radius:10px;overflow:hidden;border:2px solid #333;cursor:pointer;';
        var img=document.createElement('img');
        img.src=dataUrl; img.style.cssText='width:100%;display:block;';
        var label=document.createElement('div');
        label.style.cssText='position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.75);color:var(--accent);font-size:10px;font-weight:900;padding:5px 8px;text-align:center;';
        label.innerText='FRAME '+(i+1)+' - TAP TO SAVE';
        wrap.appendChild(img); wrap.appendChild(label);
        (function(url,idx){ wrap.onclick=function(){mobileDownload(url,'frame-'+idx+'.png');}; })(dataUrl,i+1);
        grid.appendChild(wrap);
    }
}

// ‚îÄ‚îÄ SAVE SPRITE TO PERSONAL ‚îÄ‚îÄ
async function saveSpriteToPersonal() {
    if (!activeLayer?.src) return;
    const { data:{user} } = await _supabase.auth.getUser();
    if (!user) { alert('Log in first'); return; }
    const { error } = await _supabase.from('personal_sprites').insert([{ user_id: user.id, src: activeLayer.src, name: activeLayer.nameTag || 'My Sprite', created_at: new Date().toISOString() }]);
    alert(error ? error.message : '‚úì Sprite saved!');
}

// ‚îÄ‚îÄ AUTO SAVE ‚îÄ‚îÄ
setInterval(() => { if (hasUnsavedChanges) saveOffline(true); }, 60000);

// ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ
function applyPendingBg(pendingBg, pendingBgId) {
    if (pendingBgId) {
        localStorage.removeItem('pending_bg_id');
        currentImportType = 'bg';
        _supabase.from('backgrounds_library').select('image_data').eq('id', pendingBgId).single().then(({ data }) => { if (data?.image_data) showBgImportChoice(data.image_data); });
        return;
    }
    if (!pendingBg) return;
    localStorage.removeItem('pending_background');
    if (pendingBg.startsWith('http') || pendingBg.startsWith('data:image')) { currentImportType='bg'; showBgImportChoice(pendingBg); }
    else { frames[currentIdx].background = pendingBg; render(); }
}

window.onload = function() {
    // ‚îÄ‚îÄ TAP BACKDROP TO CLOSE OVERLAY MODALS ‚îÄ‚îÄ
    document.querySelectorAll('.overlay-full').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
                // destroy cropper if crop modal is closed this way
                if (overlay.id === 'crop-modal' && cropper) { cropper.destroy(); cropper = null; }
            }
        });
    });
    const pendingBg = localStorage.getItem('pending_background');
    const pendingBgId = localStorage.getItem('pending_bg_id');

    // edit_comic_id MUST take priority over draft ‚Äî user explicitly clicked a comic to edit
    const editComicId = localStorage.getItem('edit_comic_id');
    if (editComicId) {
        localStorage.removeItem('edit_comic_id'); editingComicId = editComicId;
        document.getElementById('publish-btn').innerText = 'UPDATE';
        _supabase.from('comics').select('*').eq('id', editComicId).single().then(({data,error}) => {
            if (error||!data) { alert('Could not load comic.'); return; }
            frames = data.data || data.frames || [];
            const r = data.canvas_ratio || {w:1,h:1}; setRatio(r.w,r.h);
            document.getElementById('pub-title').value = data.title || '';
            document.getElementById('pub-tags').value = (data.tags||[]).join(', ');
            document.getElementById('pub-desc').value = data.description || '';
            if (data.cover) { finalCoverBase64=data.cover; const img=document.getElementById('final-cover-img'); img.src=data.cover; img.style.display='block'; document.getElementById('cover-label').style.display='none'; }
            applyPendingBg(pendingBg,pendingBgId);
        });
        return;
    }
    // After edit_comic_id is cleared, check for active draft
    const resumeId = localStorage.getItem('active_draft_id');
    if (resumeId) {
        const drafts = JSON.parse(localStorage.getItem('comic_drafts') || '[]');
        const found = drafts.find(d => d.id == resumeId);
        if (found) { frames = found.data || []; activeDraftId = resumeId; const r = found.ratio || {w:1,h:1}; setRatio(r.w,r.h); currentIdx = 0; render(); renderMobFrames(); applyPendingBg(pendingBg,pendingBgId); return; }
    }
    const pendingFrames = localStorage.getItem('cc-pending-frames');
    if (pendingFrames) { localStorage.removeItem('cc-pending-frames'); const saved=JSON.parse(pendingFrames); frames=saved.frames; currentIdx=saved.currentIdx; }
    const storedNew = localStorage.getItem('cc-new-comic-ratio');
    const storedActive = localStorage.getItem('cc-active-ratio');
    if (storedNew) { const r=JSON.parse(storedNew); localStorage.removeItem('cc-new-comic-ratio'); setRatio(r.w,r.h); }
    else if (storedActive) { const r=JSON.parse(storedActive); setRatio(r.w,r.h); }
    else { setRatio(1,1); }
    applyPendingBg(pendingBg,pendingBgId);
};

// ‚îÄ‚îÄ DRAFTS MODAL ‚îÄ‚îÄ
function openDraftsModal() {
    saveOffline(true);
    var drafts = [];
    try { drafts = JSON.parse(localStorage.getItem('comic_drafts') || '[]'); } catch(e) {}
    drafts.sort(function(a,b){ return (b.updated||0)-(a.updated||0); });
    var list = document.getElementById('drafts-list');
    list.innerHTML = '';
    if (!drafts.length) {
        list.innerHTML = '<div style="color:#444;font-size:13px;text-align:center;padding:30px 0;">No drafts saved yet.</div>';
    }
    drafts.forEach(function(draft) {
        var item = document.createElement('div');
        item.className = 'draft-item';
        var f = (draft.data && draft.data[0]) || {};
        var bg = f.background || '#222';
        var frameCount = (draft.data || []).length;
        var date = draft.updated ? new Date(draft.updated).toLocaleDateString() : '';
        var isCurrent = String(draft.id) === String(activeDraftId);

        // Build thumb
        var thumb = document.createElement('div');
        thumb.className = 'draft-thumb';
        if (bg.startsWith('http') || bg.startsWith('data:image')) {
            thumb.style.backgroundImage = 'url(' + bg + ')';
            thumb.style.backgroundSize = 'cover';
            thumb.style.backgroundPosition = 'center';
        } else {
            thumb.style.background = bg;
        }

        var info = document.createElement('div');
        info.className = 'draft-info';
        var title = document.createElement('div');
        title.className = 'draft-title';
        title.textContent = (isCurrent ? '‚ñ∂ ' : '') + (draft.title || 'Untitled Draft');
        var meta = document.createElement('div');
        meta.className = 'draft-meta';
        meta.textContent = frameCount + ' frame' + (frameCount !== 1 ? 's' : '') + (date ? ' ¬∑ ' + date : '');
        info.appendChild(title);
        info.appendChild(meta);

        var del = document.createElement('button');
        del.className = 'draft-del';
        del.textContent = 'üóë';
        del.title = 'Delete draft';
        del.onclick = function(e) {
            e.stopPropagation();
            if (!confirm('Delete this draft?')) return;
            var all = [];
            try { all = JSON.parse(localStorage.getItem('comic_drafts') || '[]'); } catch(ex) {}
            all = all.filter(function(d){ return String(d.id) !== String(draft.id); });
            localStorage.setItem('comic_drafts', JSON.stringify(all));
            if (String(draft.id) === String(activeDraftId)) {
                localStorage.removeItem('active_draft_id');
                activeDraftId = null;
            }
            item.remove();
            if (!document.querySelectorAll('.draft-item').length) {
                list.innerHTML = '<div style="color:#444;font-size:13px;text-align:center;padding:30px 0;">No drafts saved yet.</div>';
            }
        };

        item.appendChild(thumb);
        item.appendChild(info);
        item.appendChild(del);

        // Click to load
        item.onclick = function() {
            if (isCurrent) { closeDraftsModal(); return; }
            if (hasUnsavedChanges) { if (!confirm('Save current work first?')) return; saveOffline(true); }
            frames = JSON.parse(JSON.stringify(draft.data || [{ layers:[], background:'#ffffff' }]));
            activeDraftId = draft.id;
            localStorage.setItem('active_draft_id', String(draft.id));
            var r = draft.ratio || {w:1,h:1};
            setRatio(r.w, r.h);
            currentIdx = 0;
            activeLayer = null;
            render();
            renderMobFrames();
            closeDraftsModal();
        };

        list.appendChild(item);
    });
    document.getElementById('drafts-modal').classList.add('open');
}

function closeDraftsModal() {
    document.getElementById('drafts-modal').classList.remove('open');
}

function startNewDraft() {
    if (hasUnsavedChanges) { if (!confirm('Save current work first?')) return; saveOffline(true); }
    frames = [{ layers: [], background: '#ffffff' }];
    activeDraftId = null;
    localStorage.removeItem('active_draft_id');
    currentIdx = 0;
    activeLayer = null;
    setRatio(1,1);
    render();
    renderMobFrames();
    closeDraftsModal();
}

// ‚îÄ‚îÄ PC COMPAT STUBS ‚îÄ‚îÄ
function toggleMenu() {}
function toggleSidePanel() {}
function openBgPanel() { openSheet('bg'); }
function toggleTransform() { openTransformSheet(); }
function toggleFtbPanel() {}
function showFloatToolbar() {}
function hideFloatToolbar() {}
function closeFtbPanel() {}
function hideEditorUI() { if (document.getElementById('top-bar').style.display !== 'none') toggleHideUI(); }
function showEditorUI() { if (document.getElementById('top-bar').style.display === 'none') toggleHideUI(); }
function toggleHideUI() {
    const isHidden = document.getElementById('top-bar').style.display === 'none';
    document.getElementById('top-bar').style.display = isHidden ? '' : 'none';
    document.getElementById('bottom-bar').style.display = isHidden ? '' : 'none';
    document.getElementById('zoom-controls').style.display = isHidden ? '' : 'none';
    document.getElementById('hidden-ui-bar').style.display = isHidden ? 'none' : 'flex';
    if (!isHidden) { closeAllSheets(); closeTransformSheet(); }
}
function toggleEditorPrefs() {}
function closeEditorPrefs() {}
function toggleOnionSkin() { toggleOnionMobile(); }
function updateSelectionOpacity() {}
function sbEditAction() { if (activeLayer) openTransformSheet(); else { const t=document.createElement('div'); t.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#aaa;padding:8px 18px;border-radius:20px;font-size:12px;font-weight:800;z-index:9999;border:1px solid #333;'; t.innerText='Tap a layer first'; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); } }
function editCurrentSpriteAction() { if (activeLayer?.packData) openActionModal(activeLayer.packData, true); }
function copyLayer() { sbCopyLayer(); }
function pasteLayer() { sbPasteLayer(); }
function toggleSelectedLayerLock() {}
function setRatioForBg() {}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONION SKIN MOBILE TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleOnionMobile() {
    const toggle = document.getElementById('onion-toggle');
    toggle.checked = !toggle.checked;
    const on = toggle.checked;
    const btn = document.getElementById('onion-bot-btn');
    if (btn) {
        btn.classList.toggle('onion-on', on);
        btn.querySelector('.bico').innerText = on ? 'üßÖ' : 'üßÖ';
        btn.style.color = on ? 'var(--teal)' : '';
    }
    const popup = document.getElementById('onion-opacity-popup');
    if (on) {
        popup.classList.add('visible');
        // Auto-hide popup after 3s
        clearTimeout(popup._t);
        popup._t = setTimeout(() => popup.classList.remove('visible'), 3000);
    } else {
        popup.classList.remove('visible');
    }
    render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWPORT PAN / ZOOM (MOBILE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let vpScale = 1;
let vpOffsetX = 0, vpOffsetY = 0;
let vpZoomTimer = null;

const _vpViewport = document.getElementById('viewport');
const _vpContainer = document.getElementById('canvas-container');

function _applyVpTransform() {
    _vpContainer.style.transform = `translate(${vpOffsetX}px,${vpOffsetY}px) scale(${vpScale})`;
}

function _showZoomIndicator() {
    const el = document.getElementById('zoom-indicator');
    el.innerText = Math.round(vpScale * 100) + '%';
    el.classList.add('visible');
    clearTimeout(vpZoomTimer);
    vpZoomTimer = setTimeout(() => el.classList.remove('visible'), 1400);
}

function vpZoomStep(delta) {
    vpScale = Math.min(5, Math.max(0.2, vpScale + delta));
    _applyVpTransform();
    _showZoomIndicator();
}

function vpZoomReset() {
    vpScale = 1; vpOffsetX = 0; vpOffsetY = 0;
    _applyVpTransform();
    _showZoomIndicator();
}

// ‚îÄ‚îÄ Touch: pinch-zoom + 2-finger pan ‚îÄ‚îÄ
let _vpTouches = [];
let _vpPinchDist = 0;
let _vpPinchMidX = 0, _vpPinchMidY = 0;
let _vpPanStart = null;
let _vpIsPinching = false;

_vpViewport.addEventListener('touchstart', (e) => {
    _vpTouches = Array.from(e.touches);
    if (_vpTouches.length === 2) {
        e.preventDefault(); // MUST block browser zoom ‚Äî requires passive:false
        _vpIsPinching = true;
        const dx = _vpTouches[1].clientX - _vpTouches[0].clientX;
        const dy = _vpTouches[1].clientY - _vpTouches[0].clientY;
        _vpPinchDist = Math.hypot(dx, dy);
        _vpPinchMidX = (_vpTouches[0].clientX + _vpTouches[1].clientX) / 2;
        _vpPinchMidY = (_vpTouches[0].clientY + _vpTouches[1].clientY) / 2;
        _vpPanStart = { x: vpOffsetX, y: vpOffsetY, midX: _vpPinchMidX, midY: _vpPinchMidY };
    } else {
        _vpIsPinching = false;
    }
}, { passive: false });

_vpViewport.addEventListener('touchmove', (e) => {
    _vpTouches = Array.from(e.touches);
    if (_vpTouches.length === 2 && _vpIsPinching) {
        e.preventDefault();
        const dx = _vpTouches[1].clientX - _vpTouches[0].clientX;
        const dy = _vpTouches[1].clientY - _vpTouches[0].clientY;
        const dist = Math.hypot(dx, dy);
        const midX = (_vpTouches[0].clientX + _vpTouches[1].clientX) / 2;
        const midY = (_vpTouches[0].clientY + _vpTouches[1].clientY) / 2;

        if (_vpPinchDist > 0) {
            const scaleChange = dist / _vpPinchDist;
            const rect = _vpViewport.getBoundingClientRect();
            const cx = midX - rect.left - rect.width / 2;
            const cy = midY - rect.top - rect.height / 2;
            const newScale = Math.min(5, Math.max(0.2, vpScale * scaleChange));
            const ratio = newScale / vpScale;
            vpOffsetX = cx + (vpOffsetX - cx) * ratio;
            vpOffsetY = cy + (vpOffsetY - cy) * ratio;
            vpScale = newScale;
        }
        // 2-finger pan
        if (_vpPanStart) {
            vpOffsetX = _vpPanStart.x + (midX - _vpPanStart.midX);
            vpOffsetY = _vpPanStart.y + (midY - _vpPanStart.midY);
        }

        _vpPinchDist = dist;
        _vpPinchMidX = midX; _vpPinchMidY = midY;
        _applyVpTransform();
        _showZoomIndicator();
    }
}, { passive: false });

_vpViewport.addEventListener('touchend', (e) => {
    if (e.touches.length < 2) {
        _vpIsPinching = false;
        _vpPinchDist = 0;
        _vpPanStart = null;
    }
    _vpTouches = Array.from(e.touches);
}, { passive: true });

// Init
_applyVpTransform();
</script>
<!-- ‚îÄ‚îÄ ZOOM CONTROLS ‚îÄ‚îÄ -->
<div id="zoom-controls">
    <button class="zoom-ctrl-btn" onclick="vpZoomStep(0.25)" title="Zoom In">+</button>
    <button class="zoom-ctrl-btn" id="zoom-reset-btn" onclick="vpZoomReset()" title="Reset">FIT</button>
    <button class="zoom-ctrl-btn" onclick="vpZoomStep(-0.25)" title="Zoom Out">‚àí</button>
</div>
<div id="zoom-indicator">100%</div>

<!-- ‚îÄ‚îÄ ONION OPACITY POPUP ‚îÄ‚îÄ -->
<div id="onion-opacity-popup">
    <span>üßÖ Ghost</span>
    <input type="range" id="onion-opacity" min="0.1" max="0.7" step="0.1" value="0.3"
        style="width:100px; accent-color:var(--teal);" oninput="render()">
    <button onclick="document.getElementById('onion-opacity-popup').classList.remove('visible')"
        style="background:none;border:none;color:#555;font-size:16px;cursor:pointer;padding:0 2px;">‚úï</button>
</div>


<!-- ‚îÄ‚îÄ DRAFTS MODAL ‚îÄ‚îÄ -->
<div id="drafts-modal" onclick="if(event.target===this)closeDraftsModal()">
    <div id="drafts-panel">
        <div id="drafts-panel-head">
            <h2>üìÇ Drafts</h2>
            <button onclick="closeDraftsModal()" style="background:none;border:none;color:#555;font-size:20px;cursor:pointer;padding:0;">‚úï</button>
        </div>
        <div id="drafts-list"></div>
        <div style="padding:0 14px 10px;">
            <button class="draft-new" onclick="startNewDraft()">+ New Comic</button>
        </div>
    </div>
</div>

</body>
</html>