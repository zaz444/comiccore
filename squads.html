<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicCore ‚Äî Squads</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 90px; }

        .sq-header {
            position: sticky; top: 0; z-index: 200;
            background: rgba(0,0,0,0.96); backdrop-filter: blur(20px);
            border-bottom: 1px solid #1a1a1a; padding: 14px 16px 0;
        }
        .sq-header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .sq-back { background: none; border: 1px solid #222; color: #666; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; font-family: inherit; transition: .15s; }
        .sq-back:hover { border-color: #555; color: white; }
        .sq-header-brand { font-size: 11px; font-weight: 900; color: #ff7a00; letter-spacing: 2px; }
        .sq-header-title { font-size: 21px; font-weight: 900; margin: 0 0 2px; }
        .sq-header-sub { font-size: 11px; color: #444; font-weight: 600; margin-bottom: 10px; }
        .sq-tabs { display: flex; }
        .sq-tab { flex: 1; padding: 10px 0; font-size: 12px; font-weight: 800; color: #444; cursor: pointer; border: none; background: none; font-family: inherit; border-bottom: 2.5px solid transparent; transition: .15s; }
        .sq-tab.active { color: #ff7a00; border-bottom-color: #ff7a00; }

        .sq-stats { display: flex; gap: 8px; padding: 10px 16px; }
        .sq-stat { background: #0d0d0d; border: 1px solid #1a1a1a; border-radius: 20px; padding: 5px 12px; font-size: 11px; font-weight: 800; color: #444; }
        .sq-stat b { color: #ff7a00; }

        .sq-search-wrap { padding: 0 16px 10px; }
        .sq-search { width: 100%; background: #0d0d0d; border: 1px solid #1a1a1a; color: white; padding: 10px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; outline: none; font-family: inherit; transition: .15s; }
        .sq-search:focus { border-color: #ff7a00; }
        .sq-search::placeholder { color: #2a2a2a; }

        .sq-create-wrap { padding: 0 16px 14px; }
        .sq-create-trigger { display: flex; align-items: center; gap: 10px; padding: 13px 16px; background: #0d0d0d; border: 1.5px dashed #222; border-radius: 16px; cursor: pointer; transition: .2s; }
        .sq-create-trigger:hover { border-color: #ff7a00; }
        .sq-create-icon { width: 36px; height: 36px; border-radius: 10px; background: rgba(255,122,0,.12); display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; }
        .sq-create-text { font-size: 13px; font-weight: 700; color: #444; }
        .sq-create-text span { color: #ff7a00; }

        /* Modals */
        .sq-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(10px); }
        .sq-overlay.open { display: flex; }
        .sq-sheet { background: #0f0f0f; border: 1px solid #1e1e1e; border-radius: 24px 24px 0 0; width: 100%; max-width: 560px; padding: 24px 20px 40px; display: flex; flex-direction: column; gap: 12px; max-height: 90vh; overflow-y: auto; animation: slideUp .25s cubic-bezier(.4,0,.2,1); }
        @keyframes slideUp { from { transform: translateY(60px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .sq-sheet-title { font-size: 16px; font-weight: 900; margin: 0; }
        .sq-sheet-sub { font-size: 11px; color: #444; font-weight: 600; margin-top: 2px; }

        .sq-input { width: 100%; background: #111; border: 1px solid #1e1e1e; color: white; padding: 12px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; outline: none; font-family: inherit; transition: .15s; }
        .sq-input:focus { border-color: #ff7a00; }
        .sq-input::placeholder { color: #333; }
        textarea.sq-input { resize: none; height: 72px; line-height: 1.5; }

        .sq-pfp-row { display: flex; align-items: center; gap: 12px; }
        .sq-pfp-pick { width: 56px; height: 56px; border-radius: 14px; background: #1a1a1a; border: 2px dashed #2a2a2a; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; flex-shrink: 0; background-size: cover; background-position: center; transition: .15s; }
        .sq-pfp-pick:hover { border-color: #ff7a00; }
        .sq-pfp-pick.has-img { border-style: solid; border-color: #ff7a00; }

        .sq-label { font-size: 9px; font-weight: 900; color: #333; letter-spacing: 2px; text-transform: uppercase; }
        .sq-topic-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
        .sq-topic { padding: 5px 12px; border-radius: 20px; border: 1.5px solid #1e1e1e; background: #0d0d0d; color: #444; font-size: 11px; font-weight: 800; cursor: pointer; transition: .15s; }
        .sq-topic.on { border-color: #ff7a00; color: #ff7a00; background: rgba(255,122,0,.08); }

        .sq-toggle-row { display: flex; align-items: center; justify-content: space-between; }
        .sq-toggle-label { font-size: 13px; font-weight: 700; color: #ccc; }
        .sq-toggle-detail { font-size: 10px; color: #333; margin-top: 2px; }
        .ios-toggle { position: relative; width: 44px; height: 26px; cursor: pointer; flex-shrink: 0; display: block; }
        .ios-toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
        .ios-track { position: absolute; inset: 0; background: #222; border-radius: 13px; transition: .25s; }
        .ios-toggle input:checked + .ios-track { background: #ff7a00; }
        .ios-thumb { position: absolute; left: 3px; top: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: .25s; box-shadow: 0 1px 4px rgba(0,0,0,0.4); }
        .ios-toggle input:checked ~ .ios-thumb { left: 21px; }

        .sq-btn-primary { background: #ff7a00; color: #000; border: none; border-radius: 14px; padding: 14px; font-size: 14px; font-weight: 900; cursor: pointer; font-family: inherit; transition: .15s; }
        .sq-btn-primary:hover { opacity: .88; }
        .sq-btn-primary:disabled { opacity: .35; pointer-events: none; }
        .sq-btn-danger { background: none; border: 1px solid #ff3b30; color: #ff3b30; border-radius: 12px; padding: 13px; font-size: 13px; font-weight: 800; cursor: pointer; font-family: inherit; transition: .15s; }
        .sq-btn-danger:hover { background: rgba(255,59,48,.08); }
        .sq-btn-ghost { background: none; color: #444; border: none; font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit; padding: 6px; text-align: center; }
        .sq-btn-ghost:hover { color: #888; }

        /* Manage member items */
        .sq-member-item { display: flex; align-items: center; justify-content: space-between; background: #111; border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; }
        .sq-member-handle { font-size: 13px; font-weight: 700; color: #ccc; }
        .sq-member-actions { display: flex; gap: 6px; }
        .sq-mbtn { border: none; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; font-family: inherit; }
        .sq-mbtn-accept { background: #00c851; color: #000; }
        .sq-mbtn-decline { background: #222; color: #888; }
        .sq-mbtn-kick { background: #ff3b30; color: white; }

        /* Feed cards */
        .sq-feed { display: flex; flex-direction: column; }
        .sq-card { display: flex; gap: 12px; padding: 14px 16px; border-bottom: 1px solid #111; transition: .12s; position: relative; }
        .sq-card:first-child { border-top: 1px solid #111; }
        .sq-card:hover { background: #080808; }
        .sq-card.is-mine { border-left: 3px solid #ff7a00; padding-left: 13px; }
        .sq-card-pfp { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; background: #1a1a1a; flex-shrink: 0; border: 1px solid #1e1e1e; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .sq-card-pfp img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
        .sq-card-body { flex: 1; min-width: 0; }
        .sq-card-nameline { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; flex-wrap: wrap; }
        .sq-card-name { font-size: 14px; font-weight: 800; color: #f5f5f7; }
        .sq-tag-badge { font-size: 9px; font-weight: 900; padding: 2px 7px; border-radius: 6px; }
        .sq-badge-mine { background: rgba(255,122,0,.1); border: 1px solid rgba(255,122,0,.2); color: #ff7a00; }
        .sq-badge-private { background: #1a1a1a; border: 1px solid #222; color: #444; }
        .sq-card-owner { font-size: 11px; color: #444; font-weight: 700; margin-bottom: 5px; }
        .sq-card-desc { font-size: 12px; color: #555; line-height: 1.4; margin-bottom: 7px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sq-card-topics { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
        .sq-card-topic-tag { background: #111; border: 1px solid #1a1a1a; color: #444; font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 10px; }
        .sq-card-meta { font-size: 11px; color: #333; font-weight: 700; }
        .sq-card-right { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; flex-shrink: 0; justify-content: center; }

        .sq-action-btn { border-radius: 10px; padding: 7px 13px; font-size: 11px; font-weight: 900; cursor: pointer; font-family: inherit; transition: .15s; white-space: nowrap; border: none; }
        .sq-btn-join { background: #ff7a00; color: #000; }
        .sq-btn-join:hover { opacity: .85; }
        .sq-btn-joined { background: rgba(255,255,255,.06); color: #555; border: 1px solid #1e1e1e !important; cursor: default; }
        .sq-btn-pending { background: #111; color: #444; border: 1px solid #1e1e1e !important; pointer-events: none; }
        .sq-btn-chat { background: rgba(255,122,0,.12); color: #ff7a00; border: 1px solid rgba(255,122,0,.25) !important; }
        .sq-btn-chat:hover { background: rgba(255,122,0,.22); }
        .sq-btn-manage { background: #111; color: #666; border: 1px solid #1e1e1e !important; }
        .sq-btn-manage:hover { border-color: #444 !important; color: #aaa; }
        .sq-btn-leave { background: none; color: #ff3b30; border: 1px solid rgba(255,59,48,.25) !important; }
        .sq-btn-leave:hover { background: rgba(255,59,48,.08); }

        .sq-empty { text-align: center; padding: 60px 20px; color: #2a2a2a; }
        .sq-empty-icon { font-size: 40px; margin-bottom: 12px; }
        .sq-empty-title { font-size: 14px; font-weight: 800; }
        .sq-empty-sub { font-size: 12px; color: #222; margin-top: 4px; }

        .sq-skeleton { background: linear-gradient(90deg,#0d0d0d 25%,#141414 50%,#0d0d0d 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 12px; }
        @keyframes shimmer { 0%{background-position:200% 0}100%{background-position:-200% 0} }

        /* ‚îÄ‚îÄ Crop Modal ‚îÄ‚îÄ */
        .crop-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.96);
            z-index: 2000; display: none; flex-direction: column;
            align-items: center; justify-content: center; gap: 16px; padding: 20px;
        }
        .crop-overlay.open { display: flex; }
        .crop-box { width: min(80vw, 360px); height: min(80vw, 360px); background: #000; border-radius: 16px; overflow: hidden; }
        .crop-box img { max-width: 100%; display: block; }
        .crop-actions { display: flex; gap: 10px; }
        .crop-btn { padding: 11px 28px; border-radius: 20px; font-weight: 800; font-size: 13px; cursor: pointer; font-family: inherit; border: none; }
        .crop-btn-cancel { background: #222; color: #888; }
        .crop-btn-apply { background: #ff7a00; color: #000; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body>

<div class="sq-header">
    <div class="sq-header-top">
        <div class="sq-header-brand">COMICCORE</div>
        <button class="sq-back" onclick="location.href='index.html'">‚Üê Home</button>
    </div>
    <div class="sq-header-title">Squads</div>
    <div class="sq-header-sub">Join communities ¬∑ chat ¬∑ share ideas</div>
    <div class="sq-tabs">
        <button class="sq-tab active" id="tab-discover" onclick="switchTab('discover')">Discover</button>
        <button class="sq-tab" id="tab-mine" onclick="switchTab('mine')">My Squads</button>
    </div>
</div>

<div class="sq-stats">
    <div class="sq-stat">Created: <b id="stat-created">‚Äî</b>/5</div>
    <div class="sq-stat">Joined: <b id="stat-joined">‚Äî</b>/15</div>
</div>

<div class="sq-search-wrap">
    <input class="sq-search" id="sq-search" placeholder="Search squads by name or topic‚Ä¶" oninput="renderFeed()">
</div>

<div class="sq-create-wrap">
    <div class="sq-create-trigger" onclick="openCreateModal()">
        <div class="sq-create-icon">Ôºã</div>
        <div class="sq-create-text">Start a new <span>Squad</span> ‚Äî public or private</div>
    </div>
</div>

<div class="sq-feed" id="sq-feed"></div>

<!-- Create Modal -->
<div class="sq-overlay" id="create-overlay">
    <div class="sq-sheet">
        <div>
            <div class="sq-sheet-title">Create a Squad</div>
            <div class="sq-sheet-sub">A community where members chat and share ideas.</div>
        </div>
        <div class="sq-pfp-row">
            <div class="sq-pfp-pick" id="pfp-pick" onclick="document.getElementById('pfp-file').click()">üñº</div>
            <input type="file" id="pfp-file" hidden accept="image/*" onchange="handlePfp(this, false)">
            <input class="sq-input" id="sq-name" placeholder="Squad name" maxlength="40" style="flex:1;">
        </div>
        <textarea class="sq-input" id="sq-desc" placeholder="What's this squad about? (optional)" maxlength="200"></textarea>
        <div>
            <div class="sq-label">Topics (pick any)</div>
            <div class="sq-topic-row" id="topic-row"></div>
        </div>
        <div class="sq-toggle-row">
            <div class="sq-toggle-info">
                <div class="sq-toggle-label">Private Squad</div>
                <div class="sq-toggle-detail">Members must request to join</div>
            </div>
            <label class="ios-toggle">
                <input type="checkbox" id="sq-private">
                <div class="ios-track"></div>
                <div class="ios-thumb"></div>
            </label>
        </div>
        <button class="sq-btn-primary" id="create-btn" onclick="createSquad()">Create Squad</button>
        <div class="sq-btn-ghost" onclick="closeCreateModal()">Cancel</div>
    </div>
</div>

<!-- Manage Modal -->
<div class="sq-overlay" id="manage-overlay">
    <div class="sq-sheet">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="sq-sheet-title" id="manage-title">Manage Squad</div>
            <span onclick="closeManageModal()" style="cursor:pointer;color:#444;font-size:22px;font-weight:900;line-height:1;">‚úï</span>
        </div>
        <div class="sq-pfp-row">
            <div class="sq-pfp-pick" id="edit-pfp-pick" onclick="document.getElementById('edit-pfp-file').click()">‚úé</div>
            <input type="file" id="edit-pfp-file" hidden accept="image/*" onchange="handlePfp(this, true)">
            <input class="sq-input" id="edit-name" placeholder="Squad name" style="flex:1;">
        </div>
        <textarea class="sq-input" id="edit-desc" placeholder="Description" style="height:60px;"></textarea>
        <div class="sq-toggle-row">
            <div class="sq-toggle-info">
                <div class="sq-toggle-label">Private Squad</div>
                <div class="sq-toggle-detail">Members must request to join</div>
            </div>
            <label class="ios-toggle">
                <input type="checkbox" id="edit-private">
                <div class="ios-track"></div>
                <div class="ios-thumb"></div>
            </label>
        </div>
        <div>
            <div class="sq-label" style="margin-bottom:8px;">Join Requests</div>
            <div id="manage-requests"><div style="font-size:12px;color:#333;padding:6px 0;">No pending requests</div></div>
        </div>
        <div>
            <div class="sq-label" style="margin-bottom:8px;">Members</div>
            <div id="manage-members"><div style="font-size:12px;color:#333;padding:6px 0;">No members yet</div></div>
        </div>
        <button class="sq-btn-primary" onclick="saveSquad()">Save Changes</button>
        <button class="sq-btn-danger" onclick="deleteSquad()">Delete Squad</button>
        <div class="sq-btn-ghost" onclick="closeManageModal()">Cancel</div>
    </div>
</div>

<!-- Crop Modal -->
<div class="crop-overlay" id="pfp-crop-overlay">
    <div class="crop-box">
        <img id="pfp-crop-target" src="">
    </div>
    <div class="crop-actions">
        <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Cancel</button>
        <button class="crop-btn crop-btn-apply" onclick="applyCrop()">Use Photo</button>
    </div>
</div>

<script>
    const _sb = supabase.createClient('https://mmycqeejhguzhtzkyjaj.supabase.co','sb_publishable_8Du2GAcH5oBeiHWe-1e0Fg_XtSub2QE');
    const TOPICS = ['Manga','Comics','Anime','Sprites','Art','Story','Sci-Fi','Horror','Fantasy','Action','Collab','Beginners'];

    let myHandle = '';
    let allSquads = [];
    let myRequests = [];
    let activeTab = 'discover';
    let activeManageId = null;
    let newPfp = '';
    let editPfp = '';

    async function init() {
        if (localStorage.getItem('cc-privacy-team') === 'false') {
            document.body.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#0a0a0a;color:#fff;text-align:center;gap:16px;"><div style="font-size:48px">üîí</div><h2 style="margin:0">Squads is Disabled</h2><p style="color:#666;margin:0">You've turned this off in Settings.</p><a href="settings.html" style="background:#FF7A00;color:#000;padding:12px 24px;border-radius:24px;font-weight:700;text-decoration:none;margin-top:8px">Go to Settings</a><a href="index.html" style="color:#666;font-size:13px">‚Üê Back Home</a></div>`;
            return;
        }
        const local = JSON.parse(localStorage.getItem('user_profile') || '{}');
        const { data: { user } } = await _sb.auth.getUser();
        if (user) {
            const { data: dbp } = await _sb.from('profiles').select('handle').eq('id', user.id).single();
            myHandle = dbp?.handle || local.handle;
        } else { myHandle = local.handle; }
        if (!myHandle || myHandle === 'anonymous') { alert('Please save your profile first!'); return location.href = 'profile.html'; }

        buildTopics();
        await Promise.all([loadSquads(), updateStats()]);
    }

    function buildTopics() {
        document.getElementById('topic-row').innerHTML = TOPICS.map(t =>
            `<div class="sq-topic" data-t="${t}" onclick="this.classList.toggle('on')">${t}</div>`
        ).join('');
    }

    function getTopics() {
        return [...document.querySelectorAll('#topic-row .sq-topic.on')].map(el => el.dataset.t);
    }

    function esc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    let allAccepted = []; // all accepted team_requests across all squads (for member counts)

    async function loadSquads() {
        const feed = document.getElementById('sq-feed');
        feed.innerHTML = `<div style="padding:20px 16px;display:flex;flex-direction:column;gap:10px;">${[1,2,3].map(()=>`<div class="sq-skeleton" style="height:90px;"></div>`).join('')}</div>`;
        const [{ data: squads }, { data: reqs }, { data: accepted }] = await Promise.all([
            _sb.from('team_tickets').select('*').order('created_at', { ascending: false }),
            _sb.from('team_requests').select('*').eq('sender_handle', myHandle),
            _sb.from('team_requests').select('ticket_id').eq('status', 'accepted')
        ]);
        allSquads = squads || [];
        myRequests = reqs || [];
        allAccepted = accepted || [];
        renderFeed();
    }

    async function updateStats() {
        const [{ count: c }, { count: j }] = await Promise.all([
            _sb.from('team_tickets').select('*',{count:'exact',head:true}).eq('owner_handle', myHandle),
            _sb.from('team_requests').select('*',{count:'exact',head:true}).eq('sender_handle', myHandle).eq('status','accepted')
        ]);
        document.getElementById('stat-created').innerText = c || 0;
        document.getElementById('stat-joined').innerText = j || 0;
    }

    function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.sq-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        renderFeed();
    }

    function renderFeed() {
        const q = document.getElementById('sq-search').value.toLowerCase().trim();
        const feed = document.getElementById('sq-feed');
        feed.innerHTML = '';

        let list = allSquads.filter(s => {
            // hide private squads you're not part of
            if (s.is_private) {
                if (s.owner_handle === myHandle) return true;
                const r = myRequests.find(r => r.ticket_id === String(s.id));
                if (!r) return false;
            }
            return true;
        });

        if (activeTab === 'mine') {
            list = list.filter(s => {
                if (s.owner_handle === myHandle) return true;
                const r = myRequests.find(r => r.ticket_id === String(s.id));
                return r && r.status === 'accepted';
            });
        }

        if (q) {
            list = list.filter(s =>
                s.team_name?.toLowerCase().includes(q) ||
                s.description?.toLowerCase().includes(q) ||
                (Array.isArray(s.topics) && s.topics.some(t => t.toLowerCase().includes(q)))
            );
        }

        if (!list.length) {
            feed.innerHTML = `<div class="sq-empty"><div class="sq-empty-icon">üèïÔ∏è</div><div class="sq-empty-title">${activeTab==='mine'?'No squads yet':'No squads found'}</div><div class="sq-empty-sub">${activeTab==='mine'?'Join or create a squad to get started':'Try a different search or create one!'}</div></div>`;
            return;
        }

        list.forEach(s => feed.appendChild(buildCard(s)));
    }

    function buildCard(s) {
        const isOwner = s.owner_handle === myHandle;
        const myReq = myRequests.find(r => r.ticket_id === String(s.id));
        const isMember = isOwner || (myReq && myReq.status === 'accepted');
        const isPending = !isMember && myReq && myReq.status === 'pending';
        const topics = Array.isArray(s.topics) ? s.topics : [];

        const card = document.createElement('div');
        card.className = `sq-card${isOwner ? ' is-mine' : ''}`;

        const pfpHtml = s.pfp
            ? `<div class="sq-card-pfp"><img src="${esc(s.pfp)}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" onerror="this.parentElement.innerText='üí¨'"></div>`
            : `<div class="sq-card-pfp">üí¨</div>`;

        const topicsHtml = topics.length
            ? `<div class="sq-card-topics">${topics.map(t=>`<span class="sq-card-topic-tag">${esc(t)}</span>`).join('')}</div>`
            : '';

        let actions = '';
        if (isOwner) {
            actions = `
                <button class="sq-action-btn sq-btn-manage" onclick="event.stopPropagation();openManageModal('${s.id}')">Manage</button>
                <button class="sq-action-btn sq-btn-chat" onclick="event.stopPropagation();location.href='squad_chat.html?id=${s.id}'">üí¨ Chat</button>`;
        } else if (isMember) {
            actions = `
                <button class="sq-action-btn sq-btn-joined" style="border:1px solid #1e1e1e;">‚úì Joined</button>
                <button class="sq-action-btn sq-btn-chat" onclick="event.stopPropagation();location.href='squad_chat.html?id=${s.id}'">üí¨ Chat</button>
                <button class="sq-action-btn sq-btn-leave" style="border:1px solid rgba(255,59,48,.25);" onclick="event.stopPropagation();leaveSquad('${s.id}')">Leave</button>`;
        } else if (isPending) {
            actions = `<button class="sq-action-btn sq-btn-pending" style="border:1px solid #1e1e1e;">Requested‚Ä¶</button>`;
        } else {
            actions = `<button class="sq-action-btn sq-btn-join" id="jbtn-${s.id}" onclick="event.stopPropagation();joinSquad('${s.id}',${!!s.is_private})">${s.is_private ? 'Request to Join' : 'Join'}</button>`;
        }

        card.innerHTML = `
            ${pfpHtml}
            <div class="sq-card-body">
                <div class="sq-card-nameline">
                    <span class="sq-card-name">${esc(s.team_name)}</span>
                    ${isOwner ? '<span class="sq-tag-badge sq-badge-mine">YOURS</span>' : ''}
                    ${s.is_private ? '<span class="sq-tag-badge sq-badge-private">PRIVATE</span>' : ''}
                </div>
                <div class="sq-card-owner">by @${esc(s.owner_handle)}</div>
                ${s.description ? `<div class="sq-card-desc">${esc(s.description)}</div>` : ''}
                ${topicsHtml}
                <div class="sq-card-meta">üë• ${allAccepted.filter(r=>String(r.ticket_id)===String(s.id)).length} member${allAccepted.filter(r=>String(r.ticket_id)===String(s.id)).length!==1?'s':''}</div>
            </div>
            <div class="sq-card-right">${actions}</div>`;

        return card;
    }

    async function joinSquad(id, isPrivate) {
        const btn = document.getElementById(`jbtn-${id}`);
        if (btn) { btn.innerText = '‚Ä¶'; btn.disabled = true; }
        const status = isPrivate ? 'pending' : 'accepted';
        const { error } = await _sb.from('team_requests').insert([{ ticket_id: String(id), sender_handle: myHandle, status }]);
        if (error) { if (btn) { btn.innerText = isPrivate?'Request to Join':'Join'; btn.disabled=false; } return; }
        if (!isPrivate) allAccepted.push({ ticket_id: String(id) });
        myRequests.push({ ticket_id: String(id), sender_handle: myHandle, status });
        await updateStats();
        renderFeed();
    }

    async function leaveSquad(id) {
        if (!confirm('Leave this squad?')) return;
        await _sb.from('team_requests').delete().eq('ticket_id', String(id)).eq('sender_handle', myHandle);
        myRequests = myRequests.filter(r => r.ticket_id !== String(id));
        allAccepted = allAccepted.filter(r => !(String(r.ticket_id) === String(id) && r.sender_handle === myHandle));
        await updateStats();
        renderFeed();
    }

    // Create
    function openCreateModal() { document.getElementById('create-overlay').classList.add('open'); }
    function closeCreateModal() {
        document.getElementById('create-overlay').classList.remove('open');
        document.getElementById('sq-name').value = '';
        document.getElementById('sq-desc').value = '';
        document.getElementById('sq-private').checked = false;
        document.querySelectorAll('#topic-row .sq-topic.on').forEach(t=>t.classList.remove('on'));
        newPfp = '';
        const pp = document.getElementById('pfp-pick');
        pp.style.backgroundImage=''; pp.innerText='üñº'; pp.classList.remove('has-img');
    }

    // ‚îÄ‚îÄ PFP Crop flow (same pattern as create.html) ‚îÄ‚îÄ
    let pfpCropper = null;
    let pfpCropTarget = null; // 'new' or 'edit'

    function handlePfp(input, isEdit) {
        if (!input.files[0]) return;
        pfpCropTarget = isEdit ? 'edit' : 'new';
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.getElementById('pfp-crop-target');
            // Destroy old cropper before setting new src
            if (pfpCropper) { pfpCropper.destroy(); pfpCropper = null; }
            img.src = e.target.result;
            img.onload = () => {
                pfpCropper = new Cropper(img, { aspectRatio: 1, viewMode: 1, autoCropArea: 0.9 });
            };
            document.getElementById('pfp-crop-overlay').classList.add('open');
        };
        reader.readAsDataURL(input.files[0]);
        input.value = ''; // reset so same file can be re-selected
    }

    function applyCrop() {
        if (!pfpCropper) return;
        const b64 = pfpCropper.getCroppedCanvas({ width: 400, height: 400 }).toDataURL('image/jpeg', 0.88);
        if (pfpCropTarget === 'edit') {
            editPfp = b64;
            const el = document.getElementById('edit-pfp-pick');
            el.style.backgroundImage = `url(${b64})`; el.innerText = ''; el.classList.add('has-img');
        } else {
            newPfp = b64;
            const el = document.getElementById('pfp-pick');
            el.style.backgroundImage = `url(${b64})`; el.innerText = ''; el.classList.add('has-img');
        }
        cancelCrop();
    }

    function cancelCrop() {
        document.getElementById('pfp-crop-overlay').classList.remove('open');
        if (pfpCropper) { pfpCropper.destroy(); pfpCropper = null; }
    }

    async function createSquad() {
        const name = document.getElementById('sq-name').value.trim();
        if (!name) { document.getElementById('sq-name').focus(); return; }
        const btn = document.getElementById('create-btn');
        btn.innerText='Creating‚Ä¶'; btn.disabled=true;
        const { error } = await _sb.from('team_tickets').insert([{
            owner_handle: myHandle,
            team_name: name,
            description: document.getElementById('sq-desc').value.trim(),
            pfp: newPfp || null,
            is_private: document.getElementById('sq-private').checked
        }]);
        btn.innerText='Create Squad'; btn.disabled=false;
        if (error) { alert('Error: ' + error.message); return; }
        closeCreateModal();
        await Promise.all([loadSquads(), updateStats()]);
    }

    // Manage
    async function openManageModal(id) {
        activeManageId = id;
        const s = allSquads.find(s => String(s.id) === String(id));
        if (!s) return;
        document.getElementById('manage-title').innerText = s.team_name;
        document.getElementById('edit-name').value = s.team_name;
        document.getElementById('edit-desc').value = s.description || '';
        document.getElementById('edit-private').checked = s.is_private || false;
        editPfp = s.pfp || '';
        const ep = document.getElementById('edit-pfp-pick');
        if (s.pfp) { ep.style.backgroundImage=`url(${s.pfp})`; ep.innerText=''; ep.classList.add('has-img'); }
        else { ep.style.backgroundImage=''; ep.innerText='‚úé'; ep.classList.remove('has-img'); }
        await loadManageMembers(id);
        document.getElementById('manage-overlay').classList.add('open');
    }

    function closeManageModal() { document.getElementById('manage-overlay').classList.remove('open'); activeManageId = null; }

    async function loadManageMembers(id) {
        const { data: reqs } = await _sb.from('team_requests').select('*').eq('ticket_id', String(id));
        const pending = (reqs||[]).filter(r=>r.status==='pending');
        const members = (reqs||[]).filter(r=>r.status==='accepted');

        document.getElementById('manage-requests').innerHTML = pending.length
            ? pending.map(r=>`<div class="sq-member-item"><span class="sq-member-handle">@${esc(r.sender_handle)}</span><div class="sq-member-actions"><button class="sq-mbtn sq-mbtn-accept" onclick="respondReq('${r.id}','accepted')">Accept</button><button class="sq-mbtn sq-mbtn-decline" onclick="respondReq('${r.id}','declined')">Decline</button></div></div>`).join('')
            : '<div style="font-size:12px;color:#333;padding:6px 0;">No pending requests</div>';

        document.getElementById('manage-members').innerHTML = members.length
            ? members.map(r=>`<div class="sq-member-item"><span class="sq-member-handle">@${esc(r.sender_handle)}</span><button class="sq-mbtn sq-mbtn-kick" onclick="kickMember('${r.id}')">Kick</button></div>`).join('')
            : '<div style="font-size:12px;color:#333;padding:6px 0;">No members yet</div>';
    }

    async function respondReq(reqId, status) {
        if (status==='declined') await _sb.from('team_requests').delete().eq('id', reqId);
        else await _sb.from('team_requests').update({ status }).eq('id', reqId);
        await loadManageMembers(activeManageId);
    }

    async function kickMember(reqId) {
        if (!confirm('Kick this member?')) return;
        await _sb.from('team_requests').delete().eq('id', reqId);
        await loadManageMembers(activeManageId);
    }

    async function saveSquad() {
        const name = document.getElementById('edit-name').value.trim();
        if (!name) return;
        await _sb.from('team_tickets').update({
            team_name: name,
            description: document.getElementById('edit-desc').value.trim(),
            pfp: editPfp || null,
            is_private: document.getElementById('edit-private').checked
        }).eq('id', activeManageId);
        closeManageModal();
        await loadSquads();
    }

    async function deleteSquad() {
        if (!confirm('Delete this squad forever? This cannot be undone.')) return;
        await Promise.all([
            _sb.from('team_requests').delete().eq('ticket_id', String(activeManageId)),
            _sb.from('team_messages').delete().eq('ticket_id', String(activeManageId))
        ]);
        await _sb.from('team_tickets').delete().eq('id', activeManageId);
        closeManageModal();
        await Promise.all([loadSquads(), updateStats()]);
    }

    window.onload = init;
</script>
</body>
</html>